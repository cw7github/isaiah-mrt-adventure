<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Isaiah's MRT Food Adventure</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Fredoka:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Preload critical images for instant station loading -->
  <link rel="preload" href="assets/mascot.png" as="image">
  <link rel="preload" href="assets/train.png" as="image">
  <link rel="preload" href="assets/food_fruit.jpeg" as="image">
  <link rel="preload" href="assets/food_drink.jpeg" as="image">
  <link rel="preload" href="assets/food_bakery.png" as="image">
  <link rel="preload" href="assets/food_pizza.jpeg" as="image">
  <link rel="preload" href="assets/food_icecream.png" as="image">
  <link rel="preload" href="assets/food_fishshop.png" as="image">
  <link rel="preload" href="assets/food_cheese.png" as="image">
  <link rel="preload" href="assets/food_noodle.png" as="image">
  <link rel="preload" href="assets/icon_fruit.svg" as="image">
  <link rel="preload" href="assets/icon_drink.svg" as="image">
  <link rel="preload" href="assets/icon_bakery.svg" as="image">
  <link rel="preload" href="assets/icon_pizza.svg" as="image">
  <link rel="preload" href="assets/icon_icecream.svg" as="image">
  <link rel="preload" href="assets/icon_fish.svg" as="image">
  <link rel="preload" href="assets/icon_cheese.svg" as="image">
  <link rel="preload" href="assets/icon_noodle.svg" as="image">

  <style>
    /* ===== CSS RESET & BASE ===== */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ===== DESIGN PHILOSOPHY =====
     * "Soft Storybook" - A warm, hand-crafted aesthetic that feels like
     * flipping through a beloved children's picture book. Every element
     * has gentle edges, subtle texture, and comforting depth.
     *
     * Signature Elements:
     * 1. Paper-like texture overlay for warmth
     * 2. Soft, pillowy shadows that feel tactile
     * 3. Warm color palette inspired by watercolors
     * 4. Gentle floating animations like turning pages
     * 5. Hand-drawn inspired borders and decorations
     */

    /* ===== CSS VARIABLES ===== */
    :root {
      /* === PRIMARY PALETTE: Warm Cream & Sky === */
      /* Base backgrounds with warmth and depth */
      --bg-cream: #FDF9F3;
      --bg-cream-warm: #FBF6EE;
      --bg-cream-cool: #F8F5F0;
      --bg-soft-blue: #EEF6FA;
      --bg-soft-blue-deep: #E3F0F7;
      --bg-elevator: #EAE6E0;

      /* Paper texture overlay color */
      --paper-texture: rgba(255, 250, 240, 0.4);

      /* === MRT JOURNEY COLORS === */
      /* Primary blue - softer, more approachable */
      --mrt-blue: #4A90C2;
      --mrt-blue-deep: #3A7DB0;
      --mrt-blue-soft: #6AADDA;
      --mrt-blue-pale: #C5E1F2;
      --mrt-blue-whisper: #E8F3FA;

      /* === TAIPEI MRT LINE COLORS === */
      /* Authentic Taipei MRT system colors */
      --line-red: #E3002C;
      --line-red-light: #FF4D6D;
      --line-red-pale: #FFE5EA;

      --line-blue: #0070BD;
      --line-blue-light: #4DA6FF;
      --line-blue-pale: #E5F2FF;

      --line-green: #008659;
      --line-green-light: #4DB88D;
      --line-green-pale: #E5F7F1;

      --line-orange: #F8B61C;
      --line-orange-light: #FFD166;
      --line-orange-pale: #FFF6E5;

      --line-brown: #C48C31;
      --line-brown-light: #E0B86D;
      --line-brown-pale: #F7F0E5;

      --line-yellow: #FFDB00;
      --line-yellow-light: #FFE84D;
      --line-yellow-pale: #FFFBE5;

      /* Taipei MRT aliases for existing code compatibility */
      --taipei-red: #E3002C;
      --taipei-blue: #0070BD;
      --taipei-green: #008659;
      --taipei-orange: #F8B61C;
      --taipei-brown: #C48C31;
      --taipei-yellow: #FFDB00;

      /* Transit design tokens */
      --transit-font: 'Outfit', var(--font-display);
      --station-size: 40px;
      --station-size-sm: 32px;
      --line-width: 8px;
      --line-width-thin: 4px;

      /* === ACCENT PALETTE: Watercolor Inspired === */
      /* Each color has 3 variants: base, soft, pale */
      --accent-coral: #F28B82;
      --accent-coral-soft: #F8ADA6;
      --accent-coral-pale: #FCE4E2;

      --accent-golden: #F9D56E;
      --accent-golden-soft: #FBE49E;
      --accent-golden-pale: #FEF5DC;

      --accent-mint: #81D4C2;
      --accent-mint-soft: #A8E4D8;
      --accent-mint-pale: #E0F5F1;

      --accent-lavender: #B8A4D0;
      --accent-lavender-soft: #D0C1E0;
      --accent-lavender-pale: #F0EBF5;

      --accent-peach: #FFCAB0;
      --accent-peach-soft: #FFE0D0;
      --accent-peach-pale: #FFF3ED;

      /* === TEXT COLORS === */
      /* Warm charcoal instead of cold black */
      --text-primary: #3B3B3B;
      --text-secondary: #6B6B6B;
      --text-tertiary: #9B9B9B;
      --text-inverse: #FFFFFF;

      /* === UI ELEMENT COLORS === */
      --panel-silver: #E2E2E2;
      --panel-silver-dark: #C8C8C8;
      --panel-dark: #5A5A5A;
      --panel-glow: #7DD590;

      /* === FEEDBACK COLORS === */
      --success-green: #7DD590;
      --success-green-soft: #A8E5B5;
      --success-green-pale: #E5F6E9;
      --success-glow: rgba(125, 213, 144, 0.35);

      --error-soft: #F5A3A3;
      --error-pale: #FDECEC;

      /* === SHADOW SYSTEM === */
      /* Layered, soft shadows for depth */
      --shadow-xs: 0 1px 2px rgba(60, 60, 60, 0.06);
      --shadow-sm: 0 2px 4px rgba(60, 60, 60, 0.08), 0 1px 2px rgba(60, 60, 60, 0.04);
      --shadow-md: 0 4px 8px rgba(60, 60, 60, 0.08), 0 2px 4px rgba(60, 60, 60, 0.04);
      --shadow-lg: 0 8px 16px rgba(60, 60, 60, 0.08), 0 4px 8px rgba(60, 60, 60, 0.04);
      --shadow-xl: 0 12px 24px rgba(60, 60, 60, 0.1), 0 6px 12px rgba(60, 60, 60, 0.05);
      --shadow-glow: 0 0 20px rgba(106, 173, 218, 0.25);
      --shadow-inner: inset 0 2px 4px rgba(60, 60, 60, 0.06);

      /* Colored shadows for special elements */
      --shadow-coral: 0 4px 12px rgba(242, 139, 130, 0.3);
      --shadow-golden: 0 4px 12px rgba(249, 213, 110, 0.35);
      --shadow-mint: 0 4px 12px rgba(129, 212, 194, 0.3);
      --shadow-blue: 0 4px 12px rgba(74, 144, 194, 0.25);

      /* === TYPOGRAPHY === */
      --font-display: 'Fredoka', sans-serif;
      --font-reading: 'Nunito', sans-serif;

      /* Type scale with comfortable reading sizes */
      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 2rem;
      --text-4xl: 2.5rem;

      /* === SPACING RHYTHM === */
      --space-2xs: 0.25rem;
      --space-xs: 0.5rem;
      --space-sm: 0.75rem;
      --space-md: 1rem;
      --space-lg: clamp(0.75rem, 2vh, 1.5rem);
      --space-xl: clamp(1rem, 2.5vh, 2rem);
      --space-2xl: clamp(1.5rem, 3vh, 3rem);
      --space-3xl: clamp(2rem, 4vh, 4rem);

      /* === BORDER RADIUS === */
      /* Soft, rounded corners throughout */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-2xl: 32px;
      --radius-full: 9999px;

      /* === TOUCH TARGETS === */
      /* Generous sizes for accessibility */
      --touch-min: clamp(60px, 10vh, 80px);
      --touch-lg: clamp(80px, 12vh, 100px);
      --touch-target: clamp(40px, 6vh, 44px);

      /* === ANIMATION TIMING === */
      /* Gentle, calming motion */
      --anim-instant: 0.1s;
      --anim-fast: 0.2s;
      --anim-medium: 0.35s;
      --anim-slow: 0.5s;
      --anim-slower: 0.8s;

      /* Custom easing curves */
      --ease-out-soft: cubic-bezier(0.25, 0.8, 0.25, 1);
      --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --ease-gentle: cubic-bezier(0.4, 0, 0.2, 1);

      /* === GRAIN TEXTURE === */
      /* Subtle noise for organic feel */
      --grain-opacity: 0.03;
    }

	    /* Respect reduced motion preference */
	    @media (prefers-reduced-motion: reduce) {
	      *, *::before, *::after {
	        animation-duration: 0.01ms !important;
	        animation-iteration-count: 1 !important;
	        transition-duration: 0.01ms !important;
	      }

	      /* Keep the ride scene readable (slow, gentle motion) */
	      #mrtRideScreen .mrt-train {
	        animation-duration: 8s !important;
	        animation-iteration-count: infinite !important;
	        animation-timing-function: linear !important;
	      }

	      #mrtRideScreen .train-track,
	      #mrtRideScreen .track-ties {
	        animation-duration: 1.3s !important;
	        animation-iteration-count: infinite !important;
	      }

	      #mrtRideScreen .mrt-wheel {
	        animation-duration: 1.6s !important;
	        animation-iteration-count: infinite !important;
	      }
	    }

    /* ===== CALM MODE ===== */
    /* Muted, soothing palette for overwhelm moments */
    body.calm-mode {
      --accent-coral: #D4B5B2;
      --accent-coral-soft: #E5D0CE;
      --accent-golden: #DDD4B8;
      --accent-golden-soft: #EBE5D4;
      --accent-mint: #B5CFC6;
      --accent-mint-soft: #D0E3DD;
      --accent-lavender: #C5BACE;
      --accent-lavender-soft: #DAD2DF;
      --mrt-blue: #8AAEC8;
      --mrt-blue-soft: #A8C5D8;
      --success-green: #A8CDB4;
      --grain-opacity: 0.02;
    }

    body.calm-mode .reward-animation,
    body.calm-mode .celebration {
      display: none !important;
    }

    /* Calm mode reduces distracting motion, but should not freeze the whole app */
    body.calm-mode * {
      transition-duration: 0.15s !important;
    }

    body.calm-mode .sparkle,
    body.calm-mode .sparkle-layer,
    body.calm-mode .themed-floaters,
    body.calm-mode .cloud,
    body.calm-mode .cloud-layer,
    body.calm-mode .mrt-car {
      animation: none !important;
    }

    /* Keep the train ride feeling alive, but slower */
    body.calm-mode #mrtRideScreen .mrt-train {
      animation-timing-function: linear !important;
      animation-duration: 10s !important;
    }

    body.calm-mode #mrtRideScreen .train-track,
    body.calm-mode #mrtRideScreen .track-ties {
      animation-duration: 1.1s !important;
    }

    body.calm-mode #mrtRideScreen .mrt-wheel {
      animation-duration: 1.4s !important;
    }

    /* ===== GLOBAL GRAIN TEXTURE ===== */
    /* SVG-based noise texture for organic paper feel */
    @keyframes grain-shift {
      0%, 100% { transform: translate(0, 0); }
      10% { transform: translate(-1%, -1%); }
      30% { transform: translate(1%, 0%); }
      50% { transform: translate(-1%, 1%); }
      70% { transform: translate(1%, -1%); }
      90% { transform: translate(0%, 1%); }
    }

    /* ===== BASE STYLES ===== */
    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font-reading);
      font-size: 18px;
      line-height: 1.7;
      letter-spacing: 0.02em;
      color: var(--text-primary);
      background: var(--bg-cream);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: clamp(0.5rem, 1vh, 1.5rem);
      /* Prevent iOS rubber-banding */
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
      /* Smooth font rendering */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Subtle paper texture background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        /* Soft radial gradient for warmth */
        radial-gradient(ellipse at 30% 20%, rgba(249, 213, 110, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 80%, rgba(129, 212, 194, 0.06) 0%, transparent 50%),
        /* Very subtle dot pattern */
        radial-gradient(circle at 1px 1px, rgba(0,0,0,0.015) 1px, transparent 0);
      background-size: 100% 100%, 100% 100%, 20px 20px;
      pointer-events: none;
      z-index: 0;
    }

    /* Grain overlay for organic texture */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: var(--grain-opacity);
      pointer-events: none;
      z-index: 9999;
    }

	    /* iPad Mini specific optimizations (768x1024) */
	    @media screen and (min-width: 700px) and (max-width: 850px) {
	      body {
	        padding: var(--space-sm);
	        font-size: 18px;
	      }

	      .app-container {
	        max-height: 90vh;
	        border-radius: 20px;
	      }

	      .welcome-title {
	        font-size: 1.8rem;
	      }

	      .mrt-title {
	        font-size: 1.3rem;
	      }

	      /* Bigger station image for iPad Mini */
	      .restaurant-hero {
	        width: clamp(180px, 32vw, 240px);
	      }
	    }

    /* Landscape iPad Mini */
    @media screen and (max-height: 600px) and (orientation: landscape) {
      .app-container {
        max-height: 95vh;
      }

      .welcome-illustration {
        font-size: 3rem;
        margin-bottom: var(--space-sm);
      }

      .welcome-title {
        font-size: 1.5rem;
      }

      .big-btn {
        min-height: 60px;
        padding: var(--space-sm) var(--space-lg);
      }
    }

    /* ===== MAIN CONTAINER ===== */
    .app-container {
      width: 100%;
      max-width: 900px;
      height: 100%;
      max-height: 98vh;
      background: var(--bg-cream-warm);
      border-radius: var(--radius-2xl);
      box-shadow:
        var(--shadow-xl),
        0 0 0 1px rgba(255, 255, 255, 0.5);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 1;
      /* Subtle inner border for depth */
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    /* Decorative corner accents - storybook feel */
    .app-container::before,
    .app-container::after {
      content: '';
      position: absolute;
      width: 40px;
      height: 40px;
      pointer-events: none;
      z-index: 100;
      opacity: 0.15;
    }

    .app-container::before {
      top: 8px;
      left: 8px;
      border-top: 3px solid var(--mrt-blue);
      border-left: 3px solid var(--mrt-blue);
      border-radius: 8px 0 0 0;
    }

    .app-container::after {
      top: 8px;
      right: 8px;
      border-top: 3px solid var(--mrt-blue);
      border-right: 3px solid var(--mrt-blue);
      border-radius: 0 8px 0 0;
    }

    /* ===== HEADER ===== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: clamp(0.5rem, 1vh, 1rem) clamp(0.75rem, 1.5vh, 1.5rem);
      background:
        linear-gradient(135deg, var(--mrt-blue) 0%, var(--mrt-blue-soft) 100%);
      color: var(--text-inverse);
      position: relative;
      overflow: hidden;
    }

    /* Subtle wave pattern in header */
    .header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 6px;
      background:
        radial-gradient(ellipse 24px 6px at 12px 0, transparent 24px, var(--bg-cream-warm) 24px);
      background-size: 24px 6px;
    }

    /* Soft glow behind header */
    .header::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 50% 150%, rgba(255,255,255,0.15) 0%, transparent 60%);
      pointer-events: none;
    }

    .header-title {
      font-family: var(--font-display);
      font-size: clamp(1rem, 2.5vh, 1.25rem);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1;
    }

    .header-title .icon {
      font-size: 1.5rem;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
    }

	    .header-controls {
	      display: flex;
	      gap: var(--space-xs);
	      flex-wrap: wrap;
	      justify-content: flex-end;
	      position: relative;
	      z-index: 1;
	    }

	    .control-btn {
	      width: var(--touch-target);
	      height: var(--touch-target);
      border-radius: var(--radius-md);
      border: none;
      background: rgba(255, 255, 255, 0.18);
      backdrop-filter: blur(4px);
      color: var(--text-inverse);
      font-size: 1.2rem;
      cursor: pointer;
      transition: all var(--anim-fast) var(--ease-out-soft);
      display: flex;
      align-items: center;
      justify-content: center;
	      box-shadow: var(--shadow-sm);
	    }

	    .control-btn.control-text-btn {
	      width: auto;
	      min-width: var(--touch-target);
	      padding: 0 12px;
	      font-family: var(--font-display);
	      font-size: 0.95rem;
	      font-weight: 700;
	      letter-spacing: 0.01em;
	    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.28);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .control-btn:active {
      transform: translateY(0);
      background: rgba(255, 255, 255, 0.35);
    }

	    .control-btn.active {
	      background: var(--accent-golden);
	      color: var(--text-primary);
	      box-shadow: var(--shadow-golden);
	    }

	    /* Skills screen filter buttons */
	    .skills-filter-btn {
	      width: auto;
	      height: auto;
	      padding: 8px 12px;
	      border-radius: 999px;
	      font-size: 0.95rem;
	      line-height: 1;
	    }

    /* ===== PROGRESS BAR ===== */
    .progress-container {
      padding: clamp(0.35rem, 0.75vh, 0.75rem) clamp(0.75rem, 1.5vh, 1.5rem);
      background:
        linear-gradient(180deg, var(--bg-soft-blue-deep) 0%, var(--bg-soft-blue) 100%);
      display: flex;
      align-items: center;
      gap: var(--space-md);
      border-bottom: 1px solid rgba(0,0,0,0.04);
    }

    .progress-label {
      font-family: var(--font-display);
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
      letter-spacing: 0.02em;
    }

    .progress-bar {
      flex: 1;
      height: 10px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: var(--radius-full);
      overflow: hidden;
      box-shadow: var(--shadow-inner);
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background:
        linear-gradient(90deg,
          var(--accent-mint) 0%,
          var(--success-green) 50%,
          var(--accent-mint-soft) 100%);
      background-size: 200% 100%;
      border-radius: var(--radius-full);
      transition: width var(--anim-slower) var(--ease-out-soft);
      position: relative;
    }

    /* Animated shimmer on progress */
    .progress-fill::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255,255,255,0.4) 50%,
        transparent 100%);
      animation: shimmer 2s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .sticker-count {
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: var(--font-display);
      font-weight: 600;
      font-size: var(--text-lg);
      color: var(--accent-coral);
      background: rgba(255, 255, 255, 0.6);
      padding: var(--space-2xs) var(--space-sm);
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-xs);
    }

    .sticker-count span:first-child {
      font-size: 1.1rem;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,0.1));
    }

    /* ===== MAIN CONTENT AREA ===== */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      background: var(--bg-cream-warm);
    }

    /* ===== SCREENS ===== */
    .screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition:
        opacity var(--anim-medium) var(--ease-gentle),
        visibility 0s linear var(--anim-medium);
      /* Page-turn feel */
      transform-origin: left center;
    }

    .screen.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transition:
        opacity var(--anim-medium) var(--ease-gentle),
        visibility 0s linear 0s;
    }

    /* ===== WELCOME SCREEN ===== */
    .welcome-screen {
      background:
        radial-gradient(ellipse at 50% 0%, var(--bg-soft-blue) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 100%, var(--accent-peach-pale) 0%, transparent 40%),
        radial-gradient(ellipse at 20% 100%, var(--accent-mint-pale) 0%, transparent 40%),
        var(--bg-cream-warm);
      align-items: center;
      justify-content: center;
      padding: clamp(1rem, 2vh, 2rem);
      text-align: center;
    }

    /* Decorative floating shapes */
    .welcome-screen::before {
      content: '';
      position: absolute;
      top: 10%;
      right: 10%;
      width: 80px;
      height: 80px;
      background: var(--accent-golden-pale);
      border-radius: 50%;
      opacity: 0.6;
      animation: float 6s ease-in-out infinite;
    }

    .welcome-screen::after {
      content: '';
      position: absolute;
      bottom: 15%;
      left: 8%;
      width: 60px;
      height: 60px;
      background: var(--accent-mint-pale);
      border-radius: 50%;
      opacity: 0.5;
      animation: float 8s ease-in-out infinite reverse;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }

    .welcome-illustration {
      font-size: clamp(3rem, 8vh, 4.5rem);
      margin-bottom: var(--space-lg);
      animation: gentle-bounce 3s ease-in-out infinite;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
      position: relative;
      z-index: 1;
    }

    /* Ghibli-style mascot image */
    .welcome-mascot {
      width: clamp(140px, 35vw, 220px);
      height: auto;
      margin-bottom: var(--space-lg);
      animation: gentle-bounce 3s ease-in-out infinite;
      position: relative;
      z-index: 1;
      object-fit: contain;
      mix-blend-mode: multiply;
    }

    @keyframes gentle-bounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-12px) scale(1.02); }
    }

    .welcome-title {
      font-family: var(--font-display);
      font-size: clamp(1.5rem, 4vh, 2rem);
      font-weight: 600;
      color: var(--mrt-blue);
      margin-bottom: var(--space-sm);
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .welcome-subtitle {
      font-size: clamp(1rem, 2.5vh, 1.125rem);
      color: var(--text-secondary);
      margin-bottom: clamp(0.75rem, 2vh, 1.5rem);
      max-width: 380px;
      line-height: 1.6;
      position: relative;
      z-index: 1;
    }

    /* ===== BIG BUTTON ===== */
    /* Signature tactile button - feels like pressing a soft pillow */
    .big-btn {
      min-width: var(--touch-lg);
      min-height: clamp(60px, 10vh, 80px);
      padding: clamp(0.5rem, 1.5vh, 1rem) clamp(1.5rem, 3vh, 3rem);
      font-family: var(--font-display);
      font-size: clamp(1rem, 2.5vh, 1.25rem);
      font-weight: 600;
      letter-spacing: 0.02em;
      border: none;
      border-radius: var(--radius-xl);
      cursor: pointer;
      transition: all var(--anim-fast) var(--ease-out-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      position: relative;
      z-index: 1;
      /* Multi-layer shadow for depth */
      box-shadow:
        0 6px 0 rgba(0, 0, 0, 0.1),
        0 8px 20px rgba(0, 0, 0, 0.08),
        inset 0 -2px 0 rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .big-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 50%);
      pointer-events: none;
    }

    .big-btn:hover {
      transform: translateY(-2px);
      box-shadow:
        0 8px 0 rgba(0, 0, 0, 0.08),
        0 12px 28px rgba(0, 0, 0, 0.12),
        inset 0 -2px 0 rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .big-btn:active,
    .big-btn:focus {
      transform: translateY(3px);
      box-shadow:
        0 2px 0 rgba(0, 0, 0, 0.12),
        0 4px 12px rgba(0, 0, 0, 0.08),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
      outline: none;
    }

    /* Better touch feedback for iPad */
    @media (hover: none) {
      .big-btn:active {
        transform: translateY(4px) scale(0.98);
      }
    }

    .big-btn.primary {
      background:
        linear-gradient(135deg, var(--accent-coral) 0%, var(--accent-coral-soft) 100%);
      color: var(--text-inverse);
      box-shadow:
        0 6px 0 rgba(200, 100, 90, 0.35),
        0 8px 20px rgba(242, 139, 130, 0.25),
        inset 0 -2px 0 rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .big-btn.primary:hover {
      background:
        linear-gradient(135deg, #F59B94 0%, #FABDB7 100%);
      box-shadow:
        0 8px 0 rgba(200, 100, 90, 0.3),
        var(--shadow-coral),
        inset 0 -2px 0 rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.35);
    }

    .big-btn.secondary {
      background:
        linear-gradient(135deg, var(--mrt-blue) 0%, var(--mrt-blue-soft) 100%);
      color: var(--text-inverse);
      box-shadow:
        0 6px 0 rgba(50, 100, 140, 0.35),
        var(--shadow-blue),
        inset 0 -2px 0 rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.25);
    }

    .big-btn.secondary:hover {
      background:
        linear-gradient(135deg, var(--mrt-blue-soft) 0%, #7BBDE5 100%);
    }

    /* Make Next button more prominent */
    #continueBtn {
      width: 100%;
      max-width: 260px;
      animation: gentlePulse 2.5s ease-in-out infinite;
      font-size: var(--text-xl);
      font-weight: 600;
      min-height: 56px;
      margin: 0 auto;
    }

    #continueBtn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      transform: none;
      animation: none;
      box-shadow:
        0 3px 0 rgba(50, 100, 140, 0.25),
        var(--shadow-sm);
    }

    @keyframes gentlePulse {
      0%, 100% {
        transform: scale(1);
        box-shadow:
          0 6px 0 rgba(50, 100, 140, 0.35),
          var(--shadow-blue),
          inset 0 -2px 0 rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.25);
      }
      50% {
        transform: scale(1.03);
        box-shadow:
          0 8px 0 rgba(50, 100, 140, 0.3),
          0 4px 20px rgba(74, 144, 194, 0.35),
          var(--shadow-glow),
          inset 0 -2px 0 rgba(0, 0, 0, 0.08),
          inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }
    }

    #continueBtn:active {
      animation: none;
    }

    /* ===== TAIPEI MRT COLORS ===== */
    :root {
      --taipei-red: #E3002C;      /* Red Line (Tamsui-Xinyi) */
      --taipei-blue: #0070BD;     /* Blue Line (Bannan) */
      --taipei-green: #008659;    /* Green Line (Songshan-Xindian) */
      --taipei-orange: #F8B61C;   /* Orange Line (Zhonghe-Xinlu) */
      --taipei-brown: #C48C31;    /* Brown Line (Wenhu) */
      --taipei-yellow: #FFDB00;   /* Yellow Line (Circular) */
      --taipei-purple: #7B5AA6;   /* Purple Line (Taoyuan Airport) */
    }

    /* ===== MRT MAP SCREEN ===== */
    .mrt-screen {
      background:
        radial-gradient(ellipse at 50% 100%, rgba(0, 112, 189, 0.05) 0%, transparent 50%),
        linear-gradient(180deg, #F8F9FA 0%, #E8EAF0 100%);
      padding: var(--space-lg);
    }

    .mrt-title {
      font-family: var(--font-display);
      font-size: var(--text-2xl);
      font-weight: 700;
      color: #2C3E50;
      text-align: center;
      margin-bottom: var(--space-md);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mrt-map {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0;
      position: relative;
      overflow-y: auto;
      overflow-x: hidden;
      padding: clamp(1.5rem, 4vh, 2.5rem) clamp(1rem, 3vw, 1.5rem);
      -webkit-overflow-scrolling: touch;
      max-width: 800px;
      margin: 0 auto;
      /* Playful dotted background inspired by transit maps */
      background:
        radial-gradient(circle at 25% 25%, rgba(255, 245, 230, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(232, 245, 255, 0.4) 0%, transparent 50%),
        #FAFBFC;
      /* Custom scrollbar */
      scrollbar-width: thin;
      scrollbar-color: var(--taipei-blue) transparent;
    }

    .mrt-map::-webkit-scrollbar {
      width: 6px;
    }

    .mrt-map::-webkit-scrollbar-track {
      background: transparent;
    }

    .mrt-map::-webkit-scrollbar-thumb {
      background: var(--taipei-blue);
      border-radius: var(--radius-full);
    }

    /* MRT Line - no longer used, lines are drawn via station pseudo-elements */
    .mrt-line {
      display: none;
    }

    /* ===== METRO STATION BUTTONS ===== */
    .station-btn {
      position: relative;
      z-index: 2;
      min-height: 80px;
      padding: 18px 20px 18px 90px;
      background: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-start;
      gap: 14px;
      text-align: left;
      box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.08),
        0 2px 4px rgba(0, 0, 0, 0.04);
      margin: 0 0 24px 0;
      width: 100%;
      max-width: 100%;
    }

    /* Station circle indicator on the line */
    .station-btn::before {
      content: '';
      position: absolute;
      left: 28px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      background: white;
      border: 6px solid var(--taipei-blue);
      border-radius: 50%;
      z-index: 4;
      box-shadow:
        0 0 0 4px white,
        0 3px 8px rgba(0, 0, 0, 0.12);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Line connectors - vertical connection line */
    .station-btn::after {
      content: '';
      position: absolute;
      left: 38px;
      top: 100%;
      width: 8px;
      height: 24px;
      background: var(--taipei-blue);
      z-index: 1;
      border-radius: 4px;
    }

    /* Hide line after last station */
    .station-btn:last-of-type::after {
      display: none;
    }

    .station-btn:hover:not(:disabled) {
      transform: translateX(8px);
      box-shadow:
        0 8px 24px rgba(0, 0, 0, 0.12),
        0 4px 8px rgba(0, 0, 0, 0.08);
    }

    .station-btn:hover:not(:disabled)::before {
      transform: translateY(-50%) scale(1.2);
      box-shadow:
        0 0 0 6px white,
        0 4px 12px rgba(0, 0, 0, 0.18);
    }

    /* Line-specific hover effects - colorful borders */
    #station-fruit:hover:not(:disabled),
    #station-bakery:hover:not(:disabled) {
      border-left: 5px solid var(--taipei-red);
    }

    #station-drink:hover:not(:disabled) {
      border-left: 5px solid var(--taipei-red);
      background: linear-gradient(135deg, rgba(227, 0, 44, 0.03) 0%, white 100%);
    }

    #station-pizza:hover:not(:disabled) {
      border-left: 5px solid var(--taipei-blue);
    }

    #station-icecream:hover:not(:disabled) {
      border-left: 5px solid var(--taipei-blue);
      background: linear-gradient(135deg, rgba(0, 112, 189, 0.03) 0%, white 100%);
    }

    #station-fishshop:hover:not(:disabled) {
      border-left: 5px solid var(--taipei-green);
      background: linear-gradient(135deg, rgba(0, 134, 89, 0.03) 0%, white 100%);
    }

    #station-cheese:hover:not(:disabled),
    #station-noodle:hover:not(:disabled) {
      border-left: 5px solid var(--taipei-orange);
    }

    .station-btn:active:not(:disabled),
    .station-btn:focus:not(:disabled) {
      transform: scale(0.98) translateX(4px);
      outline: none;
    }

    /* Touch feedback for iPad */
    @media (hover: none) {
      .station-btn:active:not(:disabled) {
        transform: scale(0.98) translateX(4px);
      }
    }

    .station-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(70%);
      transform: none !important;
    }

    .station-btn:disabled::before {
      border-color: #CFD8DC;
      background: #ECEFF1;
    }

    .station-btn.completed {
      background: linear-gradient(135deg, #F1F8E9 0%, #DCEDC8 100%);
      border-left: 4px solid #7CB342;
    }

    .station-btn.completed::before {
      background: #66BB6A;
      border-color: #7CB342;
      box-shadow:
        0 0 0 4px white,
        0 3px 8px rgba(76, 175, 80, 0.3);
    }

    /* ===== STATION POSITIONING & LINE COLORS ===== */
    /* Mobile-first vertical list - all stations flow in order */

    /* RED LINE (Level 1) */
    #station-fruit::before,
    #station-fruit::after {
      border-color: var(--taipei-red);
      background: var(--taipei-red);
    }

    #station-drink::before,
    #station-drink::after {
      border-color: var(--taipei-red);
      background: var(--taipei-red);
    }

    #station-bakery::before,
    #station-bakery::after {
      border-color: var(--taipei-red);
      background: var(--taipei-red);
    }

    /* BLUE LINE (Level 2) */
    #station-pizza::before,
    #station-pizza::after {
      border-color: var(--taipei-blue);
      background: var(--taipei-blue);
    }

    #station-icecream::before,
    #station-icecream::after {
      border-color: var(--taipei-blue);
      background: var(--taipei-blue);
    }

    /* GREEN LINE (Level 3) */
    #station-fishshop::before,
    #station-fishshop::after {
      border-color: var(--taipei-green);
      background: var(--taipei-green);
    }

    /* ORANGE LINE (Level 4) */
    #station-cheese::before,
    #station-cheese::after {
      border-color: var(--taipei-orange);
      background: var(--taipei-orange);
    }

    #station-noodle::before,
    #station-noodle::after {
      border-color: var(--taipei-orange);
      background: var(--taipei-orange);
    }

    /* Transfer stations - double ring effect */
    #station-drink::before {
      box-shadow:
        0 0 0 4px white,
        0 0 0 8px var(--taipei-blue),
        0 3px 12px rgba(0, 0, 0, 0.15);
    }

    #station-icecream::before {
      box-shadow:
        0 0 0 4px white,
        0 0 0 8px var(--taipei-green),
        0 3px 12px rgba(0, 0, 0, 0.15);
    }

    #station-fishshop::before {
      box-shadow:
        0 0 0 4px white,
        0 0 0 8px var(--taipei-orange),
        0 3px 12px rgba(0, 0, 0, 0.15);
    }

    .station-icon {
      position: absolute;
      left: 90px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 2.5rem;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #FAFBFC 0%, #F5F7FA 100%);
      border-radius: 50%;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
      z-index: 3;
    }

    /* SVG icon for station buttons */
    .station-icon-img {
      position: absolute;
      left: 90px;
      top: 50%;
      transform: translateY(-50%);
      width: 56px;
      height: 56px;
      object-fit: contain;
      background: linear-gradient(135deg, #FAFBFC 0%, #F5F7FA 100%);
      border-radius: 50%;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
      padding: 8px;
      z-index: 3;
    }

    .station-info {
      flex: 1;
      text-align: left;
      min-width: 0;
      margin-right: 12px;
    }

    .station-name {
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 700;
      color: #1A237E;
      margin-bottom: 6px;
      line-height: 1.3;
    }

    .station-desc {
      font-size: 0.85rem;
      color: #546E7A;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      line-height: 1.4;
    }

    .station-status {
      font-size: 0.85rem;
      font-weight: 700;
      padding: 8px 16px;
      border-radius: 999px;
      background: #1A237E;
      color: white;
      box-shadow: 0 2px 8px rgba(26, 35, 126, 0.25);
      flex-shrink: 0;
      letter-spacing: 0.02em;
    }

    .station-level {
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 800;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .station-level.level-1 {
      background: var(--taipei-red);
      color: white;
    }
    .station-level.level-2 {
      background: var(--taipei-blue);
      color: white;
    }
    .station-level.level-3 {
      background: var(--taipei-green);
      color: white;
    }
    .station-level.level-4 {
      background: var(--taipei-orange);
      color: white;
    }

    .level-indicator {
      display: flex;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-sm);
      flex-wrap: wrap;
      background: rgba(255, 255, 255, 0.7);
      border-radius: var(--radius-lg);
      margin-top: auto;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .level-badge {
      font-size: var(--text-xs);
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-weight: 700;
      letter-spacing: 0.03em;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    .level-badge.level-1 {
      background: var(--taipei-red);
      box-shadow: 0 2px 8px rgba(227, 0, 44, 0.35);
    }
    .level-badge.level-2 {
      background: var(--taipei-blue);
      box-shadow: 0 2px 8px rgba(0, 112, 189, 0.35);
    }
    .level-badge.level-3 {
      background: var(--taipei-green);
      box-shadow: 0 2px 8px rgba(0, 134, 89, 0.35);
    }
    .level-badge.level-4 {
      background: var(--taipei-orange);
      box-shadow: 0 2px 8px rgba(248, 182, 28, 0.35);
    }

    /* ===== MRT LESSON PROGRESS BAR ===== */
    /* Shows current position on the line as you move through lesson pages */
    .mrt-progress-bar {
      position: relative;
      background: rgba(255, 255, 255, 0.95);
      padding: clamp(12px, 2vh, 20px);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin: var(--space-md) auto;
      max-width: 90%;
      backdrop-filter: blur(8px);
      border: 2px solid rgba(255, 255, 255, 0.8);
    }

    .mrt-progress-track {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      padding: 0 clamp(8px, 2vw, 16px);
    }

    .mrt-progress-track::before {
      content: '';
      position: absolute;
      left: calc(var(--station-size-sm) / 2 + clamp(8px, 2vw, 16px));
      right: calc(var(--station-size-sm) / 2 + clamp(8px, 2vw, 16px));
      top: 50%;
      height: var(--line-width-thin);
      background: #E0E0E0;
      transform: translateY(-50%);
      z-index: 0;
      border-radius: var(--radius-full);
    }

    .mrt-progress-fill {
      position: absolute;
      left: calc(var(--station-size-sm) / 2 + clamp(8px, 2vw, 16px));
      top: 50%;
      height: var(--line-width-thin);
      background: currentColor;
      transform: translateY(-50%);
      transition: width 0.5s var(--ease-out-soft);
      z-index: 1;
      border-radius: var(--radius-full);
      box-shadow: 0 0 8px currentColor;
    }

    .mrt-progress-stop {
      position: relative;
      z-index: 2;
      width: var(--station-size-sm);
      height: var(--station-size-sm);
      border-radius: 50%;
      background: white;
      border: 3px solid #E0E0E0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(0.6rem, 1.5vh, 0.75rem);
      font-weight: 700;
      color: #9E9E9E;
      transition: all 0.3s var(--ease-out-soft);
      flex-shrink: 0;
    }

    .mrt-progress-stop.completed {
      border-color: currentColor;
      background: currentColor;
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .mrt-progress-stop.current {
      border-color: currentColor;
      border-width: 4px;
      transform: scale(1.3);
      background: white;
      color: currentColor;
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.9), 0 0 12px currentColor, 0 2px 8px rgba(0, 0, 0, 0.2);
      animation: pulse-stop 2s ease-in-out infinite;
    }

    @keyframes pulse-stop {
      0%, 100% { box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.9), 0 0 12px currentColor, 0 2px 8px rgba(0, 0, 0, 0.2); }
      50% { box-shadow: 0 0 0 6px rgba(255, 255, 255, 0.9), 0 0 18px currentColor, 0 2px 12px rgba(0, 0, 0, 0.25); }
    }

    .mrt-progress-stop::after {
      content: attr(data-label);
      position: absolute;
      top: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      font-size: clamp(0.55rem, 1.3vh, 0.65rem);
      font-weight: 600;
      color: #546E7A;
      white-space: nowrap;
      opacity: 0;
      transition: opacity 0.2s ease;
      font-family: var(--transit-font);
      letter-spacing: 0.02em;
    }

    .mrt-progress-stop.current::after,
    .mrt-progress-stop:hover::after {
      opacity: 1;
    }

    .mrt-progress-bar.line-red { color: var(--taipei-red); }
    .mrt-progress-bar.line-blue { color: var(--taipei-blue); }
    .mrt-progress-bar.line-green { color: var(--taipei-green); }
    .mrt-progress-bar.line-orange { color: var(--taipei-orange); }
    .mrt-progress-bar.line-brown { color: var(--taipei-brown); }
    .mrt-progress-bar.line-yellow { color: var(--taipei-yellow); }

    .mrt-progress-info {
      text-align: center;
      margin-top: clamp(20px, 3vh, 28px);
      font-family: var(--transit-font);
      font-size: clamp(0.75rem, 1.7vh, 0.9rem);
      font-weight: 600;
      color: #37474F;
      letter-spacing: 0.03em;
    }

    .mrt-progress-station-name {
      display: block;
      font-size: clamp(0.85rem, 2vh, 1.05rem);
      font-weight: 700;
      color: currentColor;
      margin-top: 4px;
    }

    /* Mobile-First: Simple Counter Display */
    .mrt-progress-mobile {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }

    .mrt-progress-counter {
      font-family: 'Fredoka', 'Comic Sans MS', cursive;
      font-size: clamp(1.75rem, 5vw, 2.25rem);
      font-weight: 700;
      color: currentColor;
      text-align: center;
      line-height: 1.2;
      letter-spacing: -0.02em;
      animation: bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes bounce-in {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.95); }
      100% { transform: scale(1); opacity: 1; }
    }

    .mrt-progress-counter-current {
      font-size: clamp(2.5rem, 8vw, 3.5rem);
      display: inline-block;
      background: currentColor;
      color: white;
      width: clamp(60px, 15vw, 80px);
      height: clamp(60px, 15vw, 80px);
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 20px currentColor, 0 0 0 6px rgba(255, 255, 255, 0.95);
      animation: pulse-current 2s ease-in-out infinite;
      margin: 0 8px;
    }

    @keyframes pulse-current {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 6px 20px currentColor, 0 0 0 6px rgba(255, 255, 255, 0.95);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 8px 28px currentColor, 0 0 0 8px rgba(255, 255, 255, 0.95);
      }
    }

    .mrt-progress-counter-total {
      opacity: 0.6;
      font-size: clamp(1.5rem, 5vw, 2rem);
    }

    .mrt-progress-simple-bar {
      width: 100%;
      height: 12px;
      background: #E8EAF6;
      border-radius: 100px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .mrt-progress-simple-fill {
      height: 100%;
      background: currentColor;
      border-radius: 100px;
      transition: width 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: 0 2px 8px currentColor;
      position: relative;
      overflow: hidden;
    }

    .mrt-progress-simple-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.3) 50%,
        transparent 100%
      );
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .mrt-progress-label {
      text-align: center;
      font-family: 'Fredoka', 'Comic Sans MS', cursive;
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
      font-weight: 600;
      color: #37474F;
      margin-top: 8px;
      letter-spacing: 0.02em;
    }

    /* Desktop: Full Dot View (hidden on mobile) */
    .mrt-progress-desktop {
      display: none;
    }

    /* Tablet and Desktop: Show full dot view */
    @media (min-width: 640px) {
      .mrt-progress-mobile {
        display: none;
      }

      .mrt-progress-desktop {
        display: block;
      }
    }

    /* ===== METRO MAP RESPONSIVE DESIGN ===== */
    /* Mobile-first design - already optimized for mobile! */

    @media (max-width: 480px) {
      .mrt-map {
        padding: 1.25rem 0.875rem;
      }

      .station-btn {
        min-height: 70px;
        padding: 14px 16px 14px 80px;
        margin-bottom: 20px;
        border-radius: 16px;
      }

      .station-btn::before {
        left: 24px;
        width: 24px;
        height: 24px;
        border-width: 5px;
      }

      .station-btn::after {
        left: 33px;
        width: 6px;
        height: 20px;
      }

      .station-icon,
      .station-icon-img {
        left: 74px;
        width: 48px;
        height: 48px;
        font-size: 2rem;
      }

      .station-name {
        font-size: 1rem;
        margin-bottom: 4px;
      }

      .station-desc {
        font-size: 0.8rem;
        gap: 5px;
      }

      .station-status {
        font-size: 0.8rem;
        padding: 6px 14px;
      }

      .station-level {
        font-size: 0.65rem;
        padding: 3px 8px;
      }

      /* Transfer station double rings for smaller screens */
      #station-drink::before {
        box-shadow:
          0 0 0 3px white,
          0 0 0 6px var(--taipei-blue),
          0 2px 8px rgba(0, 0, 0, 0.12);
      }

      #station-icecream::before {
        box-shadow:
          0 0 0 3px white,
          0 0 0 6px var(--taipei-green),
          0 2px 8px rgba(0, 0, 0, 0.12);
      }

      #station-fishshop::before {
        box-shadow:
          0 0 0 3px white,
          0 0 0 6px var(--taipei-orange),
          0 2px 8px rgba(0, 0, 0, 0.12);
      }
    }

    /* Larger screens - more spacious layout */
    @media (min-width: 768px) {
      .mrt-map {
        padding: 2.5rem 2rem;
      }

      .station-btn {
        min-height: 90px;
        padding: 22px 24px 22px 100px;
        margin-bottom: 28px;
        max-width: 600px;
      }

      .station-btn::before {
        left: 30px;
        width: 32px;
        height: 32px;
        border-width: 7px;
      }

      .station-btn::after {
        left: 41px;
        width: 10px;
        height: 28px;
      }

      .station-icon,
      .station-icon-img {
        left: 94px;
        width: 64px;
        height: 64px;
        font-size: 3rem;
      }

      .station-name {
        font-size: 1.25rem;
        margin-bottom: 8px;
      }

      .station-desc {
        font-size: 0.9rem;
        gap: 8px;
      }

      .station-status {
        font-size: 0.9rem;
        padding: 10px 18px;
      }

      .station-level {
        font-size: 0.75rem;
        padding: 5px 12px;
      }
    }

    /* Scrollable MRT map - scrolling already handled above */

    /* ===== MAGICAL TRAIN WINDOW EXPERIENCE ===== */
    @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

    .mrt-ride-screen {
      background: #1a1a2e;
      overflow: hidden;
      position: absolute;
      inset: 0;
      display: block;
    }

    /* === TRAIN WINDOW FRAME === */
    .train-window-frame {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 100;
    }

    /* Rounded window corners with thick wooden frame */
    .train-window-frame::before {
      content: '';
      position: absolute;
      inset: 0;
      border: clamp(16px, 4vw, 28px) solid;
      border-image: linear-gradient(180deg,
        #8B7355 0%,
        #6B5344 20%,
        #4A3728 50%,
        #6B5344 80%,
        #8B7355 100%
      ) 1;
      border-radius: 24px;
      box-shadow:
        inset 0 0 30px rgba(0,0,0,0.5),
        inset 0 0 60px rgba(0,0,0,0.3),
        0 0 20px rgba(0,0,0,0.8);
    }

    /* Glass reflection effect */
    .train-window-frame::after {
      content: none;
    }

    /* Corner rivets on the window frame */
    .window-rivet {
      position: absolute;
      width: 12px;
      height: 12px;
      background: radial-gradient(circle at 30% 30%, #C0C0C0, #606060);
      border-radius: 50%;
      box-shadow: inset 0 -2px 4px rgba(0,0,0,0.5);
    }
    .window-rivet.top-left { top: 6px; left: 6px; }
    .window-rivet.top-right { top: 6px; right: 6px; }
    .window-rivet.bottom-left { bottom: 6px; left: 6px; }
    .window-rivet.bottom-right { bottom: 6px; right: 6px; }

    /* === SCENERY CONTAINER === */
    .scenery-container {
      position: absolute;
      inset: clamp(16px, 4vw, 28px);
      overflow: hidden;
      border-radius: 12px;
      background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%);
      background-size: cover;
      background-position: center;
      background-repeat: repeat-x;
    }

    /* === TAIPEI SCENERY BACKGROUNDS === */
    /* Each station shows a different iconic Taipei scene */

    /* Fruit Stand - Taipei 101 Skyline */
    .theme-fruit .scenery-container {
      background-image: url('assets/taipei_101_skyline.svg');
    }

    /* Drink Bar - Riverside Park with Bikes */
    .theme-drink .scenery-container {
      background-image: url('assets/taipei_riverside.svg');
    }

    /* Bakery - Traditional Temple */
    .theme-bakery .scenery-container {
      background-image: url('assets/taipei_temple.svg');
    }

    /* Pizza - Night Market Scene */
    .theme-pizza .scenery-container {
      background-image: url('assets/taipei_night_market.svg');
    }

    /* Ice Cream - Mountain Backdrop (Yangmingshan) */
    .theme-icecream .scenery-container {
      background-image: url('assets/taipei_mountain.svg');
    }

    /* Fish Shop - Modern MRT Elevated Tracks */
    .theme-fishshop .scenery-container {
      background-image: url('assets/taipei_mrt_elevated.svg');
    }

    /* Cheese Shop - Taipei 101 Skyline (alternate) */
    .theme-cheese .scenery-container {
      background-image: url('assets/taipei_101_skyline.svg');
    }

    /* Noodle House - Night Market */
    .theme-noodle .scenery-container {
      background-image: url('assets/taipei_night_market.svg');
    }

    /* Hide old parallax layers when using Taipei backgrounds */
    .theme-fruit .sky-layer,
    .theme-drink .sky-layer,
    .theme-bakery .sky-layer,
    .theme-pizza .sky-layer,
    .theme-icecream .sky-layer,
    .theme-fishshop .sky-layer,
    .theme-cheese .sky-layer,
    .theme-noodle .sky-layer {
      background: transparent;
    }

    .theme-fruit .mountains-layer,
    .theme-drink .mountains-layer,
    .theme-bakery .mountains-layer,
    .theme-pizza .mountains-layer,
    .theme-icecream .mountains-layer,
    .theme-fishshop .mountains-layer,
    .theme-cheese .mountains-layer,
    .theme-noodle .mountains-layer,
    .theme-fruit .hills-layer,
    .theme-drink .hills-layer,
    .theme-bakery .hills-layer,
    .theme-pizza .hills-layer,
    .theme-icecream .hills-layer,
    .theme-fishshop .hills-layer,
    .theme-cheese .hills-layer,
    .theme-noodle .hills-layer,
    .theme-fruit .trees-layer,
    .theme-drink .trees-layer,
    .theme-bakery .trees-layer,
    .theme-pizza .trees-layer,
    .theme-icecream .trees-layer,
    .theme-fishshop .trees-layer,
    .theme-cheese .trees-layer,
    .theme-noodle .trees-layer {
      display: none;
    }

    /* === SKY LAYER (furthest back) === */
    .sky-layer {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg,
        #87CEEB 0%,
        #87CEEB 40%,
        #B0E0E6 60%,
        #E0F6FF 80%,
        #F0F8FF 100%
      );
      transition: background 1s ease;
    }

    /* Sun/Moon */
    .celestial-body {
      position: absolute;
      top: 10%;
      right: 15%;
      width: clamp(40px, 8vw, 60px);
      height: clamp(40px, 8vw, 60px);
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #FFF8DC, #FFD700);
      box-shadow:
        0 0 40px rgba(255, 215, 0, 0.6),
        0 0 80px rgba(255, 215, 0, 0.3);
      animation: sun-glow 4s ease-in-out infinite;
    }

    @keyframes sun-glow {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.05); opacity: 1; }
    }

    /* === DISTANT MOUNTAINS (parallax layer 1 - slowest) === */
	    .mountains-layer {
      position: absolute;
      bottom: 35%;
      left: 0;
      width: 400%;
      height: 30%;
	      animation: parallax-distant 10s linear infinite;
	    }

    .mountain {
      position: absolute;
      bottom: 0;
      width: 0;
      height: 0;
      border-style: solid;
    }

    .mountain-1 { left: 5%; border-width: 0 60px 100px 60px; border-color: transparent transparent #7B8B6F transparent; }
    .mountain-2 { left: 15%; border-width: 0 80px 140px 80px; border-color: transparent transparent #6B7B5F transparent; }
    .mountain-3 { left: 30%; border-width: 0 50px 80px 50px; border-color: transparent transparent #8B9B7F transparent; }
    .mountain-4 { left: 40%; border-width: 0 90px 160px 90px; border-color: transparent transparent #5B6B4F transparent; }
    .mountain-5 { left: 55%; border-width: 0 70px 120px 70px; border-color: transparent transparent #7B8B6F transparent; }
    .mountain-6 { left: 70%; border-width: 0 55px 90px 55px; border-color: transparent transparent #6B7B5F transparent; }
    .mountain-7 { left: 85%; border-width: 0 85px 150px 85px; border-color: transparent transparent #5B6B4F transparent; }

    /* Snow caps */
    .mountain::before {
      content: '';
      position: absolute;
      top: -100%;
      left: 50%;
      transform: translateX(-50%);
      border-style: solid;
      border-width: 0 20px 35px 20px;
      border-color: transparent transparent rgba(255,255,255,0.8) transparent;
    }

    @keyframes parallax-distant {
      0% { transform: translateX(0); }
      100% { transform: translateX(-25%); }
    }

    /* === ROLLING HILLS (parallax layer 2) === */
	    .hills-layer {
      position: absolute;
      bottom: 22%;
      left: 0;
      width: 300%;
      height: 25%;
	      animation: parallax-mid 7s linear infinite;
	    }

    .hill {
      position: absolute;
      bottom: 0;
      border-radius: 50% 50% 0 0;
    }

    .hill-1 { left: 0%; width: 180px; height: 80px; background: linear-gradient(180deg, #7CB342 0%, #558B2F 100%); }
    .hill-2 { left: 12%; width: 220px; height: 100px; background: linear-gradient(180deg, #8BC34A 0%, #689F38 100%); }
    .hill-3 { left: 28%; width: 160px; height: 70px; background: linear-gradient(180deg, #9CCC65 0%, #7CB342 100%); }
    .hill-4 { left: 42%; width: 200px; height: 90px; background: linear-gradient(180deg, #7CB342 0%, #558B2F 100%); }
    .hill-5 { left: 58%; width: 180px; height: 75px; background: linear-gradient(180deg, #8BC34A 0%, #689F38 100%); }
    .hill-6 { left: 72%; width: 240px; height: 110px; background: linear-gradient(180deg, #7CB342 0%, #558B2F 100%); }
    .hill-7 { left: 88%; width: 170px; height: 85px; background: linear-gradient(180deg, #9CCC65 0%, #7CB342 100%); }

    @keyframes parallax-mid {
      0% { transform: translateX(0); }
      100% { transform: translateX(-33.33%); }
    }

	    /* === TREES AND OBJECTS (parallax layer 3 - fastest) === */
		    .trees-layer {
	      position: absolute;
	      bottom: 12%;
	      left: 0;
	      width: 200%;
	      height: 25%;
	      display: flex;
		      animation: parallax-near 3.5s linear infinite;
		      will-change: transform;
		      transform: translate3d(0, 0, 0);
		    }

	    .trees-strip {
	      position: relative;
	      flex: 0 0 50%;
	      height: 100%;
	    }

	    .tree {
	      position: absolute;
	      bottom: 0;
	    }

    /* Tree trunk */
    .tree::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 30px;
      background: linear-gradient(90deg, #5D4037, #8D6E63, #5D4037);
      border-radius: 2px;
    }

    /* Tree foliage */
    .tree::after {
      content: '';
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 0 25px 50px 25px;
      border-color: transparent transparent #2E7D32 transparent;
      filter: drop-shadow(0 4px 2px rgba(0,0,0,0.2));
    }

    .tree-1 { left: 3%; }
    .tree-2 { left: 8%; transform: scale(0.8); }
    .tree-3 { left: 15%; transform: scale(1.1); }
    .tree-4 { left: 22%; transform: scale(0.9); }
    .tree-5 { left: 28%; }
    .tree-6 { left: 35%; transform: scale(0.85); }
    .tree-7 { left: 42%; transform: scale(1.05); }
    .tree-8 { left: 50%; transform: scale(0.95); }
    .tree-9 { left: 58%; }
    .tree-10 { left: 65%; transform: scale(0.8); }
    .tree-11 { left: 73%; transform: scale(1.1); }
    .tree-12 { left: 80%; transform: scale(0.9); }
    .tree-13 { left: 88%; }
    .tree-14 { left: 95%; transform: scale(0.85); }

	    @keyframes parallax-near {
	      0% { transform: translate3d(0, 0, 0); }
	      100% { transform: translate3d(-50%, 0, 0); }
	    }

    /* === GROUND/GRASS LAYER === */
    .ground-layer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 15%;
      background: linear-gradient(180deg,
        #558B2F 0%,
        #33691E 40%,
        #2E5016 100%
      );
    }

    /* Grass texture */
    .ground-layer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 8px;
      background: repeating-linear-gradient(90deg,
        #7CB342 0px, #7CB342 3px,
        #8BC34A 3px, #8BC34A 6px,
        #689F38 6px, #689F38 9px
      );
    }

    /* === TRAIN TRACKS === */
	    .train-track {
      position: absolute;
      bottom: 8%;
      left: 0;
      width: 400%;
      height: 20px;
      background: linear-gradient(180deg,
        #4A3728 0%,
        #6B5344 50%,
        #4A3728 100%
      );
	      animation: track-scroll 0.55s linear infinite;
	    }

    /* Rails */
    .train-track::before,
    .train-track::after {
      content: '';
      position: absolute;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg,
        #C0C0C0 0%, #E8E8E8 50%, #C0C0C0 100%
      );
    }
    .train-track::before { top: 2px; }
    .train-track::after { bottom: 2px; }

    /* Railroad ties */
	    .track-ties {
      position: absolute;
      bottom: 8%;
      left: 0;
      width: 400%;
      height: 20px;
      background: repeating-linear-gradient(90deg,
        transparent 0px,
        transparent 20px,
        #3E2723 20px,
        #3E2723 28px
      );
	      animation: track-scroll 0.55s linear infinite;
	    }

    @keyframes track-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-28px); }
    }

    /* === TAIWAN MRT TRAIN === */
	    .mrt-train {
      --mrt-stripe-color: #E3002C; /* Default: Red Line (Tamsui-Xinyi), changes per station */
      position: absolute;
	      bottom: 16%; /* Aligned with track position */
	      left: 0;
	      display: flex;
	      align-items: flex-end;
	      z-index: 50; /* Above scenery, below window frame */
	      /* Train glides along the track (left to right) */
	      animation: mrt-glide 7.5s linear infinite;
	      will-change: transform;
	    }

	    @keyframes mrt-glide {
	      0% { transform: translateX(-85%); }
	      100% { transform: translateX(120vw); }
	    }

    /* Subtle vertical sway for realism - like real train motion */
	    .mrt-car {
	      position: relative;
	      animation: mrt-sway 0.8s ease-in-out infinite;
	    }

	    @keyframes mrt-sway {
	      0%, 100% { transform: translateY(0); }
	      50% { transform: translateY(-1.5px); }
	    }

    /* Wheel rotation synced with fast movement */
	    .mrt-train .mrt-wheel { animation: wheel-spin 0.25s linear infinite; }

    /* Front car with driver's cab */
    .mrt-front {
      width: clamp(100px, 25vw, 140px);
      height: clamp(50px, 12vw, 70px);
    }

    .mrt-front .mrt-body {
      position: absolute;
      inset: 0;
      /* Silver metallic body */
      background: linear-gradient(180deg,
        #F5F5F5 0%,
        #E8E8E8 15%,
        #D0D0D0 50%,
        #B8B8B8 85%,
        #A0A0A0 100%
      );
      border-radius: 14px 8px 8px 14px;
      box-shadow:
        0 4px 12px rgba(0,0,0,0.3),
        inset 0 2px 4px rgba(255,255,255,0.8),
        inset 0 -2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    /* Aerodynamic front nose */
    .mrt-front .mrt-body::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 10%;
      width: 10px;
      height: 80%;
      background: linear-gradient(180deg,
        #F0F0F0 0%,
        #D8D8D8 50%,
        #C0C0C0 100%
      );
      border-radius: 8px 0 0 8px;
      box-shadow: inset 2px 0 4px rgba(255,255,255,0.5);
    }

    /* Front destination display (Taiwan MRT-style) */
    .mrt-front-display {
      position: absolute;
      top: 10%;
      left: 38px;
      width: 34px;
      height: 14px;
      background: linear-gradient(180deg, #0a0a14 0%, #1a1a2e 60%, #0a0a14 100%);
      border-radius: 3px;
      box-shadow:
        inset 0 0 10px rgba(74, 222, 128, 0.15),
        0 2px 4px rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
    }

    .mrt-front-display::after {
      content: 'MRT';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'VT323', monospace;
      font-size: 0.95rem;
      color: #4ADE80;
      letter-spacing: 1px;
      text-shadow: 0 0 10px rgba(74, 222, 128, 0.7);
      opacity: 0.95;
    }

    /* Colored stripe (MRT line color) */
    .mrt-stripe {
      position: absolute;
      left: -15px;
      right: 0;
      top: 45%;
      height: 8px;
      background: var(--mrt-stripe-color);
      box-shadow:
        0 1px 2px rgba(0,0,0,0.2),
        inset 0 1px 1px rgba(255,255,255,0.3);
    }

    /* Front windshield */
    .mrt-windshield {
      position: absolute;
      left: 4px;
      top: 12%;
      width: 30px;
      height: 58%;
      background: linear-gradient(135deg,
        #1a1a2e 0%,
        #2d2d44 50%,
        #1a1a2e 100%
      );
      border-radius: 10px 4px 6px 10px;
      box-shadow:
        inset 0 0 10px rgba(100, 200, 255, 0.3),
        0 2px 4px rgba(0,0,0,0.3);
    }

    /* Windshield reflection */
    .mrt-windshield::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 40%;
      height: 50%;
      background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 100%);
      border-radius: 4px;
    }

    /* Headlights */
    .mrt-headlight {
      position: absolute;
      width: 6px;
      height: 6px;
      background: radial-gradient(circle, #FFE082 0%, #FFC107 100%);
      border-radius: 50%;
      box-shadow: 0 0 8px #FFC107, 0 0 16px rgba(255,193,7,0.5);
      left: -12px;
    }
    .mrt-headlight-l { top: 55%; }
    .mrt-headlight-r { top: 70%; }

    /* Passenger windows container */
    .mrt-windows {
      position: absolute;
      top: 12%;
      right: 8px;
      left: 25px;
      display: flex;
      gap: 4px;
      height: 35%;
    }

    .mrt-window {
      flex: 1;
      position: relative;
      background: linear-gradient(180deg,
        #87CEEB 0%,
        #B0E0E6 30%,
        #E0F7FA 100%
      );
      border-radius: 3px;
      box-shadow:
        inset 0 0 6px rgba(255,255,255,0.6),
        inset 0 2px 4px rgba(135,206,235,0.3),
        0 1px 2px rgba(0,0,0,0.2);
      border: 1px solid #A0A0A0;
    }

    /* Window shine effect */
    .mrt-window::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 30%;
      height: 40%;
      background: linear-gradient(135deg, rgba(255,255,255,0.6) 0%, transparent 100%);
      border-radius: 2px;
    }

    /* Door */
    .mrt-door {
      position: absolute;
      bottom: 5px;
      right: 20%;
      width: 18%;
      height: 55%;
      background: linear-gradient(90deg,
        #C8C8C8 0%,
        #E0E0E0 50%,
        #C8C8C8 100%
      );
      border-radius: 2px 2px 0 0;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.2);
    }

    /* Door window */
    .mrt-door::before {
      content: '';
      position: absolute;
      top: 8%;
      left: 15%;
      width: 70%;
      height: 40%;
      background: linear-gradient(180deg, #87CEEB 0%, #B0E0E6 100%);
      border-radius: 2px;
      box-shadow: inset 0 0 4px rgba(255,255,255,0.5);
    }

    /* Undercarriage */
    .mrt-undercarriage {
      position: absolute;
      bottom: -8px;
      left: 10%;
      right: 10%;
      height: 10px;
      background: linear-gradient(180deg, #3a3a3a 0%, #1a1a1a 100%);
      border-radius: 2px;
      display: flex;
      justify-content: space-between;
      padding: 0 10%;
    }

    .mrt-wheel {
      width: 14px;
      height: 14px;
      background: radial-gradient(circle at 30% 30%, #666 0%, #222 100%);
      border-radius: 50%;
      border: 2px solid #444;
      position: relative;
      top: 2px;
      animation: wheel-spin 0.3s linear infinite;
    }

    .mrt-wheel::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 6px;
      height: 6px;
      background: #888;
      border-radius: 50%;
    }

    @keyframes wheel-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Middle car */
	    .mrt-middle {
	      width: clamp(90px, 22vw, 130px);
	      height: clamp(50px, 12vw, 70px);
	    }

    .mrt-middle .mrt-body {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg,
        #F5F5F5 0%,
        #E8E8E8 15%,
        #D0D0D0 50%,
        #B8B8B8 85%,
        #A0A0A0 100%
      );
      border-radius: 4px;
      box-shadow:
        0 4px 12px rgba(0,0,0,0.3),
        inset 0 2px 4px rgba(255,255,255,0.8),
        inset 0 -2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .mrt-middle .mrt-windows {
      left: 8px;
      right: 8px;
    }

    .mrt-middle .mrt-door-1 {
      left: 15%;
      right: auto;
    }

    .mrt-middle .mrt-door-2 {
      right: 15%;
    }

	    /* Connector between cars */
	    .mrt-connector {
	      width: 10px;
	      height: 34px;
	      margin: 0 -2px;
	      transform: translateY(-14px);
	      background: linear-gradient(90deg, #2a2a2a 0%, #4a4a4a 50%, #2a2a2a 100%);
	      border-radius: 3px;
	      box-shadow:
	        inset 0 0 4px rgba(0,0,0,0.5),
	        0 2px 4px rgba(0,0,0,0.25);
	      align-self: flex-end;
	    }

	    /* Rear car (same as middle, rounded back) */
	    .mrt-rear {
	      width: clamp(90px, 22vw, 130px);
	      height: clamp(50px, 12vw, 70px);
	    }

	    .mrt-rear .mrt-body {
	      position: absolute;
	      inset: 0;
	      background: linear-gradient(180deg,
	        #F5F5F5 0%,
	        #E8E8E8 15%,
	        #D0D0D0 50%,
	        #B8B8B8 85%,
	        #A0A0A0 100%
	      );
	      border-radius: 8px 14px 14px 8px;
	      box-shadow:
	        0 4px 12px rgba(0,0,0,0.3),
	        inset 0 2px 4px rgba(255,255,255,0.8),
	        inset 0 -2px 4px rgba(0,0,0,0.1);
	      overflow: hidden;
	    }

	    .mrt-rear .mrt-windows { left: 8px; right: 8px; }
	    .mrt-rear .mrt-door-1 { left: 15%; right: auto; }
	    .mrt-rear .mrt-door-2 { right: 15%; }

    /* Station-themed stripe colors - Taipei MRT Lines */
    /* Level 1 stations: Red Line (Tamsui-Xinyi) */
    .theme-fruit .mrt-train { --mrt-stripe-color: #E3002C; } /* Red Line */
    .theme-drink .mrt-train { --mrt-stripe-color: #E3002C; } /* Red Line */
    .theme-bakery .mrt-train { --mrt-stripe-color: #E3002C; } /* Red Line */
    /* Level 2 stations: Blue Line (Bannan) */
    .theme-pizza .mrt-train { --mrt-stripe-color: #0070BD; } /* Blue Line */
    .theme-icecream .mrt-train { --mrt-stripe-color: #0070BD; } /* Blue Line */
    /* Level 3 stations: Green Line (Songshan-Xindian) */
    .theme-fishshop .mrt-train { --mrt-stripe-color: #008659; } /* Green Line */
    /* Level 4 stations: Orange Line (Zhonghe-Xinlu) */
    .theme-cheese .mrt-train { --mrt-stripe-color: #F8B61C; } /* Orange Line */
    .theme-noodle .mrt-train { --mrt-stripe-color: #F8B61C; } /* Orange Line */

    /* === FLOATING CLOUDS === */
	    .cloud-layer {
      position: absolute;
      top: 5%;
      left: 0;
      width: 300%;
      height: 30%;
	      animation: clouds-drift 8s linear infinite;
	      pointer-events: none;
	    }

    .cloud {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50px;
      filter: blur(1px);
    }

    .cloud::before,
    .cloud::after {
      content: '';
      position: absolute;
      background: inherit;
      border-radius: 50%;
    }

    .cloud-1 { width: 70px; height: 25px; top: 20%; left: 8%; }
    .cloud-1::before { width: 35px; height: 35px; top: -18px; left: 10px; }
    .cloud-1::after { width: 45px; height: 45px; top: -22px; left: 28px; }

    .cloud-2 { width: 90px; height: 30px; top: 10%; left: 35%; }
    .cloud-2::before { width: 45px; height: 45px; top: -22px; left: 12px; }
    .cloud-2::after { width: 55px; height: 55px; top: -28px; left: 35px; }

    .cloud-3 { width: 60px; height: 22px; top: 30%; left: 65%; }
    .cloud-3::before { width: 30px; height: 30px; top: -15px; left: 8px; }
    .cloud-3::after { width: 40px; height: 40px; top: -20px; left: 22px; }

    @keyframes clouds-drift {
      0% { transform: translateX(0); }
      100% { transform: translateX(-33.33%); }
    }

    /* === ANIMATED TAIPEI ELEMENTS === */
    /* Birds flying across the sky */
    .taipei-bird {
      position: absolute;
      font-size: 20px;
      animation: bird-fly 15s linear infinite;
      z-index: 5;
    }

    .taipei-bird-1 {
      top: 15%;
      left: -50px;
      animation-delay: 0s;
    }

    .taipei-bird-2 {
      top: 25%;
      left: -50px;
      animation-delay: 5s;
      font-size: 16px;
    }

    .taipei-bird-3 {
      top: 20%;
      left: -50px;
      animation-delay: 10s;
      font-size: 18px;
    }

    @keyframes bird-fly {
      0% {
        transform: translateX(0) translateY(0);
      }
      25% {
        transform: translateX(30vw) translateY(-10px);
      }
      50% {
        transform: translateX(60vw) translateY(0);
      }
      75% {
        transform: translateX(90vw) translateY(-5px);
      }
      100% {
        transform: translateX(120vw) translateY(0);
      }
    }

    /* Hot air balloon floating */
    .taipei-balloon {
      position: absolute;
      font-size: 40px;
      animation: balloon-float 20s ease-in-out infinite;
      z-index: 4;
      top: 10%;
      left: 80%;
    }

    @keyframes balloon-float {
      0%, 100% {
        transform: translateX(0) translateY(0);
      }
      25% {
        transform: translateX(-20px) translateY(-15px);
      }
      50% {
        transform: translateX(-10px) translateY(-25px);
      }
      75% {
        transform: translateX(-30px) translateY(-10px);
      }
    }

    /* Another MRT train passing in the distance (for elevated track scene) */
    .taipei-distant-train {
      position: absolute;
      top: 35%;
      left: -100px;
      width: 60px;
      height: 20px;
      background: linear-gradient(90deg, #0070BD 0%, #0090DD 100%);
      border-radius: 4px 8px 8px 4px;
      animation: distant-train-pass 12s linear infinite;
      z-index: 3;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    @keyframes distant-train-pass {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(calc(100vw + 200px));
      }
    }

    /* Lanterns swaying in night market scene */
    .taipei-lantern {
      position: absolute;
      font-size: 24px;
      animation: lantern-sway 3s ease-in-out infinite;
      z-index: 10;
    }

    .taipei-lantern-1 {
      top: 10%;
      left: 20%;
      animation-delay: 0s;
    }

    .taipei-lantern-2 {
      top: 12%;
      left: 50%;
      animation-delay: 1s;
    }

    .taipei-lantern-3 {
      top: 8%;
      left: 75%;
      animation-delay: 2s;
    }

    @keyframes lantern-sway {
      0%, 100% {
        transform: translateX(0) rotate(0deg);
      }
      25% {
        transform: translateX(-5px) rotate(-3deg);
      }
      50% {
        transform: translateX(0) rotate(0deg);
      }
      75% {
        transform: translateX(5px) rotate(3deg);
      }
    }

    /* Show/hide elements based on theme */
    .taipei-bird,
    .taipei-balloon,
    .taipei-distant-train,
    .taipei-lantern {
      display: none;
    }

    /* Birds for mountain, riverside, and skyline scenes */
    .theme-icecream .taipei-bird,
    .theme-drink .taipei-bird,
    .theme-fruit .taipei-bird {
      display: block;
    }

    /* Balloon for mountain scene */
    .theme-icecream .taipei-balloon {
      display: block;
    }

    /* Distant train for MRT elevated scene */
    .theme-fishshop .taipei-distant-train {
      display: block;
    }

    /* Lanterns for night market scenes */
    .theme-pizza .taipei-lantern,
    .theme-noodle .taipei-lantern {
      display: block;
    }

    /* === LED DESTINATION DISPLAY === */
    .destination-display {
      position: absolute;
      top: clamp(24px, 6vw, 40px);
      left: 50%;
      transform: translateX(-50%);
      z-index: 50;
      background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
      border: 3px solid #333;
      border-radius: 8px;
      padding: clamp(8px, 2vw, 14px) clamp(16px, 4vw, 28px);
      box-shadow:
        0 4px 20px rgba(0,0,0,0.8),
        inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .destination-display::before {
      content: '';
      position: absolute;
      top: 4px;
      left: 4px;
      right: 4px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    }

    .display-label {
      font-family: 'VT323', monospace;
      font-size: clamp(0.7rem, 2vw, 0.9rem);
      color: #FFB300;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-align: center;
      margin-bottom: 4px;
      text-shadow: 0 0 10px rgba(255, 179, 0, 0.5);
    }

    .display-destination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(8px, 2vw, 12px);
    }

    .display-icon {
      font-size: clamp(1.5rem, 4vw, 2rem);
      filter: drop-shadow(0 0 8px rgba(255,255,255,0.3));
      animation: icon-pulse 2s ease-in-out infinite;
    }

    @keyframes icon-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .display-name {
      font-family: 'VT323', monospace;
      font-size: clamp(1.2rem, 3.5vw, 1.8rem);
      color: #4ADE80;
      text-shadow:
        0 0 10px rgba(74, 222, 128, 0.8),
        0 0 20px rgba(74, 222, 128, 0.4);
      letter-spacing: 1px;
    }

    /* LED dots effect */
	    .display-name::before {
	      content: '';
	      color: #4ADE80;
	      animation: blink-arrow 1s step-end infinite;
	    }

    @keyframes blink-arrow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* === THEMED FLOATING ELEMENTS === */
    .themed-floaters {
      position: absolute;
      top: 15%;
      left: 0;
      width: 100%;
      height: 40%;
      pointer-events: none;
      overflow: hidden;
      z-index: 30;
    }

    .floater {
      position: absolute;
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      opacity: 0.9;
      animation: floater-drift 4s ease-in-out infinite;
      filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
    }

    .floater:nth-child(1) { top: 5%; animation-delay: 0s; left: 110%; }
    .floater:nth-child(2) { top: 35%; animation-delay: -1s; left: 110%; font-size: clamp(1.2rem, 3vw, 1.8rem); }
    .floater:nth-child(3) { top: 20%; animation-delay: -2s; left: 110%; font-size: clamp(1.8rem, 5vw, 2.8rem); }
    .floater:nth-child(4) { top: 50%; animation-delay: -0.5s; left: 110%; font-size: clamp(1.4rem, 3.5vw, 2rem); }
    .floater:nth-child(5) { top: 10%; animation-delay: -1.5s; left: 110%; font-size: clamp(1.3rem, 3vw, 1.6rem); }

    @keyframes floater-drift {
      0% {
        transform: translateX(0) translateY(0) rotate(0deg);
      }
      25% {
        transform: translateX(-30vw) translateY(-10px) rotate(5deg);
      }
      50% {
        transform: translateX(-60vw) translateY(5px) rotate(-3deg);
      }
      75% {
        transform: translateX(-90vw) translateY(-5px) rotate(3deg);
      }
      100% {
        transform: translateX(-120vw) translateY(0) rotate(0deg);
      }
    }

    /* === MAGICAL SPARKLES === */
    .sparkle-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 25;
      overflow: hidden;
    }

    .sparkle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: radial-gradient(circle, #FFF 0%, #FFE66D 50%, transparent 70%);
      border-radius: 50%;
      animation: sparkle-twinkle 1.5s ease-in-out infinite, sparkle-float 4s ease-in-out infinite;
      box-shadow: 0 0 10px 2px rgba(255, 230, 109, 0.6);
    }

    .sparkle-1 { top: 15%; left: 10%; animation-delay: 0s; }
    .sparkle-2 { top: 25%; left: 30%; animation-delay: 0.3s; width: 6px; height: 6px; }
    .sparkle-3 { top: 10%; left: 50%; animation-delay: 0.6s; }
    .sparkle-4 { top: 35%; left: 70%; animation-delay: 0.9s; width: 10px; height: 10px; }
    .sparkle-5 { top: 20%; left: 85%; animation-delay: 1.2s; width: 5px; height: 5px; }
    .sparkle-6 { top: 40%; left: 20%; animation-delay: 0.4s; }
    .sparkle-7 { top: 8%; left: 65%; animation-delay: 0.7s; width: 7px; height: 7px; }
    .sparkle-8 { top: 30%; left: 45%; animation-delay: 1.0s; }

    @keyframes sparkle-twinkle {
      0%, 100% { opacity: 0.3; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    @keyframes sparkle-float {
      0%, 100% { transform: translateY(0) translateX(0); }
      25% { transform: translateY(-10px) translateX(5px); }
      50% { transform: translateY(-5px) translateX(-5px); }
      75% { transform: translateY(-15px) translateX(3px); }
    }

    /* Gentle train wobble effect */
    .mrt-ride-screen.active .scenery-container {
      animation: train-wobble 2s ease-in-out infinite;
    }

    @keyframes train-wobble {
      0%, 100% { transform: translateY(0); }
      25% { transform: translateY(-2px); }
      50% { transform: translateY(1px); }
      75% { transform: translateY(-1px); }
    }

    /* === STATION THEME VARIATIONS === */

    /* Fruit Stand - Golden Orchard Sunset */
    .theme-fruit .sky-layer {
      background: linear-gradient(180deg,
        #FF6B35 0%, #FF8C42 20%, #FFD93D 45%,
        #C1E1C1 70%, #6BCB77 100%
      );
    }
    .theme-fruit .celestial-body {
      background: radial-gradient(circle at 30% 30%, #FFFACD, #FF8C00);
      box-shadow: 0 0 60px rgba(255, 140, 0, 0.6);
    }
    .theme-fruit .hill { background: linear-gradient(180deg, #6BCB77 0%, #4A9E5C 100%) !important; }
    .theme-fruit .tree::after { border-color: transparent transparent #FF6B35 transparent !important; }
    .theme-fruit .ground-layer { background: linear-gradient(180deg, #6BCB77 0%, #4A9E5C 100%); }

    /* Drink Bar - Crystal Blue Waterfall */
    .theme-drink .sky-layer {
      background: linear-gradient(180deg,
        #00B4D8 0%, #48CAE4 25%, #90E0EF 50%,
        #CAF0F8 75%, #ADE8F4 100%
      );
    }
    .theme-drink .celestial-body {
      background: radial-gradient(circle at 30% 30%, #FFFFFF, #B8E2F2);
      box-shadow: 0 0 50px rgba(144, 224, 239, 0.8);
    }
    .theme-drink .cloud { background: rgba(255, 255, 255, 0.95); }
    .theme-drink .mountain { border-bottom-color: #0077B6 !important; }
    .theme-drink .hill { background: linear-gradient(180deg, #48CAE4 0%, #0096C7 100%) !important; }
    .theme-drink .tree::after { border-color: transparent transparent #00B4D8 transparent !important; }
    .theme-drink .ground-layer { background: linear-gradient(180deg, #0077B6 0%, #023E8A 100%); }

    /* Bakery - Warm Cozy Village */
    .theme-bakery .sky-layer {
      background: linear-gradient(180deg,
        #FFAB76 0%, #FFD4A3 25%, #FFF1E6 50%,
        #E8D5C4 75%, #C9A87C 100%
      );
    }
    .theme-bakery .celestial-body {
      background: radial-gradient(circle at 30% 30%, #FFF8DC, #DEB887);
      box-shadow: 0 0 50px rgba(222, 184, 135, 0.6);
    }
    .theme-bakery .mountain { border-bottom-color: #A0785A !important; }
    .theme-bakery .hill { background: linear-gradient(180deg, #D4A574 0%, #B8860B 100%) !important; }
    .theme-bakery .tree::after { border-color: transparent transparent #8B4513 transparent !important; }
    .theme-bakery .ground-layer { background: linear-gradient(180deg, #C9A87C 0%, #8B7355 100%); }

    /* Pizza - Italian Tuscan Sunset */
    .theme-pizza .sky-layer {
      background: linear-gradient(180deg,
        #FF6B6B 0%, #FF8E72 25%, #FFC3A0 50%,
        #F0E68C 75%, #98D8AA 100%
      );
    }
    .theme-pizza .celestial-body {
      background: radial-gradient(circle at 30% 30%, #FFE4B5, #FF7F50);
      box-shadow: 0 0 60px rgba(255, 127, 80, 0.7);
    }
    .theme-pizza .mountain { border-bottom-color: #CD853F !important; }
    .theme-pizza .hill { background: linear-gradient(180deg, #9ACD32 0%, #6B8E23 100%) !important; }
    .theme-pizza .tree::after { border-color: transparent transparent #228B22 transparent !important; }
    .theme-pizza .ground-layer { background: linear-gradient(180deg, #6B8E23 0%, #556B2F 100%); }

    /* Ice Cream - Pastel Candy Dream */
    .theme-icecream .sky-layer {
      background: linear-gradient(180deg,
        #FFB5E8 0%, #DCD3FF 25%, #B5DEFF 45%,
        #D5FFD0 65%, #FFFFD1 85%, #FFD1DC 100%
      );
    }
    .theme-icecream .celestial-body {
      background: radial-gradient(circle at 30% 30%, #FFFFFF, #FFB5E8);
      box-shadow: 0 0 50px rgba(255, 181, 232, 0.8);
    }
    .theme-icecream .cloud { background: rgba(255, 255, 255, 1); }
    .theme-icecream .mountain { border-bottom-color: #DDA0DD !important; }
    .theme-icecream .mountain::before { border-bottom-color: #FFFFFF !important; }
    .theme-icecream .hill { background: linear-gradient(180deg, #98D8C8 0%, #7EC8B8 100%) !important; }
    .theme-icecream .tree::after { border-color: transparent transparent #FF69B4 transparent !important; }
    .theme-icecream .ground-layer { background: linear-gradient(180deg, #FFB5E8 0%, #FF69B4 100%); }

    /* Fish Shop - Deep Ocean Adventure */
    .theme-fishshop .sky-layer {
      background: linear-gradient(180deg,
        #0077B6 0%, #0096C7 20%, #00B4D8 40%,
        #48CAE4 60%, #90E0EF 80%, #00CED1 100%
      );
    }
    .theme-fishshop .celestial-body {
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.3), transparent);
      box-shadow: none;
      animation: none;
    }
    /* Bubbles instead of sun */
	    .theme-fishshop .celestial-body::after {
	      content: '';
	      font-size: 3rem;
	      position: absolute;
	      animation: bubble-rise 3s ease-in-out infinite;
	    }
    @keyframes bubble-rise {
      0%, 100% { transform: translateY(0); opacity: 0.7; }
      50% { transform: translateY(-15px); opacity: 1; }
    }
    .theme-fishshop .cloud { background: rgba(144, 224, 239, 0.4); }
    .theme-fishshop .mountain { border-bottom-color: #006994 !important; }
    .theme-fishshop .hill { background: linear-gradient(180deg, #20B2AA 0%, #008B8B 100%) !important; }
    .theme-fishshop .tree::after { border-color: transparent transparent #008080 transparent !important; }
    .theme-fishshop .ground-layer {
      background: linear-gradient(180deg, #20B2AA 0%, #006666 100%);
    }
    /* Seaweed effect */
	    .theme-fishshop .ground-layer::after {
	      content: '';
	      position: absolute;
	      top: -20px;
	      left: 0;
      width: 100%;
      font-size: 1.5rem;
      letter-spacing: 20px;
      animation: seaweed-sway 2s ease-in-out infinite;
    }
    @keyframes seaweed-sway {
      0%, 100% { transform: skewX(-3deg); }
      50% { transform: skewX(3deg); }
    }

    /* Cheese Shop - Swiss Alps Golden Hour */
    .theme-cheese .sky-layer {
      background: linear-gradient(180deg,
        #FFD700 0%, #FFA500 20%, #FFEFD5 45%,
        #E0F2E9 70%, #90EE90 100%
      );
    }
    .theme-cheese .celestial-body {
      background: radial-gradient(circle at 30% 30%, #FFFACD, #FFD700);
      box-shadow: 0 0 70px rgba(255, 215, 0, 0.7);
    }
    .theme-cheese .mountain { border-bottom-color: #DAA520 !important; }
    .theme-cheese .mountain::before { border-bottom-color: #FFFAF0 !important; }
    .theme-cheese .hill { background: linear-gradient(180deg, #9ACD32 0%, #6B8E23 100%) !important; }
    .theme-cheese .tree::after { border-color: transparent transparent #228B22 transparent !important; }
    .theme-cheese .ground-layer { background: linear-gradient(180deg, #7CB342 0%, #558B2F 100%); }

    /* Noodle House - Asian Evening Glow */
    .theme-noodle .sky-layer {
      background: linear-gradient(180deg,
        #DC143C 0%, #FF6347 20%, #FFA07A 40%,
        #FFE4B5 60%, #98FB98 80%, #3CB371 100%
      );
    }
    .theme-noodle .celestial-body {
      background: radial-gradient(circle at 30% 30%, #FFE4E1, #FF6347);
      box-shadow: 0 0 60px rgba(255, 99, 71, 0.6);
    }
    .theme-noodle .mountain { border-bottom-color: #8B0000 !important; }
    .theme-noodle .hill { background: linear-gradient(180deg, #66CDAA 0%, #3CB371 100%) !important; }
    .theme-noodle .tree::after { border-color: transparent transparent #006400 transparent !important; }
    .theme-noodle .ground-layer { background: linear-gradient(180deg, #3CB371 0%, #2E8B57 100%); }
    /* Lantern glow effect */
    .theme-noodle .destination-display {
      border-color: #FFD700;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
    }

    /* ===== ELEVATOR SCREEN ===== */
    .elevator-screen {
      background: linear-gradient(180deg, #D5D0C8 0%, #E8E3DB 50%, #C9C4BC 100%);
      display: flex;
      flex-direction: row;
      padding: clamp(0.5rem, 1vh, 1rem);
      gap: clamp(0.5rem, 1vh, 1rem);
      /* Subtle tile pattern for elevator lobby */
      background-image:
        linear-gradient(180deg, #D5D0C8 0%, #E8E3DB 50%, #C9C4BC 100%),
        repeating-linear-gradient(90deg, transparent 0, transparent 49px, rgba(0,0,0,0.03) 49px, rgba(0,0,0,0.03) 50px),
        repeating-linear-gradient(0deg, transparent 0, transparent 49px, rgba(0,0,0,0.03) 49px, rgba(0,0,0,0.03) 50px);
    }

    .elevator-shaft {
      flex: 1;
      /* Warm wooden elevator interior */
      background:
        linear-gradient(135deg, #8B7355 0%, #A0826D 25%, #6F5E52 50%, #8B7355 75%, #9B8169 100%);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: clamp(0.5rem, 1vh, 1rem);
      /* Cozy interior shadow with soft ambient lighting */
      box-shadow:
        inset 0 4px 12px rgba(0, 0, 0, 0.3),
        inset 0 -2px 6px rgba(255, 255, 255, 0.1),
        0 8px 24px rgba(0, 0, 0, 0.2),
        inset 0 0 60px rgba(255, 230, 180, 0.15);
      border: 4px solid #5D4E41;
      position: relative;
      /* Wood panel texture */
      background-image:
        linear-gradient(135deg, #8B7355 0%, #A0826D 25%, #6F5E52 50%, #8B7355 75%, #9B8169 100%),
        repeating-linear-gradient(90deg, transparent 0, transparent 3px, rgba(0,0,0,0.05) 3px, rgba(0,0,0,0.05) 6px);
    }

    /* Decorative brass corner accents */
    .elevator-shaft::before,
    .elevator-shaft::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 3px solid #B8860B;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
    }

    .elevator-shaft::before {
      top: 8px;
      left: 8px;
      border-right: none;
      border-bottom: none;
    }

    .elevator-shaft::after {
      top: 8px;
      right: 8px;
      border-left: none;
      border-bottom: none;
    }

    /* Soft ceiling light effect */
    .elevator-shaft > *:first-child::before {
      content: '';
      position: absolute;
      top: -16px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 30px;
      background: radial-gradient(ellipse at center, rgba(255, 244, 214, 0.9) 0%, rgba(255, 244, 214, 0.5) 40%, rgba(255, 244, 214, 0.2) 70%, transparent 100%);
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
      filter: blur(2px);
    }

    /* Interior handrail accent on left side */
    .elevator-shaft > .floor-display::after {
      content: '';
      position: absolute;
      left: -45px;
      top: 50%;
      transform: translateY(-50%);
      width: 35px;
      height: 6px;
      background: linear-gradient(90deg, #B8860B 0%, #DAA520 50%, #B8860B 100%);
      border-radius: 3px;
      box-shadow:
        0 2px 4px rgba(0,0,0,0.3),
        inset 0 1px 1px rgba(255,255,255,0.3);
      z-index: 0;
    }

    .floor-display {
      /* Realistic LED display */
      background: linear-gradient(180deg, #0a0a14 0%, #1a1a2e 50%, #0a0a14 100%);
      color: #FFB84D;
      font-family: 'Courier New', monospace;
      font-size: clamp(3rem, 7vh, 4rem);
      font-weight: bold;
      padding: clamp(12px, 1.5vh, 20px) var(--space-lg);
      border-radius: 8px;
      margin-bottom: clamp(0.5rem, 1vh, 1rem);
      min-width: 120px;
      text-align: center;
      /* Warm amber LED glow effect */
      text-shadow:
        0 0 15px #FFB84D,
        0 0 25px #FFB84D,
        0 0 35px rgba(255, 184, 77, 0.6);
      box-shadow:
        0 0 25px rgba(255, 184, 77, 0.3),
        inset 0 2px 8px rgba(0, 0, 0, 0.8),
        inset 0 -1px 2px rgba(255, 255, 255, 0.1),
        0 2px 4px rgba(0,0,0,0.4);
      border: 3px solid #2a2a3e;
      position: relative;
      overflow: hidden;
    }

    /* Scanline effect for LED */
    .floor-display::after {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent 0,
        transparent 2px,
        rgba(0, 0, 0, 0.1) 2px,
        rgba(0, 0, 0, 0.1) 4px
      );
      pointer-events: none;
    }

    /* Floor changing animation */
    .floor-display.changing {
      animation: floor-change 0.4s ease-in-out;
    }

    @keyframes floor-change {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(0.95); }
    }

    /* Elevator movement animation */
    .elevator-shaft.moving {
      animation: elevator-shake 3.5s ease-in-out;
    }

    @keyframes elevator-shake {
      0%, 100% { transform: translateY(0); }
      10% { transform: translateY(1px) translateX(0.5px); }
      20% { transform: translateY(-1px) translateX(-0.5px); }
      30% { transform: translateY(0.5px) translateX(0.5px); }
      40% { transform: translateY(-0.5px) translateX(-0.5px); }
      50% { transform: translateY(1px) translateX(0.5px); }
      60% { transform: translateY(-1px) translateX(-0.5px); }
      70% { transform: translateY(0.5px) translateX(0.5px); }
      80% { transform: translateY(-0.5px) translateX(-0.5px); }
      90% { transform: translateY(0.5px) translateX(0); }
    }

    .elevator-doors {
      flex: 1;
      width: 100%;
      /* Elevator door frame with viewing window */
      background: linear-gradient(180deg, #5D4E41 0%, #6F5E52 5%, #4A3F35 100%);
      border-radius: 6px;
      display: flex;
      overflow: hidden;
      position: relative;
      box-shadow:
        inset 0 0 30px rgba(0, 0, 0, 0.4),
        0 4px 8px rgba(0, 0, 0, 0.3);
      padding: 12px;
      gap: 6px;
      /* Slightly smaller to show interior walls around it */
      max-height: 85%;
      margin: auto;
    }

    .door {
      width: calc(50% - 3px);
      height: 100%;
      /* Warm metallic door with subtle brass tint */
      background:
        linear-gradient(90deg,
          #9B8169 0%,
          #B8A090 15%,
          #D0C0B0 30%,
          #B8A090 50%,
          #A08875 70%,
          #B8A090 85%,
          #9B8169 100%
        );
      border-radius: 4px;
      transition: transform 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      z-index: 2;
      /* Vertical brushed texture */
      background-image:
        linear-gradient(90deg,
          #9B8169 0%, #B8A090 15%, #D0C0B0 30%,
          #B8A090 50%, #A08875 70%, #B8A090 85%, #9B8169 100%
        ),
        repeating-linear-gradient(
          180deg,
          transparent 0,
          transparent 1px,
          rgba(255,255,255,0.03) 1px,
          rgba(255,255,255,0.03) 2px
        );
      box-shadow:
        inset 2px 0 4px rgba(255, 255, 255, 0.2),
        inset -2px 0 4px rgba(0, 0, 0, 0.3);
    }

    /* Door handle/indent */
    .door::before {
      content: '';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 100px;
      background: linear-gradient(90deg, #B8860B 0%, #DAA520 50%, #B8860B 100%);
      border-radius: 3px;
      box-shadow:
        inset 0 1px 2px rgba(255,255,255,0.4),
        0 2px 4px rgba(0,0,0,0.3);
    }

    .door-left::before {
      right: 16px;
    }

    .door-right::before {
      left: 16px;
    }

    /* Door gap indicator line */
    .door::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(180deg, #3a3028 0%, #4a3f35 50%, #3a3028 100%);
    }

    .door-left::after {
      right: 0;
    }

    .door-right::after {
      left: 0;
    }

    .doors-open .door-left {
      transform: translateX(-98%);
    }

    .doors-open .door-right {
      transform: translateX(98%);
    }

    /* Restaurant/destination view behind doors */
	    .door-window {
	      position: absolute;
      top: 12px;
      left: 12px;
      right: 12px;
      bottom: 12px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transform: scale(1.02);
      transition:
        opacity 0.6s ease 0.15s,
        transform 0.9s ease 0.15s,
        filter 0.9s ease 0.15s;
      display: block;
      z-index: 1;
      /* Warm destination interior glimpse (fallback if no image is set) */
      background:
        linear-gradient(180deg, #FFF8E7 0%, #FFF0D4 50%, #FFE8C4 100%);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: saturate(1.05) contrast(1.02);
      box-shadow:
        inset 0 0 20px rgba(255,200,100,0.25),
        0 0 18px rgba(255,220,150,0.12);
	    }

    .doors-open .door-window {
      opacity: 1;
      transform: scale(1);
    }

    .door-window::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 4px;
      background:
        radial-gradient(ellipse at 50% 30%, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0.06) 45%, rgba(0,0,0,0.10) 100%),
        linear-gradient(180deg, rgba(0,0,0,0.10) 0%, transparent 35%, transparent 65%, rgba(0,0,0,0.18) 100%);
      pointer-events: none;
    }

	    .elevator-panel {
	      width: 160px;
      /* Interior wall-mounted brushed metal panel */
      background:
        linear-gradient(180deg, #A8967B 0%, #C0AE93 20%, #B0A088 80%, #988770 100%);
      border-radius: 12px;
      padding: clamp(0.5rem, 1vh, 1rem);
      display: flex;
      flex-direction: column;
      gap: clamp(0.25rem, 0.5vh, 0.75rem);
      box-shadow:
        0 6px 20px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        inset 0 -1px 0 rgba(0, 0, 0, 0.2);
	      border: 3px solid #6F5E52;
	      position: relative;
	      align-self: center; /* center panel within elevator scene */
	    }

	    /* Removed small decorative screws (cleaner UI) */
	    .elevator-panel::before,
	    .elevator-panel::after {
	      display: none;
	      content: none;
	    }

    .panel-title {
      font-family: var(--font-display);
      font-size: 0.85rem;
      font-weight: 700;
      color: #4a3f35;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      text-shadow: 0 1px 0 rgba(255,255,255,0.3);
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      margin-bottom: 4px;
      position: relative;
    }

	    /* Removed decorative icon box (cleaner UI) */
	    .panel-title::before {
	      display: none;
	      content: none;
	    }

    .floor-btn {
      width: 100%;
      min-height: 72px;
      /* 3D tactile button */
      background:
        linear-gradient(180deg, #F8F8F8 0%, #E8E8E8 40%, #D8D8D8 100%);
      border: none;
      border-radius: 10px;
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      cursor: pointer;
      /* Only transition transform for smooth hover/press, NOT background/box-shadow */
      transition: transform 0.1s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      position: relative;
      /* 3D raised effect */
      box-shadow:
        0 4px 0 #A0A0A0,
        0 6px 8px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.8),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
    }

    .floor-btn:hover:not(:disabled):not(.active) {
      background: linear-gradient(180deg, #FFFFFF 0%, #F0F0F0 40%, #E0E0E0 100%);
      transform: translateY(-1px);
      box-shadow:
        0 5px 0 #A0A0A0,
        0 8px 12px rgba(0, 0, 0, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.9),
        inset 0 -1px 0 rgba(0, 0, 0, 0.1);
    }

    .floor-btn:active:not(:disabled) {
      transform: translateY(3px);
      box-shadow:
        0 1px 0 #A0A0A0,
        0 2px 4px rgba(0, 0, 0, 0.2),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .floor-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .floor-btn.active {
      background: linear-gradient(180deg, #FFE566 0%, #FFD93D 40%, #F0C800 100%);
      box-shadow:
        0 4px 0 #C4A000,
        0 6px 12px rgba(255, 217, 102, 0.4),
        0 0 20px rgba(255, 217, 102, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
      /* Instant highlight - no transition! */
      transition: none;
      animation: button-glow 1.5s ease-in-out infinite;
    }

    @keyframes button-glow {
      0%, 100% {
        box-shadow:
          0 4px 0 #C4A000,
          0 6px 12px rgba(255, 217, 102, 0.4),
          0 0 20px rgba(255, 217, 102, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.6);
      }
      50% {
        box-shadow:
          0 4px 0 #C4A000,
          0 6px 12px rgba(255, 217, 102, 0.6),
          0 0 30px rgba(255, 217, 102, 0.5),
          inset 0 1px 0 rgba(255, 255, 255, 0.7);
      }
    }

	    /* Interior button panel indicators */
	    .floor-btn::after {
	      display: none;
	      content: none;
	    }

	    .floor-btn.active::after {
	      display: none;
	      content: none;
	    }

    .floor-btn .floor-num {
      font-size: 1.5rem;
      text-shadow: 0 1px 0 rgba(255,255,255,0.5);
    }

    .floor-btn .floor-name {
      font-size: 0.65rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Button press animation for touch */
    @media (hover: none) {
      .floor-btn:active:not(:disabled) {
        transform: translateY(4px) scale(0.98);
      }
    }

    /* ===== WORD WARM-UP SCREEN ===== */
    .warmup-screen {
      background:
        radial-gradient(ellipse at 50% 0%, var(--accent-golden-pale) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, var(--accent-peach-pale) 0%, transparent 40%),
        linear-gradient(180deg, var(--bg-cream-warm) 0%, var(--accent-golden-pale) 100%);
      padding: clamp(0.75rem, 1.5vh, 1.5rem);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: clamp(0.75rem, 1.5vh, 1.5rem);
    }

    .warmup-header {
      text-align: center;
    }

    .warmup-icon {
      font-size: clamp(2rem, 5vh, 2.8rem);
      margin-bottom: var(--space-sm);
      animation: bounce 2s ease-in-out infinite;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .warmup-title {
      font-family: var(--font-display);
      font-size: clamp(1.25rem, 3vh, 1.5rem);
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .warmup-subtitle {
      font-family: var(--font-reading);
      font-size: var(--text-base);
      color: var(--text-secondary);
      margin: var(--space-xs) 0 0;
    }

    .warmup-words {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
      width: 100%;
      max-width: 380px;
    }

    .warmup-word-card {
      position: relative;
      background:
        linear-gradient(180deg, #FFFFFF 0%, var(--bg-cream-cool) 100%);
      border-radius: var(--radius-xl);
      padding: clamp(0.75rem, 1.5vh, 1.5rem) clamp(0.5rem, 1vh, 1rem);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);
      cursor: pointer;
      transition: all var(--anim-fast) var(--ease-out-soft);
      border: 3px solid var(--panel-silver);
      box-shadow:
        0 4px 0 var(--panel-silver-dark),
        var(--shadow-sm);
    }

    .warmup-word-card:hover {
      transform: translateY(-4px);
      box-shadow:
        0 6px 0 var(--panel-silver-dark),
        var(--shadow-md);
      border-color: var(--mrt-blue-pale);
    }

    .warmup-word-card:active {
      transform: translateY(2px) scale(0.98);
      box-shadow:
        0 2px 0 var(--panel-silver-dark),
        var(--shadow-xs);
    }

    .warmup-word-card.heard {
      border-color: var(--success-green);
      background:
        linear-gradient(180deg, var(--success-green-pale) 0%, var(--accent-mint-pale) 100%);
      box-shadow:
        0 4px 0 var(--accent-mint-soft),
        var(--shadow-mint);
    }

    .warmup-word-card.heard::after {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 20px;
      height: 20px;
      background: var(--success-green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
    }

    .warmup-word-card.heard::before {
      content: '';
      position: absolute;
      top: 12px;
      right: 16px;
      width: 6px;
      height: 10px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      z-index: 1;
    }

    .warmup-word-icon {
      font-size: clamp(1.5rem, 4vh, 2.2rem);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }

    .warmup-word-text {
      font-family: var(--font-display);
      font-size: clamp(1rem, 2.5vh, 1.25rem);
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
    }

    .warmup-progress {
      width: 100%;
      max-width: 280px;
      height: 10px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: var(--radius-full);
      overflow: hidden;
      box-shadow: var(--shadow-inner);
    }

    .warmup-progress-bar {
      height: 100%;
      background:
        linear-gradient(90deg, var(--success-green) 0%, var(--accent-mint) 100%);
      width: 0%;
      transition: width var(--anim-medium) var(--ease-out-soft);
      border-radius: var(--radius-full);
    }

    .warmup-continue-btn {
      background:
        linear-gradient(180deg, var(--success-green) 0%, #5BC06A 100%);
      color: var(--text-inverse);
      border: none;
      padding: var(--space-md) var(--space-xl);
      border-radius: var(--radius-full);
      font-family: var(--font-display);
      font-size: var(--text-lg);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      transition: all var(--anim-fast) var(--ease-out-soft);
      box-shadow:
        0 4px 0 rgba(70, 160, 90, 0.5),
        var(--shadow-mint);
      animation: warmup-pulse 2s ease-in-out infinite;
    }

    .warmup-continue-btn:hover {
      transform: translateY(-2px);
      box-shadow:
        0 6px 0 rgba(70, 160, 90, 0.4),
        0 4px 16px rgba(125, 213, 144, 0.4);
    }

    .warmup-continue-btn:active {
      transform: translateY(2px);
      box-shadow:
        0 2px 0 rgba(70, 160, 90, 0.5),
        var(--shadow-sm);
      animation: none;
    }

    .warmup-continue-btn .arrow {
      font-size: 1.4rem;
    }

    /* Phonics Focus Box - explicit instruction for digraphs/patterns */
    .phonics-focus-box {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      background: linear-gradient(135deg, var(--accent-lavender-pale) 0%, var(--accent-mint-pale) 100%);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-md);
      box-shadow: var(--shadow-sm);
      flex-wrap: wrap;
    }

    .phonics-label {
      font-family: var(--font-display);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-weight: 600;
    }

    .phonics-pattern {
      font-family: var(--font-display);
      font-size: var(--text-2xl);
      font-weight: 700;
      color: var(--accent-lavender);
      background: white;
      padding: var(--space-2xs) var(--space-sm);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      letter-spacing: 0.1em;
    }

    .phonics-example {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-style: italic;
    }

    /* Sight Word Reminder */
    .sight-word-reminder {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      background: var(--accent-golden-pale);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-lg);
      margin-top: var(--space-md);
      box-shadow: var(--shadow-xs);
    }

    .reminder-icon {
      font-size: 1.2rem;
    }

    .reminder-text {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    /* Sight word indicator on warmup cards */
	    .warmup-word-card.sight-word::before {
	      content: 'SW';
	      position: absolute;
	      top: -8px;
	      right: -8px;
	      font-size: 0.7rem;
	      font-weight: 800;
	      letter-spacing: 0.04em;
	      color: var(--text-inverse);
	      background: var(--accent-coral);
	      padding: 4px 6px;
	      border-radius: 999px;
	      box-shadow: var(--shadow-sm);
	      filter: none;
	    }

    /* Digraph highlighting on warmup cards */
    .warmup-word-card.has-digraph .warmup-word-text {
      position: relative;
    }

    .digraph-highlight {
      color: var(--accent-lavender);
      font-weight: 700;
      text-decoration: underline;
      text-decoration-color: var(--accent-lavender-soft);
      text-decoration-thickness: 3px;
    }

    body.calm-mode .digraph-highlight {
      text-decoration: none;
    }

    @keyframes warmup-pulse {
      0%, 100% {
        box-shadow:
          0 4px 0 rgba(70, 160, 90, 0.5),
          var(--shadow-mint);
      }
      50% {
        box-shadow:
          0 4px 0 rgba(70, 160, 90, 0.5),
          0 4px 20px rgba(125, 213, 144, 0.5);
      }
    }

    /* ===== RESTAURANT SCREEN ===== */
    .restaurant-screen {
      background:
        radial-gradient(ellipse at 50% 0%, var(--accent-golden-pale) 0%, transparent 50%),
        var(--bg-cream-warm);
      padding: clamp(0.75rem, 1.5vh, 1.5rem);
      padding-bottom: calc(clamp(0.75rem, 1.5vh, 1.5rem) + env(safe-area-inset-bottom, 0px));
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      gap: clamp(0.5rem, 1vh, 1rem);
      position: relative;
    }

    /* === THEMED ENVIRONMENTAL BACKGROUNDS === */
    /* Subtle ambiance that creates sense of place without distraction */

    /* Fruit Stand - Golden Orchard Glow */
    .theme-fruit .restaurant-screen {
      background:
        radial-gradient(ellipse at 50% -20%, rgba(255, 215, 77, 0.12) 0%, transparent 60%),
        radial-gradient(ellipse at -10% 50%, rgba(107, 203, 119, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 110% 50%, rgba(255, 140, 66, 0.08) 0%, transparent 50%),
        var(--bg-cream-warm);
    }

    /* Drink Bar - Cool Refreshing Mist */
    .theme-drink .restaurant-screen {
      background:
        radial-gradient(ellipse at 50% -20%, rgba(72, 202, 228, 0.1) 0%, transparent 60%),
        radial-gradient(ellipse at -10% 80%, rgba(144, 224, 239, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 110% 80%, rgba(0, 180, 216, 0.06) 0%, transparent 50%),
        var(--bg-cream-warm);
    }

    /* Bakery - Warm Cozy Hearth */
    .theme-bakery .restaurant-screen {
      background:
        radial-gradient(ellipse at 50% -20%, rgba(255, 212, 163, 0.15) 0%, transparent 60%),
        radial-gradient(ellipse at 0% 100%, rgba(201, 168, 124, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 100% 100%, rgba(222, 184, 135, 0.08) 0%, transparent 50%),
        var(--bg-cream-warm);
    }

    /* Pizza Place - Tuscan Sunset Warmth */
    .theme-pizza .restaurant-screen {
      background:
        radial-gradient(ellipse at 50% -20%, rgba(255, 195, 160, 0.12) 0%, transparent 60%),
        radial-gradient(ellipse at -10% 50%, rgba(152, 216, 170, 0.07) 0%, transparent 50%),
        radial-gradient(ellipse at 110% 50%, rgba(255, 107, 107, 0.07) 0%, transparent 50%),
        var(--bg-cream-warm);
    }

    /* Ice Cream Shop - Pastel Candy Dreams */
    .theme-icecream .restaurant-screen {
      background:
        radial-gradient(ellipse at 50% -20%, rgba(255, 181, 232, 0.1) 0%, transparent 60%),
        radial-gradient(ellipse at -10% 80%, rgba(181, 222, 255, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 110% 80%, rgba(220, 211, 255, 0.08) 0%, transparent 50%),
        var(--bg-cream-warm);
    }

    /* Fish Shop - Deep Ocean Depths */
    .theme-fishshop .restaurant-screen {
      background:
        radial-gradient(ellipse at 50% -20%, rgba(0, 180, 216, 0.1) 0%, transparent 60%),
        radial-gradient(ellipse at -10% 50%, rgba(32, 178, 170, 0.07) 0%, transparent 50%),
        radial-gradient(ellipse at 110% 50%, rgba(72, 202, 228, 0.07) 0%, transparent 50%),
        var(--bg-cream-warm);
    }

    /* Cheese Shop - Alpine Golden Glow */
    .theme-cheese .restaurant-screen {
      background:
        radial-gradient(ellipse at 50% -20%, rgba(255, 215, 0, 0.12) 0%, transparent 60%),
        radial-gradient(ellipse at -10% 80%, rgba(144, 238, 144, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 110% 80%, rgba(255, 165, 0, 0.08) 0%, transparent 50%),
        var(--bg-cream-warm);
    }

    /* Noodle House - Asian Evening Lantern Glow */
    .theme-noodle .restaurant-screen {
      background:
        radial-gradient(ellipse at 50% -20%, rgba(255, 160, 122, 0.12) 0%, transparent 60%),
        radial-gradient(ellipse at -10% 50%, rgba(60, 179, 113, 0.07) 0%, transparent 50%),
        radial-gradient(ellipse at 110% 50%, rgba(255, 99, 71, 0.07) 0%, transparent 50%),
        var(--bg-cream-warm);
    }

    .restaurant-header {
      text-align: center;
      padding: clamp(0.25rem, 0.5vh, 0.75rem) 0;
    }

    .restaurant-icon {
      font-size: clamp(2rem, 5vh, 2.8rem);
      margin-bottom: var(--space-2xs);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      animation: icon-float 3s ease-in-out infinite;
    }

    /* Ghibli-style food hero image */
    .restaurant-hero {
      width: clamp(100px, 25vw, 160px);
      height: auto;
      margin-bottom: var(--space-xs);
      animation: icon-float 3s ease-in-out infinite;
      object-fit: contain;
      mix-blend-mode: multiply;
    }

    @keyframes icon-float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }

    .restaurant-name {
      font-family: var(--font-display);
      font-size: var(--text-2xl);
      font-weight: 600;
      color: var(--text-primary);
    }

    /* ===== READING SECTION ===== */
    /* The heart of the app - optimized for focus and readability */
    .reading-section {
      background: linear-gradient(180deg, #FFFFFF 0%, #FDF8F3 100%);
      border-radius: 20px;
      padding: 0;
      box-shadow:
        0 4px 20px rgba(139, 90, 43, 0.12),
        0 2px 8px rgba(0,0,0,0.06),
        inset 0 1px 0 rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      /* Warm book-like border */
      border: 2px solid rgba(210, 180, 140, 0.4);
    }

    /* Reading section header bar */
    .reading-section::before {
      content: '  Reading Passage';
      position: relative;
      display: block;
      width: 100%;
      padding: 10px 16px;
      background: linear-gradient(135deg, #8FBC8F 0%, #6B9B6B 100%);
      font-family: var(--font-display);
      font-size: 0.95rem;
      font-weight: 700;
      color: #FFFFFF;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      letter-spacing: 0.03em;
      border-bottom: 2px solid rgba(0,0,0,0.1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Inner content padding */
    .reading-section > *:not(.reading-section::before) {
      padding-left: clamp(0.75rem, 2vw, 1.25rem);
      padding-right: clamp(0.75rem, 2vw, 1.25rem);
    }

    /* Bottom decorative accent */
    .reading-section::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #8FBC8F, #6B9B6B, #8FBC8F);
      opacity: 0.6;
    }

    /* === THEMED READING CARD ACCENTS === */
    /* Very subtle color hints on reading cards to reinforce station theme */

    /* Fruit Stand - Warm golden border hint */
    .theme-fruit .reading-section {
      border-color: rgba(255, 215, 77, 0.25);
      box-shadow:
        0 4px 20px rgba(255, 140, 66, 0.08),
        0 2px 8px rgba(0,0,0,0.06),
        inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .theme-fruit .reading-section::after {
      background: linear-gradient(90deg, rgba(107, 203, 119, 0.5), rgba(255, 215, 77, 0.6), rgba(107, 203, 119, 0.5));
    }

    /* Drink Bar - Cool blue tint */
    .theme-drink .reading-section {
      border-color: rgba(72, 202, 228, 0.2);
      box-shadow:
        0 4px 20px rgba(0, 180, 216, 0.08),
        0 2px 8px rgba(0,0,0,0.06),
        inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .theme-drink .reading-section::after {
      background: linear-gradient(90deg, rgba(72, 202, 228, 0.5), rgba(144, 224, 239, 0.6), rgba(72, 202, 228, 0.5));
    }

    /* Bakery - Warm bread crust tones */
    .theme-bakery .reading-section {
      border-color: rgba(222, 184, 135, 0.35);
      box-shadow:
        0 4px 20px rgba(201, 168, 124, 0.1),
        0 2px 8px rgba(0,0,0,0.06),
        inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .theme-bakery .reading-section::after {
      background: linear-gradient(90deg, rgba(201, 168, 124, 0.6), rgba(222, 184, 135, 0.7), rgba(201, 168, 124, 0.6));
    }

    /* Pizza Place - Tuscan herb garden */
    .theme-pizza .reading-section {
      border-color: rgba(255, 195, 160, 0.25);
      box-shadow:
        0 4px 20px rgba(255, 107, 107, 0.08),
        0 2px 8px rgba(0,0,0,0.06),
        inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .theme-pizza .reading-section::after {
      background: linear-gradient(90deg, rgba(152, 216, 170, 0.5), rgba(255, 195, 160, 0.6), rgba(152, 216, 170, 0.5));
    }

    /* Ice Cream Shop - Pastel sweetness */
    .theme-icecream .reading-section {
      border-color: rgba(255, 181, 232, 0.25);
      box-shadow:
        0 4px 20px rgba(220, 211, 255, 0.1),
        0 2px 8px rgba(0,0,0,0.06),
        inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .theme-icecream .reading-section::after {
      background: linear-gradient(90deg, rgba(181, 222, 255, 0.5), rgba(255, 181, 232, 0.6), rgba(181, 222, 255, 0.5));
    }

    /* Fish Shop - Ocean depths */
    .theme-fishshop .reading-section {
      border-color: rgba(0, 180, 216, 0.25);
      box-shadow:
        0 4px 20px rgba(32, 178, 170, 0.1),
        0 2px 8px rgba(0,0,0,0.06),
        inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .theme-fishshop .reading-section::after {
      background: linear-gradient(90deg, rgba(32, 178, 170, 0.5), rgba(72, 202, 228, 0.6), rgba(32, 178, 170, 0.5));
    }

    /* Cheese Shop - Alpine gold */
    .theme-cheese .reading-section {
      border-color: rgba(255, 215, 0, 0.25);
      box-shadow:
        0 4px 20px rgba(255, 165, 0, 0.08),
        0 2px 8px rgba(0,0,0,0.06),
        inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .theme-cheese .reading-section::after {
      background: linear-gradient(90deg, rgba(144, 238, 144, 0.5), rgba(255, 215, 0, 0.6), rgba(144, 238, 144, 0.5));
    }

    /* Noodle House - Lantern warmth */
    .theme-noodle .reading-section {
      border-color: rgba(255, 160, 122, 0.25);
      box-shadow:
        0 4px 20px rgba(255, 99, 71, 0.08),
        0 2px 8px rgba(0,0,0,0.06),
        inset 0 1px 0 rgba(255,255,255,0.9);
    }
    .theme-noodle .reading-section::after {
      background: linear-gradient(90deg, rgba(60, 179, 113, 0.5), rgba(255, 160, 122, 0.6), rgba(60, 179, 113, 0.5));
    }

    .sentence-image {
      font-size: 3.5rem;
      text-align: center;
      margin-bottom: var(--space-md);
      filter: drop-shadow(0 2px 6px rgba(0,0,0,0.1));
    }

    .sentence-display {
      font-family: var(--font-reading);
      font-size: clamp(1.35rem, 3.2vh, 1.6rem);
      font-weight: 600;
      line-height: 1.7;
      letter-spacing: 0.03em;
      color: #2D3436;
      text-align: center;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 0.4em;
      padding: clamp(1rem, 2vh, 1.5rem) clamp(1rem, 3vw, 1.5rem);
      margin: 0;
      /* Warm cream background for better readability */
      background: linear-gradient(180deg, rgba(255,252,247,0.8) 0%, rgba(255,248,240,0.9) 100%);
      min-height: 80px;
    }

    .word {
      padding: 0.15em 0.25em;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--anim-fast) var(--ease-out-soft);
      position: relative;
      /* Improve tap target */
      margin: 0.05em 0;
    }

    .word:hover {
      background: var(--mrt-blue-whisper);
      box-shadow: 0 0 0 2px var(--mrt-blue-pale);
    }

    .word:active {
      transform: scale(0.95);
    }

    .word.highlighted {
      background: var(--accent-golden);
      transform: scale(1.08);
      box-shadow: var(--shadow-golden);
      border-radius: var(--radius-sm);
    }

    /* When highlighted, hide all other visual indicators for cleaner focus */
    .word.highlighted.sight-word::after,
    .word.highlighted.focus-word::after {
      display: none;
    }

    .word.highlighted.focus-word {
      background: var(--accent-golden);
      box-shadow: var(--shadow-golden);
    }

    body.calm-mode .word.highlighted {
      transform: none;
      box-shadow: none;
    }

	    .word.tap-heard {
	      animation: word-pulse 0.4s var(--ease-out-soft);
	    }

	    body.calm-mode .word.tap-heard {
	      animation: none;
	    }

	    .gate-nudge {
	      animation: gate-nudge 0.7s ease-in-out 2;
	    }

	    @keyframes gate-nudge {
	      0% { transform: scale(1); box-shadow: none; }
	      35% { transform: scale(1.08); box-shadow: 0 0 0 3px var(--accent-golden-soft), 0 0 18px var(--accent-golden-soft); }
	      100% { transform: scale(1); box-shadow: none; }
	    }

	    body.calm-mode .gate-nudge {
	      animation: gate-glow 0.7s ease-in-out 2;
	    }

	    @keyframes gate-glow {
	      0% { box-shadow: none; }
	      35% { box-shadow: 0 0 0 3px var(--accent-golden-soft); }
	      100% { box-shadow: none; }
	    }

	    .attention-nudge {
	      animation: attention-glow 0.7s ease-in-out 2;
	    }

	    @keyframes attention-glow {
	      0% { box-shadow: none; }
	      35% { box-shadow: 0 0 0 3px var(--mrt-blue-whisper), 0 0 18px var(--mrt-blue-whisper); }
	      100% { box-shadow: none; }
	    }

	    @keyframes word-pulse {
	      0% {
	        transform: scale(1);
	        background: var(--accent-golden);
        box-shadow: var(--shadow-golden);
      }
      50% {
        transform: scale(1.12);
        box-shadow: 0 0 12px var(--accent-golden);
      }
      100% {
        transform: scale(1);
        background: transparent;
        box-shadow: none;
      }
    }

    /* ===== SIGHT WORD STYLING ===== */
    /* Gentle visual cue without being distracting */
    .word.sight-word {
      position: relative;
    }

    .word.sight-word::after {
      content: '';
      position: absolute;
      bottom: 2px;
      left: 10%;
      right: 10%;
      height: 2px;
      background: var(--accent-lavender-soft);
      border-radius: var(--radius-full);
      opacity: 0.5;
    }

    body.calm-mode .word.sight-word::after {
      opacity: 0.25;
      height: 1px;
    }

    /* Focus sight word - more prominent but still soft */
    .word.focus-word {
      background: var(--accent-lavender-pale);
      font-weight: 700;
      box-shadow: 0 0 0 2px var(--accent-lavender-soft);
    }

    .word.focus-word::after {
      background: var(--accent-lavender);
      opacity: 1;
    }

    /* Calm mode: Remove background and box-shadow from focus words to reduce visual clutter */
    body.calm-mode .word.focus-word {
      background: transparent;
      box-shadow: none;
      font-weight: 600;
    }

    body.calm-mode .word.focus-word::after {
      opacity: 0.5;
      height: 2px;
    }

    /* Digraph word styling - highlights the digraph pattern */
    .word.digraph-word {
      position: relative;
    }

    .word.digraph-word::before {
      content: attr(data-digraph);
      position: absolute;
      bottom: -16px;
      left: 50%;
      transform: translateX(-50%);
      font-size: var(--text-xs);
      font-weight: 700;
      color: var(--accent-coral);
      background: var(--accent-coral-pale);
      padding: 2px 6px;
      border-radius: var(--radius-full);
      white-space: nowrap;
    }

    /* Calm mode: Hide digraph labels to reduce visual clutter */
    body.calm-mode .word.digraph-word::before {
      display: none;
    }

    /* Audio controls - Prominent and centered */
    .audio-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: var(--space-lg);
      margin-top: var(--space-md);
      padding: var(--space-md) var(--space-sm);
      background: linear-gradient(180deg, rgba(255,255,255,0.6) 0%, rgba(255,248,240,0.8) 100%);
      border-radius: 16px;
    }

    .audio-btn {
      min-width: var(--touch-min);
      min-height: 58px;
      padding: var(--space-md) var(--space-xl);
      /* Bold coral/salmon - highly visible and inviting */
      background: linear-gradient(180deg, #FF8A7A 0%, #E86A5A 100%);
      border: 3px solid #D85A4A;
      border-radius: 16px;
      font-family: var(--font-display);
      font-size: var(--text-lg);
      font-weight: 700;
      color: #FFFFFF;
      cursor: pointer;
      transition: all var(--anim-fast) var(--ease-out-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      /* Strong 3D button effect */
      box-shadow:
        0 4px 0 #C04A3A,
        0 6px 12px rgba(232, 106, 90, 0.4),
        inset 0 1px 0 rgba(255,255,255,0.3);
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      /* Gentle attention animation */
      animation: read-btn-pulse 2.5s ease-in-out infinite;
    }

    @keyframes read-btn-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .audio-btn:hover {
      background: linear-gradient(180deg, #FF9A8A 0%, #F07A6A 100%);
      border-color: #E86A5A;
      color: #FFFFFF;
      transform: translateY(-3px) scale(1.03);
      box-shadow:
        0 6px 0 #C04A3A,
        0 10px 24px rgba(232, 106, 90, 0.5),
        inset 0 1px 0 rgba(255,255,255,0.4);
      animation: none;
    }

    .audio-btn:active {
      transform: translateY(2px) scale(0.98);
      box-shadow:
        0 2px 0 #C04A3A,
        0 3px 8px rgba(232, 106, 90, 0.3);
    }

    .audio-btn .icon {
      font-size: 1.4rem;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
    }

    .audio-btn.tip-btn {
      /* Golden hint button - secondary but still visible */
      background: linear-gradient(180deg, #FFD54F 0%, #FFCA28 100%);
      border: 3px solid #FFB300;
      color: #5D4037;
      box-shadow:
        0 4px 0 #E6A000,
        0 6px 12px rgba(255, 193, 7, 0.35),
        inset 0 1px 0 rgba(255,255,255,0.4);
      text-shadow: none;
      animation: none;
    }

    .audio-btn.tip-btn:hover {
      background: linear-gradient(180deg, #FFE082 0%, #FFD54F 100%);
      border-color: #FFCA28;
      color: #4E342E;
      transform: translateY(-2px);
      box-shadow:
        0 5px 0 #E6A000,
        0 8px 16px rgba(255, 193, 7, 0.45);
    }

    /* Reading Tip Box - Educational scaffolding */
	    .reading-tip-box {
	      display: flex;
	      align-items: flex-start;
	      gap: var(--space-sm);
	      background: linear-gradient(135deg, var(--accent-golden-pale) 0%, var(--accent-peach-pale) 100%);
	      padding: var(--space-md);
	      border-radius: var(--radius-lg);
	      margin-top: var(--space-md);
	      box-shadow: var(--shadow-sm);
	      animation: tip-appear 0.3s ease-out;
	    }

	    .passage-box {
	      text-align: left;
	      background: linear-gradient(135deg, #FFFFFF 0%, var(--bg-soft-blue) 100%);
	      border: 2px solid rgba(138, 174, 200, 0.35);
	      border-radius: var(--radius-lg);
	      box-shadow: var(--shadow-xs);
	      overflow: hidden;
	    }

	    .passage-header {
	      display: flex;
	      align-items: center;
	      justify-content: space-between;
	      gap: var(--space-sm);
	      padding: var(--space-sm) var(--space-md);
	      background: linear-gradient(135deg, var(--mrt-blue-whisper) 0%, var(--bg-soft-blue) 100%);
	      border-bottom: 1px solid rgba(0,0,0,0.05);
	    }

	    .passage-title {
	      font-family: var(--font-display);
	      font-size: var(--text-base);
	      font-weight: 700;
	      color: var(--text-secondary);
	      flex: 1;
	    }

	    .passage-icon {
	      font-size: 1.2rem;
	      flex: 0 0 auto;
	    }

	    .passage-read-btn {
	      padding: 6px 10px;
	      font-size: 0.9rem;
	      min-height: auto;
	    }

	    .passage-body {
	      padding: var(--space-md);
	      font-family: var(--font-reading);
	      font-size: var(--text-lg);
	      color: var(--text-primary);
	      line-height: 1.8;
	      max-height: 200px;
	      overflow-y: auto;
	      -webkit-overflow-scrolling: touch;
	      display: flex;
	      flex-wrap: wrap;
	      gap: 0.3em;
	      align-items: baseline;
	    }

	    /* Passage word highlighting */
	    .passage-word {
	      padding: 0.15em 0.3em;
	      border-radius: 6px;
	      cursor: pointer;
	      transition: all 0.15s ease-out;
	      position: relative;
	      display: inline-block;
	    }

	    .passage-word:hover {
	      background: rgba(255, 193, 7, 0.25);
	    }

	    .passage-word.highlighted {
	      background: linear-gradient(135deg, #FFD54F 0%, #FFB300 100%);
	      color: #5D4037;
	      transform: scale(1.12);
	      box-shadow: 0 3px 8px rgba(255, 179, 0, 0.4), 0 0 0 2px rgba(255, 213, 79, 0.5);
	      border-radius: 8px;
	      font-weight: 600;
	      z-index: 2;
	    }

	    body.calm-mode .passage-word.highlighted {
	      transform: none;
	      box-shadow: 0 2px 4px rgba(255, 179, 0, 0.3);
	    }

	    @keyframes tip-appear {
	      from {
	        opacity: 0;
	        transform: translateY(-10px);
	      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tip-icon {
      font-size: 1.4rem;
      flex-shrink: 0;
    }

	    .tip-text {
	      font-size: var(--text-sm);
	      color: var(--text-secondary);
	      line-height: 1.5;
	      white-space: pre-wrap;
	    }

    /* Sight Word Focus - highlights the target sight word */
    .sight-word-focus {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      background: var(--accent-mint-pale);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-lg);
      margin-top: var(--space-sm);
      box-shadow: var(--shadow-xs);
    }

    .focus-label {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-weight: 600;
    }

    .focus-word {
      font-family: var(--font-display);
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--accent-mint);
      background: white;
      padding: var(--space-2xs) var(--space-sm);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
    }

    #focusSightWord {
      cursor: pointer;
      user-select: none;
    }

    #focusSightWord:active {
      transform: scale(0.97);
    }

    .focus-hint {
      font-size: var(--text-xs);
      color: var(--text-tertiary);
      font-style: italic;
      width: 100%;
      text-align: center;
    }

    /* ===== MENU/ORDERING ===== */
    .menu-section {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .menu-prompt {
      font-family: var(--font-display);
      font-size: var(--text-xl);
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: var(--space-md);
    }

    .menu-item {
      min-height: var(--touch-min);
      padding: var(--space-md);
      background:
        linear-gradient(180deg, #FFFFFF 0%, var(--bg-cream-cool) 100%);
      border: 3px solid var(--panel-silver);
      border-radius: var(--radius-xl);
      cursor: pointer;
      transition: all var(--anim-fast) var(--ease-out-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      box-shadow:
        0 4px 0 var(--panel-silver-dark),
        var(--shadow-sm);
    }

    .menu-item:hover:not(:disabled):not(.wrong) {
      border-color: var(--mrt-blue);
      transform: translateY(-3px) scale(1.02);
      box-shadow:
        0 6px 0 var(--panel-silver-dark),
        var(--shadow-md);
    }

    .menu-item:active:not(:disabled):not(.wrong) {
      transform: translateY(2px);
      box-shadow:
        0 2px 0 var(--panel-silver-dark),
        var(--shadow-xs);
    }

    .menu-item.selected {
      border-color: var(--success-green);
      background:
        linear-gradient(135deg, var(--success-green-pale) 0%, var(--accent-mint-pale) 100%);
      box-shadow:
        0 4px 0 var(--accent-mint-soft),
        var(--shadow-mint);
    }

    .menu-item.wrong {
      opacity: 0.45;
      cursor: not-allowed;
      border-color: var(--panel-silver);
      filter: grayscale(30%);
    }

    .menu-item .item-icon {
      font-size: 2.4rem;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }

    .menu-item .item-name {
      font-family: var(--font-display);
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    .menu-item .item-desc {
      font-family: var(--font-reading);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-weight: 400;
      margin-top: 2px;
    }

    /* ===== QUESTION SCREEN ===== */
    .question-section {
      text-align: center;
      padding: var(--space-lg) var(--space-md);
      background: linear-gradient(180deg, #FFF8F0 0%, #FFF4E8 100%);
      border-radius: 20px;
      border: 2px solid rgba(255, 183, 77, 0.3);
      box-shadow:
        0 4px 16px rgba(255, 152, 0, 0.1),
        inset 0 1px 0 rgba(255,255,255,0.8);
    }

    /* === THEMED QUESTION CARD ACCENTS === */
    /* Subtle theming to match the station environment */

    .theme-fruit .question-section {
      border-color: rgba(255, 215, 77, 0.3);
      box-shadow:
        0 4px 16px rgba(255, 140, 66, 0.1),
        inset 0 1px 0 rgba(255,255,255,0.8);
    }

    .theme-drink .question-section {
      border-color: rgba(72, 202, 228, 0.3);
      box-shadow:
        0 4px 16px rgba(0, 180, 216, 0.1),
        inset 0 1px 0 rgba(255,255,255,0.8);
    }

    .theme-bakery .question-section {
      border-color: rgba(222, 184, 135, 0.4);
      box-shadow:
        0 4px 16px rgba(201, 168, 124, 0.12),
        inset 0 1px 0 rgba(255,255,255,0.8);
    }

    .theme-pizza .question-section {
      border-color: rgba(255, 195, 160, 0.3);
      box-shadow:
        0 4px 16px rgba(255, 107, 107, 0.1),
        inset 0 1px 0 rgba(255,255,255,0.8);
    }

    .theme-icecream .question-section {
      border-color: rgba(255, 181, 232, 0.3);
      box-shadow:
        0 4px 16px rgba(220, 211, 255, 0.12),
        inset 0 1px 0 rgba(255,255,255,0.8);
    }

    .theme-fishshop .question-section {
      border-color: rgba(0, 180, 216, 0.3);
      box-shadow:
        0 4px 16px rgba(32, 178, 170, 0.12),
        inset 0 1px 0 rgba(255,255,255,0.8);
    }

    .theme-cheese .question-section {
      border-color: rgba(255, 215, 0, 0.3);
      box-shadow:
        0 4px 16px rgba(255, 165, 0, 0.1),
        inset 0 1px 0 rgba(255,255,255,0.8);
    }

    .theme-noodle .question-section {
      border-color: rgba(255, 160, 122, 0.3);
      box-shadow:
        0 4px 16px rgba(255, 99, 71, 0.1),
        inset 0 1px 0 rgba(255,255,255,0.8);
    }

    /* Question Text - Bold and clear */
    .question-text {
      font-family: var(--font-display);
      font-size: clamp(1.3rem, 3.5vh, 1.7rem);
      font-weight: 700;
      color: #2D3436;
      margin-bottom: var(--space-md);
      line-height: 1.4;
      padding: 0 var(--space-sm);
    }

    .question-hint {
      font-family: var(--font-reading);
      font-size: var(--text-base);
      color: #5D4037;
      font-style: italic;
      margin-bottom: var(--space-lg);
      padding: 10px 16px;
      background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
      border-radius: 12px;
      display: inline-block;
      border: 2px solid rgba(255, 193, 7, 0.4);
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.15);
    }

    /* Bonus phonics question */
    .bonus-question {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
      padding: var(--space-sm) var(--space-md);
      background: linear-gradient(135deg, var(--accent-golden-pale) 0%, var(--accent-mint-pale) 100%);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .bonus-icon {
      font-size: 1.2rem;
    }

    .bonus-text {
      font-style: italic;
    }

    /* Success feedback */
    .success-feedback {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      margin-top: var(--space-md);
      padding: var(--space-md);
      background: linear-gradient(135deg, var(--success-green-pale) 0%, var(--accent-mint-pale) 100%);
      border-radius: var(--radius-lg);
      animation: feedback-appear 0.5s ease-out;
    }

    @keyframes feedback-appear {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .success-icon {
      font-size: 1.5rem;
    }

    .success-text {
      font-family: var(--font-display);
      font-size: var(--text-base);
      font-weight: 600;
      color: #2D7D68;
    }

    .answer-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-md);
      max-width: 560px;
      margin: 0 auto;
    }

    /* Fallback for narrow screens - 2 columns */
    @media screen and (max-width: 500px) {
      .answer-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .answer-btn {
      min-height: var(--touch-lg);
      padding: var(--space-md);
      background: linear-gradient(180deg, #FFFFFF 0%, #FFF8F2 100%);
      border: 3px solid #E0D4C8;
      border-radius: 16px;
      cursor: pointer;
      transition: all var(--anim-fast) var(--ease-out-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      box-shadow:
        0 4px 0 #C8BDB0,
        0 6px 12px rgba(139, 90, 43, 0.1);
    }

    .answer-btn:hover:not(:disabled):not(.wrong) {
      border-color: #64B5F6;
      background: linear-gradient(180deg, #FFFFFF 0%, #E3F2FD 100%);
      transform: translateY(-4px) scale(1.03);
      box-shadow:
        0 6px 0 #42A5F5,
        0 10px 20px rgba(33, 150, 243, 0.2);
    }

    .answer-btn:active:not(:disabled):not(.wrong) {
      transform: translateY(2px) scale(0.98);
      box-shadow:
        0 2px 0 #C8BDB0,
        0 3px 6px rgba(139, 90, 43, 0.1);
    }

    .answer-btn.correct {
      border-color: var(--success-green);
      background:
        linear-gradient(135deg, var(--success-green-pale) 0%, var(--accent-mint-pale) 100%);
      animation: correct-celebrate 0.6s var(--ease-bounce);
      box-shadow:
        0 4px 0 var(--success-green-soft),
        var(--shadow-mint);
    }

    @keyframes correct-celebrate {
      0% { transform: scale(1); }
      30% { transform: scale(1.08) rotate(-2deg); }
      60% { transform: scale(1.08) rotate(2deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    .answer-btn.wrong {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
      filter: grayscale(30%);
    }

    .answer-btn .answer-icon {
      font-size: 2.8rem;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }

    .answer-btn .answer-text {
      font-family: var(--font-display);
      font-size: var(--text-lg);
      font-weight: 600;
      color: var(--text-primary);
    }

    .answer-btn .answer-desc {
      font-family: var(--font-reading);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* ===== MENU STORY ===== */
    .menu-story {
      font-family: var(--font-reading);
      font-size: var(--text-lg);
      color: var(--text-primary);
      text-align: center;
      margin-bottom: var(--space-md);
      padding: var(--space-md);
      background:
        linear-gradient(135deg, var(--accent-golden-pale) 0%, var(--accent-peach-pale) 100%);
      border-radius: var(--radius-lg);
      line-height: 1.6;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(249, 213, 110, 0.3);
    }

    /* ===== REWARD SCREEN ===== */
    .reward-screen {
      background:
        radial-gradient(ellipse at 50% 30%, var(--accent-golden-soft) 0%, transparent 50%),
        radial-gradient(ellipse at 30% 80%, var(--accent-mint-pale) 0%, transparent 40%),
        radial-gradient(ellipse at 70% 80%, var(--accent-coral-pale) 0%, transparent 40%),
        linear-gradient(180deg, var(--accent-golden-pale) 0%, var(--bg-cream-warm) 100%);
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: var(--space-xl);
    }

    .reward-celebration {
      font-size: 4.5rem;
      margin-bottom: var(--space-lg);
      animation: celebration-bounce 1.2s var(--ease-gentle) infinite;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    }

    @keyframes celebration-bounce {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.08) rotate(-4deg); }
      75% { transform: scale(1.08) rotate(4deg); }
    }

    .reward-title {
      font-family: var(--font-display);
      font-size: var(--text-3xl);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .reward-message {
      font-size: var(--text-lg);
      color: var(--text-secondary);
      margin-bottom: var(--space-xl);
    }

    .sticker-earned {
      font-size: 3.5rem;
      padding: var(--space-lg);
      background:
        linear-gradient(180deg, #FFFFFF 0%, var(--bg-cream-warm) 100%);
      border-radius: var(--radius-2xl);
      box-shadow:
        var(--shadow-xl),
        0 0 0 4px var(--accent-golden-soft),
        0 0 30px rgba(249, 213, 110, 0.3);
      margin-bottom: var(--space-xl);
      animation: sticker-appear 0.6s var(--ease-bounce);
      position: relative;
    }

    /* Sparkle effect around sticker */
    .sticker-earned::before,
    .sticker-earned::after {
      content: '';
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--accent-golden);
      border-radius: 50%;
      animation: sparkle 1.5s ease-in-out infinite;
    }

    .sticker-earned::before {
      top: -8px;
      right: -8px;
      animation-delay: 0s;
    }

    .sticker-earned::after {
      bottom: -8px;
      left: -8px;
      animation-delay: 0.75s;
    }

    @keyframes sparkle {
      0%, 100% {
        transform: scale(0.5);
        opacity: 0.3;
      }
      50% {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes sticker-appear {
      0% {
        transform: scale(0) rotate(-180deg);
        opacity: 0;
      }
      60% {
        transform: scale(1.15) rotate(10deg);
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    /* ===== PARENT SETTINGS MODAL ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(40, 40, 40, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all var(--anim-fast) var(--ease-gentle);
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--bg-cream-warm);
      border-radius: var(--radius-2xl);
      padding: var(--space-xl);
      max-width: 420px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
      border: 1px solid rgba(255,255,255,0.5);
      transform: translateY(20px);
      transition: transform var(--anim-medium) var(--ease-out-soft);
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-title {
      font-family: var(--font-display);
      font-size: var(--text-2xl);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-lg);
      text-align: center;
    }

    .setting-group {
      margin-bottom: var(--space-lg);
      padding: var(--space-md);
      background: rgba(255,255,255,0.6);
      border-radius: var(--radius-lg);
    }

    .setting-label {
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: var(--space-sm);
      display: block;
      font-size: var(--text-sm);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .setting-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background:
        linear-gradient(180deg, var(--bg-soft-blue) 0%, var(--mrt-blue-whisper) 100%);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-inner);
    }

    .toggle-switch {
      width: 56px;
      height: 32px;
      background: var(--panel-silver);
      border-radius: var(--radius-full);
      position: relative;
      cursor: pointer;
      transition: all var(--anim-fast) var(--ease-out-soft);
      box-shadow: var(--shadow-inner);
    }

    .toggle-switch.active {
      background: var(--success-green);
      box-shadow:
        var(--shadow-inner),
        0 0 8px rgba(125, 213, 144, 0.4);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 26px;
      height: 26px;
      background:
        linear-gradient(180deg, #FFFFFF 0%, #F5F5F5 100%);
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform var(--anim-fast) var(--ease-out-soft);
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.15),
        0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .toggle-switch.active::after {
      transform: translateX(26px);
    }

    .modal-close {
      width: 100%;
      min-height: 56px;
      background:
        linear-gradient(135deg, var(--mrt-blue) 0%, var(--mrt-blue-soft) 100%);
      color: var(--text-inverse);
      border: none;
      border-radius: var(--radius-xl);
      font-family: var(--font-display);
      font-size: var(--text-lg);
      font-weight: 600;
      cursor: pointer;
      margin-top: var(--space-lg);
      transition: all var(--anim-fast) var(--ease-out-soft);
      box-shadow:
        0 4px 0 rgba(50, 100, 140, 0.35),
        var(--shadow-blue);
    }

    .modal-close:hover {
      transform: translateY(-2px);
      box-shadow:
        0 6px 0 rgba(50, 100, 140, 0.3),
        0 4px 16px rgba(74, 144, 194, 0.35);
    }

    .modal-close:active {
      transform: translateY(2px);
      box-shadow:
        0 2px 0 rgba(50, 100, 140, 0.35),
        var(--shadow-sm);
    }

    /* Reset button styling */
    .reset-btn {
      width: 100%;
      min-height: 48px;
      background:
        linear-gradient(180deg, var(--accent-coral-pale) 0%, var(--error-pale) 100%);
      color: #A54545;
      border: 2px solid var(--accent-coral-soft);
      border-radius: var(--radius-lg);
      font-family: var(--font-display);
      font-size: var(--text-base);
      font-weight: 600;
      cursor: pointer;
      margin-top: var(--space-sm);
      transition: all var(--anim-fast) var(--ease-out-soft);
    }

    .reset-btn:hover {
      background:
        linear-gradient(180deg, var(--accent-coral-soft) 0%, var(--accent-coral-pale) 100%);
      border-color: var(--accent-coral);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      body {
        padding: var(--space-sm);
      }

      .app-container {
        border-radius: var(--radius-xl);
        max-height: none;
        height: 100%;
      }

      .app-container::before,
      .app-container::after {
        display: none;
      }

      .header-title {
        font-size: var(--text-lg);
      }

      .elevator-screen {
        flex-direction: column;
      }

      .elevator-panel {
        width: 100%;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: center;
        gap: var(--space-xs);
      }

      .floor-btn {
        width: auto;
        min-width: 70px;
        flex: 1;
        max-width: 100px;
        min-height: 60px;
        padding: var(--space-xs);
      }

      .floor-btn .floor-num {
        font-size: var(--text-xl);
      }

      .floor-btn .floor-name {
        font-size: var(--text-xs);
      }

      .sentence-display {
        font-size: var(--text-xl);
      }

      .station-btn {
        min-width: 240px;
      }
    }

    @media (max-width: 500px) {
      .sentence-display {
        font-size: var(--text-lg);
      }

      .welcome-title {
        font-size: var(--text-2xl);
      }

      .answer-grid {
        grid-template-columns: 1fr;
      }

      .reading-section {
        padding: var(--space-md);
      }

      .reading-section::before,
      .reading-section::after {
        display: none;
      }
    }

    /* iPad Mini specific */
    @media (min-width: 744px) and (max-width: 820px) {
      .app-container {
        max-width: 100%;
        max-height: 100%;
        border-radius: 0;
      }
    }

    /* Landscape orientation */
    @media (orientation: landscape) and (max-height: 500px) {
      .elevator-screen {
        flex-direction: row;
      }

      .elevator-panel {
        width: 150px;
      }
    }
  </style>
</head>
<body>
	  <div class="app-container">
	    <!-- Header -->
	    <header class="header">
	      <div class="header-title">
	        <span>MRT Food Adventure</span>
	      </div>
		      <div class="header-controls">
		        <button class="control-btn control-text-btn" id="homeBtn" title="Home">Home</button>
		        <button class="control-btn control-text-btn" id="skillsBtn" title="Skills">Skills</button>
		        <button class="control-btn control-text-btn" id="soundToggle" title="Audio">Audio</button>
		        <button class="control-btn control-text-btn" id="calmModeToggle" title="Calm Mode">Calm</button>
		        <button class="control-btn control-text-btn" id="settingsBtn" title="Settings">Settings</button>
		      </div>
		    </header>

    <!-- Progress Bar -->
	    <div class="progress-container">
	      <span class="progress-label">Today's Progress</span>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
	      <div class="sticker-count">
	        <span>Stickers</span>
	        <span id="stickerCount">0</span>
	      </div>
	    </div>

    <!-- Main Content Area -->
    <main class="main-content">

      <!-- Welcome Screen -->
	      <section class="screen welcome-screen active" id="welcomeScreen">
	        <img class="welcome-mascot" src="assets/mascot.png" alt="Friendly food spirit mascot" />
	        <h1 class="welcome-title">Welcome, Isaiah!</h1>
	        <p class="welcome-subtitle">Let's ride and eat! Pick a place to go.</p>
	        <button class="big-btn primary" onclick="goToScreen('mrtScreen')">
	          <span>Start</span>
	        </button>
	      </section>

	      <!-- MRT Map Screen -->
		      <section class="screen mrt-screen" id="mrtScreen">
		        <h2 class="mrt-title" style="font-family: var(--transit-font); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 800;">Taipei MRT Network</h2>
	        <p class="welcome-subtitle" style="margin: -4px auto 16px; text-align: center; color: #546E7A; font-size: 0.9rem; font-family: var(--transit-font); font-weight: 600;">Choose your destination station</p>
	        <div class="mrt-map" id="mrtMap">
	          <div class="mrt-line"></div>
	          <!-- Stations generated dynamically -->
	        </div>
	        <div class="level-indicator">
	          <span class="level-badge level-1">Red Line</span>
	          <span class="level-badge level-2">Blue Line</span>
	          <span class="level-badge level-3">Green Line</span>
	          <span class="level-badge level-4">Orange Line</span>
	        </div>
	      </section>

	      <!-- Skills Screen -->
		      <section class="screen mrt-screen" id="skillsScreen">
		        <h2 class="mrt-title">Skill Practice</h2>
	        <p class="welcome-subtitle" style="margin: 0 auto var(--space-md); text-align: center;">
	          Practice phonics, vocabulary, and comprehension.
	        </p>
	        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: var(--space-md);">
	          <button class="control-btn skills-filter-btn" id="skillsFilterAll" title="All Levels">All</button>
	          <button class="control-btn skills-filter-btn" id="skillsFilter1" title="Level 1">Level 1</button>
	          <button class="control-btn skills-filter-btn" id="skillsFilter2" title="Level 2">Level 2</button>
	          <button class="control-btn skills-filter-btn" id="skillsFilter3" title="Level 3">Level 3</button>
	          <button class="control-btn skills-filter-btn" id="skillsFilter4" title="Level 4">Level 4</button>
	        </div>
	        <div id="skillsList" class="mrt-map" style="padding-top: 0;">
	          <!-- Skills generated dynamically -->
	        </div>
		        <div style="text-align: center; margin-top: var(--space-md);">
		          <button class="big-btn secondary" onclick="goToScreen('mrtScreen')">
		            <span>Back to Map</span>
		          </button>
		        </div>
		      </section>

      <!-- MRT Ride Animation - Train Window Experience -->
      <section class="screen mrt-ride-screen" id="mrtRideScreen">

        <!-- Scenery Container (what you see through the window) -->
        <div class="scenery-container">

          <!-- Sky Layer (furthest back) -->
          <div class="sky-layer">
            <div class="celestial-body"></div>
          </div>

          <!-- Floating Clouds -->
          <div class="cloud-layer">
            <div class="cloud cloud-1"></div>
            <div class="cloud cloud-2"></div>
            <div class="cloud cloud-3"></div>
            <div class="cloud cloud-1" style="left: 110%;"></div>
            <div class="cloud cloud-2" style="left: 140%;"></div>
          </div>

          <!-- Distant Mountains (parallax layer 1 - slowest) -->
          <div class="mountains-layer">
            <div class="mountain mountain-1"></div>
            <div class="mountain mountain-2"></div>
            <div class="mountain mountain-3"></div>
            <div class="mountain mountain-4"></div>
            <div class="mountain mountain-5"></div>
            <div class="mountain mountain-6"></div>
            <div class="mountain mountain-7"></div>
          </div>

          <!-- Rolling Hills (parallax layer 2) -->
          <div class="hills-layer">
            <div class="hill hill-1"></div>
            <div class="hill hill-2"></div>
            <div class="hill hill-3"></div>
            <div class="hill hill-4"></div>
            <div class="hill hill-5"></div>
            <div class="hill hill-6"></div>
            <div class="hill hill-7"></div>
          </div>

	          <!-- Trees (parallax layer 3 - fastest) -->
	          <div class="trees-layer">
	            <div class="trees-strip">
	              <div class="tree tree-1"></div>
	              <div class="tree tree-2"></div>
	              <div class="tree tree-3"></div>
	              <div class="tree tree-4"></div>
	              <div class="tree tree-5"></div>
	              <div class="tree tree-6"></div>
	              <div class="tree tree-7"></div>
	              <div class="tree tree-8"></div>
	              <div class="tree tree-9"></div>
	              <div class="tree tree-10"></div>
	              <div class="tree tree-11"></div>
	              <div class="tree tree-12"></div>
	              <div class="tree tree-13"></div>
	              <div class="tree tree-14"></div>
	            </div>
	            <div class="trees-strip" aria-hidden="true">
	              <div class="tree tree-1"></div>
	              <div class="tree tree-2"></div>
	              <div class="tree tree-3"></div>
	              <div class="tree tree-4"></div>
	              <div class="tree tree-5"></div>
	              <div class="tree tree-6"></div>
	              <div class="tree tree-7"></div>
	              <div class="tree tree-8"></div>
	              <div class="tree tree-9"></div>
	              <div class="tree tree-10"></div>
	              <div class="tree tree-11"></div>
	              <div class="tree tree-12"></div>
	              <div class="tree tree-13"></div>
	              <div class="tree tree-14"></div>
	            </div>
	          </div>

          <!-- Ground Layer -->
          <div class="ground-layer"></div>

          <!-- Train Tracks -->
          <div class="train-track"></div>
          <div class="track-ties"></div>

	          <!-- Themed Floating Elements -->
	          <div class="themed-floaters" id="themedFloaters">
	          </div>

          <!-- Magical Sparkles -->
          <div class="sparkle-layer">
            <div class="sparkle sparkle-1"></div>
            <div class="sparkle sparkle-2"></div>
            <div class="sparkle sparkle-3"></div>
            <div class="sparkle sparkle-4"></div>
            <div class="sparkle sparkle-5"></div>
            <div class="sparkle sparkle-6"></div>
            <div class="sparkle sparkle-7"></div>
            <div class="sparkle sparkle-8"></div>
          </div>

          <!-- Taipei Animated Elements -->
          <div class="taipei-bird taipei-bird-1"></div>
          <div class="taipei-bird taipei-bird-2"></div>
          <div class="taipei-bird taipei-bird-3"></div>
          <div class="taipei-balloon"></div>
          <div class="taipei-distant-train"></div>
          <div class="taipei-lantern taipei-lantern-1"></div>
          <div class="taipei-lantern taipei-lantern-2"></div>
          <div class="taipei-lantern taipei-lantern-3"></div>

        </div>

        <!-- Taiwan MRT Train (outside scenery-container for full-width animation) -->
		        <div class="mrt-train" id="mrtTrain">
		          <!-- Front Car (Driver's Cab) -->
		          <div class="mrt-car mrt-front">
	            <div class="mrt-body">
	              <div class="mrt-stripe"></div>
	              <div class="mrt-front-display"></div>
	              <div class="mrt-windshield"></div>
	              <div class="mrt-headlight mrt-headlight-l"></div>
	              <div class="mrt-headlight mrt-headlight-r"></div>
	            </div>
	            <div class="mrt-windows">
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	            </div>
	            <div class="mrt-door"></div>
	            <div class="mrt-undercarriage">
	              <div class="mrt-wheel"></div>
	              <div class="mrt-wheel"></div>
	            </div>
	          </div>

		          <div class="mrt-connector"></div>

		          <!-- Middle Car 1 -->
		          <div class="mrt-car mrt-middle">
		            <div class="mrt-body">
		              <div class="mrt-stripe"></div>
		            </div>
	            <div class="mrt-windows">
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	            </div>
	            <div class="mrt-door mrt-door-1"></div>
	            <div class="mrt-door mrt-door-2"></div>
	            <div class="mrt-undercarriage">
	              <div class="mrt-wheel"></div>
	              <div class="mrt-wheel"></div>
	            </div>
		          </div>

		          <div class="mrt-connector"></div>

		          <!-- Middle Car 2 -->
		          <div class="mrt-car mrt-middle">
		            <div class="mrt-body">
		              <div class="mrt-stripe"></div>
		            </div>
		            <div class="mrt-windows">
		              <div class="mrt-window"></div>
		              <div class="mrt-window"></div>
		              <div class="mrt-window"></div>
		              <div class="mrt-window"></div>
		              <div class="mrt-window"></div>
		            </div>
		            <div class="mrt-door mrt-door-1"></div>
		            <div class="mrt-door mrt-door-2"></div>
		            <div class="mrt-undercarriage">
		              <div class="mrt-wheel"></div>
		              <div class="mrt-wheel"></div>
		            </div>
		          </div>

		          <div class="mrt-connector"></div>

		          <!-- Middle Car 3 -->
		          <div class="mrt-car mrt-middle">
		            <div class="mrt-body">
		              <div class="mrt-stripe"></div>
		            </div>
		            <div class="mrt-windows">
		              <div class="mrt-window"></div>
		              <div class="mrt-window"></div>
		              <div class="mrt-window"></div>
		              <div class="mrt-window"></div>
		              <div class="mrt-window"></div>
		            </div>
		            <div class="mrt-door mrt-door-1"></div>
		            <div class="mrt-door mrt-door-2"></div>
		            <div class="mrt-undercarriage">
		              <div class="mrt-wheel"></div>
		              <div class="mrt-wheel"></div>
		            </div>
		          </div>

		          <div class="mrt-connector"></div>

		          <!-- Rear Car -->
		          <div class="mrt-car mrt-rear">
		            <div class="mrt-body">
	              <div class="mrt-stripe"></div>
	            </div>
	            <div class="mrt-windows">
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	              <div class="mrt-window"></div>
	            </div>
	            <div class="mrt-door mrt-door-1"></div>
	            <div class="mrt-door mrt-door-2"></div>
	            <div class="mrt-undercarriage">
	              <div class="mrt-wheel"></div>
	              <div class="mrt-wheel"></div>
	            </div>
	          </div>
	        </div>

        <!-- LED Destination Display -->
	        <div class="destination-display">
	          <div class="display-label">Next Stop</div>
	          <div class="display-destination">
	            <span class="display-icon" id="rideIcon" style="display: none;"></span>
	            <span class="display-name" id="destinationName">Fruit Stand</span>
	          </div>
	        </div>

        <!-- Train Window Frame (on top of everything) -->
        <div class="train-window-frame">
          <div class="window-rivet top-left"></div>
          <div class="window-rivet top-right"></div>
          <div class="window-rivet bottom-left"></div>
          <div class="window-rivet bottom-right"></div>
        </div>
      </section>

      <!-- Elevator Screen -->
      <section class="screen elevator-screen" id="elevatorScreen">
        <div class="elevator-shaft" id="elevatorShaft">
          <div class="floor-display" id="floorDisplay">1</div>
          <div class="elevator-doors" id="elevatorDoors">
            <div class="door door-left"></div>
            <div class="door door-right"></div>
            <div class="door-window" id="doorWindow"></div>
          </div>
        </div>
        <div class="elevator-panel">
          <div class="panel-title">Pick a Floor</div>
          <button class="floor-btn active" onclick="selectFloor(1)" id="floor1Btn">
            <span class="floor-num">1</span>
            <span class="floor-name">Lobby</span>
          </button>
	          <button class="floor-btn" onclick="selectFloor(2)" id="floor2Btn">
	            <span class="floor-num">2</span>
	            <span class="floor-name">Warm-Up</span>
	          </button>
          <button class="floor-btn" onclick="selectFloor(3)" id="floor3Btn">
            <span class="floor-num">3</span>
            <span class="floor-name">Restaurant</span>
          </button>
        </div>
      </section>

      <!-- Word Warm-Up Screen (Floor 2) -->
      <!-- Educational purpose: Pre-teaching vocabulary + explicit phonics instruction -->
      <!-- This follows Orton-Gillingham approach: see it, hear it, say it -->
	      <section class="screen warmup-screen" id="warmupScreen">
        <div class="warmup-header">
          <div class="warmup-icon" id="warmupIcon" style="display: none;"></div>
          <h2 class="warmup-title">Word Warm-Up!</h2>
          <p class="warmup-subtitle">Tap a word to hear it and practice. This is optional.</p>
        </div>

        <!-- Phonics Focus Box - Shows digraph/pattern for this station -->
        <div class="phonics-focus-box" id="phonicsFocusBox" style="display: none;">
          <span class="phonics-label">Sound focus</span>
          <span class="phonics-pattern" id="phonicsPattern">SH</span>
          <span class="phonics-example" id="phonicsExample">says shh, like quiet.</span>
        </div>

        <div class="warmup-words" id="warmupWords">
          <!-- Words will be inserted dynamically -->
        </div>

        <div class="warmup-progress">
          <div class="warmup-progress-bar" id="warmupProgressBar"></div>
        </div>

		        <!-- Sight Word Reminder -->
		        <div class="sight-word-reminder" id="sightWordReminder" style="display: none;">
		          <span class="reminder-text">Cards marked <strong>SW</strong> are <strong>sight words</strong>. We memorize them.</span>
		        </div>

        <button class="warmup-continue-btn" id="warmupContinueBtn" onclick="finishWarmup()" style="display: none;">
          <span>Go to Restaurant!</span>
          <span class="arrow" aria-hidden="true"></span>
        </button>
      </section>

      <!-- Restaurant Screen -->
      <section class="screen restaurant-screen" id="restaurantScreen">
        <div class="restaurant-header">
          <img class="restaurant-hero" id="restaurantHero" src="assets/food_fruit.jpeg" alt="Station food" />
          <h2 class="restaurant-name" id="restaurantName">Fruit Stand</h2>
        </div>

        <!-- MRT Lesson Progress - Shows journey through this station's stops -->
        <div class="mrt-progress-bar line-red" id="mrtLessonProgress" style="display: none;">
          <!-- Mobile View: Simple Counter -->
          <div class="mrt-progress-mobile" id="mrtProgressMobile">
            <div class="mrt-progress-counter">
              Stop <span class="mrt-progress-counter-current" id="mobileCurrentStop">1</span> of <span class="mrt-progress-counter-total" id="mobileTotalStops">8</span>
            </div>
            <div class="mrt-progress-simple-bar">
              <div class="mrt-progress-simple-fill" id="mobileProgressFill" style="width: 0%"></div>
            </div>
            <div class="mrt-progress-label" id="mobileStopLabel">Read</div>
          </div>

          <!-- Desktop View: Full Dots -->
          <div class="mrt-progress-desktop">
            <div class="mrt-progress-track" id="mrtProgressTrack">
              <!-- Progress stops will be generated here by JavaScript -->
            </div>
            <div class="mrt-progress-info">
              <span>Riding:</span>
              <span class="mrt-progress-station-name" id="progressStationName">Red Line</span>
            </div>
          </div>
        </div>

	        <div class="reading-section">
	          <div class="sentence-image" id="sentenceImage" style="display: none;"></div>
	          <div class="sentence-display" id="sentenceDisplay">
	            <!-- Words will be inserted here -->
	          </div>

	          <!-- Reading Tip Box - Scaffolding for struggling readers -->
	          <div class="reading-tip-box" id="readingTipBox" style="display: none;">
	            <span class="tip-text" id="readingTipText"></span>
	          </div>

	          <!-- Sight Word Focus - Highlights the focus sight word -->
	          <div class="sight-word-focus" id="sightWordFocus" style="display: none;">
	            <span class="focus-label">Sight Word:</span>
	            <span class="focus-word" id="focusSightWord"></span>
	            <span class="focus-hint" id="sightWordHowToHint">Tap it to hear it. Then find it in the sentence.</span>
	            <span class="focus-hint" id="sightWordSpellHint"></span>
	            <span class="focus-hint" id="sightWordGateText" style="display: none;"></span>
	            <button class="control-btn" id="sightWordSkipBtn" type="button" style="display: none; padding: 6px 10px; font-size: 0.9rem;">Skip</button>
	          </div>

	          <div class="audio-controls">
	            <button class="audio-btn" onclick="playFullSentence()">
	              <span>Read to Me</span>
	            </button>
	            <button class="audio-btn tip-btn" onclick="showReadingTip()" id="tipBtn" style="display: none;">
	              <span>Help</span>
	            </button>
	          </div>
        </div>

        <div class="menu-section" id="menuSection" style="display: none;">
          <div class="menu-story" id="menuStory" style="display: none;"></div>
          <div class="menu-prompt">What do you want?</div>
          <div class="menu-grid" id="menuGrid">
            <!-- Menu items inserted dynamically -->
          </div>
        </div>

        <div class="question-section" id="questionSection" style="display: none;">
	          <div class="passage-box" id="passageBox" style="display: none; margin-bottom: var(--space-md); max-width: 560px; margin-left: auto; margin-right: auto;">
	            <div class="passage-header">
	              <span class="passage-icon"></span>
	              <span class="passage-title">Reading Passage</span>
	              <button class="control-btn passage-read-btn" id="passageReadBtn" type="button">Read</button>
	            </div>
	            <div class="passage-body" id="passageText"></div>
	          </div>

          <div class="question-text" id="questionText">What did you pick?</div>
          <div class="question-hint" id="questionHint" style="display: none;"></div>

          <!-- Bonus phonics question for digraph stations -->
          <div class="bonus-question" id="bonusQuestion" style="display: none;">
            <span class="bonus-text" id="bonusQuestionText"></span>
          </div>

          <div class="answer-grid" id="answerGrid">
            <!-- Answer buttons inserted dynamically -->
          </div>

          <!-- Success feedback with learning reinforcement -->
          <div class="success-feedback" id="successFeedback" style="display: none;">
            <span class="success-text" id="successFeedbackText"></span>
          </div>
        </div>

        <div style="text-align: center; margin-top: auto; padding-top: var(--space-md);">
          <button class="big-btn secondary" id="continueBtn" style="display: none;" onclick="continueStory()">
            <span>Next</span>
            <span aria-hidden="true"></span>
          </button>
        </div>
      </section>

	      <!-- Reward Screen -->
		      <section class="screen reward-screen" id="rewardScreen">
		        <div class="reward-celebration"></div>
		        <h2 class="reward-title">Great Job!</h2>
		        <p class="reward-message" id="rewardMessage">You read and ordered food!</p>
		        <div class="sticker-earned" id="stickerEarned"></div>
		        <button class="big-btn primary" onclick="finishReward()" id="rewardContinueBtn">
		          <span id="rewardContinueText">Keep Going!</span>
		        </button>
		      </section>

    </main>
  </div>

  <!-- Parent Settings Modal -->
		  <div class="modal-overlay" id="settingsModal">
		    <div class="modal-content">
		      <h3 class="modal-title">Parent Settings</h3>

	      <div class="setting-group">
	        <label class="setting-label">Sound</label>
	        <div class="setting-toggle">
	          <span>Enable Sound</span>
	          <div class="toggle-switch active" id="soundSettingToggle" onclick="toggleSetting('sound')"></div>
	        </div>
	      </div>

	      <div class="setting-group">
	        <label class="setting-label">Calm Mode</label>
	        <div class="setting-toggle">
	          <span>Reduce animations &amp; colors</span>
	          <div class="toggle-switch" id="calmSettingToggle" onclick="toggleSetting('calm')"></div>
	        </div>
	      </div>

	      <div class="setting-group">
	        <label class="setting-label">Reading Supports</label>
	        <div class="setting-toggle">
	          <span>Mark sight words in sentences</span>
	          <div class="toggle-switch active" id="sightWordMarksSettingToggle" onclick="toggleSetting('sightWordMarks')"></div>
	        </div>
	        <div class="setting-toggle">
	          <span>Tap sight word to unlock Next</span>
	          <div class="toggle-switch active" id="sightWordGateSettingToggle" onclick="toggleSetting('sightWordGate')"></div>
	        </div>
	      </div>

	      <div class="setting-group">
	        <label class="setting-label">Progress</label>
	        <div class="setting-toggle">
	          <span>Pages completed today: <strong id="pagesCompleted">0</strong></span>
	        </div>
	      </div>

      <div class="setting-group">
        <label class="setting-label">Words Mastered</label>
        <div class="setting-toggle">
          <span id="wordsMastered">0</span> / <span id="wordsTotal">50</span>
        </div>
      </div>

      <div class="setting-group">
        <label class="setting-label">Stations Completed</label>
        <div class="setting-toggle">
          <span id="stationsCompleted">0</span> / 8
        </div>
      </div>

      <div class="setting-group">
        <label class="setting-label">Reset Progress</label>
        <div class="setting-toggle">
	        <button onclick="resetProgress()" style="padding: 8px 16px; background: var(--accent-coral); color: white; border: none; border-radius: 8px; cursor: pointer;">Reset All</button>
	        </div>
	      </div>

	      <button class="modal-close" onclick="closeSettings()">Done</button>
	    </div>
	  </div>

  <script>
    // ===== GAME STATE =====
	    const state = {
	      currentScreen: 'welcomeScreen',
	      currentStation: null,
	      currentFloor: 1,
	      currentPage: 0,
	      sessionPages: null,
	      stickers: 0,
	      pagesCompleted: 0,
	      soundEnabled: true,
	      calmMode: false,
	      sightWordMarksEnabled: true,
	      sightWordGateEnabled: true,
	      completedStations: [],
	      masteredWords: new Set(),
	      currentOrder: null,
	      stationTransitionTimeoutId: null,
	      requiredSightWord: null,
      sightWordGateSatisfied: true,
      sightWordSkipTimeoutId: null,
      practiceSkillId: null,
      practiceCorrect: 0,
      practiceFirstTryCorrect: 0,
      practiceTotal: 0,
	      skillsLevelFilter: 'all',
	    };

	    function pickRandom(array) {
	      if (!Array.isArray(array) || array.length === 0) return null;
	      return array[Math.floor(Math.random() * array.length)];
	    }

	    function escapeRegExp(text) {
	      return String(text || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
	    }

	    function blankFirstWordOccurrence(sentence, word) {
	      const text = String(sentence || '');
	      const target = String(word || '').trim();
	      if (!text || !target) return null;

	      const escaped = escapeRegExp(target);
	      const re = new RegExp(`(^|[^A-Za-z'])(${escaped})(?=[^A-Za-z']|$)`, 'i');
	      if (!re.test(text)) return null;
	      return text.replace(re, (_, lead) => `${lead}____`);
	    }

	    function buildSightWordCheckPage({ station, sourceSentence, focusWord }) {
	      const blanked = blankFirstWordOccurrence(sourceSentence, focusWord);
	      if (!blanked) return null;

	      const stationSightWords = Array.isArray(station?.sightWords) ? station.sightWords : [];
	      const bankSightWords = Array.isArray(skillWordBanks?.sightWords) ? skillWordBanks.sightWords : [];
	      const normalizedFocus = String(focusWord || '').toLowerCase();
	      const pool = [...stationSightWords, ...bankSightWords]
	        .filter(w => w && String(w).toLowerCase() !== normalizedFocus);
	      const distractors = pickDistinct(pool, 2);
	      const answers = shuffleInPlace([focusWord, ...distractors].filter(Boolean));

	      const stems = [
	        { q: 'Which sight word completes the sentence?', h: 'Read the sentence again. Sight words are words you learn by heart.' },
	        { q: 'Fill in the blank with the sight word.', h: 'Look at the blank. Which word makes the sentence sound right?' },
	        { q: 'Which word fits in the blank?', h: 'Try reading the sentence out loud with each word.' }
	      ];
	      const stem = pickOne(stems);
	      return makeMCQ({
	        passage: blanked,
	        question: stem.q,
	        hint: stem.h,
	        answers,
	        correctAnswerName: focusWord,
	        successMessage: 'Nice! You used the sight word in a sentence.'
	      });
	    }

	    function buildSightWordPracticePassage(word, bank) {
	      const w = String(word || '').trim();
	      if (!w) return '';

	      const lower = w.toLowerCase();
	      const noun = pickOne(bank?.nouns || ['dog', 'cat', 'book']);
	      const noun2 = pickOne((bank?.nouns || ['dog', 'cat', 'book']).filter(n => n !== noun)) || noun;
	      const place = pickOne(bank?.nounTypes?.place || ['school', 'park', 'home']);
	      const person = pickOne(bank?.nounTypes?.person || ['Mom', 'Dad', 'Teacher']);
	      const verb = pickOne(bank?.verbs || ['run', 'read', 'play']);
	      const verb2 = pickOne((bank?.verbs || ['run', 'read', 'play']).filter(v => v !== verb)) || verb;
	      const adj = pickOne(bank?.adjectives || ['big', 'small', 'happy']);

	      const templates = {
	        the: [
	          () => `The ${noun} is ${adj}.`,
	          () => `The ${noun2} can ${verb}.`
	        ],
	        and: [
	          () => `I see a ${noun} and a ${noun2}.`,
	          () => `We ${verb} and ${verb2}.`
	        ],
	        to: [
	          () => `We go to the ${place}.`,
	          () => `I like to ${verb}.`
	        ],
	        a: [
	          () => `I see a ${noun}.`,
	          () => `I want a ${noun2}.`
	        ],
	        i: [
	          () => `I ${verb}.`,
	          () => `I have a ${noun}.`
	        ],
	        see: [
	          () => `I see the ${noun}.`,
	          () => `Can you see the ${noun2}?`
	        ],
	        want: [
	          () => `I want a ${noun}.`,
	          () => `We want to ${verb}.`
	        ],
	        can: [
	          () => `I can ${verb}.`,
	          () => `The ${noun} can ${verb2}.`
	        ],
	        my: [
	          () => `This is my ${noun}.`,
	          () => `My ${noun2} is ${adj}.`
	        ],
	        is: [
	          () => `The ${noun} is ${adj}.`,
	          () => `This is a ${noun2}.`
	        ],
	        you: [
	          () => `You can ${verb}.`,
	          () => `Do you see the ${noun}?`
	        ],
	        we: [
	          () => `We ${verb}.`,
	          () => `We go to the ${place}.`
	        ],
	        like: [
	          () => `I like ${noun}.`,
	          () => `We like to ${verb}.`
	        ],
	        have: [
	          () => `I have a ${noun}.`,
	          () => `They have a ${noun2}.`
	        ],
	        this: [
	          () => `This is my ${noun}.`,
	          () => `This ${noun2} is ${adj}.`
	        ],
	        there: [
	          () => `There is a ${noun}.`,
	          () => `There is a ${noun2} here.`
	        ],
	        they: [
	          () => `They ${verb}.`,
	          () => `They have a ${noun}.`
	        ],
	        with: [
	          () => `I go with ${person}.`,
	          () => `I play with my ${noun}.`
	        ],
	        said: [
	          () => `${person} said stop.`,
	          () => `Ben said come here.`
	        ],
	        come: [
	          () => `Come here.`,
	          () => `Come with me.`
	        ],
	        here: [
	          () => `Come here.`,
	          () => `I am here.`
	        ],
	        it: [
	          () => `It is ${adj}.`,
	          () => `It can ${verb}.`
	        ]
	      };

	      const fns = templates[lower] || [
	        () => `Sight word: ${w}.`,
	        () => `I see the word ${w}.`
	      ];
	      const sentences = [fns[0](), fns[1]()].filter(Boolean);
	      return sentences.join(' ');
	    }

	    function buildSessionPagesForStation(stationId) {
	      const station = stationContent[stationId];
	      if (!station || !Array.isArray(station.pages)) return null;

	      const resolved = station.pages.map(page => {
	        if (!page || !Array.isArray(page.variants) || page.variants.length === 0) return page;
	        const variant = pickRandom(page.variants);
	        if (!variant) return page;
	        const merged = { ...page, ...variant };
	        delete merged.variants;
	        return merged;
	      });

	      // Build a coherent session flow:
	      // - Resolve variants once per session
	      // - Insert a quick, connected sight-word check the first time each focus sight word appears
	      const withSightWordChecks = [];
	      const seenFocusWords = new Set();
	      resolved.forEach(page => {
	        withSightWordChecks.push(page);
	        if (!page || page.type !== 'read') return;
	        if (!page.sightWordFocus || page.autoSightWordQuestion === false) return;

	        const focusWord = String(page.sightWordFocus || '').trim();
	        const key = focusWord.toLowerCase();
	        if (!focusWord || seenFocusWords.has(key)) return;

	        const check = buildSightWordCheckPage({
	          station,
	          sourceSentence: page.sentence || '',
	          focusWord
	        });
	        if (check) {
	          withSightWordChecks.push(check);
	          seenFocusWords.add(key);
	        }
	      });

	      return withSightWordChecks;
	    }

      function splitSentenceIntoWords(sentence) {
	      if (!sentence || typeof sentence !== 'string') return [];
	      const matches = sentence.match(/\S+/g);
	      return matches ? matches : [];
	    }

      function getCurrentStationPages() {
	      const station = stationContent[state.currentStation];
	      if (!station) return [];
	      const pages = Array.isArray(state.sessionPages) ? state.sessionPages : station.pages;
	      return Array.isArray(pages) ? pages : [];
	    }

	    function getCurrentPage() {
	      const pages = getCurrentStationPages();
	      return pages[state.currentPage] || null;
	    }

    // ===== BOOK CONTENT =====
    // EDUCATIONAL DESIGN PHILOSOPHY (Science of Reading aligned)
    //
    // FIVE PILLARS OF READING INSTRUCTION:
    // 1. PHONEMIC AWARENESS: Explicit sound-symbol teaching via teachWord feature
    // 2. PHONICS: Systematic progression from CVC to digraphs (SH, TH, CH)
    // 3. FLUENCY: "Read to Me" with word highlighting for modeling fluent reading
    // 4. VOCABULARY: Previewed words + sight word focus on each page
    // 5. COMPREHENSION: Recall questions linked to personal choices
    //
    // Progressive difficulty levels:
    // Level 1: CVC words, 4-5 word sentences (fruit, drink, bakery)
    //          - High-frequency sight words: I, see, a, the, is, my, want, like, can
    //          - Simple sentence structures
    // Level 2: Longer words, adjectives (pizza, ice cream)
    //          - 2-syllable words, compound words
    //          - More descriptive language
    // Level 3: Introduce digraphs - SH words (fish shop)
    //          - Explicit phonics: SH says "shh" like a secret
    //          - Word position awareness (start vs end)
    // Level 4: TH and CH digraphs (cheese shop, the noodle house)
    //          - Multiple digraphs in context
    //          - Longer passages with multiple sentences
    //
    // AUTISM-SPECIFIC ADAPTATIONS:
    // - Predictable story structure: Arrival -> Exploration -> Choice -> Enjoyment
    // - Literal language (no idioms)
    // - Visual supports (emoji images)
    // - Errorless learning (wrong answers guide to correct)
    // - Calm mode for sensory regulation

    // ===== FEEDBACK MESSAGES =====
    // Varied, encouraging messages for correct answers
    const correctFeedback = [
      { message: "Yes! Great job!", emoji: "star" },
      { message: "You got it! Amazing!", emoji: "celebrate" },
      { message: "That's right! Super!", emoji: "thumbsup" },
      { message: "Wow! You did it!", emoji: "wow" },
      { message: "Perfect! Well done!", emoji: "perfect" },
      { message: "Yes! You are so smart!", emoji: "brain" },
      { message: "Hooray! You know it!", emoji: "party" },
      { message: "Great reading!", emoji: "book" }
    ];

    // Gentle, supportive messages for incorrect answers
    const incorrectFeedback = [
      { message: "Hmm, look at the words again. Try the {item}.", hint: "words" },
      { message: "Almost! Remember what you picked? It was the {item}.", hint: "memory" },
      { message: "Let's try again. You wanted the {item}.", hint: "retry" },
      { message: "Look carefully. The {item} is what you chose!", hint: "look" },
      { message: "Think back to your choice. It was the {item}!", hint: "think" }
    ];

    // Gentle, supportive messages for story-detail questions (not just "what did you pick?")
    const incorrectFeedbackStory = [
      { message: "Almost! Look back at the story. Try {item}.", hint: "story" },
      { message: "Let's check the hint sentence. The answer is {item}.", hint: "hint" },
      { message: "Good try. Remember the story detail: {item}.", hint: "remember" },
      { message: "Try again. The story says {item}.", hint: "story" },
      { message: "Look carefully. It's {item}.", hint: "look" }
    ];

    // Helper function to get random feedback
    function getRandomFeedback(isCorrect, itemName = '', context = 'choice') {
      if (isCorrect) {
        const feedback = correctFeedback[Math.floor(Math.random() * correctFeedback.length)];
        return feedback.message;
      } else {
        const bank = context === 'story' ? incorrectFeedbackStory : incorrectFeedback;
        const feedback = bank[Math.floor(Math.random() * bank.length)];
        return feedback.message.replace('{item}', itemName);
      }
    }

    const stationContent = {
      // ===== LEVEL 1: CVC WORDS, SIMPLE SENTENCES =====
      // Focus: High-frequency sight words (I, see, a, the, is, my, want, like, good, can)
      // Sentence length: 3-5 words
      // Story structure: Arrival -> Exploration -> Choice -> Enjoyment
      fruit: {
        name: 'Fruit Stand',
        icon: '',
        level: 1,
        floor: 3,
        stickers: ['', '', '', ''],
        // Level 1 Focus: CVC words (red, big) + high-frequency sight words
        // Phonics pattern: Short vowel sounds (a in apple, e in red)
        sightWords: ['I', 'see', 'a', 'the', 'is', 'my', 'want', 'like', 'can', 'good'],
        previewWords: [
          { word: 'apple', icon: '', isSightWord: false, phonicsNote: 'a-p-p-le' },
          { word: 'red', icon: '', isSightWord: false, phonicsNote: 'r-e-d (CVC)' },
          { word: 'want', icon: '', isSightWord: true },
          { word: 'see', icon: '', isSightWord: true }
        ],
        pages: [
          {
            type: 'read',
            image: '',
            sentence: 'I am at the fruit stand. I see fruit on a big table. Red apples are in a bin. The apples are so red! Yellow bananas sit next to them. The bananas are so yellow! I can see oranges too. The fruit looks so good.',
            words: null,
            variants: [
              { sentence: 'I am at the fruit stand. I see fruit on the table. There is so much to see! Red apples are in a big bin. Yellow bananas sit next to them. I walk up close. The fruit looks so good.', words: null },
              { sentence: 'I am at the fruit stand. The fruit sits on the table. I look at all the colors! Red apples fill a big bin. Yellow bananas are next to them. I step up to see. The fruit looks so good.', words: null },
              { sentence: 'I am at the fruit stand. A table holds the fruit. I see so many kinds! Red apples are in a big bin. Yellow bananas sit by them. I walk up to the table. The fruit looks so good.', words: null }
            ],
            targetWords: ['I', 'am', 'at', 'the', 'fruit'],
            sightWordFocus: 'the',
            requireSightWordTap: true,
            readingTip: 'Tap the word the. Then find it in the sentence.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'I am at the fruit stand.',
            question: 'Where does the story happen?',
            comprehensionHint: 'Read the sentence. What place is named?',
            variants: [
              { question: 'Where am I?', comprehensionHint: 'Read the sentence. What place is named?' },
              { question: 'What place am I at?', comprehensionHint: 'Read the first sentence again.' },
              { question: 'What is the setting?', comprehensionHint: 'The setting is where the story happens.' }
            ],
            answers: [
              { name: 'Fruit Stand', icon: '' },
              { name: 'Fruit Shop', icon: '' },
              { name: 'Fruit Store', icon: '' }
            ],
            correctAnswerName: 'Fruit Stand',
            successMessage: 'Yes! You found the setting.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I see the fruit. Red apples are big and round. Big oranges are next to them. Yellow bananas are long. All the fruit looks fresh! The red apples look best to me. I want to pick one.',
            words: null,
            variants: [
              { sentence: 'I see red apples. The red is so bright! I see big oranges. The oranges are so round! I see yellow bananas. The yellow is so pretty! I look at all the fruit. The apples look good. I want to get one.', words: null },
              { sentence: 'I see red apples. I like the red color! I see big oranges. The big ones look good! I see yellow bananas. The yellow is so nice! I count three kinds of fruit. The apples look the best. I want one.', words: null },
              { sentence: 'I see red apples. Red is my favorite! I see big oranges. They are so big and round! I see yellow bananas. Yellow is a happy color! The fruit looks good to me. I like the apples best. I want to eat one.', words: null }
            ],
            targetWords: ['see', 'red', 'apples', 'big', 'oranges', 'yellow', 'bananas'],
            sightWordFocus: 'see',
            readingTip: 'Notice the pattern. I see a color and a fruit. This helps us read faster.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'I see yellow bananas.',
            question: 'Which fruit was yellow?',
            comprehensionHint: 'Find the color word. What fruit is next to it?',
            variants: [
              { question: 'What fruit was yellow in the story?', comprehensionHint: 'Read the sentence. Find the color word first.' },
              { question: 'Which fruit matches the words yellow bananas?', comprehensionHint: 'Read the sentence. Which fruit is yellow?' },
              { question: 'Yellow is a color. What fruit was yellow?', comprehensionHint: 'Two words go together. A color and a fruit.' }
            ],
            answers: [
              { name: 'Banana', icon: '' },
              { name: 'Lemon', icon: '' },
              { name: 'Mango', icon: '' }
            ],
            correctAnswerName: 'Banana',
            successMessage: 'Yes! You remembered a detail from what you read.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I am hungry! My belly wants food. I want fruit. The fruit is fresh and good. I see apples. I see oranges. I see bananas. What will I pick? I think and think. I want the best one!',
            words: null,
            variants: [
              { sentence: 'I am hungry. I need a snack! I want to eat fruit. It looks so good. I think about what I like. Do I want red apples? Do I want big oranges? Do I want yellow bananas? I pick the one I like best.', words: null },
              { sentence: 'I am hungry. I can feel it! I want to eat fruit. The fruit is so nice. I take my time to choose. Red apples look good. Big oranges look good too. Yellow bananas look good also. I want to pick one now.', words: null },
              { sentence: 'I am hungry. My belly is empty! I want to eat fruit. The fruit smells good. I look at the table again. I see red apples. I see big oranges. I see yellow bananas. I think about what I want most.', words: null }
            ],
            targetWords: ['want', 'fruit', 'What'],
            sightWordFocus: 'want',
            readingTip: 'Tap want. Then find it in the sentence.'
          },
          {
            type: 'menu',
            prompt: 'Pick your fruit!',
            menuStory: 'The fruit looks so good. What fruit do you want?',
            variants: [
              { prompt: 'Choose one fruit.', menuStory: 'Read the choices. Then choose one fruit.' },
              { prompt: 'Which fruit will you buy?', menuStory: 'Think about the story: red apples, big oranges, yellow bananas.' },
              { prompt: 'Pick a fruit for your snack.', menuStory: 'Pick one fruit for your snack.' }
            ],
            items: [
              { name: 'Apple', icon: '', description: 'Red and round' },
              { name: 'Orange', icon: '', description: 'Big and juicy' },
              { name: 'Banana', icon: '', description: 'Yellow and sweet' }
            ]
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'I see big oranges.',
            question: 'Which fruit was big?',
            comprehensionHint: 'Find the size word big.',
            variants: [
              { question: 'In the story, which fruit was big?', comprehensionHint: 'Read the sentence with big.' },
              { question: 'Which fruit matches the words big oranges?', comprehensionHint: 'Look for the size word big.' },
              { question: 'Big is a size word. What was big?', comprehensionHint: 'Big comes right before the fruit word.' }
            ],
            answers: [
              { name: 'Oranges', icon: '' },
              { name: 'Apples', icon: '' },
              { name: 'Bananas', icon: '' }
            ],
            correctAnswerName: 'Oranges',
            successMessage: 'Yes! You remembered which fruit was big.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'My fruit is so good! I hold it in my hand. I take a big bite. Yum! It is sweet and fresh. The juice drips down. I chew and chew. I am so happy! This is the best!',
            words: null,
            variants: [
              { sentence: 'My fruit is so good! I look at it first. I take a bite. Mmm! It is so fresh. The taste is just right. I take one more bite. I feel happy. I like my fruit a lot.', words: null },
              { sentence: 'My fruit is so good! I hold my fruit up. I take one bite. Wow! It is so yummy. The fruit is just what I wanted. I smile big. I feel happy. This is the best snack ever!', words: null },
              { sentence: 'My fruit is so good! I am so glad I picked it. I chew my fruit. Yes! It tastes so sweet. The fruit makes me feel good. I am full of joy. I feel happy. I want to come back soon!', words: null }
            ],
            targetWords: ['My', 'is', 'good', 'like', 'lot'],
            sightWordFocus: 'my',
            readingTip: 'My tells us something belongs to me. My fruit. My food. My book.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'I feel happy.',
            question: 'How did I feel?',
            comprehensionHint: 'Look for the feeling word.',
            variants: [
              { question: 'What feeling word does the story use?', comprehensionHint: 'Find the word in the last sentence.' },
              { question: 'How do I feel at the end?', comprehensionHint: 'Read the last sentence. What feeling word is there?' },
              { question: 'What is my mood?', comprehensionHint: 'Mood means how you feel.' }
            ],
            answers: [
              { name: 'Happy', icon: '' },
              { name: 'Sad', icon: '' },
              { name: 'Scared', icon: '' }
            ],
            correctAnswerName: 'Happy',
            successMessage: 'Yes! You used the story to tell the feeling.'
          }
        ]
      },
      drink: {
        name: 'Drink Bar',
        icon: '',
        level: 1,
        floor: 3,
        stickers: ['', '', '', ''],
        // Level 1 Focus: CVC words (hot, cup) + reinforcing sight words from fruit
        // Phonics pattern: Short vowel sounds, rhyming (hot/lot, cup/up)
        sightWords: ['I', 'see', 'a', 'the', 'is', 'my', 'want', 'like', 'can', 'so'],
        previewWords: [
          { word: 'drink', icon: '', isSightWord: false, phonicsNote: 'd-r-i-nk' },
          { word: 'cold', icon: '', isSightWord: false, phonicsNote: 'c-o-ld' },
          { word: 'hot', icon: '', isSightWord: false, phonicsNote: 'h-o-t (CVC)' },
          { word: 'the', icon: '', isSightWord: true }
        ],
        pages: [
          {
            type: 'read',
            image: '',
            sentence: 'I am at the drink bar. I see cups on a shelf. The cups are red and blue. It is hot outside! The sun is up. I am so thirsty. I want a cold drink.',
            words: null,
            variants: [
              { sentence: 'I am at the drink bar. I see tall cups on the shelf. The cups are red and blue. It is hot outside. I am so thirsty! The sun is up. I want a cold drink.', words: null },
              { sentence: 'I am at the drink bar. I see tall cups on the shelf. The cups are red and blue. The sun is hot today. I am so thirsty! I want a cold drink.', words: null },
              { sentence: 'I am at the drink bar. I see tall cups on the shelf. The cups are red and blue. I feel hot outside. I am so thirsty! The sun is up. I want a cold drink.', words: null }
            ],
            targetWords: ['I', 'am', 'at', 'the', 'drink'],
            sightWordFocus: 'I',
            requireSightWordTap: true,
            readingTip: 'I is always a capital letter. I am. I see. I want.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'I want a cold drink.',
            question: 'What is this story mostly about?',
            comprehensionHint: 'Main idea means what it is mostly about. What do I want?',
            variants: [
              { question: 'What is the main idea?', comprehensionHint: 'Main idea means what it is mostly about.' },
              { question: 'What is this mostly about?', comprehensionHint: 'Think about what I want.' },
              { question: 'What is the main idea of the story?', comprehensionHint: 'Read the first sentence again.' }
            ],
            answers: [
              { name: 'Getting a cold drink', icon: '' },
              { name: 'Getting a hot drink', icon: '' },
              { name: 'Getting a sweet treat', icon: '' }
            ],
            correctAnswerName: 'Getting a cold drink',
            successMessage: 'Yes! You found the main idea.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I see cold drinks. The drinks are in cups. The cups have ice. I see big cups and little cups. The drinks look so cold! They look so good. I want one!',
            words: null,
            variants: [
              { sentence: 'I see cold drinks. The ice is in the cups. They look so good! I see big cups. I see little cups. The drinks are on the shelf. I want a cold drink.', words: null },
              { sentence: 'I see cold drinks. The ice is in the cups. I see big cups. I see little cups. I see cups on the counter. The drinks look good to me.', words: null },
              { sentence: 'I see cold drinks. The ice is in the cups. They look so good! I see big cups. I see little cups. The drinks look good to me.', words: null }
            ],
            targetWords: ['see', 'cold', 'drinks', 'look', 'good'],
            sightWordFocus: 'see',
            readingTip: 'You know the word see from the fruit stand. Same word here.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'I see cold drinks.',
            question: 'What did I see at the drink bar?',
            comprehensionHint: 'Read the sentence in the box.',
            variants: [
              { question: 'What do I see?', comprehensionHint: 'The answer is in the sentence.' },
              { question: 'What did I see?', comprehensionHint: 'Read the words after I see.' },
              { question: 'In the story, what did I see?', comprehensionHint: 'Look for I see and read the next words.' }
            ],
            answers: [
              { name: 'Cold drinks', icon: '' },
              { name: 'Hot drinks', icon: '' },
              { name: 'Big drinks', icon: '' }
            ],
            correctAnswerName: 'Cold drinks',
            successMessage: 'Great! You used the sentence to answer.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I am so hot. Hot and cold are opposites. I want a cold drink. I pick a cup with juice. The cup is cold. Ice is in the cup. I hold the cup. I take a sip. It is so good!',
            words: null,
            variants: [
              { sentence: 'I am so hot. Hot and cold are opposites. The sun is up. I want a cold drink. I pick a yummy juice. The ice makes the cup cold. I hold the cold cup. I take a sip. It is so good!', words: null },
              { sentence: 'I am so hot. Hot and cold are opposites. The sun is up. I want a cold drink. I pick a yummy juice. The ice makes the cup cold. My mouth feels dry. I take a sip. It is so good!', words: null },
              { sentence: 'I am so hot. Hot and cold are opposites. The sun is up. I want a cold drink. I pick a yummy juice. The ice makes the cup cold. I hold the cup. I take a sip. It is so good!', words: null }
            ],
            targetWords: ['am', 'hot', 'want', 'cold', 'drink'],
            sightWordFocus: 'want',
            readingTip: 'Hot and cold are opposites. Hot means warm. Cold means not warm.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'Hot and cold are opposites.',
            question: 'What is the opposite of hot?',
            comprehensionHint: 'Opposite means very different.',
            variants: [
              { question: 'Which word means the opposite of hot?', comprehensionHint: 'Think about the opposite word.' },
              { question: 'Hot and cold are opposites. What is the opposite of hot?', comprehensionHint: 'Read the sentence again.' },
              { question: 'Choose the opposite.', comprehensionHint: 'Opposite means very different.' }
            ],
            answers: [
              { name: 'Cold', icon: '' },
              { name: 'Wet', icon: '' },
              { name: 'Big', icon: '' }
            ],
            correctAnswerName: 'Cold',
            successMessage: 'Yes! Cold is the opposite of hot.'
          },
          {
            type: 'menu',
            prompt: 'Pick your drink!',
            menuStory: 'It is so hot. A cold drink will be good!',
            variants: [
              { prompt: 'Choose a drink.', menuStory: 'Read each choice. Then pick one drink.' },
              { prompt: 'What drink will you get?', menuStory: 'Think about a hot day. Pick a drink that helps.' },
              { prompt: 'Pick a drink for the hot day.', menuStory: 'Choose one drink to help you cool down.' }
            ],
            items: [
              { name: 'Juice', icon: '', description: 'Sweet and cold' },
              { name: 'Milk', icon: '', description: 'Cold and creamy' },
              { name: 'Water', icon: '', description: 'Cold and fresh' }
            ]
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'I am so hot.',
            question: 'Why did I want a cold drink?',
            comprehensionHint: 'The story tells the reason. Read the sentence again.',
            variants: [
              { question: 'What is the reason I want a cold drink?', comprehensionHint: 'Reason means why. Read the sentence again.' },
              { question: 'Why do I want a cold drink?', comprehensionHint: 'Read the sentence. What is the problem?' },
              { question: 'Why did I want a cold drink?', comprehensionHint: 'Find the reason in the sentence.' }
            ],
            answers: [
              { name: 'Because I was hot', icon: '' },
              { name: 'Because I was cold', icon: '' },
              { name: 'Because I was hungry', icon: '' }
            ],
            correctAnswerName: 'Because I was hot',
            successMessage: 'Great! You used the story to answer why.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'My drink is cold. My drink helps me. The ice is in my cup. I sip and sip. I am not hot now. I feel better! The drink is good. I am happy!',
            words: null,
            variants: [
              { sentence: 'My drink is cold. My drink helps me. The ice is in my cup. I am not hot now. I sip the juice. I feel better now. The drink is so good!', words: null },
              { sentence: 'My drink is cold. My drink helps me. The ice is in my cup. I sip it slowly. I am not hot now. I feel better. The drink is so good!', words: null },
              { sentence: 'My drink is cold. My drink helps me. The ice is in my cup. My body cools down. I am not hot now. I feel better now. The drink is so good!', words: null }
            ],
            targetWords: ['My', 'drink', 'is', 'good', 'like', 'lot'],
            sightWordFocus: 'is',
            readingTip: 'Is tells what something is. My drink is cold.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'My drink helps me.',
            question: 'What helped me feel better?',
            comprehensionHint: 'Read the sentence. What helps me?',
            variants: [
              { question: 'What helped me?', comprehensionHint: 'Read the passage again.' },
              { question: 'In the story, what helped me?', comprehensionHint: 'Use the passage.' },
              { question: 'What made me feel better?', comprehensionHint: 'Look for what helps.' }
            ],
            answers: [
              { name: 'My drink', icon: '' },
              { name: 'My hat', icon: '' },
              { name: 'My shoes', icon: '' }
            ],
            correctAnswerName: 'My drink',
            successMessage: 'Yes! My drink helped me.'
          }
        ]
      },
      bakery: {
        name: 'Bakery',
        icon: '',
        level: 1,
        floor: 3,
        stickers: ['', '', '', ''],
        // Level 1 Focus: CVC words (bun, big) + introducing size words
        // Phonics pattern: Short vowel sounds, size comparisons (big/little)
        sightWords: ['I', 'see', 'a', 'the', 'is', 'my', 'want', 'like', 'can', 'so'],
        previewWords: [
          { word: 'cake', icon: '', isSightWord: false, phonicsNote: 'c-a-ke (long a)' },
          { word: 'big', icon: '', isSightWord: false, phonicsNote: 'b-i-g (CVC)' },
          { word: 'bun', icon: '', isSightWord: false, phonicsNote: 'b-u-n (CVC)' },
          { word: 'a', icon: '1', isSightWord: true }
        ],
        pages: [
          {
            type: 'read',
            image: '',
            sentence: 'I am at the bakery! The door is open. I can smell fresh bread. It smells so good! The air is warm and sweet. I can see treats on a shelf. I want a sweet treat!',
            words: null,
            variants: [
              { sentence: 'I am at the bakery. The door is open. It smells so good! I can see treats. The air is warm and sweet. I want a sweet treat!', words: null },
              { sentence: 'I am at the bakery. The door is open. I smell warm bread. It smells so good! I can see treats. The air is warm and sweet. I want a sweet treat!', words: null },
              { sentence: 'I am at the bakery. The door is open. The air smells sweet. It smells so good! I can see treats. The air is warm and sweet. I want a sweet treat!', words: null }
            ],
            targetWords: ['I', 'am', 'the', 'bakery', 'smells', 'good'],
            sightWordFocus: 'the',
            requireSightWordTap: true,
            readingTip: 'A bakery is a shop that makes bread and cakes. It smells sweet!'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'I want a sweet treat!',
            question: 'What is this story mostly about?',
            comprehensionHint: 'Main idea means what it is mostly about. What do I want?',
            variants: [
              { question: 'What is the main idea?', comprehensionHint: 'Main idea means what it is mostly about.' },
              { question: 'What is this mostly about?', comprehensionHint: 'Think about what I want.' },
              { question: 'What is the main idea of the story?', comprehensionHint: 'Look for what I want.' }
            ],
            answers: [
              { name: 'Choosing a sweet treat', icon: '' },
              { name: 'Smelling fresh bread', icon: '' },
              { name: 'Looking at treats', icon: '' }
            ],
            correctAnswerName: 'Choosing a sweet treat',
            successMessage: 'Yes! You found the main idea.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I look at all the treats. I see a big cake on the top shelf. I see little pies on a tray. I see warm buns in a basket. The buns smell so good! They all look yummy. What will I pick?',
            words: null,
            variants: [
              { sentence: 'I see a big cake. The cake is on the top shelf. I see little pies. The pies are on a tray. I see warm buns. The buns smell good. I want to pick one.', words: null },
              { sentence: 'I see a big cake. The cake is on the top shelf. I see little pies. The pies are on a tray. I see warm buns. I want to taste them.', words: null },
              { sentence: 'I see a big cake. The cake is on the top shelf. I see little pies. The pies are on a tray. I see warm buns. The bakery smells good.', words: null }
            ],
            targetWords: ['see', 'big', 'cake', 'little', 'pies', 'warm', 'buns'],
            sightWordFocus: 'a',
            readingTip: 'Big and little are size words. The cake is big. The pies are little.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'I see little pies.',
            question: 'What was little?',
            comprehensionHint: 'Find the size word little.',
            variants: [
              { question: 'In the story, what was little?', comprehensionHint: 'Read the sentence with little.' },
              { question: 'Which food matches the words little pies?', comprehensionHint: 'Look for little. What food is little?' },
              { question: 'Little tells size. What was little?', comprehensionHint: 'Little comes right before the food word.' }
            ],
            answers: [
              { name: 'Pies', icon: '' },
              { name: 'Cake', icon: '' },
              { name: 'Buns', icon: '' }
            ],
            correctAnswerName: 'Pies',
            successMessage: 'Yes! You remembered the size word and the food.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I want a sweet treat! A man at the shop can help me. I can get a big cake. I can get a little pie. I can get a warm bun. I like them all! What will I pick?',
            words: null,
            variants: [
              { sentence: 'I want a sweet treat. The man at the shop can help me. I can get cake. I can get pie. I can get a bun. I like them all! What will I pick?', words: null },
              { sentence: 'I want a sweet treat. The man at the shop can help me. I can get cake or pie. I can get a warm bun. I like them all! What will I pick?', words: null },
              { sentence: 'I want a sweet treat. The man at the shop can help me. I can get a bun. I can get pie. I can get cake. I like them all! What will I pick?', words: null }
            ],
            targetWords: ['want', 'sweet', 'treat', 'What', 'can', 'get'],
            sightWordFocus: 'can',
            readingTip: 'Can asks if I am able to do something. What can I get?'
          },
          {
            type: 'menu',
            prompt: 'Pick your treat!',
            menuStory: 'It all smells so good! What treat do you want?',
            variants: [
              { prompt: 'Choose a treat.', menuStory: 'Read each choice. Then choose one treat.' },
              { prompt: 'What treat will you get?', menuStory: 'Think about the story: big cake, little pies, warm buns.' },
              { prompt: 'Pick a sweet treat.', menuStory: 'Pick one sweet treat from the bakery.' }
            ],
            items: [
              { name: 'Cake', icon: '', description: 'Big and soft' },
              { name: 'Pie', icon: '', description: 'Sweet and yummy' },
              { name: 'Bun', icon: '', description: 'Warm and round' }
            ]
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'It smells so good!',
            question: 'What did the bakery smell like?',
            comprehensionHint: 'Look for the describing words.',
            variants: [
              { question: 'How did the bakery smell?', comprehensionHint: 'Read the passage again.' },
              { question: 'Which words describe the smell?', comprehensionHint: 'Find the words that tell the smell.' },
              { question: 'Was the smell good or bad?', comprehensionHint: 'Use the story words.' }
            ],
            answers: [
              { name: 'So good', icon: '' },
              { name: 'So bad', icon: '' },
              { name: 'So cold', icon: '' }
            ],
            correctAnswerName: 'So good',
            successMessage: 'Yes! You remembered the smell from the story.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'My treat is the best! I take a big bite. Mmm! It is soft and sweet. I am so happy! I smile big. I say thank you. The bakery is so good!',
            words: null,
            variants: [
              { sentence: 'My treat is the best! I take a bite. It is so soft and sweet. I am so happy! I smile big. I say thank you. The bakery is good!', words: null },
              { sentence: 'My treat is the best! I take a bite. It is so soft and sweet. I smile. I say thank you. The bakery is good!', words: null },
              { sentence: 'My treat is the best! I take a bite. It is so soft and sweet. I am so happy. I say thank you. The bakery is good!', words: null }
            ],
            targetWords: ['My', 'treat', 'is', 'best', 'am', 'happy'],
            sightWordFocus: 'my',
            readingTip: 'Best means the most good. My treat is the best.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            passage: 'I say thank you.',
            question: 'What did I say?',
            comprehensionHint: 'Read the sentence in the box.',
            variants: [
              { question: 'What words did I say at the end?', comprehensionHint: 'Find the words in the passage.' },
              { question: 'How did I show good manners?', comprehensionHint: 'Good manners are kind words.' },
              { question: 'Which words did I use?', comprehensionHint: 'Look for the two words I say.' }
            ],
            answers: [
              { name: 'Thank you', icon: '' },
              { name: 'Hello', icon: '' },
              { name: 'Please', icon: '' }
            ],
            correctAnswerName: 'Thank you',
            successMessage: 'Yes! You remembered the words you said.'
          }
        ]
      },

      // ===== LEVEL 2: LONGER WORDS, MORE ADJECTIVES =====
      // Focus: Compound words, descriptive adjectives, 2-syllable words
      // Sentence length: 5-8 words
      // More detail and emotion in stories
      // Building on Level 1 sight words + introducing new ones (to, some, have, very)
      pizza: {
        name: 'Pizza Place',
        icon: '',
        level: 2,
        floor: 3,
        stickers: ['', '', '', ''],
        sightWords: ['I', 'see', 'want', 'to', 'eat', 'some', 'very', 'hot', 'my', 'this'],
        previewWords: [
          { word: 'pizza', icon: '', isSightWord: false, phonicsNote: 'piz-za (2 syllables)' },
          { word: 'yummy', icon: '', isSightWord: false, phonicsNote: 'yum-my (2 syllables)' },
          { word: 'cheese', icon: '', isSightWord: false, phonicsNote: 'ch-ee-se (long e)' },
          { word: 'some', icon: '', isSightWord: true }
        ],
        pages: [
          {
            type: 'read',
            image: '',
            sentence: 'I am at the pizza place! I can smell hot pizza. Hot pizza is baking in the oven. The yummy smell fills the whole room. It makes me want to eat. My tummy rumbles. I am so hungry! I cannot wait to eat pizza.',
            words: null,
            variants: [
              { sentence: 'I am at the pizza place. I can smell hot pizza. Hot pizza is cooking! The yummy smell fills the whole room. It makes me want to eat. My tummy starts to rumble. I am so hungry! I cannot wait to eat some pizza.', words: null },
              { sentence: 'I am at the pizza place. I can smell hot pizza. Hot pizza is baking! The yummy smell is all around me. It makes me want to eat. My tummy starts to growl. I am very hungry! I want to eat pizza now.', words: null },
              { sentence: 'I am at the pizza place today. I can smell hot pizza. Hot pizza is cooking in the oven! The yummy smell fills the whole room. It makes me want to eat. My tummy feels so hungry. I cannot wait to eat some pizza!', words: null }
            ],
            targetWords: ['am', 'pizza', 'place', 'can', 'smell', 'hot'],
            sightWordFocus: 'can',
            requireSightWordTap: true,
            readingTip: 'Pizza has two parts. Say piz-za slowly.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What did I smell?',
            passage: 'I can smell hot pizza.',
            comprehensionHint: 'Read the sentence in the box.',
            variants: [
              { question: 'What smell did I notice?', comprehensionHint: 'Find the words that tell the smell.' },
              { question: 'Which words tell what I smelled?', comprehensionHint: 'Look for the words that tell the smell.' },
              { question: 'At the pizza place, what did I smell?', comprehensionHint: 'Use the passage.' }
            ],
            answers: [
              { name: 'Hot pizza', icon: '' },
              { name: 'Hot bread', icon: '' },
              { name: 'Hot soup', icon: '' }
            ],
            correctAnswerName: 'Hot pizza',
            successMessage: 'Yes! You remembered what you smelled.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I see big pizzas on the counter! They have gooey cheese on top. The cheese is gooey. Red pepperoni circles sit on the cheese. The cheese bubbles and stretches. Steam rises up from the hot pizza. It is ready to eat!',
            words: null,
            variants: [
              { sentence: 'I see big yummy pizzas on the counter. They have gooey cheese on top. The cheese is gooey. Red pepperoni dots cover them. The cheese bubbles and melts. It looks so tasty! I can see steam rising up. The pizza is very hot and ready to eat.', words: null },
              { sentence: 'I see big yummy pizzas waiting for me. They have gooey cheese on top. The cheese is gooey. Red pepperoni is all over them. The cheese is bubbly and hot. It looks so good! Steam rises from the pizza. I want to eat it right now!', words: null },
              { sentence: 'I see big yummy pizzas on the table. They have gooey cheese on top. The cheese is gooey. Red pepperoni dots are on them. The cheese bubbles and stretches. It smells so good! Steam floats up from the pizza. They are hot and ready!', words: null }
            ],
            targetWords: ['see', 'big', 'yummy', 'pizzas', 'have', 'cheese', 'top', 'gooey'],
            sightWordFocus: 'have',
            readingTip: 'Have is a sight word. The pizza has cheese. They have cheese.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'How was the cheese?',
            passage: 'The cheese is gooey.',
            comprehensionHint: 'Find the describing word.',
            variants: [
              { question: 'Which word describes the cheese?', comprehensionHint: 'Look for the describing word in the passage.' },
              { question: 'What was the cheese like?', comprehensionHint: 'Read the sentence about cheese.' },
              { question: 'How did the cheese look?', comprehensionHint: 'Use the describing word in the sentence.' }
            ],
            answers: [
              { name: 'Gooey', icon: '' },
              { name: 'Crunchy', icon: '' },
              { name: 'Dry', icon: '' }
            ],
            correctAnswerName: 'Gooey',
            successMessage: 'Yes! You remembered what the story said.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I want to eat pizza right now! My tummy is very hungry. It feels empty inside. The yummy smell makes me even hungrier. I pick up a big slice with my hands. The cheese stretches out long. I am ready for my first bite!',
            words: null,
            variants: [
              { sentence: 'I want to eat some pizza right now! My tummy is very hungry. It feels so empty inside. The yummy smell makes me want pizza even more. I pick up a big slice. The cheese stretches when I lift it up. I am ready to take my first bite!', words: null },
              { sentence: 'I want to eat some pizza today! My tummy is very hungry. It is so empty right now. The yummy pizza makes me want it more. I grab a big slice. The gooey cheese stretches out. I am ready to eat it now!', words: null },
              { sentence: 'I want to eat some pizza so much! My tummy is very hungry. It feels empty and rumbly. The good smell makes me even more hungry. I take a big slice. The cheese pulls and stretches. I cannot wait to taste it!', words: null }
            ],
            targetWords: ['want', 'to', 'eat', 'some', 'pizza', 'tummy', 'very', 'hungry'],
            sightWordFocus: 'to',
            readingTip: 'To is a helper word. I want to eat. I want to play.'
          },
          {
            type: 'menu',
            prompt: 'How much pizza do you want?',
            menuStory: 'The pizza smells so good! How hungry are you?',
            variants: [
              { prompt: 'Choose how much pizza.', menuStory: 'Read each choice. Then choose.' },
              { prompt: 'Pick your pizza size.', menuStory: 'Think about how hungry your tummy feels.' },
              { prompt: 'How many slices will you eat?', menuStory: 'Pick one answer.' }
            ],
            items: [
              { name: 'One slice', icon: '', description: 'Just a little' },
              { name: 'Two slices', icon: '', description: 'A good amount' },
              { name: 'Big pizza', icon: '', description: 'Very hungry!' }
            ]
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'How did my tummy feel?',
            passage: 'My tummy is very hungry.',
            comprehensionHint: 'Read the sentence in the box.',
            variants: [
              { question: 'What words tell how my tummy felt?', comprehensionHint: 'Find the describing words.' },
              { question: 'How hungry was my tummy?', comprehensionHint: 'Look for the describing words.' },
              { question: 'What does the story say about my tummy?', comprehensionHint: 'Use the passage.' }
            ],
            answers: [
              { name: 'Very hungry', icon: '' },
              { name: 'Very sleepy', icon: '' },
              { name: 'Very cold', icon: '' }
            ],
            correctAnswerName: 'Very hungry',
            successMessage: 'Yes! You remembered how the story described your tummy.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'My hot pizza is very yummy! I take a big bite. Mmm! The cheese is gooey and tasty. The pepperoni is a little spicy. Each bite makes me smile. Now my tummy feels full. I feel happy. This was the best pizza ever! I love pizza!',
            words: null,
            variants: [
              { sentence: 'My hot pizza is so very yummy! I take a big bite. The cheese is gooey and tasty. The pepperoni is spicy and good. Each bite makes me happy. Now my tummy feels full. I feel happy. This was the best pizza ever! I love pizza!', words: null },
              { sentence: 'My hot pizza tastes so yummy! I eat a big bite. The gooey cheese is so good. The pepperoni tastes spicy. Every bite makes me smile. Now my tummy feels full. I feel happy. This pizza was the very best! I love it so much.', words: null },
              { sentence: 'My hot pizza is very yummy! I munch a big bite. The cheese is gooey and cheesy. The red pepperoni is spicy. Each bite is so good! Now my tummy feels full. I feel happy. This was the yummiest pizza! I love eating pizza.', words: null }
            ],
            targetWords: ['hot', 'pizza', 'very', 'yummy', 'cheese', 'gooey', 'good', 'love', 'day'],
            sightWordFocus: 'very',
            readingTip: 'Very makes a word stronger. Very hot. Very yummy. Very good.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'How did my tummy feel at the end?',
            passage: 'Now my tummy feels full.',
            comprehensionHint: 'Read the last sentence.',
            variants: [
              { question: 'At the end, how did my tummy feel?', comprehensionHint: 'Find the last sentence.' },
              { question: 'Which word tells my tummy is not hungry anymore?', comprehensionHint: 'Look for the last word in the passage.' },
              { question: 'What happened at the end?', comprehensionHint: 'End means last.' }
            ],
            answers: [
              { name: 'Full', icon: '' },
              { name: 'Very hungry', icon: '' },
              { name: 'Very cold', icon: '' }
            ],
            correctAnswerName: 'Full',
            successMessage: 'Yes! You remembered what happened at the end.'
          }
        ]
      },
      icecream: {
        name: 'Ice Cream',
        icon: '',
        level: 2,
        floor: 3,
        stickers: ['', '', '', ''],
        // Level 2 Focus: Compound words (ice cream), color words, opposites (hot/cold)
        sightWords: ['I', 'see', 'want', 'to', 'eat', 'so', 'many', 'cold', 'my', 'this'],
        previewWords: [
          { word: 'ice cream', icon: '', isSightWord: false, phonicsNote: 'ice cream (compound word)' },
          { word: 'cold', icon: '', isSightWord: false, phonicsNote: 'c-o-ld' },
          { word: 'sweet', icon: '', isSightWord: false, phonicsNote: 'sw-ee-t (long e)' },
          { word: 'many', icon: '', isSightWord: true }
        ],
        pages: [
          {
            type: 'read',
            image: '',
            sentence: 'I am at the ice cream shop! I open the big door and step inside. It is so cold inside! The freezers hum and keep everything frozen. I can see many colorful ice cream treats. They look yummy and sweet!',
            words: null,
            variants: [
              { sentence: 'I am at the ice cream shop. I open the big door. It is so cold inside! The freezers make the shop cold. I can see many colorful treats. They look so yummy and sweet!', words: null },
              { sentence: 'I am at the ice cream shop. I open the big door. It is so cold inside! The freezers make the shop cold. I can see many colorful treats. They look so yummy and sweet!', words: null },
              { sentence: 'I am at the ice cream shop. I open the big door. It is so cold inside! The freezers make the shop cold. I can see many colorful treats. They look so yummy and sweet!', words: null }
            ],
            targetWords: ['am', 'ice', 'cream', 'shop', 'It', 'is', 'cold', 'inside'],
            sightWordFocus: 'it',
            requireSightWordTap: true,
            readingTip: 'Ice cream is two words. Ice and cream.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'How did it feel inside the shop?',
            passage: 'It is so cold inside!',
            comprehensionHint: 'Read the words in the box.',
            variants: [
              { question: 'What word tells how it felt inside?', comprehensionHint: 'Find the feeling word.' },
              { question: 'Was it hot or cold inside?', comprehensionHint: 'Use the passage.' },
              { question: 'Inside the shop, how did it feel?', comprehensionHint: 'Look for the word that tells the feeling.' }
            ],
            answers: [
              { name: 'Cold', icon: '' },
              { name: 'Hot', icon: '' },
              { name: 'Wet', icon: '' }
            ],
            correctAnswerName: 'Cold',
            successMessage: 'Yes! You used the story to answer.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I see so many ice cream flavors! The tubs sit in a long row. There are many colors to choose from. Pink strawberry, brown chocolate, and white vanilla! Each flavor looks different and special. Some look creamy. Some look fruity. I want to taste them all!',
            words: null,
            variants: [
              { sentence: 'I see so many yummy ice creams! The tubs are in a row. There are many colors. Pink, brown, and white! Each flavor looks different. Some are creamy. Some are fruity. I want to taste them all!', words: null },
              { sentence: 'I see so many yummy ice creams! The tubs are in a row. I see many colors. Pink, brown, and white! Each flavor looks different. Some are creamy. Some are fruity. I want to taste them all!', words: null },
              { sentence: 'I see so many yummy ice creams! The tubs are in a row. Colors are everywhere. Pink, brown, and white! Each flavor looks different. Some are creamy. Some are fruity. I want to taste them all!', words: null }
            ],
            targetWords: ['see', 'so', 'many', 'yummy', 'ice', 'creams', 'There', 'colors', 'Pink', 'brown', 'white'],
            sightWordFocus: 'many',
            readingTip: 'Many means a lot. Many colors. Many ice creams.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'Which colors were in the story?',
            passage: 'Pink, brown, and white!',
            comprehensionHint: 'Read the color words.',
            variants: [
              { question: 'What colors does the story name?', comprehensionHint: 'Look at the last sentence.' },
              { question: 'Which choice matches the colors?', comprehensionHint: 'Choose the exact words.' },
              { question: 'Pick the colors from the passage.', comprehensionHint: 'Read the color words again.' }
            ],
            answers: [
              { name: 'Pink, brown, and white', icon: '' },
              { name: 'Red, blue, and green', icon: '' },
              { name: 'Purple, orange, and black', icon: '' }
            ],
            correctAnswerName: 'Pink, brown, and white',
            successMessage: 'Great! You remembered the exact colors.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'It is a very hot day outside. The bright sun is shining down. I want to eat a cold, sweet treat! Ice cream will help me cool down and feel better. I am excited to pick my favorite flavor!',
            words: null,
            variants: [
              { sentence: 'It is a hot day. The sun is shining outside. I want to eat a cold, sweet treat! Ice cream will help me cool down. I am excited to pick my favorite flavor!', words: null },
              { sentence: 'It is a hot day. The sun is shining outside. I want a cold, sweet treat. Ice cream will help me cool down. I am excited to pick my favorite flavor!', words: null },
              { sentence: 'It is a hot day. The sun is shining outside. A cold treat sounds good to me. Ice cream will help me cool down. I am excited to pick my favorite flavor!', words: null }
            ],
            targetWords: ['It', 'is', 'hot', 'day', 'want', 'to', 'eat', 'cold', 'sweet', 'treat'],
            sightWordFocus: 'to',
            readingTip: 'Hot and cold are opposites. Hot day and cold ice cream go together.'
          },
          {
            type: 'menu',
            prompt: 'Cone, cup, or bowl?',
            menuStory: 'How do you want your ice cream? Each way is yummy!',
            variants: [
              { prompt: 'Choose: cone, cup, or bowl.', menuStory: 'Read the choices. Then pick one.' },
              { prompt: 'How will you eat it?', menuStory: 'Pick one way to eat ice cream.' },
              { prompt: 'Pick your ice cream holder.', menuStory: 'Cone, cup, or bowl?' }
            ],
            items: [
              { name: 'Cone', icon: '', description: 'Crunchy outside' },
              { name: 'Cup', icon: '', description: 'Easy to eat' },
              { name: 'Bowl', icon: '', description: 'Big and colorful' }
            ]
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What kind of day was it?',
            passage: 'It is a hot day.',
            comprehensionHint: 'Read the sentence in the box.',
            variants: [
              { question: 'What does the story say about the day?', comprehensionHint: 'Look for the describing word.' },
              { question: 'Was the day hot or cold?', comprehensionHint: 'Use the passage.' },
              { question: 'What kind of day is it?', comprehensionHint: 'Find the word that describes the day.' }
            ],
            answers: [
              { name: 'A hot day', icon: '' },
              { name: 'A cold day', icon: '' },
              { name: 'A rainy day', icon: '' }
            ],
            correctAnswerName: 'A hot day',
            successMessage: 'Great! You remembered a detail from the story.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'My sweet ice cream is so cold and yummy! I take a big lick with my tongue. The flavor is perfect and delicious! It makes my tongue happy! I feel so much cooler now. This is the best treat on a hot, sunny day!',
            words: null,
            variants: [
              { sentence: 'My sweet ice cream is so cold and yummy! I take a lick. The flavor is perfect! It makes my tongue happy! I feel cooler now. This is the best treat on a sunny day!', words: null },
              { sentence: 'My sweet ice cream is so cold and yummy! I take a lick. The flavor is perfect! It makes my tongue happy! I feel cooler now. This is the best treat on a sunny day!', words: null },
              { sentence: 'My sweet ice cream is so cold and yummy! I take a lick. The flavor is perfect! It makes my tongue happy! I smile as I eat it. I feel cooler now. This is the best treat on a sunny day!', words: null }
            ],
            targetWords: ['sweet', 'ice', 'cream', 'is', 'cold', 'yummy', 'makes', 'tongue', 'happy'],
            sightWordFocus: 'makes',
            readingTip: 'Makes tells what something does. It makes you happy.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What did the ice cream make happy?',
            passage: 'It makes my tongue happy!',
            comprehensionHint: 'Read the sentence. What part of me is happy?',
            variants: [
              { question: 'What was happy in the story?', comprehensionHint: 'Read the last words.' },
              { question: 'What did it make happy?', comprehensionHint: 'It means the ice cream.' },
              { question: 'What part of me felt happy?', comprehensionHint: 'Look for my and the body part.' }
            ],
            answers: [
              { name: 'My tongue', icon: '' },
              { name: 'My shoes', icon: '' },
              { name: 'My bed', icon: '' }
            ],
            correctAnswerName: 'My tongue',
            successMessage: 'Yes! You remembered what the story said.'
          }
        ]
      },

      // ===== LEVEL 3: DIGRAPHS - SH WORDS =====
      // Focus: SH digraph in different positions (fish, shop, shrimp, wish, fresh, shell)
      // Explicit phonics instruction with teachWord
      // More complex sentences with SH words
      // Educational note: SH is often the first digraph taught because it's
      // highly consistent and appears in many common words
      fishshop: {
        name: 'Fish Shop',
        icon: '',
        level: 3,
        floor: 3,
        stickers: ['', '', '', ''],
        digraphFocus: 'sh',
        sightWords: ['the', 'look', 'they', 'want', 'some', 'I', 'see', 'so', 'for', 'my'],
        previewWords: [
          { word: 'fish', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'end' },
          { word: 'shop', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'start' },
          { word: 'shrimp', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'start' },
          { word: 'fresh', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'end' }
        ],
        pages: [
          {
            type: 'read',
            image: '',
            sentence: 'I am at the fish shop! I can see fish on ice. The shop smells like the sea. S and H work together. SH makes the sh sound. Shop starts with SH!',
            words: null,
            variants: [
              { sentence: 'I am at the fish shop! I see so many fish. The shop smells fresh like the sea. S and H work together. SH makes the sh sound. Fish ends with SH!', words: null },
              { sentence: 'I am at the fish shop today! I can see fish everywhere. The shop smells like the sea. S and H work together. SH makes the sh sound. Shop starts with SH!', words: null },
              { sentence: 'I am at the fish shop now! Fish are on ice in the shop. It smells like the sea. S and H work together. SH makes the sh sound. Fish ends with SH!', words: null }
            ],
            targetWords: ['am', 'fish', 'shop', 'SH', 'sound', 'like', 'see', 'fresh', 'work', 'together'],
            teachWord: { word: 'shop', sound: 'sh', highlight: 'SH-op', position: 'start' },
            sightWordFocus: 'like',
            requireSightWordTap: true,
            readingTip: 'SH is one sound. SH makes the sh sound.'
          },
          {
            type: 'question',
            questionType: 'sightWord',
            questionMode: 'multipleChoice',
            passage: 'SH makes the sh sound.',
            question: 'What sound do the letters SH make?',
            comprehensionHint: 'Say the word shop. Listen for sh.',
            variants: [
              { question: 'What sound does SH make?', comprehensionHint: 'SH is one sound. Say shop.' },
              { question: 'Which sound is made by SH?', comprehensionHint: 'S and H together say sh.' },
              { question: 'In the word fish, what sound do SH make?', comprehensionHint: 'Fish ends with sh.' }
            ],
            answers: [
              { name: 'sh', icon: '' },
              { name: 'ch', icon: '' },
              { name: 'th', icon: '' }
            ],
            correctAnswerName: 'sh',
            successMessage: 'Yes! SH makes the sh sound.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'The fish looks so fresh! The fresh fish shine in the shop. I see big fish and little fish on ice. The fish shells shine bright. Everything looks so fresh at this fish shop!',
            words: null,
            variants: [
              { sentence: 'The fish looks so fresh! I see big fish and little fish. They all shine!', words: null },
              { sentence: 'The fish looks so fresh! I see big fish and little fish. The fish can shine!', words: null },
              { sentence: 'The fish looks so fresh! I see big fish and little fish. Fresh fish can shine!', words: null }
            ],
            targetWords: ['fish', 'looks', 'fresh', 'see', 'big', 'little', 'They', 'shine'],
            teachWord: { word: 'fish', sound: 'sh', highlight: 'fi-SH', position: 'end' },
            sightWordFocus: 'looks',
            readingTip: 'Fish ends with SH! Listen: fi-SH. Fresh also ends with SH!'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'How did the fish look?',
            passage: 'The fish looks so fresh!',
            comprehensionHint: 'Find the describing word.',
            variants: [
              { question: 'Which word describes the fish?', comprehensionHint: 'Read the sentence again.' },
              { question: 'What does the story say about the fish?', comprehensionHint: 'Look for the describing word.' },
              { question: 'How is the fish described?', comprehensionHint: 'Find the describing word.' }
            ],
            answers: [
              { name: 'Fresh', icon: '' },
              { name: 'Dirty', icon: '' },
              { name: 'Sleepy', icon: '' }
            ],
            correctAnswerName: 'Fresh',
            successMessage: 'Yes! You remembered the describing word.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I see pink shrimp in a shell! The fresh shrimp look so good. The shells are shiny and smooth. I wish I could have some shrimp!',
            words: null,
            variants: [
              { sentence: 'I see pink shrimp in a shell! The shrimp look so good. I wish I could have some!', words: null },
              { sentence: 'I see pink shrimp in a shell! I wish I could have some.', words: null },
              { sentence: 'I see pink shrimp in a shell! The shrimp look good. I wish I could try some!', words: null }
            ],
            targetWords: ['see', 'pink', 'shrimp', 'shell', 'look', 'good', 'wish', 'can', 'some'],
            teachWord: { word: 'shrimp', sound: 'sh', highlight: 'SH-rimp', position: 'start' },
            sightWordFocus: 'some',
            readingTip: 'Shrimp and shell start with SH. Fish and fresh end with SH.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'Where was the shrimp?',
            passage: 'I see pink shrimp in a shell!',
            comprehensionHint: 'Read the words in the box.',
            variants: [
              { question: 'Where do I see the shrimp?', comprehensionHint: 'Find the place words.' },
              { question: 'What tells where the shrimp was?', comprehensionHint: 'Look for the words in a. Then read the next word.' },
              { question: 'In the story, where was the shrimp?', comprehensionHint: 'Use the passage.' }
            ],
            answers: [
              { name: 'In a shell', icon: '' },
              { name: 'In a bowl', icon: '' },
              { name: 'In a box', icon: '' }
            ],
            correctAnswerName: 'In a shell',
            successMessage: 'Yes! You remembered where the shrimp was.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I wish for fish and shrimp. I wish for fresh fish from this shop! I wish for shrimp too. What should I get from the fish shop today? The fish looks so fresh and shiny. The shrimp in shells look good. I wish I could get both! Maybe I should get fish on a dish to share!',
            words: null,
            variants: [
              { sentence: 'I wish for fish and shrimp. I wish for fish from this shop. I wish for fresh shrimp too. What should I get from the fish shop today? The fish looks so good. The shrimp looks fresh. I wish I could get both of them. Maybe I should get fish in a dish!', words: null },
              { sentence: 'I wish for fish and shrimp. I wish for fish from the shop. I wish for fresh shrimp. What should I get today? The fish looks good. The shrimp looks fresh. I wish for both. I look at the shop menu.', words: null },
              { sentence: 'I wish for fish and shrimp. I wish for fish from this shop. I wish for shrimp. What should I get? The fish looks so good. The fresh shrimp looks good too. I wish I could get both. I think about what to get.', words: null }
            ],
            targetWords: ['wish', 'fish', 'shrimp', 'What', 'should', 'get', 'from', 'shop', 'fresh', 'dish'],
            teachWord: { word: 'wish', sound: 'sh', highlight: 'wi-SH', position: 'end' },
            sightWordFocus: 'from',
            readingTip: 'Count the SH words! Wish, fish, shrimp, shop. How many SH words?'
          },
          {
            type: 'menu',
            prompt: 'Pick from the fish shop!',
            menuStory: 'Everything at the shop is fresh! What do you wish for?',
            variants: [
              { prompt: 'Choose one thing from the shop.', menuStory: 'Read the choices. Then choose one.' },
              { prompt: 'What will you get?', menuStory: 'Think about what you wish for in the story.' },
              { prompt: 'Pick your food from the fish shop.', menuStory: 'Pick one thing to eat.' }
            ],
            items: [
              { name: 'Fish', icon: '', description: 'Fresh from the sea' },
              { name: 'Shrimp', icon: '', description: 'Pink and yummy' },
              { name: 'Crab', icon: '', description: 'In a hard shell' }
            ]
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What did I wish for?',
            passage: 'I wish for fish and shrimp.',
            comprehensionHint: 'Read the two wish sentences.',
            variants: [
              { question: 'Which two things did I wish for?', comprehensionHint: 'Look for the two wish words.' },
              { question: 'What do I wish to get?', comprehensionHint: 'Use the passage.' },
              { question: 'What does the character want from the shop?', comprehensionHint: 'Wish tells what you want.' }
            ],
            answers: [
              { name: 'Fish and shrimp', icon: '' },
              { name: 'Fish and crab', icon: '' },
              { name: 'Shrimp and crab', icon: '' }
            ],
            correctAnswerName: 'Fish and shrimp',
            bonusQuestion: 'Can you find the SH sound in fish and shrimp?',
            successMessage: 'Yes! You remembered what the story said you wished for.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'My fresh fish is so good on this dish! The fish from the shop is the best I ever had. I wish for more. She got shrimp on her dish and it looks good too. The shrimp shells shine so bright. This shop is the best! I wish I could come back to this shop soon!',
            words: null,
            variants: [
              { sentence: 'My fresh fish is so good on this dish! The fish from the shop is the best. I wish for more. She got shrimp and her dish looks good too. The shells shine on her dish. This shop is the best! I wish I could come back soon!', words: null },
              { sentence: 'My fresh fish is so good on my dish! The fish from the shop is best. I wish for more. She got shrimp. Her dish looks good. The shells shine. This shop is the best! I wish I could come back!', words: null },
              { sentence: 'My fresh fish is so good! The fish from the shop is the best. I wish for more. She got shrimp on her dish. The shells shine bright. This shop is the best! I wish to come back soon!', words: null }
            ],
            targetWords: ['fresh', 'fish', 'is', 'good', 'wish', 'more', 'This', 'shop', 'best', 'dish', 'shrimp', 'She', 'shells', 'shine'],
            sightWordFocus: 'This',
            readingTip: 'You read many SH words. fish, fresh, wish, shop.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What did I wish for?',
            passage: 'I wish for more.',
            comprehensionHint: 'What word completes the wish?',
            variants: [
              { question: 'In the story, what did I wish for?', comprehensionHint: 'Read the passage.' },
              { question: 'What does more mean here?', comprehensionHint: 'More means extra.' },
              { question: 'What did I want again?', comprehensionHint: 'Wish tells what you want.' }
            ],
            answers: [
              { name: 'More', icon: '' },
              { name: 'Less', icon: '' },
              { name: 'Nothing', icon: '' }
            ],
            correctAnswerName: 'More',
            successMessage: 'Yes! You remembered what you wished for.'
          }
          ,
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What did I think about the shop?',
            passage: 'This shop is the best!',
            comprehensionHint: 'The answer is in the sentence.',
            variants: [
              { question: 'How do I feel about the shop?', comprehensionHint: 'Look for the describing words about the shop.' },
              { question: 'What is my opinion of the shop?', comprehensionHint: 'Opinion means what you think.' },
              { question: 'What does the story say about the shop?', comprehensionHint: 'Use the passage.' }
            ],
            answers: [
              { name: 'It is the best', icon: '' },
              { name: 'It is noisy', icon: '' },
              { name: 'It is closed', icon: '' }
            ],
            correctAnswerName: 'It is the best',
            successMessage: 'Yes! You used the story to find the opinion.'
          }
        ]
      },

      // ===== LEVEL 4: TH AND CH DIGRAPHS =====
      // Focus: CH digraph (cheese, choose, lunch, chunk, sandwich)
      // Longer passages with multiple sentences
      // More comprehension and story elements
      cheese: {
        name: 'Cheese Shop',
        icon: '',
        level: 4,
        floor: 3,
        stickers: ['', '', '', ''],
        digraphFocus: 'ch',
        sightWords: ['the', 'I', 'want', 'to', 'will', 'can', 'has', 'some', 'very', 'many'],
        previewWords: [
          { word: 'cheese', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'start' },
          { word: 'choose', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'start' },
          { word: 'sandwich', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'end' },
          { word: 'chunk', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'start' }
        ],
        pages: [
          {
            type: 'read',
            image: '',
            sentence: 'I am at the cheese shop today! The CH sound is in cheese and chunk. C and H work together. CH makes the ch sound. It sounds like a choo choo train! I can hear CH in cheese, choose, chunk, and munch.',
            words: null,
            variants: [
              { sentence: 'I am at the cheese shop today! The CH sound is in cheese and chunk. C and H work together. CH makes the ch sound. It sounds like a choo choo train! I can hear CH in cheese, choose, chunk, and munch.', words: null },
              { sentence: 'I am at the cheese shop today! The CH sound is in cheese and chunk. C and H work together. CH makes the ch sound. It sounds like a choo choo train! I hear the CH sound in cheese and choose. I hear the CH sound in chunk and munch.', words: null },
              { sentence: 'I am at the cheese shop today! The CH sound is in cheese and chunk. C and H work together. CH makes the ch sound. It sounds like a choo choo train! I can hear the CH sound in cheese, choose, chunk, and munch.', words: null }
            ],
            targetWords: ['am', 'cheese', 'shop', 'CH', 'sound', 'like', 'choo', 'train', 'makes', 'chunk'],
            teachWord: { word: 'cheese', sound: 'ch', highlight: 'CH-eese', position: 'start' },
            sightWordFocus: 'like',
            requireSightWordTap: true,
            readingTip: 'CH is one sound. CH makes the ch sound.'
          },
          {
            type: 'question',
            questionType: 'sightWord',
            questionMode: 'multipleChoice',
            passage: 'CH makes the ch sound.',
            question: 'What sound do the letters CH make?',
            comprehensionHint: 'Say the word cheese. Listen for ch.',
            variants: [
              { question: 'What sound does CH make?', comprehensionHint: 'CH is one sound. Say cheese.' },
              { question: 'Which sound is made by CH?', comprehensionHint: 'C and H together say ch.' },
              { question: 'In the word chunk, what sound do CH make?', comprehensionHint: 'Chunk starts with ch.' }
            ],
            answers: [
              { name: 'ch', icon: '' },
              { name: 'sh', icon: '' },
              { name: 'th', icon: '' }
            ],
            correctAnswerName: 'ch',
            successMessage: 'Yes! CH makes the ch sound.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I see big chunks of cheese on the shelf at this cheese shop! The shop has so many kinds to choose from. Some cheese is yellow and rich, and some cheese is white and soft. I can see tiny holes in one big chunk. A cheerful man at the shop gives me a chunk to try. I munch and chew the cheese. Yum! I want to choose one chunk to take home!',
            words: null,
            variants: [
              { sentence: 'I see big chunks of cheese on the shelf! The shop has so many kinds. Some cheese is yellow and rich, and some cheese is white and soft. I can see the holes in one big chunk. A nice man at the shop gives me a chunk to try. I munch on the cheese. I want to choose one to take home!', words: null },
              { sentence: 'I see big chunks of cheese on the shelf! The shop has so many kinds. Some cheese is yellow and rich, and some cheese is white and soft. I can see the holes in one big chunk. A nice man at the shop gives me a chunk to try. I munch on the cheese. I want to choose a kind.', words: null },
              { sentence: 'I see big chunks of cheese on the shelf! The shop has so many kinds. Some cheese is yellow and rich, and some cheese is white and soft. I can see the holes in one big chunk. A nice man at the shop gives me a chunk to try. I munch on the cheese. I look and choose one.', words: null }
            ],
            targetWords: ['see', 'chunks', 'cheese', 'shop', 'has', 'many', 'kinds', 'Some', 'yellow', 'white', 'want', 'choose'],
            teachWord: { word: 'chunks', sound: 'ch', highlight: 'CH-unks', position: 'start' },
            sightWordFocus: 'has',
            readingTip: 'Has tells what something has. The shop has many kinds.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What colors were some cheese?',
            passage: 'Some cheese is yellow and rich, and some cheese is white and soft.',
            comprehensionHint: 'Read the two color sentences.',
            variants: [
              { question: 'Which colors does the story name?', comprehensionHint: 'Find the two color words.' },
              { question: 'What are two cheese colors?', comprehensionHint: 'Read the passage again.' },
              { question: 'Pick the colors from the passage.', comprehensionHint: 'Choose the exact words.' }
            ],
            answers: [
              { name: 'Yellow and white', icon: '' },
              { name: 'Pink and brown', icon: '' },
              { name: 'Red and green', icon: '' }
            ],
            correctAnswerName: 'Yellow and white',
            successMessage: 'Great! You remembered the colors from the story.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I want to choose a cheese sandwich for lunch today! A sandwich has soft bread with chunks of cheese inside. A sandwich has bread and cheese. The man at the cheese shop will help me. He will choose the best cheese chunks for my sandwich. It will be very yummy and filling to munch on. I can eat each bite and chew it well. I will be so happy!',
            words: null,
            variants: [
              { sentence: 'I want a cheese sandwich for lunch today! A sandwich has soft bread and chunks of cheese. A sandwich has bread and cheese. The man will help me make my sandwich. He will choose the best cheese. It will be very yummy and filling. I can munch on it for my whole lunch. I can eat it all and feel happy!', words: null },
              { sentence: 'I want a cheese sandwich for lunch today! A sandwich has soft bread and chunks of cheese. A sandwich has bread and cheese. The man will help me make my sandwich. He will choose the best cheese. It will be very yummy and filling. I can eat it all and feel happy!', words: null },
              { sentence: 'I want a cheese sandwich for lunch today! A sandwich has soft bread and chunks of cheese. A sandwich has bread and cheese. The man will help me make my sandwich. He will choose the best cheese. It will be very yummy and filling. I can munch on it for my whole lunch.', words: null }
            ],
            targetWords: ['want', 'cheese', 'sandwich', 'lunch', 'has', 'bread', 'It', 'will', 'very', 'yummy', 'can', 'eat'],
            teachWord: { word: 'sandwich', sound: 'ch', highlight: 'sandwi-CH', position: 'end' },
            sightWordFocus: 'will',
            readingTip: 'Will tells what is going to happen. The man will help me.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What does a sandwich have?',
            passage: 'A sandwich has bread and cheese.',
            comprehensionHint: 'Read the sentence in the box.',
            variants: [
              { question: 'Which foods are in the sandwich?', comprehensionHint: 'Look for two foods.' },
              { question: 'What does the story say a sandwich has?', comprehensionHint: 'Use the passage.' },
              { question: 'What two things does a sandwich have?', comprehensionHint: 'Find two foods in the sentence.' }
            ],
            answers: [
              { name: 'Bread and cheese', icon: '' },
              { name: 'Milk and tea', icon: '' },
              { name: 'Fish and shrimp', icon: '' }
            ],
            correctAnswerName: 'Bread and cheese',
            successMessage: 'Yes! You used the story to answer.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I will choose cheese today at the cheese shop! The cheerful man helps me pick which cheese to get. He shows me each chunk on the shelf. He gives me a big chunk. I try it and munch on it. I take a bite and chew. The cheese is so rich and good! I choose my favorite chunk right away. I say thank you very much to him. This cheese shop is the best in the whole town!',
            words: null,
            variants: [
              { sentence: 'I will choose cheese today! The nice man at the shop helps me pick. He shows me each chunk. He gives me a big chunk. I take a bite and munch. The cheese is so good! I choose my favorite chunk. I say thank you. The cheese shop is the best!', words: null },
              { sentence: 'I will choose cheese today! The nice man helps me pick. He shows me each chunk. He gives me a big chunk. I take a bite and munch. The cheese is so good! I choose my favorite chunk. I say thank you. The cheese shop is the best!', words: null },
              { sentence: 'I will choose cheese today! The man at the shop helps me pick. He shows me each chunk. He gives me a big chunk. I take a bite and munch. The cheese is so good! I choose my favorite chunk. The cheese shop is the best!', words: null }
            ],
            targetWords: ['will', 'choose', 'cheese', 'today', 'nice', 'man', 'shop', 'helps', 'gives', 'big', 'chunk', 'thank', 'much'],
            teachWord: { word: 'choose', sound: 'ch', highlight: 'CH-oose', position: 'start' },
            sightWordFocus: 'gives',
            readingTip: 'Gives means to hand something to someone. He gives me a chunk.'
          },
          {
            type: 'menu',
            prompt: 'What cheese dish do you want?',
            menuStory: 'The cheese shop has yummy foods! Which one will you choose?',
            variants: [
              { prompt: 'Choose a cheese dish.', menuStory: 'Read the choices. Then choose one.' },
              { prompt: 'What will you choose?', menuStory: 'Pick one cheese food.' },
              { prompt: 'Pick one cheese meal.', menuStory: 'Choose one option.' }
            ],
            items: [
              { name: 'Cheese', icon: '', description: 'Just cheese chunks' },
              { name: 'Sandwich', icon: '', description: 'Cheese in bread' },
              { name: 'Chips', icon: '', description: 'With cheese on top' }
            ]
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What did the nice man give me?',
            passage: 'He gives me a big chunk.',
            comprehensionHint: 'Look for what he gives me.',
            variants: [
              { question: 'What did the man give me?', comprehensionHint: 'Read the words after gives me.' },
              { question: 'What did I get at the shop?', comprehensionHint: 'Use the passage.' },
              { question: 'What did the helper give me?', comprehensionHint: 'The helper is the nice man.' }
            ],
            answers: [
              { name: 'A big chunk', icon: '' },
              { name: 'A big cup', icon: '' },
              { name: 'A big cake', icon: '' }
            ],
            correctAnswerName: 'A big chunk',
            bonusQuestion: 'Can you hear the CH sound in chunk?',
            successMessage: 'Great! You remembered what the man gave you.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'My cheese sandwich is so yummy! I chose a good chunk of cheese for it. The cheese sandwich tastes very rich and good. I munch and chew each and every bite. The big chunk of cheese makes it extra delicious! I am so happy I chose to come to this cheese shop. I want to cheer and shout! I want to come back to this cheese shop soon!',
            words: null,
            variants: [
              { sentence: 'My cheese is so yummy! I chose a good chunk. The cheese sandwich tastes very good. I munch and chew each bite. The chunk of cheese makes it rich. I am so happy I chose this shop. I want to cheer! I want to come back to this cheese shop soon!', words: null },
              { sentence: 'My cheese is so yummy! I chose a good chunk. The cheese sandwich tastes very good. I munch and chew each bite. The chunk of cheese makes it rich. I want to cheer! I want to come back to this cheese shop soon!', words: null },
              { sentence: 'My cheese is so yummy! I chose a good chunk. The cheese sandwich tastes very good. I munch and chew each bite. I am so happy I chose this shop. I want to come back to this cheese shop soon!', words: null }
            ],
            targetWords: ['cheese', 'yummy', 'chose', 'good', 'sandwich', 'tastes', 'very', 'want', 'come', 'back', 'this', 'shop', 'soon'],
            sightWordFocus: 'come',
            readingTip: 'Come means to go to a place. I want to come back soon.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What do I want to do soon?',
            passage: 'I want to come back to this cheese shop soon!',
            comprehensionHint: 'What does the character want to do?',
            variants: [
              { question: 'What does the character want to do next?', comprehensionHint: 'Look for what I want to do soon.' },
              { question: 'What do I want to do soon?', comprehensionHint: 'Read the passage again.' },
              { question: 'What is my plan?', comprehensionHint: 'Plan means what you want to do.' }
            ],
            answers: [
              { name: 'Come back', icon: '' },
              { name: 'Go to bed', icon: '' },
              { name: 'Go home', icon: '' }
            ],
            correctAnswerName: 'Come back',
            successMessage: 'Yes! You remembered what you wanted to do.'
          }
        ]
      },
      noodle: {
        name: 'Noodle House',
        icon: '',
        level: 4,
        floor: 3,
        stickers: ['', '', '', ''],
        digraphFocus: 'th',
        sightWords: ['the', 'they', 'this', 'that', 'there', 'I', 'want', 'will', 'think', 'with'],
        previewWords: [
          { word: 'the', icon: '', isSightWord: true, hasDigraph: true, digraphPosition: 'start' },
          { word: 'this', icon: '', isSightWord: true, hasDigraph: true, digraphPosition: 'start' },
          { word: 'thick', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'start' },
          { word: 'that', icon: '', isSightWord: true, hasDigraph: true, digraphPosition: 'start' }
        ],
        pages: [
          {
            type: 'read',
            image: '',
            sentence: 'I am at the noodle house today! The TH sound is in the word the. The TH sound is in the word this. The TH sound is in the word that. TH makes the th sound. You make the TH sound with your tongue out a little. I can hear TH in the word they. I can hear TH in the word think.',
            words: null,
            variants: [
              { sentence: 'I am at the noodle house today! The TH sound is in the word the. The TH sound is in the word this. The TH sound is in the word that. TH makes the th sound. You make the TH sound with your tongue out a little. I can hear TH in the word they. I can hear TH in the word think.', words: null },
              { sentence: 'I am at the noodle house today! The TH sound is in the word the. The TH sound is in the word this. The TH sound is in the word that. TH makes the th sound. You make the TH sound with your tongue out a little. I can hear TH in the word think. I can hear TH in the word they.', words: null },
              { sentence: 'I am at the noodle house today! The TH sound is in the word this. The TH sound is in the word that. The TH sound is in the word the. TH makes the th sound. You make the TH sound with your tongue out a little. I can hear TH in the word they. I can hear TH in the word think.', words: null }
            ],
            targetWords: ['am', 'the', 'noodle', 'house', 'TH', 'sound', 'makes', 'with', 'your', 'tongue'],
            teachWord: { word: 'the', sound: 'th', highlight: 'TH-e', position: 'start' },
            sightWordFocus: 'with',
            requireSightWordTap: true,
            readingTip: 'Put your tongue out a little for TH. You make the sound with your tongue.'
          },
          {
            type: 'question',
            questionType: 'sightWord',
            questionMode: 'multipleChoice',
            question: 'What sound do the letters TH make?',
            passage: 'TH makes the th sound.',
            comprehensionHint: 'Say the word the. Listen for th.',
            variants: [
              { question: 'What sound does TH make?', comprehensionHint: 'TH is one sound. Say the.' },
              { question: 'Which sound is made by TH?', comprehensionHint: 'T and H together say th.' },
              { question: 'In the word this, what sound do TH make?', comprehensionHint: 'This starts with th.' }
            ],
            answers: [
              { name: 'th', icon: '' },
              { name: 'ch', icon: '' },
              { name: 'sh', icon: '' }
            ],
            correctAnswerName: 'th',
            successMessage: 'Yes! TH makes the th sound.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I see the hot noodles at this noodle house! They sit in big bowls on the counter. The steam goes up in the air. The noodles smell so amazing! I think they will be very good! I can feel the warmth coming from the bowls. This shop makes the best noodles in the whole town!',
            words: null,
            variants: [
              { sentence: 'I see the hot noodles at the shop. They are in big bowls on the counter. The steam goes up in the air. The noodles smell so good! I think they will be very good! I can feel the warmth from the bowls. This shop makes the best noodles!', words: null },
              { sentence: 'I see the hot noodles at the shop. They are in big bowls on the counter. The steam goes up in the air. The noodles smell so good! I think they will be very good! I can feel the warmth from the bowls. This shop makes the best noodles!', words: null },
              { sentence: 'I see the hot noodles at the shop. The bowls are big and on the counter. The steam goes up in the air. The noodles smell so good! I think they will be very good! I can feel the warmth from the bowls. This shop makes the best noodles!', words: null }
            ],
            targetWords: ['see', 'the', 'hot', 'noodles', 'shop', 'They', 'big', 'bowls', 'steam', 'goes', 'air', 'think', 'will', 'very', 'good'],
            teachWord: { word: 'They', sound: 'th', highlight: 'TH-ey', position: 'start' },
            sightWordFocus: 'They',
            readingTip: 'They means more than one. They are in bowls. They smell good.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'Where did the steam go?',
            passage: 'The steam goes up in the air.',
            comprehensionHint: 'Read the sentence in the box.',
            variants: [
              { question: 'What happened to the steam?', comprehensionHint: 'Use the passage.' },
              { question: 'In the story, where did the steam go?', comprehensionHint: 'Look for the words up and air.' },
              { question: 'Where does the steam go?', comprehensionHint: 'Find the direction word.' }
            ],
            answers: [
              { name: 'Up in the air', icon: '' },
              { name: 'Down on the floor', icon: '' },
              { name: 'Into the bowl', icon: '' }
            ],
            correctAnswerName: 'Up in the air',
            successMessage: 'Yes! You remembered a detail from the story.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What did I think about the noodles?',
            passage: 'I think they will be very good!',
            comprehensionHint: 'Read the words after I think.',
            variants: [
              { question: 'What do I think will happen?', comprehensionHint: 'Read the words after I think.' },
              { question: 'In the story, what did I think?', comprehensionHint: 'Use the passage.' },
              { question: 'What do I think?', comprehensionHint: 'Read the words after I think.' }
            ],
            answers: [
              { name: 'They will be very good', icon: '' },
              { name: 'They will be very cold', icon: '' },
              { name: 'They will be very bad', icon: '' }
            ],
            correctAnswerName: 'They will be very good',
            successMessage: 'Yes! You found what I thought.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'This soup at the noodle house is so hot and delicious! I smell the yummy broth. The amazing smell fills the whole room. There are many good things floating in the soup. I see thick noodles and other things in there. The broth looks thick and very rich. I want to taste it right away! I want to eat it all with these chopsticks!',
            words: null,
            variants: [
              { sentence: 'This soup is so hot and good! I smell the yummy broth. The smell fills the air. There are many things in the soup. I see noodles and things floating. The broth looks thick and rich. I want to taste it! I want to eat it all with chopsticks!', words: null },
              { sentence: 'This soup is so hot and good! I smell the yummy broth. The smell fills the air. There are many things in the soup. I see noodles and things floating. The broth looks thick and rich. I want to eat it all with chopsticks!', words: null },
              { sentence: 'This soup is so hot and good! I smell the yummy broth. The smell fills the air. There are many things in the soup. I see noodles and things floating. The broth looks thick and rich. I want to taste it!', words: null }
            ],
            targetWords: ['This', 'soup', 'hot', 'good', 'smell', 'the', 'yummy', 'broth', 'There', 'many', 'things', 'want', 'eat'],
            teachWord: { word: 'This', sound: 'th', highlight: 'TH-is', position: 'start' },
            sightWordFocus: 'There',
            readingTip: 'There tells where something is. There are noodles in the soup.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What did I smell?',
            passage: 'I smell the yummy broth.',
            comprehensionHint: 'Read the sentence in the box.',
            variants: [
              { question: 'What smell did I notice?', comprehensionHint: 'Find the words after smell.' },
              { question: 'In the story, what did I smell?', comprehensionHint: 'Use the passage.' },
              { question: 'What did I smell in the soup?', comprehensionHint: 'Look for broth.' }
            ],
            answers: [
              { name: 'Yummy broth', icon: '' },
              { name: 'Yummy noodles', icon: '' },
              { name: 'Yummy rice', icon: '' }
            ],
            correctAnswerName: 'Yummy broth',
            successMessage: 'Great! You found the right detail.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'I want that big bowl over there on the counter! The one with all the thick noodles inside. The noodles look thick and long. They are smooth and shiny in the broth. I think I will use chopsticks. I am very hungry right now! This is the perfect meal for me to eat!',
            words: null,
            variants: [
              { sentence: 'I want that bowl over there! The one with the thick noodles. The noodles look thick and long. They are smooth and shiny. I think I will use chopsticks. I am very hungry now! This is the perfect meal for me!', words: null },
              { sentence: 'I want that bowl over there! The one with the thick noodles. The noodles look thick and long. They are smooth and shiny. I think I will use chopsticks. This is the perfect meal for me!', words: null },
              { sentence: 'I want that bowl over there! The one with the thick noodles. The noodles look thick and long. They are smooth and shiny. I think I will use chopsticks. I am hungry now! This is the perfect meal for me!', words: null }
            ],
            targetWords: ['want', 'that', 'bowl', 'over', 'there', 'The', 'noodles', 'look', 'thick', 'long', 'think', 'will', 'chopsticks', 'very', 'hungry'],
            teachWord: { word: 'that', sound: 'th', highlight: 'TH-at', position: 'start' },
            sightWordFocus: 'think',
            readingTip: 'Think means to use your brain. I think I will use chopsticks.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'What will I use to eat the noodles?',
            passage: 'I think I will use chopsticks.',
            comprehensionHint: 'Read the sentence in the box.',
            variants: [
              { question: 'What will I use?', comprehensionHint: 'Look for the tool word.' },
              { question: 'In the story, what will I use to eat?', comprehensionHint: 'Use the passage.' },
              { question: 'What tool will I use?', comprehensionHint: 'Find the tool word.' }
            ],
            answers: [
              { name: 'Chopsticks', icon: '' },
              { name: 'A fork', icon: '' },
              { name: 'My hands', icon: '' }
            ],
            correctAnswerName: 'Chopsticks',
            bonusQuestion: 'Can you say the thick noodles and hear the TH sound?',
            successMessage: 'Yes! You remembered what the story said.'
          },
          {
            type: 'menu',
            prompt: 'Which yummy food do you want?',
            menuStory: 'The noodle house has many yummy things! What will you pick?',
            variants: [
              { prompt: 'Choose one food.', menuStory: 'Read the choices. Then choose one.' },
              { prompt: 'What will you eat?', menuStory: 'Pick one food from the noodle house.' },
              { prompt: 'Pick your meal.', menuStory: 'Choose one option.' }
            ],
            items: [
              { name: 'Noodles', icon: '', description: 'Long and thick' },
              { name: 'Soup', icon: '', description: 'Hot and yummy' },
              { name: 'Rice', icon: '', description: 'Soft and white' }
            ]
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'How did the noodles look?',
            passage: 'The noodles look thick and long.',
            comprehensionHint: 'Read the describing words.',
            variants: [
              { question: 'Which words describe the noodles?', comprehensionHint: 'Find the describing words in the passage.' },
              { question: 'In the story, how do the noodles look?', comprehensionHint: 'Use the passage.' },
              { question: 'What does the story say about the noodles?', comprehensionHint: 'Look for two describing words.' }
            ],
            answers: [
              { name: 'Thick and long', icon: '' },
              { name: 'Thin and long', icon: '' },
              { name: 'Thick and short', icon: '' }
            ],
            correctAnswerName: 'Thick and long',
            successMessage: 'Yes! You remembered how the story described the noodles.'
          },
          {
            type: 'read',
            image: '',
            sentence: 'The noodles from this noodle house are so good! They are thick and very tasty. The warm broth fills my whole mouth with flavor. I slurp the long noodles with my chopsticks. I think this is the very best meal I have ever had! The cook at this shop made these noodles perfectly. I feel so happy and full! I want to thank the cook!',
            words: null,
            variants: [
              { sentence: 'The noodles are so good! They are thick and tasty. The broth is warm and fills my mouth. I slurp the noodles with my chopsticks. I think this is the best meal! The cook made this perfectly. I feel so happy! I want to thank the cook!', words: null },
              { sentence: 'The noodles are so good! They are thick and tasty. The broth is warm and fills my mouth. I slurp the noodles with my chopsticks. The cook made this perfectly. I feel so happy! I want to thank the cook!', words: null },
              { sentence: 'The noodles are so good! They are thick and tasty. The broth is warm and fills my mouth. I slurp the noodles with my chopsticks. I think this is the best meal! I feel so happy! I want to thank the cook!', words: null }
            ],
            targetWords: ['The', 'noodles', 'good', 'They', 'thick', 'tasty', 'think', 'this', 'the', 'best', 'meal', 'want', 'thank', 'cook'],
            sightWordFocus: 'thank',
            readingTip: 'Thank is what you say to be kind. I thank the cook.'
          },
          {
            type: 'question',
            questionType: 'comprehension',
            questionMode: 'multipleChoice',
            question: 'Who do I want to thank?',
            passage: 'I want to thank the cook!',
            comprehensionHint: 'Read the sentence in the box.',
            variants: [
              { question: 'Who does the story say I want to thank?', comprehensionHint: 'Use the passage.' },
              { question: 'Who do I want to thank?', comprehensionHint: 'Find the person word.' },
              { question: 'Who helped make the meal?', comprehensionHint: 'Think about who makes the meal.' }
            ],
            answers: [
              { name: 'The cook', icon: '' },
              { name: 'The train', icon: '' },
              { name: 'The bowl', icon: '' }
            ],
            correctAnswerName: 'The cook',
            successMessage: 'Yes! You remembered who I want to thank.'
          }
        ]
      }
      ,
      // ===== NEW STATIONS (7 additional) =====

      // Red Bean Bread (Level 1 - CVC Consolidation)
      redbean: {
        name: 'Red Bean Bread',
        icon: '',
        level: 1,
        floor: 3,
        stickers: ['', '', '', ''],
        sightWords: ['I', 'see', 'a', 'the', 'is', 'my', 'want', 'like', 'can', 'good'],
        previewWords: [
          { word: 'red', icon: '', isSightWord: false, phonicsNote: 'r-e-d (CVC)' },
          { word: 'bean', icon: '', isSightWord: false, phonicsNote: 'b-ea-n' },
          { word: 'bread', icon: '', isSightWord: false, phonicsNote: 'br-ea-d' },
          { word: 'want', icon: '', isSightWord: true }
        ],
        pages: [
          { type: 'read', image: '', sentence: 'I am at the red bean bread shop. I see fresh bread on the shelf. The bread is warm. It smells so good! I can see red beans inside. The beans are sweet.', words: null, targetWords: ['red', 'bean', 'bread', 'warm', 'sweet'], sightWordFocus: 'the', readingTip: 'Red bean bread is a popular treat in Taiwan!' },
          { type: 'question', questionType: 'comprehension', questionMode: 'multipleChoice', passage: 'I am at the red bean bread shop.', question: 'Where am I?', comprehensionHint: 'Find the name of the shop.', answers: [{ name: 'Red Bean Bread Shop', icon: '' }, { name: 'Fruit Stand', icon: '' }, { name: 'Pizza Place', icon: '' }], correctAnswerName: 'Red Bean Bread Shop', successMessage: 'Yes! You found the setting.' },
          { type: 'read', image: '', sentence: 'I pick a big bun. The bun is soft and warm. I take a bite. Yum! The red beans are sweet inside. This is so good! I like red bean bread a lot.', words: null, targetWords: ['big', 'bun', 'soft', 'warm', 'bite', 'sweet'], sightWordFocus: 'like', readingTip: 'Notice the CVC words: big, bun, red, lot!' },
          { type: 'menu', prompt: 'Pick your bread!', menuStory: 'The bread looks so good. What will you pick?', items: [{ name: 'Red Bean Bun', icon: '', description: 'Sweet and soft' }, { name: 'Plain Roll', icon: '', description: 'Simple and warm' }, { name: 'Sesame Bread', icon: '', description: 'Crunchy seeds' }] },
          { type: 'question', questionType: 'comprehension', questionMode: 'multipleChoice', passage: 'The red beans are sweet inside.', question: 'How do the red beans taste?', comprehensionHint: 'Find the taste word.', answers: [{ name: 'Sweet', icon: '' }, { name: 'Sour', icon: '' }, { name: 'Spicy', icon: '' }], correctAnswerName: 'Sweet', successMessage: 'Yes! The red beans are sweet!' }
        ]
      },

      // Bubble Tea (Level 2 - Compound Words)
      bubbletea: {
        name: 'Bubble Tea',
        icon: '',
        level: 2,
        floor: 3,
        stickers: ['', '', '', ''],
        sightWords: ['I', 'see', 'want', 'to', 'get', 'some', 'very', 'my', 'this', 'with'],
        previewWords: [
          { word: 'bubble', icon: '', isSightWord: false, phonicsNote: 'bub-ble (2 syllables)' },
          { word: 'tea', icon: '', isSightWord: false, phonicsNote: 't-ea' },
          { word: 'tapioca', icon: '', isSightWord: false, phonicsNote: 'tap-i-o-ca (4 syllables)' },
          { word: 'want', icon: '', isSightWord: true }
        ],
        pages: [
          { type: 'read', image: '', sentence: 'I am at the bubble tea shop. I see many cups with tea inside. The tea has bubbles at the bottom! The bubbles are tapioca pearls. They look so fun to drink!', words: null, targetWords: ['bubble', 'tea', 'cups', 'bubbles', 'tapioca', 'pearls'], sightWordFocus: 'with', readingTip: 'Bubble tea is a famous drink from Taiwan!' },
          { type: 'question', questionType: 'comprehension', questionMode: 'multipleChoice', passage: 'The bubbles are tapioca pearls.', question: 'What are the bubbles made of?', comprehensionHint: 'Find the word that tells what the bubbles are.', answers: [{ name: 'Tapioca pearls', icon: '' }, { name: 'Candy', icon: '' }, { name: 'Ice', icon: '' }], correctAnswerName: 'Tapioca pearls', successMessage: 'Yes! Tapioca pearls are the bubbles!' },
          { type: 'read', image: '', sentence: 'I want to get some bubble tea. I pick milk tea with bubbles. The cup is cold in my hand. I sip the tea with a big straw. The bubbles pop in my mouth! This is so yummy!', words: null, targetWords: ['bubble', 'milk', 'tea', 'cold', 'straw', 'pop', 'mouth'], sightWordFocus: 'some', readingTip: 'Milk tea is two words. Milk and tea.' },
          { type: 'menu', prompt: 'Pick your bubble tea!', menuStory: 'So many flavors! What will you pick?', items: [{ name: 'Milk Tea', icon: '', description: 'Classic and creamy' }, { name: 'Fruit Tea', icon: '', description: 'Fresh and fruity' }, { name: 'Green Tea', icon: '', description: 'Light and fresh' }] },
          { type: 'question', questionType: 'comprehension', questionMode: 'multipleChoice', passage: 'I sip the tea with a big straw.', question: 'How do I drink the tea?', comprehensionHint: 'Find the tool used for drinking.', answers: [{ name: 'With a straw', icon: '' }, { name: 'With a spoon', icon: '' }, { name: 'With a cup', icon: '' }], correctAnswerName: 'With a straw', successMessage: 'Yes! You use a big straw for bubble tea!' }
        ]
      },

      // Burger Joint (Level 2 - Action Words)
      burger: {
        name: 'Burger Joint',
        icon: '',
        level: 2,
        floor: 3,
        stickers: ['', '', '', ''],
        sightWords: ['I', 'see', 'want', 'to', 'eat', 'some', 'very', 'big', 'my', 'this'],
        previewWords: [
          { word: 'burger', icon: '', isSightWord: false, phonicsNote: 'bur-ger (2 syllables)' },
          { word: 'fries', icon: '', isSightWord: false, phonicsNote: 'fr-ies' },
          { word: 'bite', icon: '', isSightWord: false, phonicsNote: 'b-i-te (silent e)' },
          { word: 'eat', icon: '', isSightWord: true }
        ],
        pages: [
          { type: 'read', image: '', sentence: 'I am at the burger joint. I see big burgers on the menu. The burgers have meat and cheese. I also see fries! The fries are golden and crispy.', words: null, targetWords: ['burger', 'big', 'meat', 'cheese', 'fries', 'golden', 'crispy'], sightWordFocus: 'see', readingTip: 'Action words tell us what happens: see, eat, bite!' },
          { type: 'question', questionType: 'comprehension', questionMode: 'multipleChoice', passage: 'The fries are golden and crispy.', question: 'What are the fries like?', comprehensionHint: 'Find the words that describe the fries.', answers: [{ name: 'Golden and crispy', icon: '' }, { name: 'Cold and wet', icon: '' }, { name: 'Soft and white', icon: '' }], correctAnswerName: 'Golden and crispy', successMessage: 'Yes! The fries are golden and crispy!' },
          { type: 'read', image: '', sentence: 'I want to eat a big burger. I pick it up with my hands. I take a big bite. Mmm! The cheese is melty. The meat is juicy. I chew and chew. This is so good!', words: null, targetWords: ['eat', 'pick', 'bite', 'chew', 'melty', 'juicy'], sightWordFocus: 'eat', readingTip: 'Notice the action words: eat, pick, bite, chew!' },
          { type: 'menu', prompt: 'Pick your meal!', menuStory: 'Time to order! What will you pick?', items: [{ name: 'Burger', icon: '', description: 'Big and juicy' }, { name: 'Fries', icon: '', description: 'Golden and crispy' }, { name: 'Both!', icon: '', description: 'A full meal' }] },
          { type: 'question', questionType: 'comprehension', questionMode: 'multipleChoice', passage: 'I take a big bite.', question: 'What action word tells how I eat?', comprehensionHint: 'Find the word that shows eating.', answers: [{ name: 'Bite', icon: '' }, { name: 'Sleep', icon: '' }, { name: 'Run', icon: '' }], correctAnswerName: 'Bite', successMessage: 'Yes! Bite is the action word.' }
        ]
      },

      // Sushi Bar (Level 3 - sh digraph practice)
      sushi: {
        name: 'Sushi Bar',
        icon: '',
        level: 3,
        floor: 3,
        stickers: ['', '', '', ''],
        digraphFocus: 'sh',
        sightWords: ['the', 'look', 'they', 'want', 'some', 'I', 'see', 'so', 'for', 'my'],
        previewWords: [
          { word: 'sushi', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'middle' },
          { word: 'fish', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'end' },
          { word: 'fresh', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'end' },
          { word: 'dish', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'end' }
        ],
        pages: [
          { type: 'read', image: '', sentence: 'I am at the sushi bar. I see fresh fish on a dish. The sushi looks so good! The fish shines in the light. I wish I could eat it all!', words: null, targetWords: ['sushi', 'fresh', 'fish', 'dish', 'shines', 'wish'], sightWordFocus: 'the', readingTip: 'Listen for the sh sound. sushi, fish, dish, shines, wish.' },
          { type: 'question', questionType: 'sightWord', questionMode: 'multipleChoice', passage: 'The fish shines in the light.', question: 'Which word ends with sh?', comprehensionHint: 'Say each word. Listen for sh at the end.', answers: [{ name: 'fish', icon: '' }, { name: 'shines', icon: '' }, { name: 'light', icon: '' }], correctAnswerName: 'fish', successMessage: 'Yes! Fish ends with the sh sound.' },
          { type: 'read', image: '', sentence: 'I pick some sushi to share. The chef makes a fresh dish for me. I use chopsticks to eat. The fish is so fresh! I shall come back soon!', words: null, targetWords: ['sushi', 'share', 'fresh', 'dish', 'shall'], sightWordFocus: 'some', readingTip: 'Share and shall also have the sh sound.' },
          { type: 'menu', prompt: 'Pick your sushi!', menuStory: 'The sushi looks fresh! What will you pick?', items: [{ name: 'Fish Sushi', icon: '', description: 'Fresh fish on rice' }, { name: 'Shrimp Roll', icon: '', description: 'Shrimp inside' }, { name: 'Veggie Roll', icon: '', description: 'Fresh vegetables' }] },
          { type: 'question', questionType: 'sightWord', questionMode: 'multipleChoice', passage: 'The sushi is fresh.', question: 'Which word has sh in the middle?', comprehensionHint: 'Say each word slowly. Listen for sh in the middle.', answers: [{ name: 'sushi', icon: '' }, { name: 'fish', icon: '' }, { name: 'fresh', icon: '' }], correctAnswerName: 'sushi', successMessage: 'Yes! Sushi has sh in the middle.' }
        ]
      },

      // Chicken Hut (Level 3 - ch digraph practice)
      chicken: {
        name: 'Chicken Hut',
        icon: '',
        level: 3,
        floor: 3,
        stickers: ['', '', '', ''],
        digraphFocus: 'ch',
        sightWords: ['the', 'I', 'want', 'to', 'will', 'can', 'has', 'some', 'very', 'many'],
        previewWords: [
          { word: 'chicken', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'start' },
          { word: 'crunchy', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'middle' },
          { word: 'munch', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'end' },
          { word: 'choice', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'start' }
        ],
        pages: [
          { type: 'read', image: '', sentence: 'I am at the chicken hut. I see chicken cooking! The chicken is crunchy and golden. I can choose what I want. There are so many choices!', words: null, targetWords: ['chicken', 'crunchy', 'choose', 'choices'], sightWordFocus: 'the', readingTip: 'Listen for the ch sound. chicken, crunchy, choose, choices.' },
          { type: 'question', questionType: 'sightWord', questionMode: 'multipleChoice', passage: 'The chicken is crunchy.', question: 'Which word starts with the ch sound?', comprehensionHint: 'Say each word. Listen for ch at the start.', answers: [{ name: 'chicken', icon: '' }, { name: 'golden', icon: '' }, { name: 'crunchy', icon: '' }], correctAnswerName: 'chicken', successMessage: 'Yes! Chicken starts with the ch sound.' },
          { type: 'read', image: '', sentence: 'I choose a big piece of chicken. I munch on it. Crunch, crunch! It is so crunchy! Each bite is yummy. I chew and chew. This is the best chicken!', words: null, targetWords: ['choose', 'chicken', 'munch', 'crunch', 'crunchy', 'each', 'chew'], sightWordFocus: 'each', readingTip: 'Munch and crunch end with the ch sound.' },
          { type: 'menu', prompt: 'Make your choice!', menuStory: 'The chicken smells so good! What will you choose?', items: [{ name: 'Chicken Leg', icon: '', description: 'Big and crunchy' }, { name: 'Chicken Wing', icon: '', description: 'Small and crispy' }, { name: 'Chicken Chunks', icon: '', description: 'Bite-sized pieces' }] },
          { type: 'question', questionType: 'sightWord', questionMode: 'multipleChoice', passage: 'I munch on the crunchy chicken.', question: 'Which word ends with ch?', comprehensionHint: 'Say each word slowly. Listen for ch at the end.', answers: [{ name: 'munch', icon: '' }, { name: 'chicken', icon: '' }, { name: 'choose', icon: '' }], correctAnswerName: 'munch', successMessage: 'Yes! Munch ends with the ch sound.' }
        ]
      },

      // Smoothie Stand (Level 4 - th digraph practice)
      smoothie: {
        name: 'Smoothie Stand',
        icon: '',
        level: 4,
        floor: 3,
        stickers: ['', '', '', ''],
        digraphFocus: 'th',
        sightWords: ['the', 'they', 'this', 'that', 'there', 'I', 'want', 'will', 'think', 'with'],
        previewWords: [
          { word: 'the', icon: '', isSightWord: true, hasDigraph: true, digraphPosition: 'start' },
          { word: 'this', icon: '', isSightWord: true, hasDigraph: true, digraphPosition: 'start' },
          { word: 'thick', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'start' },
          { word: 'smooth', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'end' }
        ],
        pages: [
          { type: 'read', image: '', sentence: 'I am at the smoothie stand. I see thick smoothies there. This one has mango. That one has berries. I think they all look good!', words: null, targetWords: ['the', 'thick', 'there', 'this', 'that', 'think', 'they'], sightWordFocus: 'there', readingTip: 'Listen for the th sound. the, thick, there, this, that, think, they.' },
          { type: 'question', questionType: 'sightWord', questionMode: 'multipleChoice', passage: 'This one has mango. That one has berries.', question: 'Which two words start with th?', comprehensionHint: 'Find the pointing words that start with th.', answers: [{ name: 'This and That', icon: '' }, { name: 'One and Has', icon: '1' }, { name: 'Mango and Berries', icon: '' }], correctAnswerName: 'This and That', successMessage: 'Yes! This and that both start with th.' },
          { type: 'read', image: '', sentence: 'I think I want this thick smoothie. The fruit is fresh. They blend it smooth. I drink it through a straw. Mmm! This is the best thing ever!', words: null, targetWords: ['think', 'this', 'thick', 'the', 'they', 'smooth', 'through', 'thing'], sightWordFocus: 'think', readingTip: 'Smooth and through end with the th sound.' },
          { type: 'menu', prompt: 'Pick your smoothie!', menuStory: 'They all look thick and yummy! What will you pick?', items: [{ name: 'Mango Smoothie', icon: '', description: 'Thick and tropical' }, { name: 'Berry Smoothie', icon: '', description: 'Sweet and smooth' }, { name: 'Banana Smoothie', icon: '', description: 'Creamy and thick' }] },
          { type: 'question', questionType: 'sightWord', questionMode: 'multipleChoice', passage: 'They blend it smooth.', question: 'Which word ends with th?', comprehensionHint: 'Say each word slowly. Listen for th at the end.', answers: [{ name: 'smooth', icon: '' }, { name: 'they', icon: '' }, { name: 'blend', icon: '' }], correctAnswerName: 'smooth', successMessage: 'Yes! Smooth ends with the th sound.' }
        ]
      },

      // Tea House (Level 4 - th consolidation)
      teahouse: {
        name: 'Tea House',
        icon: '',
        level: 4,
        floor: 3,
        stickers: ['', '', '', ''],
        digraphFocus: 'th',
        sightWords: ['the', 'they', 'this', 'that', 'there', 'I', 'want', 'will', 'think', 'with'],
        previewWords: [
          { word: 'the', icon: '', isSightWord: true, hasDigraph: true, digraphPosition: 'start' },
          { word: 'with', icon: '', isSightWord: true, hasDigraph: true, digraphPosition: 'end' },
          { word: 'thank', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'start' },
          { word: 'both', icon: '', isSightWord: false, hasDigraph: true, digraphPosition: 'end' }
        ],
        pages: [
          { type: 'read', image: '', sentence: 'I am at the tea house in the mountains. The air is fresh up here. I can see the city far below. This is a peaceful place. I think I will stay for a while.', words: null, targetWords: ['the', 'this', 'think'], sightWordFocus: 'the', readingTip: 'Traditional tea houses in Taiwan are often in the mountains!' },
          { type: 'question', questionType: 'comprehension', questionMode: 'multipleChoice', passage: 'I am at the tea house in the mountains.', question: 'Where is the tea house?', comprehensionHint: 'Find where the tea house is located.', answers: [{ name: 'In the mountains', icon: '' }, { name: 'By the beach', icon: '' }, { name: 'In the city', icon: '' }], correctAnswerName: 'In the mountains', successMessage: 'Yes! The tea house is in the mountains!' },
          { type: 'read', image: '', sentence: 'The tea is warm with a nice smell. I drink it with both hands. I think this tea is the best! I thank the server. They smile at me. I feel thankful for this moment.', words: null, targetWords: ['the', 'with', 'both', 'think', 'this', 'thank', 'they', 'thankful'], sightWordFocus: 'with', readingTip: 'Thank and thankful both start with th.' },
          { type: 'menu', prompt: 'Pick your tea!', menuStory: 'The tea house has many teas. What will you pick?', items: [{ name: 'Green Tea', icon: '', description: 'Light and fresh' }, { name: 'Oolong Tea', icon: '', description: 'Rich and smooth' }, { name: 'Milk Tea', icon: '', description: 'Creamy and warm' }] },
          { type: 'question', questionType: 'sightWord', questionMode: 'multipleChoice', passage: 'I feel thankful for this moment.', question: 'Which word has th at the start?', comprehensionHint: 'Find the feeling word that starts with th.', answers: [{ name: 'thankful', icon: '' }, { name: 'with', icon: '' }, { name: 'both', icon: '' }], correctAnswerName: 'thankful', successMessage: 'Yes! Thankful starts with the th sound.' }
        ]
      },
      practice: {
        name: 'Skill Practice',
        icon: '',
        level: 1,
        floor: 2,
        isPractice: true,
        stickers: ['', '', '', ''],
        sightWords: [],
        previewWords: [],
        pages: []
      }
    };

    // ===== SPEECH SYNTHESIS (ElevenLabs TTS) =====
    let audioContext = null;
    let currentSource = null;
    // Cache key (lowercased text) -> { arrayBuffer, mimeType, outputFormat, wordTimings, decodedAudioBuffer }
    const audioCache = new Map();
    let ttsManifest = null;
    let ttsManifestPromise = null;

    async function loadTtsManifest() {
      if (ttsManifest) return ttsManifest;
      if (ttsManifestPromise) return ttsManifestPromise;

      ttsManifestPromise = (async () => {
        try {
          const resp = await fetch('assets/tts/manifest.json', { cache: 'no-store' });
          if (!resp.ok) return null;
          const json = await resp.json();
          if (json && typeof json === 'object' && json.items && typeof json.items === 'object') {
            ttsManifest = json;
          }
        } catch (e) {}
        return ttsManifest;
      })();

      const result = await ttsManifestPromise;
      // If the manifest failed to load, allow a retry later.
      if (!ttsManifest) ttsManifestPromise = null;
      return result;
    }

    async function maybeLoadPrebuiltClip(cacheKey) {
      const manifest = await loadTtsManifest();
      const entry = manifest && manifest.items ? manifest.items[cacheKey] : null;
      if (!entry || !entry.file) return null;

      try {
        const resp = await fetch(entry.file, { cache: 'force-cache' });
        if (!resp.ok) return null;
        const arrayBuffer = await resp.arrayBuffer();
        const clip = {
          arrayBuffer,
          mimeType: entry.mimeType || manifest.mimeType || 'audio/mpeg',
          outputFormat: entry.outputFormat || manifest.outputFormat || 'default',
          wordTimings: entry.wordTimings || null,
          decodedAudioBuffer: null
        };
        audioCache.set(cacheKey, clip);
        return clip;
      } catch (e) {
        return null;
      }
    }

    // Initialize audio context on first user interaction
    function initAudioContext() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioContext;
    }

    let audioUnlockAttempted = false;
    function unlockAudioContext() {
      const ctx = initAudioContext();
      if (!ctx) return null;

      // On iOS Safari, AudioContext resume must be initiated from a user gesture.
      // Do not await here; just kick off resume during the gesture.
      if (ctx.state === 'suspended' || ctx.state === 'interrupted') {
        try {
          const p = ctx.resume();
          if (p && typeof p.catch === 'function') p.catch(() => {});
        } catch (e) {}
      }

      // iOS sometimes requires a "real" source start to fully unlock audio.
      if (!audioUnlockAttempted) {
        try {
          const silentBuffer = ctx.createBuffer(1, 1, ctx.sampleRate || 44100);
          const source = ctx.createBufferSource();
          source.buffer = silentBuffer;
          source.connect(ctx.destination);
          const now = ctx.currentTime;
          source.start(now);
          source.stop(now + 0.01);
          audioUnlockAttempted = true;
        } catch (e) {
          // If this fails, we'll try again on the next user gesture.
          audioUnlockAttempted = false;
        }
      }

      return ctx;
    }

    async function ensureAudioContextReady(timeoutMs = 250) {
      const ctx = initAudioContext();
      if (ctx.state !== 'suspended' && ctx.state !== 'interrupted') return ctx;

      try {
        const resumePromise = ctx.resume();
        if (resumePromise && typeof resumePromise.then === 'function') {
          await Promise.race([
            resumePromise,
            new Promise(resolve => setTimeout(resolve, timeoutMs))
          ]);
        }
      } catch (e) {}

      return ctx;
    }

    // Returns audio metadata for timing synchronization, or null if no audio
    async function speak(text, playbackRate = 1.0, options = {}) {
      if (!state.soundEnabled) return null;
      // Best-effort unlock for mobile Safari (no-op on desktop).
      unlockAudioContext();

      // Stop any currently playing audio
      if (currentSource) {
        try { currentSource.stop(); } catch (e) {}
        currentSource = null;
      }

      // Check cache first
      const cacheKey = text.toLowerCase().trim();
      if (audioCache.has(cacheKey)) {
        try {
          return await playTtsAudio(audioCache.get(cacheKey), playbackRate, options);
        } catch (e) {
          console.warn('WebAudio playback failed (cached). Falling back to SpeechSynthesis.', e);
          return fallbackSpeak(text, playbackRate);
        }
      }

      try {
        // Try pre-generated audio (assets/tts/manifest.json) before calling the API.
        const prebuilt = await maybeLoadPrebuiltClip(cacheKey);
        if (prebuilt) {
          try {
            return await playTtsAudio(prebuilt, playbackRate, options);
          } catch (e) {
            console.warn('WebAudio playback failed (prebuilt). Falling back to SpeechSynthesis.', e);
            return fallbackSpeak(text, playbackRate);
          }
        }

        // Call our TTS API
        const response = await fetch('/api/tts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: text
          })
        });

        if (!response.ok) {
          console.error('TTS API error:', response.status);
          return fallbackSpeak(text, playbackRate);
        }

        const data = await response.json();

        if (data.audio) {
          const clip = {
            arrayBuffer: base64ToArrayBuffer(data.audio),
            mimeType: data.mimeType || 'audio/mpeg',
            outputFormat: data.outputFormat || 'default',
            wordTimings: data.wordTimings || null,
            decodedAudioBuffer: null
          };
          audioCache.set(cacheKey, clip);
          try {
            return await playTtsAudio(clip, playbackRate, options);
          } catch (e) {
            console.warn('WebAudio playback failed. Falling back to SpeechSynthesis.', e);
            return fallbackSpeak(text, playbackRate);
          }
        } else {
          return fallbackSpeak(text, playbackRate);
        }

      } catch (error) {
        console.error('TTS error:', error);
        return fallbackSpeak(text, playbackRate);
      }
    }

    function stopSpeech() {
      if (!currentSource) return;
      try { currentSource.stop(); } catch (e) {}
      currentSource = null;
    }

	    function setContinueEnabled(enabled) {
	      const continueBtn = document.getElementById('continueBtn');
	      if (!continueBtn) return;
	      continueBtn.disabled = !enabled;
	      continueBtn.setAttribute('aria-disabled', (!enabled).toString());
	    }

	    function clearSightWordNudges() {
	      const focusChip = document.getElementById('focusSightWord');
	      if (focusChip) focusChip.classList.remove('gate-nudge');
	      const display = document.getElementById('sentenceDisplay');
	      if (display) {
	        display.querySelectorAll('.word.gate-nudge').forEach(el => el.classList.remove('gate-nudge'));
	      }
	    }

	    function nudgeSightWordGate() {
	      if (!state.requiredSightWord || state.sightWordGateSatisfied) return;

	      const gateText = document.getElementById('sightWordGateText');
	      if (gateText && state.requiredSightWord) {
	        gateText.textContent = `Tap ${state.requiredSightWord} in the sentence. You can also tap it here.`;
	        gateText.style.display = 'block';
	      }

	      clearSightWordNudges();

	      const focusChip = document.getElementById('focusSightWord');
	      if (focusChip) {
	        focusChip.classList.remove('gate-nudge');
	        // Reflow to restart CSS animation
	        // eslint-disable-next-line no-unused-expressions
	        focusChip.offsetWidth;
	        focusChip.classList.add('gate-nudge');
	      }

	      const display = document.getElementById('sentenceDisplay');
	      if (display) {
	        const focusWords = Array.from(display.querySelectorAll('.word.focus-word'));
	        focusWords.forEach(el => {
	          el.classList.remove('gate-nudge');
	          // eslint-disable-next-line no-unused-expressions
	          el.offsetWidth;
	          el.classList.add('gate-nudge');
	        });
	      }
	    }

	    function nudgeForQuestionSupport() {
	      const hintElement = document.getElementById('questionHint');
	      if (hintElement && hintElement.textContent && hintElement.style.display === 'none') {
	        hintElement.style.display = 'inline-block';
	      }

	      const targets = [
	        document.getElementById('passageBox'),
	        hintElement
	      ].filter(Boolean);

	      targets.forEach(el => {
	        el.classList.remove('attention-nudge');
	        // Reflow to restart CSS animation.
	        // eslint-disable-next-line no-unused-expressions
	        el.offsetWidth;
	        el.classList.add('attention-nudge');
	        setTimeout(() => el.classList.remove('attention-nudge'), 1600);
	      });
	    }

	    function clearSightWordGateUi() {
	      const gateText = document.getElementById('sightWordGateText');
	      const skipBtn = document.getElementById('sightWordSkipBtn');
	      if (gateText) gateText.style.display = 'none';
	      if (skipBtn) skipBtn.style.display = 'none';
	    }

	    function clearSightWordGate() {
	      state.requiredSightWord = null;
	      state.sightWordGateSatisfied = true;
	      if (state.sightWordSkipTimeoutId) {
	        clearTimeout(state.sightWordSkipTimeoutId);
	        state.sightWordSkipTimeoutId = null;
	      }
	      clearSightWordNudges();
	      clearSightWordGateUi();
	      setContinueEnabled(true);
	    }

	    function armSightWordGate(focusSightWord) {
	      clearSightWordGate();
	      if (!focusSightWord) return;

	      state.requiredSightWord = focusSightWord.toLowerCase();
	      state.sightWordGateSatisfied = false;

	      const gateText = document.getElementById('sightWordGateText');
	      if (gateText) {
	        gateText.textContent = `Tap ${focusSightWord} in the sentence. You can also tap it here.`;
	        gateText.style.display = 'block';
	      }

	      // Keep Next clickable; if pressed early we nudge the word instead of blocking the button.
	      setContinueEnabled(true);

	      state.sightWordSkipTimeoutId = setTimeout(() => {
	        if (state.sightWordGateSatisfied) return;
	        const skipBtn = document.getElementById('sightWordSkipBtn');
	        if (skipBtn) skipBtn.style.display = 'inline-flex';
	      }, 6000);
	    }

	    function satisfySightWordGate() {
	      if (state.sightWordGateSatisfied) return;
	      state.sightWordGateSatisfied = true;

	      const gateText = document.getElementById('sightWordGateText');
	      if (gateText) {
	        gateText.textContent = 'Nice! Press Next.';
	        gateText.style.display = 'block';
	      }

	      clearSightWordNudges();

	      const skipBtn = document.getElementById('sightWordSkipBtn');
	      if (skipBtn) skipBtn.style.display = 'none';

      if (state.sightWordSkipTimeoutId) {
        clearTimeout(state.sightWordSkipTimeoutId);
        state.sightWordSkipTimeoutId = null;
      }

      setContinueEnabled(true);
    }

    function skipSightWordGate() {
      satisfySightWordGate();
    }

    // Convert base64 to ArrayBuffer
    function base64ToArrayBuffer(base64) {
      const binaryString = atob(base64);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes.buffer;
    }

    function analyzePcmForSilence(float32Array, sampleRate) {
      const windowSize = Math.max(1, Math.floor(sampleRate * 0.01)); // 10ms
      const windowCount = Math.ceil(float32Array.length / windowSize);
      const energies = new Float32Array(windowCount);

      for (let w = 0; w < windowCount; w++) {
        const start = w * windowSize;
        const end = Math.min(float32Array.length, start + windowSize);
        const len = Math.max(1, end - start);
        let sumSquares = 0;
        for (let i = start; i < end; i++) {
          const x = float32Array[i];
          sumSquares += x * x;
        }
        energies[w] = Math.sqrt(sumSquares / len);
      }

      const sorted = Array.from(energies).sort((a, b) => a - b);
      const pickPercentile = p => {
        if (sorted.length === 0) return 0;
        const idx = Math.min(sorted.length - 1, Math.max(0, Math.floor((sorted.length - 1) * p)));
        return sorted[idx] || 0;
      };

      const noiseFloor = pickPercentile(0.1);
      const p90 = pickPercentile(0.9);
      const dynamicRange = Math.max(1e-6, p90 - noiseFloor);

      let silenceThreshold = noiseFloor + dynamicRange * 0.08;
      silenceThreshold = Math.max(silenceThreshold, noiseFloor * 2, 0.0015);
      silenceThreshold = Math.min(silenceThreshold, 0.03);

      const silentWindows = new Array(windowCount);
      for (let w = 0; w < windowCount; w++) {
        silentWindows[w] = energies[w] < silenceThreshold;
      }

      // Smooth out single-window blips so a tiny spike doesn't destroy a pause.
      for (let w = 1; w < windowCount - 1; w++) {
        if (!silentWindows[w] && silentWindows[w - 1] && silentWindows[w + 1]) {
          silentWindows[w] = true;
          continue;
        }
        if (silentWindows[w] && !silentWindows[w - 1] && !silentWindows[w + 1]) {
          silentWindows[w] = false;
        }
      }

      let firstNonSilent = 0;
      while (firstNonSilent < windowCount && silentWindows[firstNonSilent]) {
        firstNonSilent++;
      }
      if (firstNonSilent >= windowCount) firstNonSilent = 0;

      let lastNonSilent = windowCount - 1;
      while (lastNonSilent >= 0 && silentWindows[lastNonSilent]) {
        lastNonSilent--;
      }
      if (lastNonSilent < 0) lastNonSilent = windowCount - 1;

      const leadingSilenceMs = (firstNonSilent * windowSize / sampleRate) * 1000;
      const trailingSilenceStartSample = Math.min(float32Array.length, (lastNonSilent + 1) * windowSize);
      const trailingSilenceMs = ((float32Array.length - trailingSilenceStartSample) / sampleRate) * 1000;

      const silenceMidpointsMs = [];
      const silenceSegmentsMs = [];
      const minRunWindows = 3; // >= 30ms
      let runStart = null;

      for (let w = 0; w <= windowCount; w++) {
        const isSilent = w < windowCount ? silentWindows[w] : false;

        if (isSilent) {
          if (runStart === null) runStart = w;
          continue;
        }

        if (runStart === null) continue;

        const runEnd = w - 1;
        const runLength = runEnd - runStart + 1;
        if (runLength >= minRunWindows) {
          const runStartSample = runStart * windowSize;
          const runEndSample = Math.min(float32Array.length, (runEnd + 1) * windowSize);

          silenceSegmentsMs.push({
            startMs: (runStartSample / sampleRate) * 1000,
            endMs: (runEndSample / sampleRate) * 1000
          });

          const midWindow = (runStart + runEnd + 1) / 2;
          const midSample = midWindow * windowSize;
          silenceMidpointsMs.push((midSample / sampleRate) * 1000);
        }
        runStart = null;
      }

      return { leadingSilenceMs, trailingSilenceMs, silenceMidpointsMs, silenceSegmentsMs };
    }

    function getPcmSampleRateFromOutputFormat(outputFormat, fallback = 24000) {
      const match = String(outputFormat || '').match(/pcm_(\d+)/i);
      const parsed = match ? Number.parseInt(match[1], 10) : Number.NaN;
      return Number.isFinite(parsed) ? parsed : fallback;
    }

    function decodeAudioDataCompat(ctx, arrayBuffer) {
      return new Promise((resolve, reject) => {
        try {
          const maybePromise = ctx.decodeAudioData(arrayBuffer, resolve, reject);
          if (maybePromise && typeof maybePromise.then === 'function') {
            maybePromise.then(resolve).catch(reject);
          }
        } catch (e) {
          reject(e);
        }
      });
    }

    // Play TTS audio using Web Audio API (supports mp3/wav decode + optional PCM-L16).
    // Returns timing metadata for word highlighting.
    async function playTtsAudio(clip, playbackRate = 1.0, options = {}) {
      const ctx = await ensureAudioContextReady();
      if (!ctx || ctx.state === 'closed') {
        throw new Error('AudioContext not available');
      }
      if (ctx.state === 'suspended' || ctx.state === 'interrupted') {
        throw new Error(`AudioContext not running (${ctx.state})`);
      }

      if (!clip || !clip.arrayBuffer) {
        throw new Error('Missing audio clip data');
      }

      const mimeType = String(clip.mimeType || '').toLowerCase();
      const outputFormat = String(clip.outputFormat || 'default');

      let audioBuffer = clip.decodedAudioBuffer || null;
      if (!audioBuffer) {
        const isPcm =
          mimeType.startsWith('audio/l16') ||
          outputFormat.toLowerCase().startsWith('pcm');

        if (isPcm) {
          const sampleRate = getPcmSampleRateFromOutputFormat(outputFormat, 24000);
          const int16Array = new Int16Array(clip.arrayBuffer);

          const float32Array = new Float32Array(int16Array.length);
          for (let i = 0; i < int16Array.length; i++) {
            float32Array[i] = int16Array[i] / 32768.0;
          }

          audioBuffer = ctx.createBuffer(1, float32Array.length, sampleRate);
          audioBuffer.getChannelData(0).set(float32Array);
        } else {
          // Decode encoded audio (default ElevenLabs output is MP3).
          const decodeBuffer = clip.arrayBuffer.slice(0);
          audioBuffer = await decodeAudioDataCompat(ctx, decodeBuffer);
        }

        clip.decodedAudioBuffer = audioBuffer;
      }

      let analysis = null;
      if (options && options.analyze) {
        const channel = audioBuffer.getChannelData(0);
        analysis = analyzePcmForSilence(channel, audioBuffer.sampleRate);
        const scale = 1 / playbackRate;
        analysis.leadingSilenceMs *= scale;
        analysis.trailingSilenceMs *= scale;
        analysis.silenceMidpointsMs = analysis.silenceMidpointsMs.map(ms => ms * scale);
        analysis.silenceSegmentsMs = analysis.silenceSegmentsMs.map(segment => ({
          startMs: segment.startMs * scale,
          endMs: segment.endMs * scale
        }));
      }

      // Schedule slightly ahead for consistent sync.
      const source = ctx.createBufferSource();
      source.buffer = audioBuffer;
      source.playbackRate.value = playbackRate;
      source.connect(ctx.destination);
      const startTime = ctx.currentTime + 0.05;
      source.start(startTime);
      currentSource = source;

      let outputStartPerfMs = null;
      if (typeof ctx.getOutputTimestamp === 'function') {
        try {
          const ts = ctx.getOutputTimestamp();
          if (ts && typeof ts.contextTime === 'number' && typeof ts.performanceTime === 'number') {
            outputStartPerfMs = ts.performanceTime + (startTime - ts.contextTime) * 1000;
          }
        } catch (e) {}
      }

      // Fallback is a conservative guess for devices/browsers that don't expose latency.
      let outputLatencySec = 0.05;
      if (typeof ctx.outputLatency === 'number' && Number.isFinite(ctx.outputLatency)) {
        outputLatencySec = ctx.outputLatency;
      } else if (typeof ctx.baseLatency === 'number' && Number.isFinite(ctx.baseLatency)) {
        outputLatencySec = ctx.baseLatency;
      }

      // Scale word timings to match playbackRate (timestamps are for rate=1.0).
      let wordTimings = null;
      if (clip.wordTimings && Array.isArray(clip.wordTimings.startMs) && Array.isArray(clip.wordTimings.endMs)) {
        const scale = 1 / playbackRate;
        wordTimings = {
          words: Array.isArray(clip.wordTimings.words) ? clip.wordTimings.words.slice() : [],
          startMs: clip.wordTimings.startMs.map(ms => (Number.isFinite(ms) ? ms * scale : ms)),
          endMs: clip.wordTimings.endMs.map(ms => (Number.isFinite(ms) ? ms * scale : ms))
        };
      }

      // If the encoded audio contains padding/leading silence, shift timestamps so word 0
      // starts when speech actually starts (helps MP3 encoder delay on some devices).
      let timingOffsetMs = 0;
      if (analysis && wordTimings && wordTimings.startMs && wordTimings.startMs.length > 0) {
        const firstStart = wordTimings.startMs[0];
        if (Number.isFinite(firstStart) && Number.isFinite(analysis.leadingSilenceMs)) {
          const delta = analysis.leadingSilenceMs - firstStart;
          if (Number.isFinite(delta) && Math.abs(delta) <= 500) {
            timingOffsetMs = delta;
          }
        }
      }

      const duration = (audioBuffer.duration / playbackRate) * 1000; // in ms
      return {
        duration,
        source,
        ctx,
        startTime,
        outputStartPerfMs,
        outputLatencySec,
        leadingSilenceMs: analysis ? analysis.leadingSilenceMs : 0,
        trailingSilenceMs: analysis ? analysis.trailingSilenceMs : 0,
        silenceMidpointsMs: analysis ? analysis.silenceMidpointsMs : [],
        silenceSegmentsMs: analysis ? analysis.silenceSegmentsMs : [],
        wordTimings,
        timingOffsetMs
      };
    }

    // Fallback to browser speech synthesis
    // Returns { duration } estimate in ms
    function fallbackSpeak(text, rate = 1.0) {
      if (!state.soundEnabled) return null;

      window.speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = rate;
      utterance.pitch = 1.1;
      utterance.volume = 1;

      const voices = window.speechSynthesis.getVoices();
      const preferredVoice = voices.find(v =>
        v.name.includes('Samantha') ||
        v.name.includes('Google US English') ||
        v.name.includes('Microsoft Zira')
      );
      if (preferredVoice) {
        utterance.voice = preferredVoice;
      }

      window.speechSynthesis.speak(utterance);

      // Estimate duration: ~150ms per character at normal speed, adjusted for rate
      const estimatedDuration = (text.length * 150) / rate;
      return { duration: estimatedDuration };
    }

    // ===== AUDIO PRE-LOADING =====
    // Pre-fetch TTS audio for all words/sentences in a station to eliminate lag
    async function preloadStationAudio(stationId, pagesOverride = null) {
      const station = stationContent[stationId];
      if (!station) return;

      const textsToPreload = new Map(); // cacheKey -> original text (preserve casing for better TTS)
      const addTextToPreload = text => {
        if (!text || typeof text !== 'string') return;
        const normalized = text.trim();
        if (!normalized) return;
        const cacheKey = normalized.toLowerCase().trim();
        if (!cacheKey) return;
        if (!textsToPreload.has(cacheKey)) {
          textsToPreload.set(cacheKey, normalized);
        }
      };

      // Add preview words
      if (station.previewWords) {
        station.previewWords.forEach(item => {
          addTextToPreload(item.word);
        });
      }

      // Add all words and sentences from all pages
      const pages = Array.isArray(pagesOverride) ? pagesOverride : station.pages;
      if (Array.isArray(pages)) {
        pages.forEach(page => {
          // Add sentence for "Read to Me" functionality
          if (page.sentence) {
            addTextToPreload(page.sentence);
          }

          // Add individual words
          const wordList = Array.isArray(page.words) ? page.words : splitSentenceIntoWords(page.sentence || '');
          if (wordList.length) {
            wordList.forEach(word => {
              const cleanWord = String(word).replace(/[.,!?;:]$/g, '').trim();
              addTextToPreload(cleanWord);
            });
          }

          // Add menu item names
          if (page.items) {
            page.items.forEach(item => {
              addTextToPreload(item.name);
            });
          }

          // Add question text
          if (page.question) {
            addTextToPreload(page.question);
          }

          // Add menu prompt
          if (page.prompt) {
            addTextToPreload(page.prompt);
          }
        });
      }

      // Fire-and-forget: preload all unique texts in parallel without blocking.
      // Prefer pre-generated assets (assets/tts/manifest.json) to avoid runtime API calls.
      const preloadPromises = Array.from(textsToPreload.entries()).map(async ([cacheKey, text]) => {
        // Skip if already cached
        if (audioCache.has(cacheKey)) return;

        // Prefer pre-generated audio
        const prebuilt = await maybeLoadPrebuiltClip(cacheKey);
        if (prebuilt) return;

        // Fallback: fetch and cache from API (should be rare if the manifest is complete)
        try {
          const response = await fetch('/api/tts', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              text: text
            })
          });

          if (!response.ok) {
            console.warn('Preload TTS failed for:', text);
            return;
          }

          const data = await response.json();
          if (data && data.audio) {
            const clip = {
              arrayBuffer: base64ToArrayBuffer(data.audio),
              mimeType: data.mimeType || 'audio/mpeg',
              outputFormat: data.outputFormat || 'default',
              wordTimings: data.wordTimings || null,
              decodedAudioBuffer: null
            };
            audioCache.set(cacheKey, clip);
          }
        } catch (error) {
          // Silently fail - will fall back to on-demand loading
          console.warn('Error preloading audio for:', text, error);
        }
      });

      // Don't await - let preloading happen in background
      Promise.all(preloadPromises).then(() => {
        console.log(`Preloaded ${textsToPreload.size} audio clips for station: ${stationId}`);
      });
    }

    // ===== SCREEN NAVIGATION =====
    function updateHomeButtonState() {
      const homeBtn = document.getElementById('homeBtn');
      if (!homeBtn) return;
      const isHomeScreen = state.currentScreen === 'welcomeScreen' || state.currentScreen === 'mrtScreen' || state.currentScreen === 'skillsScreen';
      homeBtn.disabled = isHomeScreen;
      homeBtn.style.opacity = isHomeScreen ? '0.6' : '1';
    }

    function goToScreen(screenId) {
      // Hide all screens
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });

      // Show target screen
      const targetScreen = document.getElementById(screenId);
      if (targetScreen) {
        targetScreen.classList.add('active');
        state.currentScreen = screenId;
        updateHomeButtonState();
      }
    }

    // ===== MRT STATION SELECTION =====

    // Station theme configurations
    const stationThemes = {
      fruit: {
        themeClass: 'theme-fruit',
        floaters: ['', '', '', '', '']
      },
      drink: {
        themeClass: 'theme-drink',
        floaters: ['', '', '', '', '']
      },
      bakery: {
        themeClass: 'theme-bakery',
        floaters: ['', '', '', '', '']
      },
      pizza: {
        themeClass: 'theme-pizza',
        floaters: ['', '', '', '', '']
      },
      icecream: {
        themeClass: 'theme-icecream',
        floaters: ['', '', '', '', '']
      },
      fishshop: {
        themeClass: 'theme-fishshop',
        floaters: ['', '', '', '', '']
      },
      cheese: {
        themeClass: 'theme-cheese',
        floaters: ['', '', '', '', '']
      },
      noodle: {
        themeClass: 'theme-noodle',
        floaters: ['', '', '', '', '']
      }
    };

    function selectStation(stationId) {
      state.currentStation = stationId;
      state.currentPage = 0;
      state.currentOrder = null;
      state.sessionPages = buildSessionPagesForStation(stationId);

      if (state.stationTransitionTimeoutId) {
        clearTimeout(state.stationTransitionTimeoutId);
        state.stationTransitionTimeoutId = null;
      }

      // Start preloading audio in background during train ride (~6 seconds)
      preloadStationAudio(stationId, state.sessionPages);

      // Preload station images during train ride for instant display
      if (stationImages[stationId]) {
        preloadImage(stationImages[stationId]);
      }
      if (stationIcons[stationId]) {
        preloadImage(stationIcons[stationId]);
      }
      // Preload the elevator door reveal scenes so the doors can open instantly.
      preloadElevatorScenesForStation(stationId);

      const station = stationContent[stationId];
      const theme = stationThemes[stationId];
      const rideScreen = document.getElementById('mrtRideScreen');

	      // Update destination banner
	      document.getElementById('destinationName').textContent = station.name;
	      const rideIconEl = document.getElementById('rideIcon');
	      if (rideIconEl) rideIconEl.textContent = '';

      // Remove all theme classes and apply new one
      rideScreen.className = 'screen mrt-ride-screen';
      if (theme) {
        rideScreen.classList.add(theme.themeClass);

	        // Update floating elements with themed emojis
	        const floatersContainer = document.getElementById('themedFloaters');
	        floatersContainer.innerHTML = '';
	      }

      // Show MRT ride animation
      goToScreen('mrtRideScreen');

	      // Restart train animation
	      const train = document.querySelector('.mrt-train');
	      if (train) {
	        train.style.animation = 'none';
	        train.offsetHeight; // Trigger reflow
	        train.style.animation = 'mrt-glide 7.5s linear infinite';
	      }

      // Restart floater animations
      const floaters = document.querySelectorAll('.floater');
      floaters.forEach(floater => {
        floater.style.animation = 'none';
        floater.offsetHeight;
        floater.style.animation = 'float-across 6s linear infinite';
      });

      // After the ride, show elevator (give a bit more time to enjoy the train)
      state.stationTransitionTimeoutId = setTimeout(() => {
        goToScreen('elevatorScreen');
        showElevatorAtFloor(1, { openDoors: false });
        const doors = document.getElementById('elevatorDoors');
        if (doors) setTimeout(() => doors.classList.add('doors-open'), 250);
        state.stationTransitionTimeoutId = null;
      }, 6000);
    }

    function goHome() {
      const isInLessonFlow =
        state.currentScreen === 'mrtRideScreen' ||
        state.currentScreen === 'elevatorScreen' ||
        state.currentScreen === 'warmupScreen' ||
        state.currentScreen === 'restaurantScreen';

      if (isInLessonFlow && state.currentStation) {
        const ok = confirm('Go back to the station map? You will leave this story.');
        if (!ok) return;
      }

      stopSpeech();
      clearSightWordGate();

      if (state.stationTransitionTimeoutId) {
        clearTimeout(state.stationTransitionTimeoutId);
        state.stationTransitionTimeoutId = null;
      }

      state.currentStation = null;
      state.currentOrder = null;
      state.currentPage = 0;
      state.currentFloor = 1;
      state.sessionPages = null;
      state.practiceSkillId = null;
      state.practiceCorrect = 0;
      state.practiceFirstTryCorrect = 0;
      state.practiceTotal = 0;

      generateMRTMap();
      goToScreen('mrtScreen');
    }

    // ===== ELEVATOR =====
    const elevatorDoorScenes = {
      lobby: 'assets/elevator_scenes/lobby.jpg',
      warmup: {
        fruit: 'assets/elevator_scenes/fruit_warmup.jpg',
        drink: 'assets/elevator_scenes/drink_warmup.jpg',
        bakery: 'assets/elevator_scenes/bakery_warmup.jpg',
        pizza: 'assets/elevator_scenes/pizza_warmup.jpg',
        icecream: 'assets/elevator_scenes/icecream_warmup.jpg',
        fishshop: 'assets/elevator_scenes/fishshop_warmup.jpg',
        cheese: 'assets/elevator_scenes/cheese_warmup.jpg',
        noodle: 'assets/elevator_scenes/noodle_warmup.jpg'
      },
      restaurant: {
        fruit: 'assets/elevator_scenes/fruit_restaurant.jpg',
        drink: 'assets/elevator_scenes/drink_restaurant.jpg',
        bakery: 'assets/elevator_scenes/bakery_restaurant.jpg',
        pizza: 'assets/elevator_scenes/pizza_restaurant.jpg',
        icecream: 'assets/elevator_scenes/icecream_restaurant.jpg',
        fishshop: 'assets/elevator_scenes/fishshop_restaurant.jpg',
        cheese: 'assets/elevator_scenes/cheese_restaurant.jpg',
        noodle: 'assets/elevator_scenes/noodle_restaurant.jpg'
      }
    };

    function getElevatorDoorSceneUrl(stationId, floor) {
      if (floor === 2) return elevatorDoorScenes.warmup[stationId] || null;
      if (floor === 3) return elevatorDoorScenes.restaurant[stationId] || null;
      if (floor === 1) return elevatorDoorScenes.lobby || null;
      return null;
    }

    function setElevatorDoorScene(stationId, floor) {
      const doorWindow = document.getElementById('doorWindow');
      if (!doorWindow) return;

      const url = getElevatorDoorSceneUrl(stationId, floor);
      if (url) {
        // Keep a gradient fallback in case the image fails to load.
        doorWindow.style.backgroundImage =
          `url('${url}'), linear-gradient(180deg, #FFF8E7 0%, #FFF0D4 50%, #FFE8C4 100%)`;
        doorWindow.dataset.sceneReady = '1';
        doorWindow.dataset.sceneFloor = String(floor);
        doorWindow.dataset.sceneStation = stationId || '';
      } else {
        doorWindow.style.backgroundImage = '';
        doorWindow.dataset.sceneReady = '0';
        doorWindow.dataset.sceneFloor = '';
        doorWindow.dataset.sceneStation = '';
      }
    }

    function preloadElevatorScenesForStation(stationId) {
      const warmup = elevatorDoorScenes.warmup[stationId];
      const restaurant = elevatorDoorScenes.restaurant[stationId];
      if (warmup) preloadImage(warmup).catch(() => {});
      if (restaurant) preloadImage(restaurant).catch(() => {});
    }

    let elevatorInMotion = false;

    function setElevatorControlsEnabled(enabled) {
      document.querySelectorAll('.floor-btn').forEach(btn => {
        btn.disabled = !enabled;
      });
    }

    function showElevatorAtFloor(floor, options = {}) {
      const openDoors = options.openDoors !== false;

      state.currentFloor = floor;

      const display = document.getElementById('floorDisplay');
      if (display) display.textContent = String(floor);

      document.querySelectorAll('.floor-btn').forEach(btn => btn.classList.remove('active'));
      const floorBtn = document.getElementById(`floor${floor}Btn`);
      if (floorBtn) floorBtn.classList.add('active');

      const doors = document.getElementById('elevatorDoors');
      if (doors) doors.classList.toggle('doors-open', openDoors);

      setElevatorDoorScene(state.currentStation, floor);
      setElevatorControlsEnabled(true);
      elevatorInMotion = false;
    }

    function selectFloor(floor) {
      if (floor === state.currentFloor) return;
      if (elevatorInMotion) return;
      elevatorInMotion = true;
      setElevatorControlsEnabled(false);

      // Update button states
      document.querySelectorAll('.floor-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`floor${floor}Btn`).classList.add('active');

      // Get elevator elements
      const display = document.getElementById('floorDisplay');
      const doors = document.getElementById('elevatorDoors');
      const shaft = document.getElementById('elevatorShaft');
      if (!display || !doors || !shaft) {
        elevatorInMotion = false;
        setElevatorControlsEnabled(true);
        return;
      }

      // Close doors with slower animation
      doors.classList.remove('doors-open');
      // Removed auto-play: speak('Doors closing');

      // Start elevator movement after doors close (1.5s for door close animation)
      setTimeout(() => {
        // Add elevator movement shake effect
        shaft.classList.add('moving');

        // Add changing class for LED flicker effect
        display.classList.add('changing');

        // Change floor number with slower animation for immersion
        let currentDisplay = state.currentFloor;
        const direction = floor > state.currentFloor ? 1 : -1;
        const totalFloors = Math.abs(floor - state.currentFloor);

        // Slower interval for more immersive ride (700ms per floor instead of 400ms)
        const interval = setInterval(() => {
          if (currentDisplay === floor) {
            clearInterval(interval);
            state.currentFloor = floor;
            display.classList.remove('changing');

            // Remove movement effects
            setTimeout(() => {
              shaft.classList.remove('moving');
            }, 300);

            // Open doors after elevator stops (800ms delay for realism)
            setTimeout(() => {
              setElevatorDoorScene(state.currentStation, floor);
              doors.classList.add('doors-open');
              elevatorInMotion = false;
              // Removed auto-play: speak(`Floor ${floor}. Doors opening.`);

              // Floor 2: Word Warm-Up
              if (floor === 2) {
                setTimeout(() => {
                  showWarmup();
                }, 1800);
                return;
              }

              // Floor 3: Restaurant
              if (floor === 3) {
                setTimeout(() => {
                  showRestaurant();
                }, 1800);
                return;
              }

              // Floor 1: stay in elevator UI
              setElevatorControlsEnabled(true);
            }, 800);
            return;
          }

          currentDisplay += direction;
          display.textContent = currentDisplay;
        }, 700);
      }, 1500);
    }

    // ===== WORD WARM-UP =====
    let warmupWordsHeard = new Set();

    function showWarmup() {
      const station = stationContent[state.currentStation];
      if (!station || !station.previewWords) {
        // No preview words, skip to restaurant
        goToScreen('elevatorScreen');
        showElevatorAtFloor(2, { openDoors: true });
        setTimeout(() => {
          if (state.currentScreen === 'elevatorScreen') selectFloor(3);
        }, 650);
        return;
      }

      // Reset warmup state
      warmupWordsHeard = new Set();

      // Update UI
	      const warmupIconEl = document.getElementById('warmupIcon');
	      if (warmupIconEl) warmupIconEl.textContent = '';

      // Show phonics focus if this station has a digraph focus
      const phonicsFocusBox = document.getElementById('phonicsFocusBox');
      if (station.digraphFocus) {
        phonicsFocusBox.style.display = 'flex';
        document.getElementById('phonicsPattern').textContent = station.digraphFocus.toUpperCase();

        // Set appropriate example based on digraph
        const digraphExamples = {
          'sh': 'Makes the sh sound. Like ship.',
          'ch': 'Makes the ch sound. Like chip.',
          'th': 'Makes the th sound. Like this.'
        };
        document.getElementById('phonicsExample').textContent =
          digraphExamples[station.digraphFocus] || 'is a special sound!';
      } else {
        phonicsFocusBox.style.display = 'none';
      }

      // Show sight word reminder if there are sight words in preview
      const sightWordReminder = document.getElementById('sightWordReminder');
      const hasSightWords = station.previewWords.some(w => w.isSightWord);
      sightWordReminder.style.display = hasSightWords ? 'flex' : 'none';

      // Build word cards
      const wordsContainer = document.getElementById('warmupWords');
      wordsContainer.innerHTML = '';

      station.previewWords.forEach((wordData, index) => {
        const card = document.createElement('div');
        card.className = 'warmup-word-card';

        // Add sight word indicator
        if (wordData.isSightWord) {
          card.classList.add('sight-word');
        }

        // Add digraph indicator
        if (wordData.hasDigraph) {
          card.classList.add('has-digraph');
        }

        card.dataset.word = wordData.word;
        card.dataset.index = index;

        // Highlight digraph in word if applicable
        let displayWord = wordData.word;
        if (wordData.hasDigraph && station.digraphFocus) {
          const digraph = station.digraphFocus;
          displayWord = wordData.word.replace(
            new RegExp(digraph, 'gi'),
            `<span class="digraph-highlight">${digraph.toUpperCase()}</span>`
          );
        }

	        card.innerHTML = `
	          <div class="warmup-word-text">${displayWord}</div>
	        `;
        card.onclick = () => tapWarmupWord(wordData.word, index);
        wordsContainer.appendChild(card);
      });

      // Reset progress
      document.getElementById('warmupProgressBar').style.width = '0%';
      document.getElementById('warmupContinueBtn').style.display = 'none';

      goToScreen('warmupScreen');
      // Educational note: We don't auto-play audio - let child initiate interaction

      // Show continue button after 3 seconds (optional warm-up)
      setTimeout(() => {
        document.getElementById('warmupContinueBtn').style.display = 'flex';
      }, 3000);
    }

    function tapWarmupWord(word, index) {
      // Initialize audio context on user interaction (required for iOS)
      unlockAudioContext();

      const station = stationContent[state.currentStation];
      const totalWords = station.previewWords.length;
      const wordData = station.previewWords[index];

      // For CVC words with phonicsNote, do sound blending (educational feature)
      // This teaches phonemic awareness - crucial for early reading
      if (wordData.phonicsNote && wordData.phonicsNote.includes('CVC')) {
        // Sound out the word slowly first, then blend
        speakWithBlending(word);
      } else {
        // Regular word - just speak it
        speak(word, 0.9); // Slightly slower for clarity
      }

      // Mark as heard
      warmupWordsHeard.add(index);

      // Update card style
      const cards = document.querySelectorAll('.warmup-word-card');
      cards[index].classList.add('heard');

      // Update progress bar
      const progress = (warmupWordsHeard.size / totalWords) * 100;
      document.getElementById('warmupProgressBar').style.width = `${progress}%`;

      // Continue button is already shown on a timer - no need to wait for all words
      // Users can practice as much or as little as they want!
    }

    // Sound blending for CVC words - speaks each sound then blends
    // This is a core Orton-Gillingham/Science of Reading technique
    async function speakWithBlending(word) {
      // For short CVC words, we speak the whole word clearly
      // The phonics note in the data provides the breakdown
      await speak(word, 0.85); // Speak slowly and clearly
    }

    function finishWarmup() {
      // Go back to elevator and automatically go to floor 3
      goToScreen('elevatorScreen');
      setTimeout(() => {
        showElevatorAtFloor(2, { openDoors: true });
        setTimeout(() => {
          if (state.currentScreen === 'elevatorScreen') selectFloor(3);
        }, 650);
      }, 250);
    }

    // ===== STATION ASSETS (Ghibli-style) =====
    // Large hero images for restaurant screens
    const stationImages = {
      fruit: 'assets/food_fruit.jpeg',
      drink: 'assets/food_drink.jpeg',
      bakery: 'assets/food_bakery.png',
      pizza: 'assets/food_pizza.jpeg',
      icecream: 'assets/food_icecream.png',
      fishshop: 'assets/food_fishshop.png',
      cheese: 'assets/food_cheese.png',
      noodle: 'assets/food_noodle.png',
      practice: 'assets/mascot.png'
    };

    // Small SVG icons for buttons
    const stationIcons = {
      fruit: 'assets/icon_fruit.svg',
      drink: 'assets/icon_drink.svg',
      bakery: 'assets/icon_bakery.svg',
      pizza: 'assets/icon_pizza.svg',
      icecream: 'assets/icon_icecream.svg',
      fishshop: 'assets/icon_fish.svg',
      cheese: 'assets/icon_cheese.svg',
      noodle: 'assets/icon_noodle.svg'
    };

    // ===== IMAGE PRELOADING =====
    // Preload state management
    const imagePreloadState = {
      loaded: new Set(),
      loading: new Set(),
      failed: new Set(),
      allReady: false
    };

    // Preload a single image and track its state
    function preloadImage(src) {
      // Skip if already loaded or loading
      if (imagePreloadState.loaded.has(src) || imagePreloadState.loading.has(src)) {
        return Promise.resolve(src);
      }

      imagePreloadState.loading.add(src);

      return new Promise((resolve, reject) => {
        const img = new Image();

        img.onload = () => {
          imagePreloadState.loading.delete(src);
          imagePreloadState.loaded.add(src);
          console.log(`Preloaded image: ${src}`);
          resolve(src);
        };

        img.onerror = () => {
          imagePreloadState.loading.delete(src);
          imagePreloadState.failed.add(src);
          console.warn(`Failed to preload image: ${src}`);
          reject(new Error(`Failed to load ${src}`));
        };

        img.src = src;
      });
    }

    // Preload all station assets
    async function preloadAllStationAssets() {
      console.log('Starting image preload...');

      const allImages = [
        'assets/mascot.png',
        'assets/train.png',
        'assets/elevator_scenes/lobby.jpg',
        ...Object.values(stationImages),
        ...Object.values(stationIcons)
      ];

      // Preload all images in parallel
      const preloadPromises = allImages.map(src =>
        preloadImage(src).catch(err => {
          // Log error but don't stop other images from loading
          console.warn(`Image preload error for ${src}:`, err);
        })
      );

      try {
        await Promise.all(preloadPromises);
        imagePreloadState.allReady = true;
        console.log(`Image preload complete: ${imagePreloadState.loaded.size} loaded, ${imagePreloadState.failed.size} failed`);
      } catch (err) {
        console.warn('Some images failed to preload, but continuing:', err);
        imagePreloadState.allReady = true;
      }
    }

    // ===== RESTAURANT =====
    function showRestaurant() {
      const station = stationContent[state.currentStation];

      // Update hero image based on station (only if changed to avoid re-rendering)
      const heroImg = document.getElementById('restaurantHero');
      const newImageSrc = stationImages[state.currentStation];
      if (heroImg && newImageSrc) {
        // Only update src if it's different (avoids unnecessary reloads/reflows)
        if (heroImg.src !== newImageSrc && !heroImg.src.endsWith(newImageSrc)) {
          heroImg.src = newImageSrc;
        }
        heroImg.alt = station.name;
      }
      document.getElementById('restaurantName').textContent = station.name;

      goToScreen('restaurantScreen');
      showPage();
    }

    function updateMRTProgressBar() {
      const progressBar = document.getElementById('mrtLessonProgress');
      const progressTrack = document.getElementById('mrtProgressTrack');
      const progressStationName = document.getElementById('progressStationName');
      const mobileCurrentStop = document.getElementById('mobileCurrentStop');
      const mobileTotalStops = document.getElementById('mobileTotalStops');
      const mobileProgressFill = document.getElementById('mobileProgressFill');
      const mobileStopLabel = document.getElementById('mobileStopLabel');

      if (!progressBar || !progressTrack) return;

      const pages = getCurrentStationPages();
      if (!pages || pages.length === 0) {
        progressBar.style.display = 'none';
        return;
      }

      const station = stationContent[state.currentStation];
      if (!station) return;

      // Determine line color based on station level
      const lineColors = {
        1: 'line-red',    // Red Line
        2: 'line-blue',   // Blue Line
        3: 'line-green',  // Green Line
        4: 'line-orange'  // Orange Line
      };
      const lineClass = lineColors[station.level] || 'line-red';

      // Update progress bar color
      progressBar.className = 'mrt-progress-bar ' + lineClass;

      // Update station name display
      const lineName = {
        1: 'Red Line',
        2: 'Blue Line',
        3: 'Green Line',
        4: 'Orange Line'
      }[station.level] || 'MRT Line';
      progressStationName.textContent = lineName + '  ' + station.name;

      // === UPDATE MOBILE VIEW ===
      const currentPage = state.currentPage + 1; // Convert to 1-based
      const totalPages = pages.length;

      mobileCurrentStop.textContent = currentPage;
      mobileTotalStops.textContent = totalPages;

      // Get current page label
      const currentPageData = pages[state.currentPage];
      const labels = {
        'read': 'Read',
        'question': 'Question',
        'menu': 'Choose'
      };
      const label = labels[currentPageData?.type] || 'Step ' + currentPage;
      mobileStopLabel.textContent = label;

      // Update mobile progress bar width
      const mobileProgress = ((currentPage - 1) / Math.max(1, totalPages - 1)) * 100;
      mobileProgressFill.style.width = mobileProgress + '%';

      // === UPDATE DESKTOP VIEW ===
      // Generate progress stops
      progressTrack.innerHTML = '';

      // Add progress fill element
      const progressFill = document.createElement('div');
      progressFill.className = 'mrt-progress-fill';
      progressTrack.appendChild(progressFill);

      // Create stops for each page
      pages.forEach((page, index) => {
        const stop = document.createElement('div');
        stop.className = 'mrt-progress-stop';

        // Determine stop label based on page type
        const label = labels[page.type] || (index + 1);
        stop.setAttribute('data-label', label);
        stop.textContent = index + 1;

        // Mark completed stops
        if (index < state.currentPage) {
          stop.classList.add('completed');
        }

        // Mark current stop
        if (index === state.currentPage) {
          stop.classList.add('current');
        }

        progressTrack.appendChild(stop);
      });

      // Calculate and set progress fill width
      const progress = state.currentPage / Math.max(1, pages.length - 1);
      const fillWidth = progress * 100;
      progressFill.style.width = fillWidth + '%';

      // Show the progress bar
      progressBar.style.display = 'block';
    }

    function showPage() {
      const pages = getCurrentStationPages();
      const page = pages[state.currentPage];
      if (!page) return;

      // Update MRT lesson progress bar
      updateMRTProgressBar();

      // Hide all sections first
      document.getElementById('menuSection').style.display = 'none';
      document.getElementById('questionSection').style.display = 'none';
      document.getElementById('continueBtn').style.display = 'none';

      const readingSection = document.querySelector('.reading-section');

      if (page.type === 'read') {
        readingSection.style.display = 'flex';
        showReadingPage(page);
      } else if (page.type === 'menu') {
        readingSection.style.display = 'none';
        showMenuPage(page);
      } else if (page.type === 'question') {
        readingSection.style.display = 'none';
        showQuestionPage(page);
      }
    }

		    function showReadingPage(page) {
		      const sentenceImageEl = document.getElementById('sentenceImage');
		      if (sentenceImageEl) {
		        sentenceImageEl.textContent = '';
		        sentenceImageEl.style.display = 'none';
		      }

	      // Get station's sight words for highlighting
	      const station = stationContent[state.currentStation];
	      const stationSightWords = station.sightWords || [];
	      const focusSightWord = page.sightWordFocus || null;

	      // Create clickable words
	      const display = document.getElementById('sentenceDisplay');
	      display.innerHTML = '';

	      let foundFocusInSentence = false;
	      const wordList = Array.isArray(page.words) ? page.words : splitSentenceIntoWords(page.sentence || '');
	      wordList.forEach((word, index) => {
	        const wordSpan = document.createElement('span');
	        wordSpan.className = 'word';

	        // Clean word for comparison (remove punctuation)
	        const cleanWord = word.replace(/[.,!?"]/g, '');

	        // Check if this is a sight word
	        const isSightWord = stationSightWords.includes(cleanWord) ||
	                            stationSightWords.includes(cleanWord.toLowerCase());

	        // Check if this is the focus sight word for this page
	        const isFocusWord = focusSightWord &&
	                            (cleanWord.toLowerCase() === focusSightWord.toLowerCase());

	        // Add sight word styling
	        if (isFocusWord) {
	          wordSpan.classList.add('sight-word', 'focus-word');
	          foundFocusInSentence = true;
	        } else if (isSightWord) {
	          if (state.sightWordMarksEnabled) wordSpan.classList.add('sight-word');
	        }

	        // Check if this is a digraph teaching word
	        if (page.teachWord && cleanWord.toLowerCase() === page.teachWord.word.toLowerCase()) {
	          wordSpan.classList.add('digraph-word');
	          wordSpan.setAttribute('data-digraph', page.teachWord.sound.toUpperCase());
	        }

	        wordSpan.textContent = word;
	        wordSpan.onclick = () => tapWord(word, wordSpan);
	        display.appendChild(wordSpan);
	      });

	      // Show/hide reading tip based on page content
	      const readingTipBox = document.getElementById('readingTipBox');
	      const tipBtn = document.getElementById('tipBtn');
	      const readingTipTextEl = document.getElementById('readingTipText');

	      const helpParts = [];
	      if (page.readingTip) helpParts.push(page.readingTip);

	      if (focusSightWord) {
	        const cleaned = String(focusSightWord || '').replace(/[^A-Za-z']/g, '');
	        const chars = cleaned.split('').filter(Boolean);
	        const spellLine = chars.length ? `Spell it. ${chars.map(c => c.toUpperCase()).join(' ')}` : '';
	        const gateLine = (page.requireSightWordTap && state.sightWordGateEnabled && !state.calmMode)
	          ? 'To keep going, tap the sight word. You can tap it in the sentence or on the card.'
	          : '';
	        helpParts.push(
	          [
	            `Sight word is ${focusSightWord}.`,
	            'Tap it to hear it. Then find it in the sentence.',
	            spellLine,
	            gateLine
	          ].filter(Boolean).join('\n')
	        );
	      }

	      helpParts.push('Tap each word to hear it.');
	      helpParts.push('Press Read to Me to hear the whole sentence.');
	      const helpText = helpParts.filter(Boolean).join('\n\n');

	      // Always provide a small, actionable help path for struggling readers.
	      tipBtn.style.display = 'flex';
	      readingTipBox.style.display = 'none'; // Hide until user clicks Help
	      if (readingTipTextEl) readingTipTextEl.textContent = helpText;

	      // Show sight word focus box
	      const sightWordFocus = document.getElementById('sightWordFocus');
	      const focusChip = document.getElementById('focusSightWord');
	      const focusLabel = sightWordFocus ? sightWordFocus.querySelector('.focus-label') : null;
	      const howToHint = document.getElementById('sightWordHowToHint');
	      const spellHint = document.getElementById('sightWordSpellHint');
	      if (focusSightWord) {
	        sightWordFocus.style.display = 'flex';
	        if (focusChip) {
	          focusChip.textContent = focusSightWord;
	          focusChip.setAttribute('role', 'button');
	          focusChip.setAttribute('tabindex', '0');
	          focusChip.setAttribute('aria-label', `Tap to hear the sight word: ${focusSightWord}`);
	          focusChip.onclick = () => {
	            unlockAudioContext();
	            speak(focusSightWord, 1.0);
	            if (state.requiredSightWord && !state.sightWordGateSatisfied && focusSightWord.toLowerCase() === state.requiredSightWord) {
	              satisfySightWordGate();
	            }
	          };
	          focusChip.onkeydown = e => {
	            if (e.key === 'Enter' || e.key === ' ') {
	              e.preventDefault();
	              focusChip.click();
	            }
	          };
	        }

	        if (howToHint) {
	          howToHint.textContent = 'Tap it to hear it. Then find it in the sentence.';
	        }

	        if (spellHint) {
	          const cleaned = String(focusSightWord || '').replace(/[^A-Za-z']/g, '');
	          const chars = cleaned.split('').filter(Boolean);
	          spellHint.textContent = chars.length ? `Spell it. ${chars.map(c => c.toUpperCase()).join(' ')}` : '';
	        }
	      } else {
	        sightWordFocus.style.display = 'none';
	        if (focusChip) {
	          focusChip.onclick = null;
	          focusChip.onkeydown = null;
	        }
	        if (spellHint) spellHint.textContent = '';
	      }

	      // Show continue button
	      document.getElementById('continueBtn').style.display = 'flex';
	      const shouldGate = !!(focusSightWord && page.requireSightWordTap && state.sightWordGateEnabled && !state.calmMode && foundFocusInSentence);
	      if (focusLabel) focusLabel.textContent = shouldGate ? 'Tap this sight word:' : 'Sight Word:';
	      if (howToHint && shouldGate) howToHint.textContent = 'Tap it here or in the sentence to keep going.';
	      if (shouldGate) {
	        armSightWordGate(focusSightWord);
	      } else {
	        clearSightWordGate();
	      }

      // Educational note: We don't auto-read - let the user tap "Read to Me" when ready
      // This promotes active engagement and prevents audio overwhelm (important for autism)
    }

    // Show reading tip when Help button is clicked
    function showReadingTip() {
      const readingTipBox = document.getElementById('readingTipBox');
      const isVisible = readingTipBox.style.display === 'flex';
      readingTipBox.style.display = isVisible ? 'none' : 'flex';
    }

    function tapWord(word, element) {
      // Initialize audio context on user interaction (required for iOS)
      unlockAudioContext();

      // Clean word for speech (remove punctuation)
      const cleanWord = word.replace(/[.,!?]/g, '');
      speak(cleanWord, 1.0);

      // Visual feedback
      element.classList.add('tap-heard');
      setTimeout(() => element.classList.remove('tap-heard'), 500);

      // Track word exposure
      state.masteredWords.add(cleanWord.toLowerCase());
      updateProgress();

      // Soft gate: require tapping the focus sight word (when present) to unlock Next
      if (state.requiredSightWord && !state.sightWordGateSatisfied) {
        const normalized = cleanWord.replace(/["]/g, '').toLowerCase();
        if (normalized === state.requiredSightWord) {
          satisfySightWordGate();
        }
      }
    }

    let sentenceHighlightRafId = null;
    let sentenceHighlightToken = 0;

    // Passage highlight tracking (for reading comprehension passages)
    let passageHighlightRafId = null;
    let passageHighlightToken = 0;

    function cancelPassageHighlight(wordElements) {
      passageHighlightToken++;
      if (passageHighlightRafId !== null) {
        cancelAnimationFrame(passageHighlightRafId);
        passageHighlightRafId = null;
      }
      if (wordElements && wordElements.length) {
        wordElements.forEach(el => el.classList.remove('highlighted'));
      }
      return passageHighlightToken;
    }

    async function playFullPassage(passageText) {
      unlockAudioContext();

      const passageBody = document.getElementById('passageText');
      if (!passageBody) return;

      const wordElements = Array.from(passageBody.querySelectorAll('.passage-word'));
      if (wordElements.length === 0) return;

      const token = cancelPassageHighlight(wordElements);

      const result = await speak(passageText, 1.0, { analyze: true });
      if (token !== passageHighlightToken) return;
      if (!result || !result.duration) return;

      const wordTexts = wordElements.map(el => (el.textContent || '').trim());

      const normalizeTokenForCompare = tokenText =>
        String(tokenText || '')
          .toLowerCase()
          .replace(/^[""']+|[""']+$/g, '')
          .replace(/[^a-z0-9']/g, '');

      const ttsWordTimings = result.wordTimings;
      let useTtsTimings =
        ttsWordTimings &&
        Array.isArray(ttsWordTimings.startMs) &&
        ttsWordTimings.startMs.length === wordTexts.length;

      if (useTtsTimings && Array.isArray(ttsWordTimings.words) && ttsWordTimings.words.length === wordTexts.length) {
        let mismatches = 0;
        for (let i = 0; i < wordTexts.length; i++) {
          if (normalizeTokenForCompare(ttsWordTimings.words[i]) !== normalizeTokenForCompare(wordTexts[i])) {
            mismatches++;
          }
        }
        const mismatchLimit = Math.max(2, Math.floor(wordTexts.length * 0.25));
        if (mismatches > mismatchLimit) useTtsTimings = false;
      }

      const durationMs = result.duration;
      let boundariesMs;

      if (useTtsTimings) {
        const offsetMs = Number.isFinite(result.timingOffsetMs) ? result.timingOffsetMs : 0;
        boundariesMs = new Array(wordTexts.length + 1);
        let last = 0;
        for (let i = 0; i < wordTexts.length; i++) {
          const raw = ttsWordTimings.startMs[i];
          let ms = (Number.isFinite(raw) ? raw : last) + offsetMs;
          ms = Math.max(0, Math.min(ms, durationMs));
          if (ms < last) ms = last;
          boundariesMs[i] = ms;
          last = ms;
        }
        boundariesMs[wordTexts.length] = durationMs;
      } else {
        // Fallback: estimate word boundaries based on word lengths
        boundariesMs = computeWordBoundariesMs(wordTexts, durationMs, { includePunctuationWeight: true });
      }

      let currentWordIndex = -1;
      let lastHighlightedIndex = -1;

      const setHighlightedIndex = index => {
        if (index === lastHighlightedIndex) return;
        if (lastHighlightedIndex >= 0 && wordElements[lastHighlightedIndex]) {
          wordElements[lastHighlightedIndex].classList.remove('highlighted');
        }
        if (index >= 0 && wordElements[index]) {
          wordElements[index].classList.add('highlighted');
        }
        lastHighlightedIndex = index;
      };

      const stop = () => {
        if (token !== passageHighlightToken) return;
        passageHighlightToken++;
        if (passageHighlightRafId !== null) {
          cancelAnimationFrame(passageHighlightRafId);
          passageHighlightRafId = null;
        }
        setHighlightedIndex(-1);
      };

      if (result.source) {
        result.source.onended = stop;
      }

      const updateHighlightForAudioElapsedMs = audioElapsedMs => {
        if (token !== passageHighlightToken) return false;
        if (audioElapsedMs < 0) {
          setHighlightedIndex(-1);
          return true;
        }
        if (audioElapsedMs >= durationMs) {
          stop();
          return false;
        }
        while (currentWordIndex + 1 < wordElements.length && boundariesMs[currentWordIndex + 1] < audioElapsedMs) {
          currentWordIndex++;
        }
        setHighlightedIndex(currentWordIndex);
        return true;
      };

      if (Number.isFinite(result.outputStartPerfMs)) {
        const tickPerf = () => {
          if (!updateHighlightForAudioElapsedMs(performance.now() - result.outputStartPerfMs)) return;
          passageHighlightRafId = requestAnimationFrame(tickPerf);
        };
        passageHighlightRafId = requestAnimationFrame(tickPerf);
        return;
      }

      if (result.ctx && typeof result.startTime === 'number') {
        const latencySec = typeof result.outputLatencySec === 'number' ? result.outputLatencySec : 0;
        const tick = () => {
          if (!updateHighlightForAudioElapsedMs((result.ctx.currentTime - result.startTime - latencySec) * 1000)) return;
          passageHighlightRafId = requestAnimationFrame(tick);
        };
        passageHighlightRafId = requestAnimationFrame(tick);
        return;
      }

      // Fallback wall-clock timing
      const startedAtMs = performance.now();
      const tickFallback = () => {
        if (!updateHighlightForAudioElapsedMs(performance.now() - startedAtMs)) return;
        passageHighlightRafId = requestAnimationFrame(tickFallback);
      };
      passageHighlightRafId = requestAnimationFrame(tickFallback);
    }

    function computeWordBoundariesMs(wordTexts, durationMs, options = {}) {
      const silenceMidpointsMs = Array.isArray(options.silenceMidpointsMs) ? options.silenceMidpointsMs : [];
      const includePunctuationWeight = options.includePunctuationWeight !== false;
      const wordCount = wordTexts.length;
      const boundaries = new Array(wordCount + 1);
      boundaries[0] = 0;
      boundaries[wordCount] = Math.max(0, durationMs);

      if (wordCount <= 1 || durationMs <= 0) {
        return boundaries;
      }

      const weights = wordTexts.map(text => {
        const raw = (text || '').trim();
        const core = raw.replace(/^["']+|["']+$/g, '');
        const letters = core.replace(/[^A-Za-z']/g, '');
        const baseLen = Math.max(1, letters.length || core.replace(/[^A-Za-z0-9']/g, '').length || 1);
        const vowelGroups = (letters.toLowerCase().match(/[aeiouy]+/g) || []).length || 1;

        let weight = 2 + baseLen + vowelGroups;

        if (includePunctuationWeight) {
          if (/\.\.\.$/.test(core) || /$/.test(core)) {
            weight += 10;
          } else if (/[.?!]$/.test(core)) {
            weight += 8;
          } else if (/[,;:]$/.test(core)) {
            weight += 4;
          }
        }

        return weight;
      });

      const totalWeight = weights.reduce((sum, w) => sum + w, 0) || wordCount;
      let acc = 0;
      for (let i = 0; i < wordCount; i++) {
        boundaries[i] = (acc / totalWeight) * durationMs;
        acc += weights[i];
      }
      boundaries[wordCount] = durationMs;

      if (!Array.isArray(silenceMidpointsMs) || silenceMidpointsMs.length === 0) {
        return boundaries;
      }

      const adjusted = boundaries.slice();
      const candidates = silenceMidpointsMs.filter(t => Number.isFinite(t)).sort((a, b) => a - b);
      const minGapMs = Math.max(60, Math.min(140, durationMs / (wordCount * 2)));
      const searchWindowMs = Math.min(260, Math.max(140, durationMs * 0.12));

      for (let i = 1; i < wordCount; i++) {
        const expected = boundaries[i];
        const earliest = adjusted[i - 1] + minGapMs;
        const latest = durationMs - (wordCount - i) * minGapMs;

        if (earliest >= latest) {
          adjusted[i] = Math.min(Math.max(expected, earliest), latest);
          continue;
        }

        let best = null;
        let bestDist = Infinity;
        for (const t of candidates) {
          if (t < earliest) continue;
          if (t > latest) break;

          const dist = Math.abs(t - expected);
          if (dist <= searchWindowMs && dist < bestDist) {
            best = t;
            bestDist = dist;
          }
        }

        adjusted[i] = best !== null ? best : Math.min(Math.max(expected, earliest), latest);
      }

      adjusted[wordCount] = durationMs;
      return adjusted;
    }

    function cancelSentenceHighlight(wordElements) {
      sentenceHighlightToken++;
      if (sentenceHighlightRafId !== null) {
        cancelAnimationFrame(sentenceHighlightRafId);
        sentenceHighlightRafId = null;
      }
      if (wordElements && wordElements.length) {
        wordElements.forEach(el => el.classList.remove('highlighted'));
      }
      return sentenceHighlightToken;
    }

	    async function playFullSentence() {
	      // Initialize audio context on user interaction (required for iOS)
	      unlockAudioContext();

	      const page = getCurrentPage();
	      if (!page) return;

	      const wordElements = Array.from(document.querySelectorAll('.sentence-display .word'));
	      if (wordElements.length === 0) return;

	      const buildSentenceFromWordElements = elements => {
	        const tokens = elements.map(el => (el.textContent || '').trim()).filter(Boolean);
	        if (tokens.length === 0) return '';
	        let text = tokens.join(' ');
	        text = text.replace(/\s+([.,!?;:])/g, '$1');
	        text = text.replace(/(["'])\s+/g, '$1');
	        return text.trim();
	      };

	      const sentenceText =
	        (typeof page.sentence === 'string' && page.sentence.trim())
	          ? page.sentence.trim()
	          : buildSentenceFromWordElements(wordElements);

	      if (!sentenceText) return;

	      const token = cancelSentenceHighlight(wordElements);

	      const result = await speak(sentenceText, 1.0, { analyze: true });
	      if (token !== sentenceHighlightToken) return;
	      if (!result || !result.duration) return;

      const wordTexts = wordElements.map(el => (el.textContent || '').trim());

      // If the TTS backend provides word-level timestamps, use them for near-perfect sync.
      // (Fallback below remains for cases where timestamps are missing/mismatched.)
      const normalizeTokenForCompare = tokenText =>
        String(tokenText || '')
          .toLowerCase()
          .replace(/^["']+|["']+$/g, '')
          .replace(/[^a-z0-9']/g, '');

      const ttsWordTimings = result.wordTimings;
      let useTtsTimings =
        ttsWordTimings &&
        Array.isArray(ttsWordTimings.startMs) &&
        ttsWordTimings.startMs.length === wordTexts.length;

      if (useTtsTimings && Array.isArray(ttsWordTimings.words) && ttsWordTimings.words.length === wordTexts.length) {
        let mismatches = 0;
        for (let i = 0; i < wordTexts.length; i++) {
          if (normalizeTokenForCompare(ttsWordTimings.words[i]) !== normalizeTokenForCompare(wordTexts[i])) {
            mismatches++;
          }
        }
        const mismatchLimit = Math.max(2, Math.floor(wordTexts.length * 0.25));
        if (mismatches > mismatchLimit) useTtsTimings = false;
      }

      if (useTtsTimings) {
        const durationMs = result.duration;
        const offsetMs = Number.isFinite(result.timingOffsetMs) ? result.timingOffsetMs : 0;
        const boundariesMs = new Array(wordTexts.length + 1);

        let last = 0;
        for (let i = 0; i < wordTexts.length; i++) {
          const raw = ttsWordTimings.startMs[i];
          let ms = (Number.isFinite(raw) ? raw : last) + offsetMs;
          ms = Math.max(0, Math.min(ms, durationMs));
          if (ms < last) ms = last;
          boundariesMs[i] = ms;
          last = ms;
        }
        boundariesMs[wordTexts.length] = durationMs;

        let currentWordIndex = -1;
        let lastHighlightedIndex = -1;

        const setHighlightedIndex = index => {
          if (index === lastHighlightedIndex) return;

          if (lastHighlightedIndex >= 0 && wordElements[lastHighlightedIndex]) {
            wordElements[lastHighlightedIndex].classList.remove('highlighted');
          }

          if (index >= 0 && wordElements[index]) {
            wordElements[index].classList.add('highlighted');
          }

          lastHighlightedIndex = index;
        };

        const stop = () => {
          if (token !== sentenceHighlightToken) return;
          sentenceHighlightToken++;

          if (sentenceHighlightRafId !== null) {
            cancelAnimationFrame(sentenceHighlightRafId);
            sentenceHighlightRafId = null;
          }

          setHighlightedIndex(-1);
        };

        if (result.source) {
          result.source.onended = stop;
        }

        const updateHighlightForAudioElapsedMs = audioElapsedMs => {
          if (token !== sentenceHighlightToken) return false;

          if (audioElapsedMs < 0) {
            setHighlightedIndex(-1);
            return true;
          }

          if (audioElapsedMs >= durationMs) {
            stop();
            return false;
          }

          while (currentWordIndex + 1 < wordElements.length && boundariesMs[currentWordIndex + 1] < audioElapsedMs) {
            currentWordIndex++;
          }
          setHighlightedIndex(currentWordIndex);
          return true;
        };

        if (Number.isFinite(result.outputStartPerfMs)) {
          const tickPerf = () => {
            if (!updateHighlightForAudioElapsedMs(performance.now() - result.outputStartPerfMs)) return;
            sentenceHighlightRafId = requestAnimationFrame(tickPerf);
          };
          sentenceHighlightRafId = requestAnimationFrame(tickPerf);
          return;
        }

        if (result.ctx && typeof result.startTime === 'number') {
          const latencySec = typeof result.outputLatencySec === 'number' ? result.outputLatencySec : 0;
          const tick = () => {
            if (!updateHighlightForAudioElapsedMs((result.ctx.currentTime - result.startTime - latencySec) * 1000)) return;
            sentenceHighlightRafId = requestAnimationFrame(tick);
          };
          sentenceHighlightRafId = requestAnimationFrame(tick);
          return;
        }

        const startedAtMs = performance.now();
        const tickFallback = () => {
          if (!updateHighlightForAudioElapsedMs(performance.now() - startedAtMs)) return;
          sentenceHighlightRafId = requestAnimationFrame(tickFallback);
        };
        sentenceHighlightRafId = requestAnimationFrame(tickFallback);
        return;
      }

      const punctuationBreakWordIndices = [];
      for (let i = 0; i < wordTexts.length - 1; i++) {
        const tokenText = wordTexts[i] || '';
        if (/[.?!]["']?$/.test(tokenText)) {
          punctuationBreakWordIndices.push(i);
        }
      }
      const leadingSilenceMs = result.leadingSilenceMs || 0;
      const trailingSilenceMs = result.trailingSilenceMs || 0;
      const audioHighlightDurationMs = Math.max(0, result.duration - leadingSilenceMs - trailingSilenceMs);

      const rawSilenceSegments = Array.isArray(result.silenceSegmentsMs) ? result.silenceSegmentsMs : [];
      const minPauseMs = 40;
      const pauseSegments = rawSilenceSegments
        .map(segment => ({
          startMs: (segment.startMs || 0) - leadingSilenceMs,
          endMs: (segment.endMs || 0) - leadingSilenceMs
        }))
        .filter(segment => Number.isFinite(segment.startMs) && Number.isFinite(segment.endMs))
        .map(segment => ({
          startMs: Math.max(0, segment.startMs),
          endMs: Math.min(audioHighlightDurationMs, segment.endMs)
        }))
        .filter(segment => segment.endMs > segment.startMs)
        .filter(segment => (segment.endMs - segment.startMs) >= minPauseMs)
        .sort((a, b) => a.startMs - b.startMs)
        .reduce((merged, segment) => {
          const last = merged[merged.length - 1];
          if (!last || segment.startMs > last.endMs) {
            merged.push(segment);
            return merged;
          }
          last.endMs = Math.max(last.endMs, segment.endMs);
          return merged;
        }, []);

      const silenceMsBefore = t => {
        if (pauseSegments.length === 0 || t <= 0) return 0;
        let silence = 0;
        for (const segment of pauseSegments) {
          if (t <= segment.startMs) break;
          silence += Math.min(t, segment.endMs) - segment.startMs;
        }
        return silence;
      };

      const pauseSpeechTimes = pauseSegments
        .map(segment => segment.startMs - silenceMsBefore(segment.startMs))
        .filter(t => Number.isFinite(t))
        .sort((a, b) => a - b);

      const pauseTotalMs = pauseSegments.reduce((sum, segment) => sum + (segment.endMs - segment.startMs), 0);
      const speechDurationMs = Math.max(0, audioHighlightDurationMs - pauseTotalMs);

      const includePunctuationWeight = pauseSpeechTimes.length < punctuationBreakWordIndices.length;

      let boundariesMs = computeWordBoundariesMs(wordTexts, speechDurationMs, {
        includePunctuationWeight,
        silenceMidpointsMs: pauseSpeechTimes
      });

      // Snap sentence-break boundaries (., !, ?) to the strongest detected pauses.
      if (punctuationBreakWordIndices.length > 0 && pauseSegments.length > 0 && boundariesMs.length === wordTexts.length + 1) {
        const minGapMs = Math.max(60, Math.min(140, speechDurationMs / (wordTexts.length * 2)));
        const maxSnapDistanceMs = Math.min(700, Math.max(320, speechDurationMs * 0.22));

        const strongPauseTimes = pauseSegments
          .filter(segment => (segment.endMs - segment.startMs) >= 60)
          .map(segment => segment.startMs - silenceMsBefore(segment.startMs))
          .filter(t => Number.isFinite(t))
          .sort((a, b) => a - b);

        if (strongPauseTimes.length > 0) {
          let cursor = 0;
          for (const breakWordIndex of punctuationBreakWordIndices) {
            const boundaryIndex = breakWordIndex + 1;
            if (boundaryIndex <= 0 || boundaryIndex >= boundariesMs.length) continue;

            const expected = boundariesMs[boundaryIndex];
            let bestIdx = -1;
            let bestDist = Infinity;

            for (let i = cursor; i < strongPauseTimes.length; i++) {
              const t = strongPauseTimes[i];
              if (t < expected - maxSnapDistanceMs) continue;
              if (t > expected + maxSnapDistanceMs) break;

              const dist = Math.abs(t - expected);
              if (dist < bestDist) {
                bestDist = dist;
                bestIdx = i;
              }
            }

            if (bestIdx === -1) continue;

            const target = strongPauseTimes[bestIdx];
            const earliest = boundariesMs[boundaryIndex - 1] + minGapMs;
            const latest = boundaryIndex + 1 < boundariesMs.length ? boundariesMs[boundaryIndex + 1] - minGapMs : speechDurationMs;

            if (earliest < latest) {
              boundariesMs[boundaryIndex] = Math.min(Math.max(target, earliest), latest);
              cursor = bestIdx + 1;
            }
          }

          boundariesMs[boundariesMs.length - 1] = speechDurationMs;
        }
      }

      let currentWordIndex = -1;
      let lastHighlightedIndex = -1;

      const setHighlightedIndex = index => {
        if (index === lastHighlightedIndex) return;

        if (lastHighlightedIndex >= 0 && wordElements[lastHighlightedIndex]) {
          wordElements[lastHighlightedIndex].classList.remove('highlighted');
        }

        if (index >= 0 && wordElements[index]) {
          wordElements[index].classList.add('highlighted');
        }

        lastHighlightedIndex = index;
      };

      const stop = () => {
        if (token !== sentenceHighlightToken) return;
        sentenceHighlightToken++;

        if (sentenceHighlightRafId !== null) {
          cancelAnimationFrame(sentenceHighlightRafId);
          sentenceHighlightRafId = null;
        }

        setHighlightedIndex(-1);
      };

      if (result.source) {
        result.source.onended = stop;
      }

      const updateHighlightForAudioElapsedMs = audioElapsedMs => {
        if (token !== sentenceHighlightToken) return false;

        const elapsedMs = audioElapsedMs - leadingSilenceMs;

        if (elapsedMs < 0) {
          setHighlightedIndex(-1);
          return true;
        }

        if (elapsedMs >= audioHighlightDurationMs) {
          stop();
          return false;
        }

        const speechElapsedMs = Math.max(0, elapsedMs - silenceMsBefore(elapsedMs));

        while (currentWordIndex + 1 < wordElements.length && boundariesMs[currentWordIndex + 1] < speechElapsedMs) {
          currentWordIndex++;
        }
        setHighlightedIndex(currentWordIndex);
        return true;
      };

      if (Number.isFinite(result.outputStartPerfMs)) {
        const tickPerf = () => {
          if (!updateHighlightForAudioElapsedMs(performance.now() - result.outputStartPerfMs)) return;
          sentenceHighlightRafId = requestAnimationFrame(tickPerf);
        };
        sentenceHighlightRafId = requestAnimationFrame(tickPerf);
        return;
      }

      if (result.ctx && typeof result.startTime === 'number') {
        const latencySec = typeof result.outputLatencySec === 'number' ? result.outputLatencySec : 0;
        const tick = () => {
          if (!updateHighlightForAudioElapsedMs((result.ctx.currentTime - result.startTime - latencySec) * 1000)) return;
          sentenceHighlightRafId = requestAnimationFrame(tick);
        };
        sentenceHighlightRafId = requestAnimationFrame(tick);
        return;
      }

      // Last-resort wall-clock timing (e.g., if we fall back to SpeechSynthesis).
      const startedAtMs = performance.now();
      const tickFallback = () => {
        if (!updateHighlightForAudioElapsedMs(performance.now() - startedAtMs)) return;
        sentenceHighlightRafId = requestAnimationFrame(tickFallback);
      };
      sentenceHighlightRafId = requestAnimationFrame(tickFallback);
    }

    function showMenuPage(page) {
      document.getElementById('menuSection').style.display = 'block';
      document.querySelector('.menu-prompt').textContent = page.prompt;
      clearSightWordGate();

      // Show menu story if available (adds learning context)
      const menuStoryEl = document.getElementById('menuStory');
      if (page.menuStory) {
        menuStoryEl.textContent = page.menuStory;
        menuStoryEl.style.display = 'block';
      } else {
        menuStoryEl.style.display = 'none';
      }

      const grid = document.getElementById('menuGrid');
      grid.innerHTML = '';

      page.items.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'menu-item';

        // Add description for extra learning context if available
        const descText = item.description ? `<span class="item-desc">${item.description}</span>` : '';

	        btn.innerHTML = `
	          <span class="item-name">${item.name}</span>
	          ${descText}
	        `;
        btn.onclick = () => selectMenuItem(item, btn);
        grid.appendChild(btn);
      });

      // Removed auto-play: speak(page.prompt);
    }

    function selectMenuItem(item, button) {
      // Store the order
      state.currentOrder = item;

      // Visual feedback
      document.querySelectorAll('.menu-item').forEach(btn => {
        btn.classList.remove('selected');
      });
      button.classList.add('selected');

      speak(`You picked ${item.name}!`);

      // Show continue button
      document.getElementById('continueBtn').style.display = 'flex';
      setContinueEnabled(true);
    }

	    function showQuestionPage(page) {
	      document.getElementById('questionSection').style.display = 'block';
	      clearSightWordGate();

	      // Show optional passage/story text (used by skill practice items)
	      // Only show for comprehension questions - sight word and other question types should not display passage
	      const passageBox = document.getElementById('passageBox');
	      const passageText = document.getElementById('passageText');
	      const passageReadBtn = document.getElementById('passageReadBtn');
	      const passage = normalizePassageText(page.passage || '') || getMostRecentPassageTextForQuestion();

	      // Check if this is a sight word question by examining both question and passage text
	      const questionLower = (page.question || '').toLowerCase();
	      const passageLower = (page.passage || '').toLowerCase();
	      const isSightWordQuestion = questionLower.includes('sight word') || passageLower.includes('sight word');
	      const isComprehensionQuestion = page.questionType === 'comprehension' && !isSightWordQuestion;

	      if (passageBox && passageText && passage && isComprehensionQuestion) {
	        // Render passage as clickable word spans for highlighting
	        const passageWords = splitSentenceIntoWords(passage);
	        passageText.innerHTML = '';
	        passageWords.forEach((word, index) => {
	          const wordSpan = document.createElement('span');
	          wordSpan.className = 'passage-word';
	          wordSpan.textContent = word;
	          wordSpan.onclick = () => {
	            unlockAudioContext();
	            const cleanWord = word.replace(/[.,!?"]/g, '');
	            speak(cleanWord, 1.0);
	          };
	          passageText.appendChild(wordSpan);
	        });
	        passageBox.style.display = 'block';
	        if (passageReadBtn) {
	          passageReadBtn.style.display = state.soundEnabled ? 'inline-flex' : 'none';
	          passageReadBtn.onclick = () => {
	            playFullPassage(passage);
	          };
	        }
	      } else if (passageBox) {
	        passageBox.style.display = 'none';
	        if (passageReadBtn) passageReadBtn.onclick = null;
	      }

	      // Set question text - use the page's question
	      document.getElementById('questionText').textContent = page.question;

	      // Show comprehension hint if available
	      const hintElement = document.getElementById('questionHint');
	      if (hintElement && page.comprehensionHint) {
	        hintElement.textContent = page.comprehensionHint;
	        // Hide by default; reveal after a wrong attempt so the learner tries first.
	        hintElement.style.display = 'none';
	      } else if (hintElement) {
	        hintElement.style.display = 'none';
	      }

      // Show bonus phonics question for digraph stations
      const bonusQuestion = document.getElementById('bonusQuestion');
      if (page.bonusQuestion) {
        bonusQuestion.style.display = 'flex';
        document.getElementById('bonusQuestionText').textContent = page.bonusQuestion;
      } else {
        bonusQuestion.style.display = 'none';
      }

      // Hide success feedback initially
      document.getElementById('successFeedback').style.display = 'none';

      const grid = document.getElementById('answerGrid');
      grid.innerHTML = '';

      const station = stationContent[state.currentStation];

      // Question sources:
      // - menu recall (default): answers come from the station menu items
      // - multiple choice: answers come from page.answers (story-detail questions)
      const isMultipleChoice = page.questionMode === 'multipleChoice' || Array.isArray(page.answers);

      let answerItems = [];
      let correctAnswerName = '';
      let feedbackContext = 'choice';

      if (isMultipleChoice) {
        answerItems = [...(page.answers || [])];
        correctAnswerName = page.correctAnswerName || '';
        feedbackContext = 'story';
      } else {
        const menuPage = getCurrentStationPages().find(p => p && p.type === 'menu');
        answerItems = menuPage && Array.isArray(menuPage.items) ? [...menuPage.items] : [];
        correctAnswerName = (state.currentOrder && state.currentOrder.name) ? state.currentOrder.name : '';
      }

      // Shuffle all items for random order
      const allItems = [...answerItems];
      for (let i = allItems.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [allItems[i], allItems[j]] = [allItems[j], allItems[i]];
      }

      allItems.forEach(answer => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';

        // Add description for extra learning context if available
        const descText = answer.description ? `<span class="answer-desc">${answer.description}</span>` : '';

        btn.innerHTML = `
          <span class="answer-text">${answer.name}</span>
          ${descText}
        `;
        btn.onclick = () => selectAnswer(answer, btn, answer.name === correctAnswerName, page, correctAnswerName, feedbackContext);
        grid.appendChild(btn);
      });

      // Educational note: We don't auto-play the question - let user read it
    }

	    function selectAnswer(answer, button, isCorrect, page, correctAnswerName, feedbackContext) {
      // Disable all buttons temporarily to prevent rapid clicking
      const allButtons = document.querySelectorAll('.answer-btn');
      const isPractice = !!stationContent[state.currentStation]?.isPractice;

      if (isPractice && !page._practiceAttempted) {
        page._practiceAttempted = true;
        if (isCorrect) {
          state.practiceFirstTryCorrect++;
        }
      }

	      if (isCorrect) {
	        button.classList.add('correct');

        if (isPractice && !page._practiceScored) {
          page._practiceScored = true;
          state.practiceCorrect++;
        }

        // Use varied feedback messages
        const feedbackMessage = getRandomFeedback(true);
        speak(feedbackMessage);

        // Disable wrong answers
        allButtons.forEach(btn => {
          if (!btn.classList.contains('correct')) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
          }
        });

	        // Show success feedback with educational reinforcement
	        const successFeedback = document.getElementById('successFeedback');
	        const successText = document.getElementById('successFeedbackText');
        if (page.successMessage) {
          successText.textContent = page.successMessage;
        } else {
          successText.textContent = 'Great job! You remembered what you read!';
        }
	        successFeedback.style.display = 'flex';

	        // Hide the hint once they get it right (prevents mixed messaging).
	        const hintElement = document.getElementById('questionHint');
	        if (hintElement) hintElement.style.display = 'none';

        // Show continue after celebration
        setTimeout(() => {
          document.getElementById('continueBtn').style.display = 'flex';
        }, 1000);
	      } else {
	        // Gentle try-again: keep going without revealing the answer.
	        button.classList.add('wrong');
	        button.disabled = true;

	        const hintElement = document.getElementById('questionHint');
	        const hasHint = !!(hintElement && hintElement.textContent);
	        speak(hasHint ? 'Try again. Use the hint.' : 'Try again. Look back at the passage.');
	        nudgeForQuestionSupport();
	      }
	    }

	    function continueStory() {
	      if (state.requiredSightWord && !state.sightWordGateSatisfied) {
	        nudgeSightWordGate();
	        return;
	      }
	      const pages = getCurrentStationPages();
	      state.currentPage++;

	      if (state.currentPage >= pages.length) {
	        // Station complete! Show reward
        showReward();
      } else {
        showPage();
      }
    }

    // ===== REWARDS =====
	    function showReward() {
	      const station = stationContent[state.currentStation];

      // Award sticker
      state.stickers++;
      state.pagesCompleted++;

      // Mark station as completed (skip for skill practice)
      if (!station.isPractice) {
        if (!state.completedStations.includes(state.currentStation)) {
          state.completedStations.push(state.currentStation);
          unlockNextStation();
        }
      }

	      const stickerEarnedEl = document.getElementById('stickerEarned');
	      if (stickerEarnedEl) {
	        if (station.isPractice && state.practiceTotal > 0) {
	          stickerEarnedEl.textContent = `Score ${state.practiceCorrect}/${state.practiceTotal}`;
	        } else {
	          stickerEarnedEl.textContent = 'Sticker +1';
	        }
	      }
	      if (station.isPractice && state.practiceTotal > 0) {
	        document.getElementById('rewardMessage').textContent = `${station.name} complete! Score: ${state.practiceCorrect}/${state.practiceTotal} (first try: ${state.practiceFirstTryCorrect}/${state.practiceTotal})`;
	        const rewardContinueText = document.getElementById('rewardContinueText');
	        if (rewardContinueText) rewardContinueText.textContent = 'More Skills';
	      } else {
	        document.getElementById('rewardMessage').textContent = `You finished ${station.name}!`;
	        const rewardContinueText = document.getElementById('rewardContinueText');
	        if (rewardContinueText) rewardContinueText.textContent = 'Keep Going!';
	      }

      updateProgress();
      goToScreen('rewardScreen');

      if (!state.calmMode) {
        // Removed auto-play: speak('Great job! You got a sticker!');
      }
    }

	    function finishReward() {
      // Reset floor
      state.currentFloor = 1;
      if (state.currentStation === 'practice') {
        state.currentStation = null;
        state.sessionPages = null;
        state.practiceSkillId = null;
        state.practiceCorrect = 0;
        state.practiceFirstTryCorrect = 0;
        state.practiceTotal = 0;
        renderSkillsScreen();
        goToScreen('skillsScreen');
      } else {
        state.sessionPages = null;
        goToScreen('mrtScreen');
      }
    }

    // ===== PROGRESS =====
    function updateProgress() {
      // Update sticker count
      document.getElementById('stickerCount').textContent = state.stickers;

      // Update progress bar (based on stations completed)
      const totalStations = Object.keys(stationContent).filter(id => !stationContent[id].isPractice).length;
      const progress = (state.completedStations.length / totalStations) * 100;
      document.getElementById('progressFill').style.width = `${progress}%`;

      // Update settings modal
      document.getElementById('pagesCompleted').textContent = state.pagesCompleted;
      document.getElementById('wordsMastered').textContent = state.masteredWords.size;
      document.getElementById('stationsCompleted').textContent = state.completedStations.length;

      // Save to localStorage
      saveProgress();
    }

    function resetProgress() {
      if (confirm('Reset all progress? This cannot be undone.')) {
        localStorage.removeItem('isaiahProgress');
        state.stickers = 0;
        state.pagesCompleted = 0;
        state.completedStations = [];
        state.masteredWords = new Set();
        updateProgress();
        generateMRTMap();
        closeSettings();
        goToScreen('welcomeScreen');
      }
    }

	    function saveProgress() {
	      const saveData = {
	        stickers: state.stickers,
	        pagesCompleted: state.pagesCompleted,
	        completedStations: state.completedStations,
	        masteredWords: Array.from(state.masteredWords),
	        soundEnabled: state.soundEnabled,
	        calmMode: state.calmMode,
	        sightWordMarksEnabled: state.sightWordMarksEnabled,
	        sightWordGateEnabled: state.sightWordGateEnabled
	      };
	      localStorage.setItem('isaiahProgress', JSON.stringify(saveData));
	    }

    function loadProgress() {
      const saved = localStorage.getItem('isaiahProgress');
      if (saved) {
        const data = JSON.parse(saved);
        state.stickers = data.stickers || 0;
        state.pagesCompleted = data.pagesCompleted || 0;
        state.completedStations = data.completedStations || [];
	        state.masteredWords = new Set(data.masteredWords || []);
	        state.soundEnabled = data.soundEnabled !== false;
	        state.calmMode = data.calmMode || false;
	        state.sightWordMarksEnabled = data.sightWordMarksEnabled !== false;
	        state.sightWordGateEnabled = data.sightWordGateEnabled !== false;

        // Restore UI state
        updateProgress();

	        // Restore settings toggles
		        if (state.calmMode) {
		          document.body.classList.add('calm-mode');
		          document.getElementById('calmModeToggle').classList.add('active');
		          document.getElementById('calmSettingToggle').classList.add('active');
		        }
		        document.getElementById('soundToggle').textContent = 'Audio';
		        document.getElementById('soundToggle').classList.toggle('active', state.soundEnabled);
		        document.getElementById('soundSettingToggle').classList.toggle('active', state.soundEnabled);
		        document.getElementById('calmModeToggle').textContent = 'Calm';
		        const marksToggle = document.getElementById('sightWordMarksSettingToggle');
		        const gateToggle = document.getElementById('sightWordGateSettingToggle');
		        if (marksToggle) marksToggle.classList.toggle('active', state.sightWordMarksEnabled);
		        if (gateToggle) gateToggle.classList.toggle('active', state.sightWordGateEnabled);
		      }
		    }

    // ===== SETTINGS =====
		    function toggleSetting(setting) {
		      if (setting === 'sound') {
		        state.soundEnabled = !state.soundEnabled;
		        document.getElementById('soundToggle').textContent = 'Audio';
		        document.getElementById('soundToggle').classList.toggle('active', state.soundEnabled);
		        document.getElementById('soundSettingToggle').classList.toggle('active', state.soundEnabled);
		      } else if (setting === 'calm') {
		        state.calmMode = !state.calmMode;
		        document.body.classList.toggle('calm-mode', state.calmMode);
		        document.getElementById('calmModeToggle').classList.toggle('active', state.calmMode);
		        document.getElementById('calmSettingToggle').classList.toggle('active', state.calmMode);
		        document.getElementById('calmModeToggle').textContent = 'Calm';
		      } else if (setting === 'sightWordMarks') {
		        state.sightWordMarksEnabled = !state.sightWordMarksEnabled;
		        const toggle = document.getElementById('sightWordMarksSettingToggle');
		        if (toggle) toggle.classList.toggle('active', state.sightWordMarksEnabled);
		        if (state.currentStation) showPage();
		      } else if (setting === 'sightWordGate') {
		        state.sightWordGateEnabled = !state.sightWordGateEnabled;
		        const toggle = document.getElementById('sightWordGateSettingToggle');
		        if (toggle) toggle.classList.toggle('active', state.sightWordGateEnabled);
		        if (!state.sightWordGateEnabled) clearSightWordGate();
		        if (state.currentStation) showPage();
		      }
		      saveProgress();
		    }

    document.getElementById('homeBtn').onclick = () => goHome();
    document.getElementById('skillsBtn').onclick = () => {
      updateSkillsFilterButtons();
      renderSkillsScreen();
      goToScreen('skillsScreen');
    };
    document.getElementById('skillsFilterAll').onclick = () => setSkillsLevelFilter('all');
    document.getElementById('skillsFilter1').onclick = () => setSkillsLevelFilter(1);
    document.getElementById('skillsFilter2').onclick = () => setSkillsLevelFilter(2);
    document.getElementById('skillsFilter3').onclick = () => setSkillsLevelFilter(3);
    document.getElementById('skillsFilter4').onclick = () => setSkillsLevelFilter(4);
    document.getElementById('sightWordSkipBtn').onclick = () => skipSightWordGate();
    document.getElementById('soundToggle').onclick = () => toggleSetting('sound');
    document.getElementById('calmModeToggle').onclick = () => toggleSetting('calm');

    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('settingsModal').classList.add('active');
    };

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    // Close modal on overlay click
    document.getElementById('settingsModal').onclick = (e) => {
      if (e.target.id === 'settingsModal') {
        closeSettings();
      }
    };

    // ===== SKILL PRACTICE =====
    function shuffleInPlace(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

	    function pickOne(array) {
	      return array[Math.floor(Math.random() * array.length)];
	    }

	    function normalizePassageText(text) {
	      return (text || '').toString().replace(/\s+/g, ' ').trim();
	    }

	    function getMostRecentPassageTextForQuestion() {
	      const pages = getCurrentStationPages();
	      if (!Array.isArray(pages) || pages.length === 0) return '';
	      const idx = Number.isFinite(state.currentPage) ? state.currentPage : 0;
	      const start = Math.min(idx - 1, pages.length - 1);

	      const passages = [];
	      const seen = new Set();
	      const add = text => {
	        const normalized = normalizePassageText(text);
	        const key = normalized.toLowerCase();
	        if (!normalized || seen.has(key)) return;
	        seen.add(key);
	        passages.push(normalized);
	      };

	      for (let i = start; i >= 0; i--) {
	        const p = pages[i];
	        if (!p || p.type !== 'read') continue;
	        if (typeof p.sentence === 'string' && p.sentence.trim()) add(p.sentence);
	        else if (Array.isArray(p.words) && p.words.length) add(p.words.join(' '));
	        if (passages.length >= 2) break;
	      }

	      if (passages.length) return passages.reverse().join('\n');

	      for (let i = start; i >= 0; i--) {
	        const p = pages[i];
	        if (!p) continue;
	        if (p.type === 'menu' && typeof p.menuStory === 'string' && p.menuStory.trim()) {
	          return normalizePassageText(p.menuStory);
	        }
	      }

	      return '';
	    }

	    function pickDistinct(array, count, exclude = new Set()) {
	      const pool = array.filter(x => !exclude.has(x));
	      shuffleInPlace(pool);
	      return pool.slice(0, count);
	    }

    function makeMCQ({ question, passage = null, hint = null, answers, correctAnswerName, successMessage }) {
      return {
        type: 'question',
        questionType: 'comprehension',
        questionMode: 'multipleChoice',
        question,
        passage,
        comprehensionHint: hint || '',
        answers: answers.map(name => ({ name, icon: '' })),
        correctAnswerName,
        successMessage: successMessage || 'Great job!'
      };
    }

	    const skillWordBanks = {
      vowels: ['a', 'e', 'i', 'o', 'u'],
      consonants: ['b', 'c', 'd', 'f', 'g', 'h', 'j', 'k', 'l', 'm', 'n', 'p', 'q', 'r', 's', 't', 'v', 'w', 'x', 'y', 'z'],

      cvc: [
        'cat', 'dog', 'pig', 'hen', 'bug', 'map', 'sun', 'hop', 'fin', 'cap', 'bed', 'kid', 'log', 'cup', 'bat', 'hat', 'rat',
        'jam', 'pen', 'sit', 'lip', 'rug', 'fox', 'win', 'mud', 'tap', 'mop', 'net', 'hut', 'rib', 'gum', 'jet', 'nut', 'mix',
        'zip', 'fan', 'web', 'red', 'tan', 'vet', 'top', 'pot', 'sip', 'rag', 'pin', 'pan', 'got', 'get', 'fun'
      ],
      cvcc: ['milk', 'hand', 'wind', 'camp', 'best', 'nest', 'lamp', 'desk', 'sock', 'belt'],
      ccvc: ['flag', 'frog', 'step', 'stop', 'plan', 'clip', 'drip', 'crab', 'slam', 'brag', 'skip', 'spot', 'clap', 'grin'],

      twoSyllables: [
        { word: 'pizza', syllables: 2 },
        { word: 'paper', syllables: 2 },
        { word: 'tiger', syllables: 2 },
        { word: 'table', syllables: 2 },
        { word: 'open', syllables: 2 },
        { word: 'robot', syllables: 2 },
        { word: 'music', syllables: 2 },
        { word: 'seven', syllables: 2 },
        { word: 'sunset', syllables: 2 },
        { word: 'lunchbox', syllables: 2 },
        { word: 'pencil', syllables: 2 },
        { word: 'rabbit', syllables: 2 },
        { word: 'apple', syllables: 2 },
        { word: 'monkey', syllables: 2 },
        { word: 'window', syllables: 2 },
        { word: 'pocket', syllables: 2 },
        { word: 'kitten', syllables: 2 },
        { word: 'market', syllables: 2 },
        { word: 'basket', syllables: 2 },
        { word: 'rocket', syllables: 2 },
        { word: 'napkin', syllables: 2 }
      ],
      threeSyllables: [
        { word: 'banana', syllables: 3 },
        { word: 'animal', syllables: 3 },
        { word: 'tomato', syllables: 3 },
        { word: 'elephant', syllables: 3 },
        { word: 'family', syllables: 3 },
        { word: 'octopus', syllables: 3 },
        { word: 'butterfly', syllables: 3 },
        { word: 'computer', syllables: 3 },
        { word: 'tomorrow', syllables: 3 },
        { word: 'remember', syllables: 3 },
        { word: 'strawberry', syllables: 3 }
      ],
      twoSyllableBuild: [
        { a: 'ba', b: 'by', word: 'baby' },
        { a: 'pi', b: 'zza', word: 'pizza' },
        { a: 'pa', b: 'per', word: 'paper' },
        { a: 'ta', b: 'ble', word: 'table' },
        { a: 'ro', b: 'bot', word: 'robot' },
        { a: 'mu', b: 'sic', word: 'music' },
        { a: 'pen', b: 'cil', word: 'pencil' },
        { a: 'rab', b: 'bit', word: 'rabbit' },
        { a: 'ap', b: 'ple', word: 'apple' },
        { a: 'mon', b: 'key', word: 'monkey' },
        { a: 'win', b: 'dow', word: 'window' },
        { a: 'kit', b: 'ten', word: 'kitten' },
        { a: 'mar', b: 'ket', word: 'market' },
        { a: 'bas', b: 'ket', word: 'basket' },
        { a: 'roc', b: 'ket', word: 'rocket' },
        { a: 'nap', b: 'kin', word: 'napkin' }
      ],
      compoundWords: [
        { a: 'sun', b: 'set', word: 'sunset' },
        { a: 'cup', b: 'cake', word: 'cupcake' },
        { a: 'lunch', b: 'box', word: 'lunchbox' },
        { a: 'rain', b: 'bow', word: 'rainbow' },
        { a: 'bed', b: 'room', word: 'bedroom' },
        { a: 'rain', b: 'coat', word: 'raincoat' },
        { a: 'play', b: 'ground', word: 'playground' },
        { a: 'sun', b: 'flower', word: 'sunflower' },
        { a: 'foot', b: 'ball', word: 'football' },
        { a: 'back', b: 'pack', word: 'backpack' },
        { a: 'tooth', b: 'brush', word: 'toothbrush' }
      ],

      rhymes: [
        ['cat', 'hat', 'bat', 'rat'],
        ['pig', 'wig', 'dig'],
        ['sun', 'fun', 'run'],
        ['cap', 'map', 'tap'],
        ['bed', 'red'],
        ['pen', 'hen', 'ten'],
        ['hop', 'mop', 'top'],
        ['rug', 'bug', 'hug'],
        ['fin', 'win', 'pin'],
        ['cup', 'pup'],
        ['cake', 'bake', 'lake'],
        ['shop', 'top', 'mop'],
        ['fish', 'dish', 'wish']
      ],

      digraphs: {
        sh: ['ship', 'shop', 'fish', 'dish', 'shell', 'wish', 'shut', 'shed', 'shop', 'shack', 'rush', 'cash'],
        ch: ['chip', 'chop', 'chin', 'cheese', 'chair', 'chill', 'chat', 'chess', 'much', 'lunch'],
        th: ['this', 'that', 'them', 'thin', 'bath', 'with', 'then', 'than', 'math', 'thick']
      },
      blends: ['st', 'sp', 'sl', 'pl', 'cl', 'fl', 'br', 'cr', 'tr', 'gr'],
      blendWords: {
        st: ['stop', 'step', 'star'],
        sp: ['spin', 'spot', 'spoon'],
        sl: ['slip', 'slam', 'sled'],
        pl: ['plan', 'plug', 'plant'],
        cl: ['clap', 'clip', 'clock'],
        fl: ['flag', 'flip', 'flat'],
        br: ['brag', 'brick', 'brown'],
        cr: ['crab', 'crack', 'crisp'],
        tr: ['trip', 'truck', 'train'],
        gr: ['grin', 'grab', 'green']
      },

      silentE: [
        { short: 'cap', long: 'cape' },
        { short: 'kit', long: 'kite' },
        { short: 'hop', long: 'hope' },
        { short: 'cub', long: 'cube' },
        { short: 'mad', long: 'made' },
        { short: 'hid', long: 'hide' },
        { short: 'tap', long: 'tape' }
      ],
      vowelTeams: {
        ee: ['see', 'tree', 'feet', 'seed', 'green', 'sleep', 'sweet', 'jeep', 'week', 'need', 'keep'],
        ea: ['eat', 'leaf', 'sea', 'meat', 'peach', 'beach', 'seal', 'team', 'seat', 'read', 'clean'],
        ai: ['rain', 'tail', 'mail', 'sail', 'train', 'paint', 'chain', 'wait', 'snail', 'brain'],
        ay: ['day', 'play', 'say', 'stay', 'tray', 'gray', 'clay', 'spray', 'may', 'way'],
        oa: ['boat', 'goat', 'road', 'soap', 'coat', 'toad', 'float', 'loaf', 'oat', 'goal'],
        ow: ['snow', 'grow', 'blow', 'slow', 'flow', 'glow', 'show', 'crow', 'low', 'row']
      },
      rControlled: {
        ar: ['car', 'star', 'park', 'farm', 'yard', 'barn', 'march', 'hard', 'cart', 'part'],
        er: ['her', 'fern', 'term', 'paper', 'germ', 'corner', 'river', 'teacher', 'baker', 'letter'],
        ir: ['bird', 'girl', 'shirt', 'first', 'third', 'stir', 'whirl', 'skirt', 'dirt'],
        or: ['fork', 'corn', 'storm', 'short', 'born', 'horse', 'shore', 'more', 'sort'],
        ur: ['turn', 'fur', 'hurt', 'nurse', 'burn', 'curl', 'surf', 'purse', 'burst']
      },
      diphthongs: {
        oi: ['coin', 'oil', 'boil', 'soil', 'foil', 'join', 'point'],
        oy: ['boy', 'toy', 'joy', 'soy', 'enjoy', 'ploy'],
        ou: ['out', 'loud', 'cloud', 'house', 'mouse', 'shout', 'found'],
        ow: ['cow', 'now', 'brown', 'town', 'down', 'how', 'clown']
      },

      sightWords: ['the', 'and', 'to', 'a', 'I', 'see', 'want', 'can', 'my', 'is', 'you', 'we', 'like', 'have', 'this', 'there', 'they', 'with', 'said', 'come', 'here', 'it'],
      sightWordSentences: [
        { sentence: 'I ____ a dog.', correct: 'see', choices: ['see', 'want', 'have'] },
        { sentence: '____ is my book.', correct: 'This', choices: ['This', 'There', 'You'] },
        { sentence: 'I ____ to eat.', correct: 'want', choices: ['want', 'like', 'have'] },
        { sentence: '____ is a cat.', correct: 'It', choices: ['It', 'My', 'We'] },
        { sentence: 'We ____ here.', correct: 'come', choices: ['come', 'can', 'see'] },
        { sentence: '____ is the door.', correct: 'There', choices: ['There', 'They', 'We'] },
        { sentence: 'I ____ my hat.', correct: 'have', choices: ['have', 'with', 'come'] },
        { sentence: '____ like pizza.', correct: 'I', choices: ['I', 'My', 'There'] },
        { sentence: '____ are my friends.', correct: 'They', choices: ['They', 'The', 'To'] },
        { sentence: 'Come ____.', correct: 'here', choices: ['here', 'there', 'to'] },
        { sentence: 'I can ____.', correct: 'see', choices: ['see', 'my', 'is'] },
        { sentence: '____ is my cup.', correct: 'This', choices: ['This', 'They', 'You'] },
        { sentence: 'I ____ the dog.', correct: 'see', choices: ['see', 'say', 'sip'] },
        { sentence: 'I ____ you.', correct: 'like', choices: ['like', 'lake', 'lick'] },
        { sentence: 'We ____ to play.', correct: 'want', choices: ['want', 'went', 'win'] },
        { sentence: '____ is my mom.', correct: 'This', choices: ['This', 'They', 'We'] },
        { sentence: '____ can help.', correct: 'You', choices: ['You', 'The', 'To'] },
        { sentence: '____ is hot.', correct: 'It', choices: ['It', 'In', 'If'] },
        { sentence: 'I go ____ the park.', correct: 'to', choices: ['to', 'two', 'too'] },
        { sentence: 'The cat is ____.', correct: 'here', choices: ['here', 'have', 'this'] },
        { sentence: 'I like ___ big dog.', correct: 'the', choices: ['the', 'to', 'and'] },
        { sentence: 'We sit ___ read.', correct: 'and', choices: ['and', 'a', 'to'] },
        { sentence: 'I go ___ school.', correct: 'to', choices: ['to', 'two', 'too'] },
        { sentence: 'I see ___ cat.', correct: 'a', choices: ['a', 'an', 'and'] },
        { sentence: 'This is ___ book.', correct: 'my', choices: ['my', 'me', 'mice'] },
        { sentence: 'I ___ read.', correct: 'can', choices: ['can', 'ran', 'car'] },
        { sentence: 'We play ___ Mom.', correct: 'with', choices: ['with', 'wish', 'wet'] },
        { sentence: 'Mom ___ hi.', correct: 'said', choices: ['said', 'sail', 'sad'] }
      ],

      nouns: ['dog', 'cat', 'fish', 'bird', 'pizza', 'shop', 'table', 'teacher', 'park', 'bus', 'box', 'dish', 'book', 'desk', 'pencil', 'hat', 'sock', 'shirt', 'home', 'store', 'train', 'cake', 'kite', 'cup', 'bed'],
      nounTypes: {
        person: ['mom', 'dad', 'teacher', 'doctor', 'friend', 'girl', 'boy'],
        place: ['park', 'school', 'home', 'store', 'beach', 'zoo'],
        animal: ['dog', 'cat', 'fish', 'bird', 'frog', 'duck'],
        thing: ['book', 'desk', 'pencil', 'hat', 'sock', 'cup', 'box', 'kite']
      },
      verbs: ['run', 'jump', 'eat', 'see', 'want', 'help', 'play', 'walk', 'look', 'read', 'write', 'cook', 'draw', 'sing', 'sit', 'stand'],
      adjectives: ['big', 'small', 'hot', 'cold', 'yummy', 'fresh', 'happy', 'sad', 'tiny', 'brave', 'loud', 'quiet', 'fast', 'slow', 'wet', 'dry'],
      adjectiveDegrees: [
        { base: 'fast', comparative: 'faster', superlative: 'fastest' },
        { base: 'small', comparative: 'smaller', superlative: 'smallest' },
        { base: 'tall', comparative: 'taller', superlative: 'tallest' },
        { base: 'long', comparative: 'longer', superlative: 'longest' },
        { base: 'loud', comparative: 'louder', superlative: 'loudest' },
        { base: 'big', comparative: 'bigger', superlative: 'biggest' },
        { base: 'cold', comparative: 'colder', superlative: 'coldest' },
        { base: 'hot', comparative: 'hotter', superlative: 'hottest' },
        { base: 'slow', comparative: 'slower', superlative: 'slowest' },
        { base: 'short', comparative: 'shorter', superlative: 'shortest' }
      ],
      unscrambleSentences: [
        { words: ['I', 'see', 'a', 'cat'], correct: 'I see a cat.', wrong: ['See I a cat.', 'I a see cat.'] },
        { words: ['We', 'ride', 'the', 'train'], correct: 'We ride the train.', wrong: ['Ride we the train.', 'We the ride train.'] },
        { words: ['The', 'dog', 'can', 'run'], correct: 'The dog can run.', wrong: ['Dog the can run.', 'The can dog run.'] },
        { words: ['She', 'has', 'a', 'hat'], correct: 'She has a hat.', wrong: ['Has she a hat.', 'She a has hat.'] },
        { words: ['I', 'like', 'cold', 'milk'], correct: 'I like cold milk.', wrong: ['I cold like milk.', 'Like I cold milk.'] },
        { words: ['They', 'play', 'a', 'game'], correct: 'They play a game.', wrong: ['Play they a game.', 'They a play game.'] },
        { words: ['The', 'fish', 'is', 'wet'], correct: 'The fish is wet.', wrong: ['Fish the is wet.', 'The is fish wet.'] },
        { words: ['I', 'want', 'a', 'cookie'], correct: 'I want a cookie.', wrong: ['Want I a cookie.', 'I a want cookie.'] }
      ],
      prepositions: ['in', 'on', 'under', 'by', 'behind', 'between', 'next to'],

      numberWords: [
        { digit: '1', word: 'one', wrong: ['won', 'on'] },
        { digit: '2', word: 'two', wrong: ['to', 'too'] },
        { digit: '3', word: 'three', wrong: ['tree', 'free'] },
        { digit: '4', word: 'four', wrong: ['for', 'fore'] },
        { digit: '5', word: 'five', wrong: ['fiv', 'fine'] },
        { digit: '6', word: 'six', wrong: ['sicks', 'sip'] },
        { digit: '7', word: 'seven', wrong: ['sevin', 'siren'] },
        { digit: '8', word: 'eight', wrong: ['ate', 'eigt'] },
        { digit: '9', word: 'nine', wrong: ['neen', 'nice'] },
        { digit: '10', word: 'ten', wrong: ['tin', 'teen'] }
      ],

      prefixesUn: [
        { base: 'happy', derived: 'unhappy', meaning: 'not happy', wrong: ['happy', 'happier'] },
        { base: 'kind', derived: 'unkind', meaning: 'not kind', wrong: ['kind', 'kinds'] },
        { base: 'safe', derived: 'unsafe', meaning: 'not safe', wrong: ['safe', 'safest'] },
        { base: 'fair', derived: 'unfair', meaning: 'not fair', wrong: ['fair', 'fairs'] },
        { base: 'lock', derived: 'unlock', meaning: 'open the lock', wrong: ['lock', 'locked'] },
        { base: 'wrap', derived: 'unwrap', meaning: 'take off the wrap', wrong: ['wrap', 'wrapped'] },
        { base: 'tie', derived: 'untie', meaning: 'undo the tie', wrong: ['tie', 'tied'] },
        { base: 'clean', derived: 'unclean', meaning: 'not clean', wrong: ['clean', 'cleaner'] },
        { base: 'even', derived: 'uneven', meaning: 'not even', wrong: ['even', 'evenly'] },
        { base: 'able', derived: 'unable', meaning: 'not able', wrong: ['able', 'ables'] }
      ],

      suffixesFul: [
        { base: 'help', derived: 'helpful', meaning: 'full of help', wrong: ['help', 'helpless'] },
        { base: 'care', derived: 'careful', meaning: 'full of care', wrong: ['care', 'careless'] },
        { base: 'hope', derived: 'hopeful', meaning: 'full of hope', wrong: ['hope', 'hopeless'] },
        { base: 'use', derived: 'useful', meaning: 'full of use', wrong: ['use', 'useless'] },
        { base: 'play', derived: 'playful', meaning: 'full of play', wrong: ['play', 'played'] },
        { base: 'thank', derived: 'thankful', meaning: 'full of thanks', wrong: ['thank', 'thanks'] },
        { base: 'joy', derived: 'joyful', meaning: 'full of joy', wrong: ['joy', 'joyless'] },
        { base: 'wonder', derived: 'wonderful', meaning: 'full of wonder', wrong: ['wonder', 'wonderless'] },
        { base: 'beauty', derived: 'beautiful', meaning: 'full of beauty', wrong: ['beauty', 'beautyless'] },
        { base: 'color', derived: 'colorful', meaning: 'full of color', wrong: ['color', 'colorless'] }
      ],

      properNouns: [
        { question: 'Which word is a name?', correct: 'Sam', wrong: ['boy', 'dog'] },
        { question: 'Which word is a name?', correct: 'Mia', wrong: ['girl', 'cat'] },
        { question: 'Which word is a name?', correct: 'Ben', wrong: ['friend', 'park'] },
        { question: 'Which word should start with a capital letter?', correct: 'Monday', wrong: ['school', 'home'] },
        { question: 'Which word should start with a capital letter?', correct: 'January', wrong: ['winter', 'month'] },
        { question: 'Which word is a name?', correct: 'Ana', wrong: ['teacher', 'school'] },
        { question: 'Which word is a name?', correct: 'Tom', wrong: ['kid', 'chair'] },
        { question: 'Which word should start with a capital letter?', correct: 'Friday', wrong: ['lunch', 'night'] },
        { question: 'Which word should start with a capital letter?', correct: 'March', wrong: ['spring', 'weather'] },
        { question: 'Which word is a name?', correct: 'Max', wrong: ['puppy', 'bone'] }
      ],

      possessiveNouns: [
        { owner: 'girl', thing: 'hat', correct: "girl's", wrong: ['girls', 'girl'] },
        { owner: 'boy', thing: 'bike', correct: "boy's", wrong: ['boys', 'boy'] },
        { owner: 'Mom', thing: 'bag', correct: "Mom's", wrong: ['Moms', 'Mom'] },
        { owner: 'Dad', thing: 'car', correct: "Dad's", wrong: ['Dads', 'Dad'] },
        { owner: 'teacher', thing: 'book', correct: "teacher's", wrong: ['teachers', 'teacher'] },
        { owner: 'dog', thing: 'bone', correct: "dog's", wrong: ['dogs', 'dog'] },
        { owner: 'bird', thing: 'nest', correct: "bird's", wrong: ['birds', 'bird'] },
        { owner: 'friend', thing: 'toy', correct: "friend's", wrong: ['friends', 'friend'] },
        { owner: 'baby', thing: 'bottle', correct: "baby's", wrong: ['babies', 'baby'] },
        { owner: 'cat', thing: 'food', correct: "cat's", wrong: ['cats', 'cat'] }
      ],

      irregularPlurals: [
        { singular: 'child', plural: 'children', wrong: ['childs', 'childes'] },
        { singular: 'man', plural: 'men', wrong: ['mans', 'mens'] },
        { singular: 'woman', plural: 'women', wrong: ['womans', 'womens'] },
        { singular: 'mouse', plural: 'mice', wrong: ['mouses', 'mices'] },
        { singular: 'foot', plural: 'feet', wrong: ['foots', 'feets'] },
        { singular: 'tooth', plural: 'teeth', wrong: ['tooths', 'teeths'] }
      ],

      possessivePronouns: [
        { sentence: 'This is ____ book.', correct: 'my', wrong: ['me', 'I'] },
        { sentence: 'That is ____ hat.', correct: 'his', wrong: ['him', 'he'] },
        { sentence: 'This is ____ doll.', correct: 'her', wrong: ['she', 'hers'] },
        { sentence: 'Look at ____ bike.', correct: 'my', wrong: ['me', 'I'] },
        { sentence: 'We like ____ school.', correct: 'our', wrong: ['us', 'we'] },
        { sentence: 'That is ____ dog.', correct: 'their', wrong: ['they', 'them'] },
        { sentence: 'I see ____ bag.', correct: 'your', wrong: ['you', 'yours'] },
        { sentence: 'Where is ____ pencil?', correct: 'my', wrong: ['me', 'I'] },
        { sentence: 'She lost ____ coat.', correct: 'her', wrong: ['she', 'hers'] },
        { sentence: 'He rides ____ bike.', correct: 'his', wrong: ['him', 'he'] },
        { sentence: 'These are ____ shoes.', correct: 'our', wrong: ['us', 'we'] },
        { sentence: 'Those are ____ toys.', correct: 'their', wrong: ['they', 'them'] }
      ],

      synonyms: [
        { word: 'big', synonym: 'large', wrong: ['hot', 'sad'] },
        { word: 'small', synonym: 'little', wrong: ['cold', 'run'] },
        { word: 'happy', synonym: 'glad', wrong: ['mad', 'wet'] },
        { word: 'tiny', synonym: 'small', wrong: ['loud', 'slow'] },
        { word: 'fast', synonym: 'quick', wrong: ['cold', 'sad'] },
        { word: 'loud', synonym: 'noisy', wrong: ['tiny', 'quiet'] },
        { word: 'sad', synonym: 'unhappy', wrong: ['glad', 'fast'] },
        { word: 'begin', synonym: 'start', wrong: ['stop', 'sleep'] },
        { word: 'smart', synonym: 'clever', wrong: ['tired', 'wet'] },
        { word: 'angry', synonym: 'mad', wrong: ['glad', 'sleepy'] },
        { word: 'funny', synonym: 'silly', wrong: ['quiet', 'cold'] },
        { word: 'wet', synonym: 'damp', wrong: ['dry', 'hot'] },
        { word: 'cold', synonym: 'chilly', wrong: ['sunny', 'loud'] },
        { word: 'help', synonym: 'assist', wrong: ['hide', 'hurt'] }
      ],
      antonyms: [
        { word: 'hot', antonym: 'cold', wrong: ['big', 'fast'] },
        { word: 'up', antonym: 'down', wrong: ['in', 'on'] },
        { word: 'happy', antonym: 'sad', wrong: ['glad', 'smile'] },
        { word: 'quiet', antonym: 'loud', wrong: ['fast', 'tiny'] },
        { word: 'big', antonym: 'small', wrong: ['tall', 'wide'] },
        { word: 'in', antonym: 'out', wrong: ['up', 'over'] },
        { word: 'open', antonym: 'shut', wrong: ['shine', 'splash'] },
        { word: 'first', antonym: 'last', wrong: ['next', 'fast'] },
        { word: 'fast', antonym: 'slow', wrong: ['quick', 'loud'] },
        { word: 'wet', antonym: 'dry', wrong: ['damp', 'cold'] },
        { word: 'day', antonym: 'night', wrong: ['sun', 'light'] },
        { word: 'clean', antonym: 'dirty', wrong: ['tidy', 'shiny'] },
        { word: 'full', antonym: 'empty', wrong: ['big', 'heavy'] },
        { word: 'on', antonym: 'off', wrong: ['up', 'over'] }
      ],
      categories: [
        { category: 'Animals', words: ['dog', 'cat', 'fish'], odd: 'cake' },
        { category: 'Food', words: ['pizza', 'cake', 'rice'], odd: 'shoe' },
        { category: 'Colors', words: ['red', 'blue', 'green'], odd: 'jump' },
        { category: 'School', words: ['book', 'desk', 'pencil'], odd: 'soup' },
        { category: 'Clothes', words: ['hat', 'sock', 'shirt'], odd: 'fish' },
        { category: 'Places', words: ['park', 'home', 'store'], odd: 'jump' },
        { category: 'Weather', words: ['rain', 'snow', 'wind'], odd: 'pizza' },
        { category: 'Actions', words: ['run', 'jump', 'read'], odd: 'blue' },
        { category: 'Kitchen', words: ['cup', 'plate', 'spoon'], odd: 'kite' },
        { category: 'Body Parts', words: ['hand', 'foot', 'nose'], odd: 'rain' },
        { category: 'Toys', words: ['ball', 'kite', 'doll'], odd: 'bread' },
        { category: 'Pets', words: ['dog', 'cat', 'fish'], odd: 'desk' },
        { category: 'Vehicles', words: ['car', 'bus', 'train'], odd: 'leaf' }
      ],

      multipleMeaning: [
        { context: 'I hit the ball with a bat.', correct: 'A sports stick', wrong: ['A flying animal', 'A kind of food'] },
        { context: 'We put jam on toast.', correct: 'Sweet fruit spread', wrong: ['A traffic problem', 'A kind of shoe'] },
        { context: 'The cars are in a jam.', correct: 'A traffic problem', wrong: ['Sweet fruit spread', 'A flying animal'] },
        { context: 'I can put soup in a can.', correct: 'A metal container', wrong: ['To be able to', 'A kind of animal'] },
        { context: 'I can read this word.', correct: 'To be able to', wrong: ['A metal container', 'A kind of food'] },
        { context: 'The duck has a bill.', correct: 'The duck\'s mouth', wrong: ['Money to pay', 'A kind of bed'] },
        { context: 'Mom pays the bill.', correct: 'Money to pay', wrong: ['The duck\'s mouth', 'A kind of fish'] },
        { context: 'The dog can bark.', correct: 'A dog sound', wrong: ['Tree skin', 'A kind of shoe'] },
        { context: 'The bark is rough.', correct: 'Tree skin', wrong: ['A dog sound', 'A kind of soup'] },
        { context: 'The light is bright.', correct: 'Not dark', wrong: ['Not heavy', 'A kind of food'] },
        { context: 'The bag is light.', correct: 'Not heavy', wrong: ['Not dark', 'A kind of bird'] },
        { context: 'I wear a ring.', correct: 'A piece of jewelry', wrong: ['A loud sound', 'A kind of fish'] },
        { context: 'The bell will ring.', correct: 'Make a sound', wrong: ['A piece of jewelry', 'A kind of cookie'] }
      ],
      contextClues: [
        { passage: 'The puppy is tiny. It is very small.', correct: 'very small', wrong: ['very loud', 'very tall'] },
        { passage: 'The soup is steaming. It is very hot.', correct: 'very hot', wrong: ['very cold', 'very quiet'] },
        { passage: 'The room is quiet. No one is talking.', correct: 'not loud', wrong: ['very loud', 'very fast'] },
        { passage: 'The ice is slippery. It is hard to stand.', correct: 'hard to stand on', wrong: ['easy to read', 'very loud'] },
        { passage: 'The cake is sweet. It tastes like sugar.', correct: 'tastes like sugar', wrong: ['tastes like dirt', 'tastes like soap'] },
        { passage: 'The puppy is playful. It runs and jumps.', correct: 'likes to play', wrong: ['likes to sleep', 'likes to hide'] },
        { passage: 'The box is heavy. I need help to lift it.', correct: 'hard to lift', wrong: ['easy to carry', 'very tiny'] },
        { passage: 'The path is narrow. Only one person can walk.', correct: 'not wide', wrong: ['very wide', 'very loud'] },
        { passage: 'The puppy is calm. It sits still.', correct: 'not wild', wrong: ['very loud', 'very fast'] },
        { passage: 'The water is freezing. My hands feel cold.', correct: 'very, very cold', wrong: ['very hot', 'very loud'] },
        { passage: 'The snack is crunchy. It makes a loud sound when I bite.', correct: 'hard and crackly', wrong: ['soft and quiet', 'wet and slippery'] },
        { passage: 'The glass is fragile. It can break easily.', correct: 'can break easily', wrong: ['very strong', 'very loud'] },
        { passage: 'The baby is fussy. The baby cries and cries.', correct: 'hard to please', wrong: ['very sleepy', 'very brave'] }
      ],
      shadesOfMeaning: [
        { question: 'Which word means the MOST happy?', answers: ['glad', 'happy', 'thrilled'], correct: 'thrilled' },
        { question: 'Which word means the MOST cold?', answers: ['cool', 'cold', 'freezing'], correct: 'freezing' },
        { question: 'Which word means the MOST loud?', answers: ['loud', 'noisy', 'deafening'], correct: 'deafening' },
        { question: 'Which word means the MOST hot?', answers: ['warm', 'hot', 'burning'], correct: 'burning' },
        { question: 'Which word means the MOST big?', answers: ['big', 'large', 'huge'], correct: 'huge' }
      ],
      shadesOrder: [
        { prompt: 'Order from least to most happy.', words: ['glad', 'happy', 'thrilled'], correct: ['glad', 'happy', 'thrilled'] },
        { prompt: 'Order from least to most cold.', words: ['cool', 'cold', 'freezing'], correct: ['cool', 'cold', 'freezing'] },
        { prompt: 'Order from least to most loud.', words: ['loud', 'noisy', 'deafening'], correct: ['loud', 'noisy', 'deafening'] },
        { prompt: 'Order from least to most big.', words: ['big', 'large', 'huge'], correct: ['big', 'large', 'huge'] },
        { prompt: 'Order from least to most fast.', words: ['fast', 'faster', 'fastest'], correct: ['fast', 'faster', 'fastest'] },
        { prompt: 'Order from least to most small.', words: ['small', 'smaller', 'smallest'], correct: ['small', 'smaller', 'smallest'] },
        { prompt: 'Order from least to most wet.', words: ['damp', 'wet', 'soaked'], correct: ['damp', 'wet', 'soaked'] },
        { prompt: 'Order from least to most tired.', words: ['tired', 'sleepy', 'exhausted'], correct: ['tired', 'sleepy', 'exhausted'] },
        { prompt: 'Order from least to most good.', words: ['good', 'great', 'excellent'], correct: ['good', 'great', 'excellent'] }
      ],

      phonemeChange: [
        { base: 'cat', firstTo: 'b', result: 'bat', lastTo: 'p', lastResult: 'cap', vowelTo: 'o', vowelResult: 'cot' },
        { base: 'dog', firstTo: 'l', result: 'log', lastTo: 't', lastResult: 'dot', vowelTo: 'i', vowelResult: 'dig' },
        { base: 'sun', firstTo: 'f', result: 'fun', lastTo: 'm', lastResult: 'sum', vowelTo: 'o', vowelResult: 'son' },
        { base: 'bed', firstTo: 'r', result: 'red', lastTo: 'g', lastResult: 'beg', vowelTo: 'a', vowelResult: 'bad' },
        { base: 'pin', firstTo: 't', result: 'tin', lastTo: 'g', lastResult: 'pig', vowelTo: 'a', vowelResult: 'pan' },
        { base: 'tap', firstTo: 'm', result: 'map', lastTo: 'n', lastResult: 'tan', vowelTo: 'o', vowelResult: 'top' },
        { base: 'bug', firstTo: 'h', result: 'hug', lastTo: 'n', lastResult: 'bun', vowelTo: 'a', vowelResult: 'bag' },
        { base: 'hat', firstTo: 'b', result: 'bat', lastTo: 'm', lastResult: 'ham', vowelTo: 'u', vowelResult: 'hut' },
        { base: 'cap', firstTo: 't', result: 'tap', lastTo: 't', lastResult: 'cat', vowelTo: 'o', vowelResult: 'cop' },
        { base: 'fin', firstTo: 'p', result: 'pin', lastTo: 't', lastResult: 'fit', vowelTo: 'a', vowelResult: 'fan' }
      ],

      contractions: [
        { phrase: 'do not', contraction: "don't", wrong: ["do'nt", 'dont'] },
        { phrase: 'cannot', contraction: "can't", wrong: ['cant', "ca'nt"] },
        { phrase: 'I am', contraction: "I'm", wrong: ['Im', "I m".replace(' ', '')] },
        { phrase: 'we are', contraction: "we're", wrong: ['were', "we re".replace(' ', '')] },
        { phrase: 'it is', contraction: "it's", wrong: ['its', "it s".replace(' ', '')] },
        { phrase: 'you are', contraction: "you're", wrong: ['your', "you re".replace(' ', '')] },
        { phrase: 'they are', contraction: "they're", wrong: ['there', "they re".replace(' ', '')] },
        { phrase: 'she is', contraction: "she's", wrong: ['shes', "she s".replace(' ', '')] },
        { phrase: 'is not', contraction: "isn't", wrong: ['isnt', "is'nt"] },
        { phrase: 'are not', contraction: "aren't", wrong: ['arent', "are'nt"] },
        { phrase: 'will not', contraction: "won't", wrong: ['wont', "wo'nt"] },
        { phrase: 'has not', contraction: "hasn't", wrong: ['hasnt', "has'nt"] },
        { phrase: 'did not', contraction: "didn't", wrong: ['didnt', "did'nt"] }
      ],
      plurals: [
        { singular: 'cat', plural: 'cats', wrong: ['cat', 'cates'] },
        { singular: 'dog', plural: 'dogs', wrong: ['dog', 'doges'] },
        { singular: 'box', plural: 'boxes', wrong: ['boxs', 'box'] },
        { singular: 'dish', plural: 'dishes', wrong: ['dishs', 'dish'] },
        { singular: 'bus', plural: 'buses', wrong: ['buss', 'bus'] },
        { singular: 'fox', plural: 'foxes', wrong: ['foxs', 'fox'] },
        { singular: 'bench', plural: 'benches', wrong: ['benchs', 'bench'] },
        { singular: 'class', plural: 'classes', wrong: ['classs', 'class'] },
        { singular: 'baby', plural: 'babies', wrong: ['babys', 'baby'] },
        { singular: 'city', plural: 'cities', wrong: ['citys', 'city'] },
        { singular: 'leaf', plural: 'leaves', wrong: ['leafs', 'leaf'] }
      ],
      sentenceTypes: [
        { sentence: 'I like pizza.', type: 'Statement' },
        { sentence: 'Do you like pizza?', type: 'Question' },
        { sentence: 'Please sit down.', type: 'Command' },
        { sentence: 'That is amazing!', type: 'Exclamation' },
        { sentence: 'The dog can run.', type: 'Statement' },
        { sentence: 'Where is the book?', type: 'Question' },
        { sentence: 'Close the door.', type: 'Command' },
        { sentence: 'I did it!', type: 'Exclamation' },
        { sentence: 'We ride the train.', type: 'Statement' },
        { sentence: 'Can you help me?', type: 'Question' },
        { sentence: 'Stop and look.', type: 'Command' },
        { sentence: 'What a big fish!', type: 'Exclamation' }
      ],
      whSentences: [
        { sentence: '____ is at the door?', correct: 'Who', wrong: ['Where', 'When'] },
        { sentence: '____ do you live?', correct: 'Where', wrong: ['Who', 'Why'] },
        { sentence: '____ did you eat?', correct: 'What', wrong: ['When', 'Who'] },
        { sentence: '____ is it raining?', correct: 'Why', wrong: ['What', 'Where'] },
        { sentence: '____ do we go?', correct: 'When', wrong: ['Who', 'What'] },
        { sentence: '____ is your name?', correct: 'What', wrong: ['Where', 'When'] },
        { sentence: '____ is the party?', correct: 'When', wrong: ['Who', 'Why'] },
        { sentence: '____ is the ball?', correct: 'Where', wrong: ['What', 'When'] },
        { sentence: '____ is calling me?', correct: 'Who', wrong: ['Where', 'Why'] },
        { sentence: '____ are you sad?', correct: 'Why', wrong: ['Who', 'When'] },
        { sentence: '____ is in the box?', correct: 'What', wrong: ['When', 'Why'] },
        { sentence: '____ is the teacher?', correct: 'Who', wrong: ['What', 'When'] },
        { sentence: '____ do we eat lunch?', correct: 'When', wrong: ['Where', 'Why'] },
        { sentence: '____ do we put the shoes?', correct: 'Where', wrong: ['Who', 'When'] }
      ],
      conjunctions: [
        { sentence: 'I like soup ____ I like pizza.', correct: 'and', wrong: ['but', 'because'] },
        { sentence: 'I want to play, ____ it is raining.', correct: 'but', wrong: ['and', 'so'] },
        { sentence: 'I was hungry, ____ I ate.', correct: 'so', wrong: ['but', 'because'] },
        { sentence: 'I wear a coat ____ it is cold.', correct: 'because', wrong: ['and', 'so'] },
        { sentence: 'I can read ____ I can write.', correct: 'and', wrong: ['but', 'because'] },
        { sentence: 'I was tired, ____ I went to bed.', correct: 'so', wrong: ['and', 'but'] },
        { sentence: 'I want to go, ____ I must wait.', correct: 'but', wrong: ['and', 'because'] },
        { sentence: 'I ate, ____ I was still hungry.', correct: 'but', wrong: ['and', 'because'] },
        { sentence: 'I wore boots ____ it was raining.', correct: 'because', wrong: ['and', 'but'] },
        { sentence: 'I finished my work, ____ I played.', correct: 'so', wrong: ['but', 'because'] }
      ],
      timeOrder: [
        { sentence: '____, I wash my hands. Next, I eat.', correct: 'First', wrong: ['Next', 'Last'] },
        { sentence: 'First, I mix. ____, I bake. Last, I eat.', correct: 'Next', wrong: ['First', 'Last'] },
        { sentence: 'First, I read. Next, I write. ____, I clean up.', correct: 'Last', wrong: ['First', 'Next'] },
        { sentence: '____, I put on socks. Next, I put on shoes.', correct: 'First', wrong: ['Next', 'Last'] },
        { sentence: 'First, we line up. ____, we walk to class. Last, we sit.', correct: 'Next', wrong: ['First', 'Last'] },
        { sentence: 'First, I brush my teeth. Next, I wash my face. ____, I go to bed.', correct: 'Last', wrong: ['First', 'Next'] },
        { sentence: '____, I get a bowl. Next, I pour cereal. Last, I eat.', correct: 'First', wrong: ['Next', 'Last'] },
        { sentence: 'First, I open the door. ____, I step in. Last, I shut it.', correct: 'Next', wrong: ['First', 'Last'] },
        { sentence: 'First, we pack. Next, we ride. ____, we arrive.', correct: 'Last', wrong: ['First', 'Next'] }
      ],
      textFeatures: [
        { question: 'What helps you find page numbers fast?', correct: 'Table of contents', wrong: ['Title', 'Picture'] },
        { question: 'What tells what a picture shows?', correct: 'Caption', wrong: ['Question mark', 'Rhyme'] },
        { question: 'What word is at the top of a page to tell the topic?', correct: 'Heading', wrong: ['Sticker', 'Song'] },
        { question: 'What list tells what a word means?', correct: 'Glossary', wrong: ['Calendar', 'Recipe'] },
        { question: 'What list helps you find topics at the back of a book?', correct: 'Index', wrong: ['Poem', 'Riddle'] },
        { question: 'What shows the parts of something with words and lines?', correct: 'Label', wrong: ['Rhyme', 'End mark'] },
        { question: 'What helps you see where places are?', correct: 'Map', wrong: ['Joke', 'Song'] },
        { question: 'What special word shows important words in dark print?', correct: 'Bold print', wrong: ['Whisper', 'Shadow'] }
      ],
      bestTitle: [
        { passage: 'Sam plants a seed. Sam waters it. A plant grows.', correct: 'A New Plant', wrong: ['A Rainy Day', 'A Fast Train'] },
        { passage: 'Mia makes a sandwich. Mia eats lunch. Mia feels full.', correct: 'Lunch Time', wrong: ['At the Zoo', 'A Snow Day'] },
        { passage: 'Ben finds a lost hat. Ben gives it back. The girl smiles.', correct: 'A Kind Choice', wrong: ['A Big Race', 'A Fish Shop'] },
        { passage: 'A dog is wet. The dog shakes. Water splashes.', correct: 'A Wet Dog', wrong: ['A Dry Desert', 'A Quiet Room'] },
        { passage: 'We line up. We get on the bus. We go to school.', correct: 'Going to School', wrong: ['Baking a Cake', 'Flying a Kite'] },
        { passage: 'Ana reads a book. Ana learns facts. Ana tells a friend.', correct: 'Reading to Learn', wrong: ['Fixing a Bike', 'Eating Pizza'] },
        { passage: 'The wind blows. Leaves fall. It is autumn.', correct: 'A Windy Fall Day', wrong: ['Summer at the Beach', 'A New Puppy'] },
        { passage: 'A boy drops his ice cream. He feels sad. Mom helps him.', correct: 'Ice Cream Trouble', wrong: ['A Lost Hat', 'A New Toy'] },
        { passage: 'The class is loud. The teacher says please be quiet.', correct: 'Quiet in Class', wrong: ['A Loud Class', 'Reading Time'] },
        { passage: 'Dad cooks rice. The rice gets soft. We eat dinner.', correct: 'Dinner Is Ready', wrong: ['Lunch Time', 'A Quiet Room'] },
        { passage: 'Kim puts on boots. Kim walks in the rain. Kim stays dry.', correct: 'Walking in the Rain', wrong: ['A Hot Desert', 'A Sleeping Cat'] },
        { passage: 'The bird finds sticks. The bird builds a nest.', correct: 'Building a Nest', wrong: ['A New Toy', 'A Cold Drink'] },
        { passage: 'Sara loses a pencil. Sara looks under the desk. Sara finds it.', correct: 'Finding a Pencil', wrong: ['A Snowy Day', 'A Pizza Party'] },
        { passage: 'A boy is thirsty. He drinks water. He feels better.', correct: 'A Thirsty Boy', wrong: ['A Cold Drink', 'Feeling Better'] },
        { passage: 'We wash our hands. We eat. We clean up.', correct: 'After We Eat', wrong: ['A Rainy Day', 'A New Train'] },
        { passage: 'The puppy runs. The puppy jumps. The puppy plays.', correct: 'Puppy Play', wrong: ['A Sad Song', 'A Quiet Cave'] },
        { passage: 'Mom bakes a cake. The cake smells sweet. We taste it.', correct: 'Baking a Cake', wrong: ['Riding a Bike', 'A Lost Hat'] },
        { passage: 'A frog sits on a log. A frog jumps in the pond.', correct: 'A Frog Jumps', wrong: ['A Long Train', 'A Cold Pizza'] },
        { passage: 'Ben reads the sign. Ben walks to the store.', correct: 'Reading a Sign', wrong: ['Going to School', 'A New Plant'] }
      ],
      supportingDetail: [
        { passage: 'The cat sits on the bed. The cat is sleepy.', question: 'Which detail is in the passage?', correct: 'The cat is sleepy.', wrong: ['The cat is hungry.', 'The cat is happy.'] },
        { passage: 'Ben has a kite. Ben runs fast. The kite goes up.', question: 'Which detail is in the passage?', correct: 'The kite goes up.', wrong: ['The kite goes down.', 'Ben sits down.'] },
        { passage: 'Mia goes to the bakery. It smells sweet. Mia buys a bun.', question: 'Which detail is in the passage?', correct: 'It smells sweet.', wrong: ['It smells like bread.', 'Mia buys a cake.'] },
        { passage: 'Dark clouds come. Rain starts. We go inside.', question: 'What happens in the passage?', correct: 'We go inside.', wrong: ['We stay outside.', 'We close the door.'] },
        { passage: 'The soup is hot. Steam goes up. I wait to eat.', question: 'Which detail is true?', correct: 'Steam goes up.', wrong: ['Steam goes down.', 'The soup is cold.'] },
        { passage: 'The dog is thirsty. The dog drinks water.', question: 'Which detail is in the passage?', correct: 'The dog drinks water.', wrong: ['The dog eats food.', 'The dog takes a nap.'] },
        { passage: 'We clean up toys. We put them in a box.', question: 'Which detail is in the passage?', correct: 'We put toys in a box.', wrong: ['We leave toys on the floor.', 'We put toys on a shelf.'] },
        { passage: 'I wear a coat because it is cold.', question: 'Which detail is in the passage?', correct: 'It is cold.', wrong: ['It is hot.', 'It is bedtime.'] },
        { passage: 'A fish swims in water. A bird flies in the sky.', question: 'Which detail is in the passage?', correct: 'A bird flies in the sky.', wrong: ['A bird sings in a tree.', 'A fish hides by rocks.'] },
        { passage: 'Tom reads each page. Tom learns new words.', question: 'Which detail is in the passage?', correct: 'Tom learns new words.', wrong: ['Tom draws a picture.', 'Tom plays a game.'] },
        { passage: 'We go to the park. We swing. We slide.', question: 'Which detail is in the passage?', correct: 'We swing.', wrong: ['We run.', 'We climb.'] },
        { passage: 'A baby drinks milk. The baby smiles.', question: 'Which detail is in the passage?', correct: 'The baby smiles.', wrong: ['The baby cries.', 'The baby falls asleep.'] },
        { passage: 'Dad fixes the bike. The bike can roll again.', question: 'Which detail is in the passage?', correct: 'Dad fixes the bike.', wrong: ['Dad cleans the bike.', 'Dad rides the bike.'] },
        { passage: 'Ana paints with red and blue. Ana makes a picture.', question: 'Which detail is in the passage?', correct: 'Ana paints with red and blue.', wrong: ['Ana paints with green and yellow.', 'Ana draws with a pencil.'] },
        { passage: 'The rain stops. The sun comes out.', question: 'Which detail is in the passage?', correct: 'The sun comes out.', wrong: ['The rain starts.', 'The clouds cover the sun.'] },
        { passage: 'Ben is hungry. Ben eats an apple.', question: 'Which detail is in the passage?', correct: 'Ben eats an apple.', wrong: ['Ben eats a banana.', 'Ben drinks water.'] },
        { passage: 'Mia has a new puppy. The puppy runs to her.', question: 'Which detail is in the passage?', correct: 'The puppy runs to her.', wrong: ['The puppy runs away.', 'The puppy sits down.'] },
        { passage: 'We make pancakes. We mix and stir. We cook them.', question: 'Which detail is in the passage?', correct: 'We mix and stir.', wrong: ['We plant a tree.', 'We fly a kite.'] },
        { passage: 'The class is quiet. The teacher reads a story.', question: 'Which detail is in the passage?', correct: 'The teacher reads a story.', wrong: ['The teacher writes on a board.', 'The class talks loudly.'] },
        { passage: 'A boy drops his cup. The water spills on the floor.', question: 'Which detail is in the passage?', correct: 'The water spills on the floor.', wrong: ['The cup stays dry.', 'The boy wipes it up.'] },
        { passage: 'Kim ties her shoes. Kim runs outside.', question: 'Which detail is in the passage?', correct: 'Kim ties her shoes.', wrong: ['Kim paints her shoes.', 'Kim sleeps on the shoes.'] },
        { passage: 'The bird builds a nest with sticks.', question: 'Which detail is in the passage?', correct: 'The bird uses sticks.', wrong: ['The bird uses leaves.', 'The bird uses grass.'] },
        { passage: 'We wash our hands before we eat.', question: 'Which detail is in the passage?', correct: 'We wash our hands.', wrong: ['We wash our face.', 'We wash our plate.'] },
        { passage: 'Dad packs a lunch. Dad puts an apple in the bag.', question: 'Which detail is in the passage?', correct: 'Dad puts an apple in the bag.', wrong: ['Dad puts a sandwich in the bag.', 'Dad puts a banana in the bag.'] },
        { passage: 'The dog digs in the yard. The dog finds a bone.', question: 'Which detail is in the passage?', correct: 'The dog finds a bone.', wrong: ['The dog finds a stick.', 'The dog finds a toy.'] },
        { passage: 'Lia reads a sign. The sign says STOP.', question: 'Which detail is in the passage?', correct: 'The sign says STOP.', wrong: ['The sign says GO.', 'The sign says SLOW.'] },
        { passage: 'I put on boots. I walk in the rain. I stay dry.', question: 'Which detail is in the passage?', correct: 'I stay dry.', wrong: ['I get wet.', 'I use an umbrella.'] }
      ],
      characterActions: [
        { passage: 'Ben sees a friend fall. Ben helps her up.', question: 'What is Ben like?', correct: 'Helpful', wrong: ['Mean', 'Lazy'] },
        { passage: 'Mia shares her crayons. Mia says you can use mine.', question: 'What is Mia like?', correct: 'Kind', wrong: ['Rude', 'Scared'] },
        { passage: 'Tom hears a loud sound. Tom hides behind a chair.', question: 'How does Tom feel?', correct: 'Scared', wrong: ['Proud', 'Sleepy'] },
        { passage: 'Ana tries a hard puzzle. Ana keeps trying.', question: 'What is Ana like?', correct: 'Keeps trying', wrong: ['Gives up', 'Does not care'] },
        { passage: 'Kai says I can do it. Kai smiles and tries again.', question: 'How does Kai feel?', correct: 'Confident', wrong: ['Sad', 'Angry'] },
        { passage: 'A girl says sorry. She fixes the mistake.', question: 'What is the girl like?', correct: 'Fixes mistakes', wrong: ['Blames others', 'Runs away'] },
        { passage: 'A boy takes a toy without asking.', question: 'What is the boy like?', correct: 'Rude', wrong: ['Kind', 'Helpful'] },
        { passage: 'Lia waits her turn. Lia stands in line.', question: 'What is Lia like?', correct: 'Patient', wrong: ['Wild', 'Mean'] },
        { passage: 'Dad cooks dinner. Dad says we can work together.', question: 'What is Dad like?', correct: 'Helpful', wrong: ['Rude', 'Sleepy'] },
        { passage: 'A child sees a lost mitten. The child gives it back.', question: 'What is the child like?', correct: 'Honest', wrong: ['Mean', 'Greedy'] },
        { passage: 'A kid lets a friend go first. The kid smiles.', question: 'What is the kid like?', correct: 'Kind', wrong: ['Rude', 'Mean'] },
        { passage: 'A boy tries a new slide. The boy says I am brave.', question: 'How does the boy feel?', correct: 'Brave', wrong: ['Scared', 'Sleepy'] },
        { passage: 'A girl says I will help. The girl carries the box.', question: 'What is the girl like?', correct: 'Helpful', wrong: ['Mean', 'Rude'] },
        { passage: 'A child looks at a mess. The child cleans it up.', question: 'What is the child like?', correct: 'Responsible', wrong: ['Lazy', 'Mean'] },
        { passage: 'A kid laughs when a friend falls. The kid does not help.', question: 'What is the kid like?', correct: 'Mean', wrong: ['Kind', 'Helpful'] }
      ],
      pronounReference: [
        { passage: 'Mia has a dog. She pets it.', question: 'Who is she?', correct: 'Mia', wrong: ['The dog', 'It'] },
        { passage: 'Ben has two cats. They run.', question: 'Who are they?', correct: 'The cats', wrong: ['Ben', 'A dog'] },
        { passage: 'I have a ball. It is red.', question: 'What is it?', correct: 'The ball', wrong: ['Red', 'I'] },
        { passage: 'Sara eats an apple. It is sweet.', question: 'What is it?', correct: 'The apple', wrong: ['Sara', 'Sweet'] },
        { passage: 'Tom and Ana play a game. They laugh.', question: 'Who are they?', correct: 'Tom and Ana', wrong: ['A game', 'Laugh'] },
        { passage: 'Dad fixes the bike. He smiles.', question: 'Who is he?', correct: 'Dad', wrong: ['The bike', 'Smiles'] },
        { passage: 'The fish swims in water. It is wet.', question: 'What is it?', correct: 'The fish', wrong: ['Water', 'Wet'] },
        { passage: 'The baby drinks milk. She looks happy.', question: 'Who is she?', correct: 'The baby', wrong: ['Milk', 'Happy'] },
        { passage: 'The teacher reads. She points to the words.', question: 'Who is she?', correct: 'The teacher', wrong: ['The words', 'Points'] },
        { passage: 'My friends come here. They sit down.', question: 'Who are they?', correct: 'My friends', wrong: ['Here', 'Down'] },
        { passage: 'Max has a kite. He flies it.', question: 'Who is he?', correct: 'Max', wrong: ['The kite', 'It'] },
        { passage: 'The cats are hungry. They eat.', question: 'Who are they?', correct: 'The cats', wrong: ['Hungry', 'Eat'] },
        { passage: 'Mom makes soup. She stirs it.', question: 'What is it?', correct: 'The soup', wrong: ['Mom', 'Stirs'] },
        { passage: 'A bird has a nest. It sits there.', question: 'What is it?', correct: 'The bird', wrong: ['The nest', 'There'] },
        { passage: 'Ben and Mia read. They look at the words.', question: 'Who are they?', correct: 'Ben and Mia', wrong: ['The words', 'Look'] }
      ],
      problemSolution: [
        { passage: 'Mia is thirsty. Mia gets a drink.', problem: 'Mia is thirsty', solution: 'Mia gets a drink', wrongProblem: ['Mia is sleepy', 'Mia is hungry'], wrongSolution: ['Mia drops the cup', 'Mia goes to bed'] },
        { passage: 'Ben is cold. Ben puts on a coat.', problem: 'Ben is cold', solution: 'Ben puts on a coat', wrongProblem: ['Ben is hot', 'Ben is hungry'], wrongSolution: ['Ben puts on a hat', 'Ben takes off his coat'] },
        { passage: 'The room is messy. We clean up.', problem: 'The room is messy', solution: 'We clean up', wrongProblem: ['The room is quiet', 'The room is bright'], wrongSolution: ['We make a mess', 'We run away'] },
        { passage: 'The soup is hot. I wait before I eat.', problem: 'The soup is hot', solution: 'I wait before I eat', wrongProblem: ['The soup is cold', 'The soup is loud'], wrongSolution: ['I eat very fast', 'I blow on the soup'] },
        { passage: 'Sara cannot find her pencil. Sara looks under the desk.', problem: 'Sara cannot find her pencil', solution: 'Sara looks under the desk', wrongProblem: ['Sara is sleepy', 'Sara is hungry'], wrongSolution: ['Sara looks in her bag', 'Sara looks in a drawer'] },
        { passage: 'The dog is thirsty. The dog drinks water.', problem: 'The dog is thirsty', solution: 'The dog drinks water', wrongProblem: ['The dog is hungry', 'The dog is tired'], wrongSolution: ['The dog eats food', 'The dog takes a nap'] },
        { passage: 'The rain starts. We use an umbrella.', problem: 'The rain starts', solution: 'We use an umbrella', wrongProblem: ['The wind blows', 'The sky is cloudy'], wrongSolution: ['We wear a coat', 'We run in the rain'] },
        { passage: 'Tom spills milk. Tom wipes it up.', problem: 'Tom spills milk', solution: 'Tom wipes it up', wrongProblem: ['Tom drops a cup', 'Tom is thirsty'], wrongSolution: ['Tom leaves it there', 'Tom goes to bed'] },
        { passage: 'The toy breaks. Dad fixes it.', problem: 'The toy breaks', solution: 'Dad fixes it', wrongProblem: ['The toy is dirty', 'The toy is lost'], wrongSolution: ['Dad breaks it more', 'Dad hides the toy'] },
        { passage: 'The door is locked. We find a key.', problem: 'The door is locked', solution: 'We find a key', wrongProblem: ['The door is stuck', 'The door is heavy'], wrongSolution: ['We throw the key away', 'We paint the lock'] },
        { passage: 'I am hungry. I eat a sandwich.', problem: 'I am hungry', solution: 'I eat a sandwich', wrongProblem: ['I am thirsty', 'I am sleepy'], wrongSolution: ['I drink water', 'I go to bed'] },
        { passage: 'The floor is wet. We walk slowly.', problem: 'The floor is wet', solution: 'We walk slowly', wrongProblem: ['The floor is slippery', 'The floor is messy'], wrongSolution: ['We run fast', 'We jump on the floor'] }
      ],

      spelling: {
        cvc: [
          { word: 'cat', wrong: ['cet', 'cta'] },
          { word: 'dog', wrong: ['dug', 'god'] },
          { word: 'sun', wrong: ['son', 'snu'] },
          { word: 'bed', wrong: ['bde', 'bad'] },
          { word: 'map', wrong: ['mop', 'mpa'] },
          { word: 'pig', wrong: ['peg', 'pg i'.replace(' ', '')] },
          { word: 'hat', wrong: ['hot', 'hta'] },
          { word: 'cup', wrong: ['cap', 'cpu'] },
          { word: 'log', wrong: ['lag', 'lgo'] },
          { word: 'fin', wrong: ['fan', 'fni'] },
          { word: 'pen', wrong: ['pan', 'pne'] },
          { word: 'sit', wrong: ['set', 'sti'] },
          { word: 'rug', wrong: ['rag', 'rgu'] },
          { word: 'top', wrong: ['tap', 'tpo'] }
        ],
        digraph: [
          { word: 'ship', wrong: ['sip', 'shp'] },
          { word: 'shop', wrong: ['sop', 'shpo'] },
          { word: 'fish', wrong: ['fis', 'fihs'] },
          { word: 'dish', wrong: ['dis', 'dihs'] },
          { word: 'wish', wrong: ['wis', 'wihs'] },
          { word: 'chip', wrong: ['cip', 'chp'] },
          { word: 'chop', wrong: ['cop', 'chpo'] },
          { word: 'chin', wrong: ['cin', 'chni'] },
          { word: 'this', wrong: ['tis', 'thsi'] },
          { word: 'that', wrong: ['tat', 'thta'] },
          { word: 'thin', wrong: ['tin', 'thni'] },
          { word: 'with', wrong: ['wit', 'wthi'] }
        ],
        sight: [
          { word: 'there', wrong: ['thare', 'ther'] },
          { word: 'want', wrong: ['went', 'wnat'] },
          { word: 'like', wrong: ['liek', 'lik'] },
          { word: 'come', wrong: ['com', 'cme'] },
          { word: 'said', wrong: ['sed', 'siad'] },
          { word: 'have', wrong: ['hve', 'haev'] },
          { word: 'they', wrong: ['thay', 'tehy'] },
          { word: 'were', wrong: ['wer', 'we re'.replace(' ', '')] },
          { word: 'from', wrong: ['form', 'frmo'] },
          { word: 'who', wrong: ['hoo', 'woh'] },
          { word: 'could', wrong: ['coud', 'colud'] },
          { word: 'once', wrong: ['onc', 'ocne'] },
          { word: 'because', wrong: ['becaus', 'becuase'] },
          { word: 'does', wrong: ['doas', 'dose'] },
          { word: 'where', wrong: ['wher', 'whare'] },
          { word: 'again', wrong: ['agin', 'agian'] }
        ]
      }
    };

	    function generateSkillPages(skillId, count = 10) {
	      const pages = [];
	      const bank = skillWordBanks;
      const usedPoolItems = new Set();

      function pickPoolItem(poolKey, items) {
        if (!Array.isArray(items) || items.length === 0) return null;
        const start = Math.floor(Math.random() * items.length);
        for (let offset = 0; offset < items.length; offset++) {
          const idx = (start + offset) % items.length;
          const key = `${poolKey}:${idx}`;
          if (!usedPoolItems.has(key)) {
            usedPoolItems.add(key);
            return items[idx];
          }
        }
        return pickOne(items);
      }

      function pickUniqueValue(valueKey, candidates) {
        if (!Array.isArray(candidates) || candidates.length === 0) return null;
        const pool = shuffleInPlace([...candidates]);
        for (const value of pool) {
          const token = `${valueKey}:${String(value).toLowerCase()}`;
          if (!usedPoolItems.has(token)) {
            usedPoolItems.add(token);
            return value;
          }
        }
        return pickOne(candidates);
      }

      function pickWordStartingWith(letter) {
        const candidates = bank.cvc.filter(w => (w[0] || '').toLowerCase() === letter.toLowerCase());
        return candidates.length ? pickOne(candidates) : null;
      }

	      function pickWordEndingWith(letter) {
	        const candidates = bank.cvc.filter(w => w.endsWith(letter.toLowerCase()));
	        return candidates.length ? pickOne(candidates) : null;
	      }

	      function flattenValues(obj) {
	        if (!obj) return [];
	        return Object.keys(obj).reduce((acc, key) => acc.concat(obj[key] || []), []);
	      }

	      function pickWrongWords(pool, count, excludeSet) {
	        const candidates = (pool || []).filter(w => !excludeSet.has(w));
	        return pickDistinct(candidates.length ? candidates : bank.cvc, count, excludeSet);
	      }

	      for (let i = 0; i < count; i++) {
	        if (skillId.startsWith('vowel-team-')) {
	          const team = skillId.replace('vowel-team-', '');
	          const teamWords = (bank.vowelTeams && bank.vowelTeams[team]) ? bank.vowelTeams[team] : [];
	          const correct = pickUniqueValue(`vowel-team-${team}`, teamWords) || (teamWords.length ? pickOne(teamWords) : 'see');
	          const wrongPool = flattenValues(bank.vowelTeams).concat(bank.cvc);
	          const wrong = pickWrongWords(wrongPool.filter(w => !w.includes(team)), 2, new Set([correct]));
	          const answers = shuffleInPlace([correct, ...wrong]);
	          const stems = [
	            { q: `Which word has ${team.toUpperCase()}?`, h: `Look for the letters ${team}.` },
	            { q: `Find the word with ${team.toUpperCase()}.`, h: `Scan for ${team}.` },
	            { q: `Which word contains ${team.toUpperCase()}?`, h: `The vowel team is ${team}.` }
	          ];
	          const stem = pickOne(stems);
	          pages.push(makeMCQ({
	            passage: `Vowel team: ${team.toUpperCase()}`,
	            question: stem.q,
	            hint: stem.h,
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Nice! You found the vowel team.'
	          }));
	        } else if (skillId.startsWith('r-controlled-')) {
	          const pattern = skillId.replace('r-controlled-', '');
	          const patternWords = (bank.rControlled && bank.rControlled[pattern]) ? bank.rControlled[pattern] : [];
	          const correct = pickUniqueValue(`r-controlled-${pattern}`, patternWords) || (patternWords.length ? pickOne(patternWords) : 'car');
	          const wrongPool = flattenValues(bank.rControlled).concat(bank.cvc, bank.ccvc, bank.cvcc);
	          const wrong = pickWrongWords(wrongPool.filter(w => !w.includes(pattern)), 2, new Set([correct]));
	          const answers = shuffleInPlace([correct, ...wrong]);
	          const stems = [
	            { q: `Which word has ${pattern.toUpperCase()}?`, h: `Look for the letters ${pattern}.` },
	            { q: `Find the word with ${pattern.toUpperCase()}.`, h: `Scan for ${pattern}.` },
	            { q: `Which word contains ${pattern.toUpperCase()}?`, h: `R-controlled means the vowel + R.` }
	          ];
	          const stem = pickOne(stems);
	          pages.push(makeMCQ({
	            passage: `R-controlled: ${pattern.toUpperCase()}`,
	            question: stem.q,
	            hint: stem.h,
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Great! You found the r-controlled vowel.'
	          }));
	        } else if (skillId.startsWith('diphthong-')) {
	          const pattern = skillId.replace('diphthong-', '');
	          const patternWords = (bank.diphthongs && bank.diphthongs[pattern]) ? bank.diphthongs[pattern] : [];
	          const correct = pickUniqueValue(`diphthong-${pattern}`, patternWords) || (patternWords.length ? pickOne(patternWords) : 'coin');
	          const wrongPool = flattenValues(bank.diphthongs).concat(bank.cvc, bank.ccvc, bank.cvcc);
	          const wrong = pickWrongWords(wrongPool.filter(w => !w.includes(pattern)), 2, new Set([correct]));
	          const answers = shuffleInPlace([correct, ...wrong]);
	          const stems = [
	            { q: `Which word has ${pattern.toUpperCase()}?`, h: `Look for the letters ${pattern}.` },
	            { q: `Find the word with ${pattern.toUpperCase()}.`, h: `Scan for ${pattern}.` },
	            { q: `Which word contains ${pattern.toUpperCase()}?`, h: `Look for the vowel pattern.` }
	          ];
	          const stem = pickOne(stems);
	          pages.push(makeMCQ({
	            passage: `Vowel pattern: ${pattern.toUpperCase()}`,
	            question: stem.q,
	            hint: stem.h,
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Nice! You found the vowel pattern.'
	          }));
	        } else if (skillId === 'compound-words') {
	          const item = pickPoolItem('compoundWords', bank.compoundWords || []);
	          const correct = item ? item.word : 'sunset';
	          const wrong = pickWrongWords((bank.twoSyllables || []).map(x => x.word).concat(bank.cvc), 2, new Set([correct]));
	          const answers = shuffleInPlace([correct, ...wrong]);
	          pages.push(makeMCQ({
	            passage: `Put the words together: ${item ? item.a : 'sun'} + ${item ? item.b : 'set'}`,
	            question: 'Which compound word do you make?',
	            hint: 'A compound word is two words joined together.',
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Yes! You made a compound word.'
	          }));
	        } else if (skillId === 'two-syllable-build') {
	          const item = pickPoolItem('twoSyllableBuild', bank.twoSyllableBuild || []);
	          const correct = item ? item.word : 'baby';
	          const wrong = pickWrongWords((bank.twoSyllableBuild || []).map(x => x.word).concat((bank.twoSyllables || []).map(x => x.word)), 2, new Set([correct]));
	          const answers = shuffleInPlace([correct, ...wrong]);
	          pages.push(makeMCQ({
	            passage: `Put the syllables together: ${item ? item.a : 'ba'} + ${item ? item.b : 'by'}`,
	            question: 'Which word do you make?',
	            hint: 'Blend the two parts.',
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Nice syllable blending!'
	          }));
        } else if (skillId === 'syllables-which') {
	          const target = pickUniqueValue('syllables-which-target', ['2', '3']) || pickOne(['2', '3']);
	          const correctPool = target === '2' ? (bank.twoSyllables || []).map(x => x.word) : (bank.threeSyllables || []).map(x => x.word);
	          const correct = pickUniqueValue(`syllables-which-${target}`, correctPool) || pickOne(correctPool);
	          const wrongPool = (target === '2'
	            ? (bank.threeSyllables || []).map(x => x.word)
	            : (bank.twoSyllables || []).map(x => x.word)).concat(bank.cvc);
	          const wrong = pickWrongWords(wrongPool, 2, new Set([correct]));
	          const answers = shuffleInPlace([correct, ...wrong]);
	          const stems = [
	            { q: `Which word has ${target} syllables?`, h: 'Clap the parts you hear.' },
	            { q: `Which word has ${target} beats?`, h: 'Say the word slowly.' },
	            { q: `Pick the ${target}-syllable word.`, h: 'Each part you clap is a syllable.' }
	          ];
	          const stem = pickOne(stems);
	          pages.push(makeMCQ({
	            question: stem.q,
	            hint: stem.h,
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Great syllable listening!'
	          }));
	        } else if (skillId === 'rhyming-complete') {
	          const family = pickPoolItem('rhyming-complete', bank.rhymes) || pickOne(bank.rhymes);
	          const base = pickOne(family);
	          const correct = pickDistinct(family, 1, new Set([base]))[0];
	          const wrong = pickWrongWords(bank.cvc, 2, new Set([base, correct]));
	          const answers = shuffleInPlace([correct, ...wrong]);
	          pages.push(makeMCQ({
	            passage: `I see a ${base}. It wears a _____.`,
	            question: 'Which word completes the rhyme?',
	            hint: 'Pick a word that rhymes with the first word.',
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Yes! That makes a rhyme.'
	          }));
	        } else if (skillId === 'blend-sounds') {
	          const word = pickUniqueValue('blend-sounds', bank.cvc) || pickOne(bank.cvc);
	          const sounds = word.split('').join(' - ');
	          const correct = word;
	          const wrong = pickWrongWords(bank.cvc, 2, new Set([correct]));
	          const answers = shuffleInPlace([correct, ...wrong]);
	          const stems = [
	            { q: 'Which word do the sounds make?', h: 'Say the sounds fast and smooth.' },
	            { q: 'Blend the sounds. What word do you read?', h: 'Say it slowly, then faster.' },
	            { q: 'What word is this?', h: 'Put the sounds together.' }
	          ];
	          const stem = pickOne(stems);
	          pages.push(makeMCQ({
	            passage: `Blend: ${sounds}`,
	            question: stem.q,
	            hint: stem.h,
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Nice blending!'
	          }));
	        } else if (skillId === 'first-sound') {
	          const word = pickUniqueValue('first-sound', bank.cvc) || pickOne(bank.cvc);
	          const correct = word[0].toLowerCase();
	          const wrong = pickDistinct(bank.consonants.filter(c => c !== correct), 2);
	          const answers = shuffleInPlace([correct.toUpperCase(), ...wrong.map(x => x.toUpperCase())]);
	          const stems = [
	            { q: 'What is the first letter?', h: 'Look at the start of the word.' },
	            { q: 'Which letter does the word start with?', h: 'Find the first letter.' },
	            { q: 'What letter comes first?', h: 'Point to the first letter.' }
	          ];
	          const stem = pickOne(stems);
	          pages.push(makeMCQ({
	            passage: `Word: ${word}`,
	            question: stem.q,
	            hint: stem.h,
	            answers,
	            correctAnswerName: correct.toUpperCase(),
	            successMessage: 'Yes! That is the first letter.'
	          }));
	        } else if (skillId === 'last-sound') {
	          const word = pickUniqueValue('last-sound', bank.cvc) || pickOne(bank.cvc);
	          const correct = word[word.length - 1].toLowerCase();
	          const wrong = pickDistinct(bank.consonants.filter(c => c !== correct), 2);
	          const answers = shuffleInPlace([correct.toUpperCase(), ...wrong.map(x => x.toUpperCase())]);
	          const stems = [
	            { q: 'What is the last letter?', h: 'Look at the end of the word.' },
	            { q: 'Which letter does the word end with?', h: 'Find the last letter.' },
	            { q: 'What letter comes last?', h: 'Point to the last letter.' }
	          ];
	          const stem = pickOne(stems);
	          pages.push(makeMCQ({
	            passage: `Word: ${word}`,
	            question: stem.q,
	            hint: stem.h,
	            answers,
	            correctAnswerName: correct.toUpperCase(),
	            successMessage: 'Nice! That is the last letter.'
	          }));
	        } else if (skillId === 'long-vowel-silent-e') {
	          const pair = pickPoolItem('long-vowel-silent-e', bank.silentE) || pickOne(bank.silentE);
	          const correct = pair.long;
	          const wrong = pickWrongWords([pair.short, ...bank.cvc], 2, new Set([correct]));
	          const answers = shuffleInPlace([correct, ...wrong]);
	          pages.push(makeMCQ({
	            passage: `Short word: ${pair.short}`,
	            question: 'Which word has a long vowel sound?',
	            hint: 'Silent e often makes the vowel say its name.',
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Yes! That word has a long vowel sound.'
	          }));
        } else if (skillId === 'sentence-type') {
	          const item = pickPoolItem('sentenceTypes', bank.sentenceTypes || []);
	          const correct = item ? item.type : 'Statement';
	          const types = ['Statement', 'Question', 'Command', 'Exclamation'];
	          const wrong = pickDistinct(types.filter(t => t !== correct), 2);
	          const answers = shuffleInPlace([correct, ...wrong]);
	          pages.push(makeMCQ({
	            passage: item ? item.sentence : 'I like pizza.',
	            question: 'What kind of sentence is this?',
	            hint: 'Look at the end mark and the meaning.',
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Nice sentence type!'
	          }));
        } else if (skillId === 'wh-words') {
	          const item = pickPoolItem('whSentences', bank.whSentences || []);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: item.sentence.replace('____', '_____'),
	            question: 'Which word completes the question?',
	            hint: 'Who = a person. What = a thing. Where = a place. When = a time. Why = a reason.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Great question word!'
	          }));
	        } else if (skillId === 'contractions') {
	          const item = pickPoolItem('contractions', bank.contractions || []);
	          const answers = shuffleInPlace([item.contraction, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: `Words: ${item.phrase}`,
	            question: 'Choose the contraction.',
	            hint: 'A contraction is two words made shorter.',
	            answers,
	            correctAnswerName: item.contraction,
	            successMessage: 'Nice contraction!'
	          }));
	        } else if (skillId === 'plurals') {
	          const item = pickPoolItem('plurals', bank.plurals || []);
	          const answers = shuffleInPlace([item.plural, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: `One ${item.singular}. Two _____.`,
	            question: 'Choose the correct plural.',
	            hint: 'Plural means more than one.',
	            answers,
	            correctAnswerName: item.plural,
	            successMessage: 'Great plural!'
	          }));
	        } else if (skillId === 'irregular-plurals') {
	          const item = pickPoolItem('irregular-plurals', bank.irregularPlurals || []);
	          const answers = shuffleInPlace([item.plural, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: `One ${item.singular}. Two _____.`,
	            question: 'Choose the correct irregular plural.',
	            hint: 'Some plurals change the word in a special way.',
	            answers,
	            correctAnswerName: item.plural,
	            successMessage: 'Great irregular plural!'
	          }));
	        } else if (skillId === 'possessive-nouns') {
	          const item = pickPoolItem('possessive-nouns', bank.possessiveNouns || []);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: `This is the ____ ${item.thing}.`,
	            question: `Which word shows that the ${item.thing} belongs to the ${item.owner}?`,
	            hint: 'A singular possessive often adds apostrophe + s.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Nice! That shows ownership.'
	          }));
	        } else if (skillId === 'conjunctions') {
	          const item = pickPoolItem('conjunctions', bank.conjunctions || []);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: item.sentence.replace('____', '_____'),
	            question: 'Which word connects the ideas?',
	            hint: 'Try reading the whole sentence.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Nice linking word!'
	          }));
	        } else if (skillId === 'time-order') {
	          const item = pickPoolItem('timeOrder', bank.timeOrder || []);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: item.sentence.replace('____', '_____'),
	            question: 'Which time word fits best?',
	            hint: 'Time words help us tell the order.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Great time-order word!'
	          }));
	        } else if (skillId === 'context-clues') {
	          const item = pickPoolItem('contextClues', bank.contextClues || []);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: item.passage,
	            question: 'What does the new word mean?',
	            hint: 'Use the clues in the sentence.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Yes! You used context clues.'
	          }));
	        } else if (skillId === 'multiple-meaning') {
	          const item = pickPoolItem('multipleMeaning', bank.multipleMeaning || []);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: item.context,
	            question: 'What does the word mean here?',
	            hint: 'Use the sentence to help you.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Nice! You used the context.'
	          }));
	        } else if (skillId === 'shades-of-meaning') {
	          const item = pickPoolItem('shadesOfMeaning', bank.shadesOfMeaning || []);
	          const answers = shuffleInPlace([...item.answers]);
	          pages.push(makeMCQ({
	            question: item.question,
	            hint: 'Some words are stronger than others.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Great word choice!'
	          }));
	        } else if (skillId === 'shades-order') {
	          const item = pickPoolItem('shadesOrder', bank.shadesOrder || []);
	          const words = Array.isArray(item.words) ? item.words : [];
	          const correctOrder = Array.isArray(item.correct) ? item.correct : words;
	          const correct = correctOrder.join(', ');

	          // Build two wrong orderings (different permutations).
	          const perms = [];
	          const base = [...words];
	          for (let i = 0; i < 6 && perms.length < 6; i++) {
	            const attempt = shuffleInPlace([...base]).join(', ');
	            if (!perms.includes(attempt)) perms.push(attempt);
	          }
	          const wrong = perms.filter(p => p !== correct);
	          const wrong1 = wrong[0] || shuffleInPlace([...base]).reverse().join(', ');
	          const wrong2 = wrong[1] || shuffleInPlace([...base]).join(', ');
	          const answers = shuffleInPlace([correct, wrong1, wrong2]);

	          pages.push(makeMCQ({
	            passage: `Words: ${words.join(', ')}`,
	            question: item.prompt || 'Put the words in order.',
	            hint: 'Think about which word is weaker and which word is stronger.',
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Nice ordering!'
	          }));
	        } else if (skillId === 'text-features') {
	          const item = pickPoolItem('textFeatures', bank.textFeatures || []);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            question: item.question,
	            hint: 'Text features help us read and learn.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Nice text-feature knowledge!'
	          }));
	        } else if (skillId === 'setting') {
	          const items = [
	            { passage: 'Ana is at the park. She swings and slides.', correct: 'At the park', wrong: ['At the beach', 'At the store'] },
	            { passage: 'Max sits at his desk. He writes with a pencil.', correct: 'At school', wrong: ['At the zoo', 'On a boat'] },
	            { passage: 'Ben is in the kitchen. Ben stirs soup.', correct: 'In the kitchen', wrong: ['At the park', 'In the car'] },
	            { passage: 'Mia is at the beach. Mia builds a sand castle.', correct: 'At the beach', wrong: ['At school', 'In the snow'] },
	            { passage: 'A cat sits on a bed. The room is quiet.', correct: 'In a bedroom', wrong: ['At a zoo', 'In a pool'] },
	            { passage: 'A bus stops at a sign. Kids get on.', correct: 'At a bus stop', wrong: ['In a bathtub', 'In a forest'] },
	            { passage: 'We stand in line. The teacher opens the door.', correct: 'At school', wrong: ['At the store', 'On a farm'] },
	            { passage: 'Dad grills food in the yard. The sun is out.', correct: 'In the yard', wrong: ['In a classroom', 'On a boat'] },
	            { passage: 'The fish swims by plants and rocks.', correct: 'In water', wrong: ['In the sky', 'On a bed'] },
	            { passage: 'Snow falls. Kids wear coats and hats.', correct: 'Outside in the snow', wrong: ['At the beach', 'In the desert'] }
	          ];
	          const item = pickPoolItem('setting', items);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: item.passage,
	            question: 'Where does the story happen?',
	            hint: 'The setting is where it happens.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Yes! You found the setting.'
	          }));
	        } else if (skillId === 'character') {
	          const items = [
	            { passage: 'Ben has a kite. Ben runs to make it fly.', correct: 'Ben', wrong: ['The kite', 'The sun'] },
	            { passage: 'Mia feeds her cat. The cat purrs.', correct: 'Mia', wrong: ['A bike', 'A book'] },
	            { passage: 'Tom kicks the ball. Tom smiles.', correct: 'Tom', wrong: ['The ball', 'The grass'] },
	            { passage: 'Sara paints a picture. Sara uses blue.', correct: 'Sara', wrong: ['The paint', 'The paper'] },
	            { passage: 'Dad cooks rice. Dad stirs the pot.', correct: 'Dad', wrong: ['The rice', 'The pot'] },
	            { passage: 'A dog barks. The dog runs to the door.', correct: 'The dog', wrong: ['The door', 'The yard'] },
	            { passage: 'The bird builds a nest. The bird finds sticks.', correct: 'The bird', wrong: ['The nest', 'The sticks'] },
	            { passage: 'Lia reads a book. Lia turns each page.', correct: 'Lia', wrong: ['The page', 'The chair'] },
	            { passage: 'Mom washes dishes. Mom dries them.', correct: 'Mom', wrong: ['The dishes', 'The sink'] },
	            { passage: 'A frog jumps. The frog lands in a pond.', correct: 'The frog', wrong: ['The pond', 'A rock'] },
	            { passage: 'A teacher reads a story. The class listens.', correct: 'A teacher', wrong: ['The class', 'A book'] },
	            { passage: 'The baby drinks milk. The baby smiles.', correct: 'The baby', wrong: ['Milk', 'A cup'] }
	          ];
	          const item = pickPoolItem('character', items);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: item.passage,
	            question: 'Who is the main character?',
	            hint: 'The main character is who the story is mostly about.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Nice! You found the character.'
	          }));
	        } else if (skillId === 'cause-effect') {
	          const items = [
	            { passage: 'It is raining. Kai gets an umbrella.', question: 'Why does Kai get an umbrella?', correct: 'Because it is raining', wrong: ['Because it is hot', 'Because it is bedtime'] },
	            { passage: 'Lia is hungry. Lia eats an apple.', question: 'Why does Lia eat an apple?', correct: 'Because she is hungry', wrong: ['Because she is sleepy', 'Because she is cold'] },
	            { passage: 'It is cold. Ben puts on a coat.', question: 'Why does Ben put on a coat?', correct: 'Because it is cold', wrong: ['Because it is hot', 'Because it is lunch'] },
	            { passage: 'The floor is wet. Mia walks slowly.', question: 'Why does Mia walk slowly?', correct: 'Because the floor is wet', wrong: ['Because she is flying', 'Because she is a fish'] },
	            { passage: 'Sam drops his pencil. Sam picks it up.', question: 'Why does Sam pick up the pencil?', correct: 'Because he dropped it', wrong: ['Because it is raining', 'Because it is bedtime'] },
	            { passage: 'The dog is thirsty. The dog drinks water.', question: 'Why does the dog drink water?', correct: 'Because the dog is thirsty', wrong: ['Because the dog is asleep', 'Because the dog is a car'] },
	            { passage: 'The light is off. Dad flips the switch.', question: 'Why does Dad flip the switch?', correct: 'Because the light is off', wrong: ['Because it is a sandwich', 'Because it is snowing'] },
	            { passage: 'The soup is hot. I wait before I eat.', question: 'Why do I wait?', correct: 'Because the soup is hot', wrong: ['Because the soup is cold', 'Because it is night'] },
	            { passage: 'The bus comes. We get on.', question: 'Why do we get on the bus?', correct: 'Because the bus comes', wrong: ['Because the bus is a fish', 'Because we are sleeping'] },
	            { passage: 'I lose my hat. I look for it.', question: 'Why do I look for my hat?', correct: 'Because I lost it', wrong: ['Because it is raining', 'Because hats are pets'] },
	            { passage: 'The dog barks. Mom opens the door.', question: 'Why does Mom open the door?', correct: 'Because the dog barks', wrong: ['Because the door is hungry', 'Because Mom is a bird'] },
	            { passage: 'The room is messy. We clean up.', question: 'Why do we clean up?', correct: 'Because the room is messy', wrong: ['Because the room is sleeping', 'Because it is a fish'] }
	          ];
	          const item = pickPoolItem('cause-effect', items);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: item.passage,
	            question: item.question,
	            hint: 'Cause is why. Effect is what happened.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Great cause and effect!'
	          }));
	        } else if (skillId === 'prediction-next') {
	          const items = [
	            { passage: 'Sam puts bread in the toaster.', correct: 'The bread will toast', wrong: ['The bread will swim', 'The bread will fly'] },
	            { passage: 'Mia opens a book and looks at the words.', correct: 'Mia will read', wrong: ['Mia will drive a car', 'Mia will melt'] },
	            { passage: 'The sky gets dark. Rain starts to fall.', correct: 'It will rain more', wrong: ['It will snow inside', 'The sun will go in a cup'] },
	            { passage: 'A boy ties his shoes. He walks to the door.', correct: 'He will go outside', wrong: ['He will turn into a fish', 'He will fly to the moon'] },
	            { passage: 'Mom cracks eggs into a bowl. Mom stirs.', correct: 'Mom will cook', wrong: ['The eggs will read', 'The bowl will run'] },
	            { passage: 'The bus stops. The door opens.', correct: 'People will get on or off', wrong: ['The bus will swim', 'The bus will eat'] },
	            { passage: 'A dog runs to its bowl. The dog wags its tail.', correct: 'The dog will eat', wrong: ['The dog will paint', 'The dog will drive'] },
	            { passage: 'A child yawns. The child gets into bed.', correct: 'The child will sleep', wrong: ['The child will build a nest', 'The child will melt'] },
	            { passage: 'We put on boots. We walk outside. Rain falls.', correct: 'We will stay dry', wrong: ['We will turn into rain', 'Boots will fly'] },
	            { passage: 'Dad pours milk. Dad adds cereal.', correct: 'Dad will eat breakfast', wrong: ['Dad will paint the milk', 'Dad will swim in cereal'] },
	            { passage: 'A girl picks up a book. She sits down.', correct: 'She will read', wrong: ['She will melt', 'The book will run'] },
	            { passage: 'The bell rings. Kids stand up.', correct: 'Kids will line up', wrong: ['Kids will turn into cats', 'The bell will sleep'] },
	            { passage: 'I feel cold. I get a blanket.', correct: 'I will feel warmer', wrong: ['The blanket will bark', 'I will turn into a cloud'] }
	          ];
	          const item = pickPoolItem('prediction-next', items);
	          const answers = shuffleInPlace([item.correct, ...item.wrong]);
	          pages.push(makeMCQ({
	            passage: item.passage,
	            question: 'What will happen next?',
	            hint: 'Use what you know to make a smart guess.',
	            answers,
	            correctAnswerName: item.correct,
	            successMessage: 'Nice prediction!'
	          }));
	        } else if (skillId === 'vowels-letter') {
	          const correct = pickOne(bank.vowels);
	          const wrong = pickDistinct(bank.consonants, 2);
	          const answers = shuffleInPlace([correct, ...wrong]);
	          pages.push(makeMCQ({
            question: 'Which letter is a vowel?',
            hint: 'Vowels are a, e, i, o, u.',
            answers,
            correctAnswerName: correct,
            successMessage: 'Yes! That is a vowel.'
          }));
        } else if (skillId === 'consonant-or-vowel') {
          const consonantPool = bank.consonants.filter(c => c !== 'y');
          const letter = Math.random() < 0.5 ? pickOne(bank.vowels) : pickOne(consonantPool);
          const correctAnswerName = bank.vowels.includes(letter) ? 'Vowel' : 'Consonant';
          pages.push(makeMCQ({
            passage: `Letter: ${letter.toUpperCase()}`,
            question: 'What kind of letter is this?',
            hint: 'Vowels are a, e, i, o, u. Every other letter is a consonant.',
            answers: shuffleInPlace(['Vowel', 'Consonant', 'Neither']),
            correctAnswerName,
            successMessage: 'Nice!'
          }));
        } else if (skillId === 'vowels-word') {
          const word = pickUniqueValue('vowels-word', bank.cvc) || pickOne(bank.cvc);
          const vowelsIn = Array.from(new Set(word.split('').filter(ch => bank.vowels.includes(ch))));
          const correct = vowelsIn.length ? pickOne(vowelsIn) : 'a';
          const wrong = pickDistinct(bank.vowels, 2, new Set([correct]));
          const answers = shuffleInPlace([correct, ...wrong]);
          const stems = [
            { q: 'Which vowel is in the word?', h: 'Look at the letters in the word.' },
            { q: 'Which vowel do you see?', h: 'Vowels are a, e, i, o, u.' },
            { q: 'What vowel is inside the word?', h: 'Find the vowel letter.' }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            passage: `Word: ${word}`,
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: correct,
            successMessage: 'Nice! You found the vowel.'
          }));
        } else if (skillId === 'syllables-count') {
          const choicePool = pickPoolItem('syllables-count', [...bank.twoSyllables, ...bank.threeSyllables]) || shuffleInPlace([...bank.twoSyllables, ...bank.threeSyllables]).slice(0, 1)[0];
          const correct = String(choicePool.syllables);
          const answers = shuffleInPlace(['1', '2', '3'].filter(x => x !== correct).slice(0, 2).concat([correct]));
          const stems = [
            { q: 'How many syllables does the word have?', h: 'Clap the parts you hear.' },
            { q: 'How many beats are in the word?', h: 'Say it slowly and clap.' },
            { q: 'How many parts do you hear?', h: 'Each part is a syllable.' }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            passage: `Word: ${choicePool.word}`,
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: correct,
            successMessage: 'Great counting!'
          }));
        } else if (skillId === 'rhyming-choose') {
          const family = pickPoolItem('rhymes', bank.rhymes);
          const base = pickOne(family);
          const rhymes = pickDistinct(family, 1, new Set([base]));
          const correct = rhymes[0];
          const wrong = pickDistinct(bank.cvc, 2, new Set([base, correct]));
          const answers = shuffleInPlace([correct, ...wrong]);
          const stems = [
            { q: `Which word rhymes with ${base}?`, h: 'Rhyming words have the same ending sound.' },
            { q: `Find a word that rhymes with ${base}.`, h: 'Listen for the same ending sound.' },
            { q: `Which word sounds like ${base} at the end?`, h: 'Same ending sound = rhyme.' }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            passage: `Word: ${base}`,
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: correct,
            successMessage: 'Yes! Those words rhyme.'
          }));
        } else if (skillId === 'rhyming-odd') {
          const richerFamilies = (bank.rhymes || []).filter(f => Array.isArray(f) && f.length >= 3);
          const family = pickPoolItem('rhymes-odd', richerFamilies) || pickPoolItem('rhymes', bank.rhymes) || pickOne(bank.rhymes);
          const base = pickOne(family);
          const rhymers = pickDistinct(family, 2, new Set([base]));
          const odd = pickDistinct(bank.cvc.filter(w => !family.includes(w)), 1, new Set([base, ...rhymers]))[0] ||
                      pickDistinct(bank.cvc, 1, new Set([base, ...rhymers]))[0];
          const answers = shuffleInPlace([...rhymers, odd]);
          const stems = [
            { q: `Which word does NOT rhyme with ${base}?`, h: 'Two words rhyme with the base word.' },
            { q: `Find the word that does not rhyme.`, h: `Two words rhyme with ${base}.` },
            { q: `Which word has a different ending sound?`, h: `The base word is ${base}.` }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            passage: `Word: ${base}`,
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: odd,
            successMessage: 'Yes! That one does not rhyme.'
          }));
        } else if (skillId === 'start-letter') {
          const letter = pickUniqueValue('start-letter-letter', bank.consonants) || pickOne(bank.consonants);
          const candidates = bank.cvc.filter(w => (w[0] || '').toLowerCase() === letter.toLowerCase());
          let correct = pickUniqueValue(`start-letter-word-${letter}`, candidates);
          if (!correct) correct = candidates.length ? pickOne(candidates) : pickOne(bank.cvc);
          const wrong = pickDistinct(bank.cvc.filter(w => (w[0] || '').toLowerCase() !== letter), 2, new Set([correct]));
          const answers = shuffleInPlace([correct, ...wrong]);
          const stems = [
            { q: `Which word starts with ${letter.toUpperCase()}?`, h: 'Look at the first letter.' },
            { q: `Pick the word that begins with ${letter.toUpperCase()}.`, h: 'Begins means starts.' },
            { q: `Find a word that starts with ${letter.toUpperCase()}.`, h: 'Check the first letter in each word.' }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: correct,
            successMessage: 'Great! You found the starting letter.'
          }));
        } else if (skillId === 'end-letter') {
          const letterPool = ['t', 'g', 'p', 'n', 'm', 'd', 'b', 'r', 's'];
          const letter = pickUniqueValue('end-letter-letter', letterPool) || pickOne(letterPool);
          const candidates = bank.cvc.filter(w => w.endsWith(letter.toLowerCase()));
          let correct = pickUniqueValue(`end-letter-word-${letter}`, candidates);
          if (!correct) correct = candidates.length ? pickOne(candidates) : pickOne(bank.cvc);
          const wrong = pickDistinct(bank.cvc.filter(w => !w.endsWith(letter)), 2, new Set([correct]));
          const answers = shuffleInPlace([correct, ...wrong]);
          const stems = [
            { q: `Which word ends with ${letter.toUpperCase()}?`, h: 'Look at the last letter.' },
            { q: `Pick the word that ends with ${letter.toUpperCase()}.`, h: 'Ends means last letter.' },
            { q: `Find a word that ends with ${letter.toUpperCase()}.`, h: 'Check the last letter in each word.' }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: correct,
            successMessage: 'Nice ending letter!'
          }));
        } else if (skillId === 'digraph-find') {
          const digraph = pickUniqueValue('digraph-find-target', ['sh', 'ch', 'th']) || pickOne(['sh', 'ch', 'th']);
          const correctWord = pickUniqueValue(`digraph-find-${digraph}`, bank.digraphs[digraph]) || pickOne(bank.digraphs[digraph]);
          const otherDigraphs = ['sh', 'ch', 'th'].filter(d => d !== digraph);
          const wrongDigraph = pickUniqueValue('digraph-find-wrong-digraph', otherDigraphs) || pickOne(otherDigraphs);
          const wrong1 = pickUniqueValue(`digraph-find-${wrongDigraph}`, bank.digraphs[wrongDigraph]) || pickOne(bank.digraphs[wrongDigraph]);
          const wrong2 = pickUniqueValue('digraph-find-nodigraph', bank.cvc.filter(w => !/(sh|ch|th)/i.test(w))) || pickOne(bank.cvc);
          const answers = shuffleInPlace([correctWord, wrong1, wrong2]);
          const stems = [
            { q: `Which word has ${digraph.toUpperCase()}?`, h: `Look for the letters ${digraph}.` },
            { q: `Find the word with ${digraph.toUpperCase()}.`, h: `Scan for ${digraph}.` },
            { q: `Which word contains ${digraph.toUpperCase()}?`, h: `Two letters make one sound.` }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: correctWord,
            successMessage: `Yes! That word has ${digraph.toUpperCase()}.`
          }));
        } else if (skillId === 'digraph-choose') {
          const templates = [
            { pattern: '__ip', word: 'ship', correct: 'sh' },
            { pattern: '__ip', word: 'chip', correct: 'ch' },
            { pattern: '__op', word: 'shop', correct: 'sh' },
            { pattern: '__op', word: 'chop', correct: 'ch' },
            { pattern: '__in', word: 'thin', correct: 'th' },
            { pattern: '__is', word: 'this', correct: 'th' },
            { pattern: '__en', word: 'then', correct: 'th' },
            { pattern: '__at', word: 'chat', correct: 'ch' }
          ];
          const item = pickPoolItem('digraph-choose', templates);
          const correct = item.correct;
          const wrong = pickDistinct(['sh', 'ch', 'th'], 2, new Set([correct]));
          const answers = shuffleInPlace([correct, ...wrong]);
          pages.push(makeMCQ({
            passage: `Complete: ${item.pattern}`,
            question: 'Choose the correct digraph.',
            hint: 'A digraph is two letters that make one sound.',
            answers,
            correctAnswerName: correct,
            successMessage: `Nice! You made the word "${item.word}".`
          }));
        } else if (skillId === 'blends-start') {
          const blend = pickUniqueValue('blends-start-target', bank.blends) || pickOne(bank.blends);
          const correct = pickUniqueValue(`blends-start-${blend}`, bank.blendWords[blend] || ['stop']) || pickOne(bank.blendWords[blend] || ['stop']);
          const wrong = pickDistinct(bank.cvc, 2, new Set([correct]));
          const answers = shuffleInPlace([correct, ...wrong]);
          const stems = [
            { q: `Which word starts with ${blend.toUpperCase()}?`, h: 'Look at the first two letters.' },
            { q: `Pick the word that begins with ${blend.toUpperCase()}.`, h: 'A blend has two consonants.' },
            { q: `Find a word with the blend ${blend.toUpperCase()}.`, h: 'Look at the start of the word.' }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: correct,
            successMessage: `Yes! That word starts with ${blend.toUpperCase()}.`
          }));
        } else if (skillId === 'short-vowel-fill') {
          const templates = [
            { pattern: 'c_t', correct: 'a', word: 'cat' },
            { pattern: 'd_g', correct: 'o', word: 'dog' },
            { pattern: 'b_g', correct: 'u', word: 'bug' },
            { pattern: 'h_n', correct: 'e', word: 'hen' },
            { pattern: 'p_g', correct: 'i', word: 'pig' },
            { pattern: 'm_p', correct: 'a', word: 'map' },
            { pattern: 's_n', correct: 'u', word: 'sun' },
            { pattern: 'f_n', correct: 'i', word: 'fin' },
            { pattern: 'r_t', correct: 'a', word: 'rat' },
            { pattern: 'b_d', correct: 'e', word: 'bed' },
            { pattern: 'c_p', correct: 'a', word: 'cap' },
            { pattern: 'h_t', correct: 'a', word: 'hat' }
          ];
          const item = pickPoolItem('short-vowel-fill', templates);
          const correct = item.correct;
          const wrong = pickDistinct(bank.vowels, 2, new Set([correct]));
          const answers = shuffleInPlace([correct, ...wrong]);
          pages.push(makeMCQ({
            passage: `Complete the word: ${item.pattern}`,
            question: 'Which vowel makes a real word?',
            hint: 'Try each vowel.',
            answers,
            correctAnswerName: correct,
            successMessage: `Yes! ${item.word} is a real word.`
          }));
	        } else if (skillId === 'silent-e') {
	          const pair = pickPoolItem('silent-e', bank.silentE);
	          const correct = pair.long;
	          const wrong = pickDistinct([pair.short, ...bank.cvc], 2, new Set([correct]));
	          const answers = shuffleInPlace([correct, ...wrong]);
	          pages.push(makeMCQ({
	            passage: `Short word: ${pair.short}`,
	            question: 'Which word has a silent e?',
	            hint: 'Silent e is the last letter e.',
	            answers,
	            correctAnswerName: correct,
	            successMessage: 'Yes! That word ends with silent e.'
	          }));
	        } else if (skillId === 'sight-blank') {
	          const item = pickPoolItem('sightWordSentences', bank.sightWordSentences || []);
	          const focus = item.correct;
	          const practicePassage = buildSightWordPracticePassage(focus, bank);
	          pages.push({
	            type: 'read',
	            sentence: practicePassage,
	            words: null,
	            sightWordFocus: focus,
	            requireSightWordTap: false,
	            readingTip: 'Sight words are words we learn by heart. Tap the sight word to hear it.'
	          });

	          const answers = shuffleInPlace([...item.choices]);
	          pages.push(makeMCQ({
	            passage: item.sentence.replace('___', '____'),
	            question: 'Which sight word completes the sentence?',
	            hint: 'Use the sight word you just practiced.',
	            answers,
	            correctAnswerName: focus,
	            successMessage: 'Great! That sight word makes the sentence work.'
	          }));
	        } else if (skillId === 'main-idea') {
	          const passages = [
	            { passage: 'Sam is hot. Sam gets a cold drink. Sam feels better.', correct: 'Getting a cold drink', wrong: ['Going to bed', 'Catching a fish'] },
	            { passage: 'Mia goes to the bakery. Mia smells buns. Mia picks a sweet treat.', correct: 'Choosing a sweet treat', wrong: ['Riding a train', 'Cleaning a room'] },
	            { passage: 'Ben has a kite. Ben runs. The kite goes up high.', correct: 'Flying a kite', wrong: ['Washing dishes', 'Taking a nap'] },
            { passage: 'A dog is wet. The dog shakes. Water goes everywhere.', correct: 'A wet dog shakes', wrong: ['A dog reads', 'A dog cooks soup'] },
            { passage: 'Kim plants a seed. Kim waters it. A small plant grows.', correct: 'Growing a plant', wrong: ['Breaking a toy', 'Losing a shoe'] },
            { passage: 'Lia is hungry. Lia makes a sandwich. Lia eats it.', correct: 'Making a sandwich', wrong: ['Catching a bug', 'Painting a wall'] },
            { passage: 'Tom has a book. Tom reads each page. Tom learns new facts.', correct: 'Reading a book', wrong: ['Driving a car', 'Jumping in a pool'] },
            { passage: 'We see dark clouds. We hear thunder. We go inside.', correct: 'Going inside during a storm', wrong: ['Going to the beach', 'Making popcorn'] },
            { passage: 'The cat wants food. The cat meows. The cat eats.', correct: 'A cat wants food', wrong: ['A cat does math', 'A cat flies'] },
            { passage: 'Ana paints a picture. Ana uses blue and red. Ana smiles.', correct: 'Painting a picture', wrong: ['Fixing a bike', 'Building a house'] },
            { passage: 'Dad cooks rice. The rice gets soft. We eat dinner.', correct: 'Making dinner', wrong: ['Taking a test', 'Going on a boat'] },
            { passage: 'A boy finds a lost mitten. He gives it back. The owner says thank you.', correct: 'Returning a lost item', wrong: ['Hiding a toy', 'Eating candy'] },
            { passage: 'A girl has a pet fish. She feeds it. The fish swims fast.', correct: 'Feeding a fish', wrong: ['Flying a plane', 'Fixing a car'] },
            { passage: 'We go to the park. We swing. We slide. We laugh.', correct: 'Playing at the park', wrong: ['Cooking soup', 'Cleaning a car'] },
            { passage: 'A boy is cold. He puts on a coat. He feels warm.', correct: 'Putting on a coat', wrong: ['Eating a pizza', 'Painting a wall'] },
            { passage: 'Mom bakes a cake. It smells sweet. We taste it.', correct: 'Baking a cake', wrong: ['Catching a shark', 'Driving a bus'] },
            { passage: 'A child drops a pencil. The child picks it up.', correct: 'Picking up a pencil', wrong: ['Throwing a ball', 'Making a nest'] },
            { passage: 'A dog digs in the sand. The dog finds a stick.', correct: 'Finding a stick', wrong: ['Reading a map', 'Flying to space'] },
            { passage: 'We brush our teeth. We wash our face. We go to bed.', correct: 'Getting ready for bed', wrong: ['Going to a zoo', 'Building a boat'] },
            { passage: 'A baby cries. Dad hugs the baby. The baby stops crying.', correct: 'Helping a baby feel better', wrong: ['Playing a drum', 'Swimming in class'] },
            { passage: 'A girl reads a sign. The sign says STOP. The girl stops.', correct: 'Reading a sign', wrong: ['Making a salad', 'Catching a bug'] },
            { passage: 'It rains. We use an umbrella. We stay dry.', correct: 'Staying dry in the rain', wrong: ['Melting ice cream', 'Planting a tree'] }
          ];
          const item = pickPoolItem('main-idea', passages);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            passage: item.passage,
            question: 'What is the main idea?',
            hint: 'What is it mostly about?',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Yes! You found the main idea.'
          }));
        } else if (skillId === 'sequence-first') {
          const items = [
            { passage: 'First, I wash my hands. Next, I eat pizza. Last, I clean up.', question: 'What happened first?', correct: 'I wash my hands', wrong: ['I eat pizza', 'I clean up'] },
            { passage: 'First, I open the book. Next, I read the words. Last, I close the book.', question: 'What happened last?', correct: 'I close the book', wrong: ['I open the book', 'I read the words'] },
            { passage: 'First, I put on socks. Next, I put on shoes. Last, I go outside.', question: 'What happened next?', correct: 'I put on shoes', wrong: ['I go outside', 'I put on socks'] },
            { passage: 'First, I get a bowl. Next, I pour cereal. Last, I eat.', question: 'What happened first?', correct: 'I get a bowl', wrong: ['I pour cereal', 'I eat'] },
            { passage: 'First, I pick up my toys. Next, I put them in a box. Last, I sit down.', question: 'What happened last?', correct: 'I sit down', wrong: ['I pick up my toys', 'I put them in a box'] },
            { passage: 'First, I water the plant. Next, I wait. Last, I see a sprout.', question: 'What happened next?', correct: 'I wait', wrong: ['I water the plant', 'I see a sprout'] },
            { passage: 'First, I mix the batter. Next, I bake it. Last, I taste the cake.', question: 'What happened last?', correct: 'I taste the cake', wrong: ['I mix the batter', 'I bake it'] },
            { passage: 'First, we line up. Next, we walk to class. Last, we sit down.', question: 'What happened first?', correct: 'We line up', wrong: ['We walk to class', 'We sit down'] },
            { passage: 'First, I get my coat. Next, I zip it. Last, I go out.', question: 'What happened next?', correct: 'I zip it', wrong: ['I go out', 'I get my coat'] },
            { passage: 'First, I find a pencil. Next, I write my name. Last, I color.', question: 'What happened next?', correct: 'I write my name', wrong: ['I color', 'I find a pencil'] },
            { passage: 'First, I fill a cup. Next, I take a sip. Last, I put it down.', question: 'What happened last?', correct: 'I put it down', wrong: ['I fill a cup', 'I take a sip'] },
            { passage: 'First, we wash the apples. Next, we cut them. Last, we eat them.', question: 'What happened first?', correct: 'We wash the apples', wrong: ['We cut them', 'We eat them'] },
            { passage: 'First, I open the door. Next, I step in. Last, I shut the door.', question: 'What happened last?', correct: 'I shut the door', wrong: ['I open the door', 'I step in'] },
            { passage: 'First, I pick a book. Next, I read a page. Last, I put it away.', question: 'What happened next?', correct: 'I read a page', wrong: ['I put it away', 'I pick a book'] },
            { passage: 'First, we pack snacks. Next, we get on the train. Last, we arrive.', question: 'What happened next?', correct: 'We get on the train', wrong: ['We arrive', 'We pack snacks'] },
            { passage: 'First, I see a mess. Next, I clean it up. Last, the room looks neat.', question: 'What happened first?', correct: 'I see a mess', wrong: ['I clean it up', 'The room looks neat'] }
          ];
          const item = pickPoolItem('sequence-first', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            passage: item.passage,
            question: item.question,
            hint: 'Use the time words: first, next, last.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice sequencing!'
          }));
        } else if (skillId === 'inference-feeling') {
          const items = [
            { passage: 'Ben smiles. Ben laughs. Ben says, \"This is fun!\"', correct: 'Happy', wrong: ['Sad', 'Angry'] },
            { passage: 'Lia drops her ice cream. Lia cries.', correct: 'Sad', wrong: ['Happy', 'Proud'] },
            { passage: 'Tom hears a loud sound. Tom hides behind the chair.', correct: 'Scared', wrong: ['Excited', 'Sleepy'] },
            { passage: 'Kai jumps up and down. Kai says, \"I can\'t wait!\"', correct: 'Excited', wrong: ['Bored', 'Sleepy'] },
            { passage: 'Mia hugs her new puppy. Mia says, \"I love you.\"', correct: 'Happy', wrong: ['Angry', 'Scared'] },
            { passage: 'A boy cannot find his backpack. He looks and looks.', correct: 'Worried', wrong: ['Proud', 'Silly'] },
            { passage: 'A girl wins a ribbon. She smiles big.', correct: 'Proud', wrong: ['Sad', 'Scared'] },
            { passage: 'A child yawns. The child rubs their eyes.', correct: 'Sleepy', wrong: ['Angry', 'Excited'] },
            { passage: 'The dog growls. The dog shows its teeth.', correct: 'Angry', wrong: ['Happy', 'Proud'] },
            { passage: 'The class is loud. A boy covers his ears.', correct: 'Upset', wrong: ['Proud', 'Excited'] },
            { passage: 'A girl gets a gift. She says, \"Thank you!\"', correct: 'Happy', wrong: ['Angry', 'Sleepy'] },
            { passage: 'A boy drops his lunch. He frowns.', correct: 'Sad', wrong: ['Proud', 'Excited'] },
            { passage: 'A child sees a spider. The child jumps back.', correct: 'Scared', wrong: ['Sleepy', 'Proud'] },
            { passage: 'A kid solves the hard puzzle. The kid smiles.', correct: 'Proud', wrong: ['Angry', 'Scared'] }
          ];
          const item = pickPoolItem('inference-feeling', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            passage: item.passage,
            question: 'How does the character feel?',
            hint: 'Use the clues in the story.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Yes! You used clues to infer the feeling.'
          }));
        } else if (skillId === 'reality-fiction') {
          const items = [
            { question: 'Which could happen in real life?', correct: 'A dog eats food.', wrong: ['A dog reads a book.', 'A dog drives a car.'] },
            { question: 'Which could happen in real life?', correct: 'A child drinks water.', wrong: ['A child flies like a bird.', 'A child turns into a fish.'] },
            { question: 'Which could happen in real life?', correct: 'A bird builds a nest.', wrong: ['A bird writes a letter.', 'A bird cooks soup.'] },
            { question: 'Which could happen in real life?', correct: 'A fish swims in water.', wrong: ['A fish rides a bike.', 'A fish talks on the phone.'] },
            { question: 'Which could happen in real life?', correct: 'A cat sleeps on a bed.', wrong: ['A cat paints a house.', 'A cat drives a bus.'] },
            { question: 'Which could happen in real life?', correct: 'A child reads a book.', wrong: ['A child becomes invisible.', 'A child turns into a dragon.'] },
            { question: 'Which could happen in real life?', correct: 'Rain falls from clouds.', wrong: ['Rain falls from a lamp.', 'Rain falls from a shoe.'] },
            { question: 'Which could happen in real life?', correct: 'A teacher writes on a board.', wrong: ['A teacher flies to the moon.', 'A teacher turns into a tiger.'] },
            { question: 'Which could happen in real life?', correct: 'A child ties a shoe.', wrong: ['A shoe ties a child.', 'A child turns into a shoe.'] },
            { question: 'Which could happen in real life?', correct: 'A dog barks at a door.', wrong: ['A door barks at a dog.', 'A dog becomes a door.'] },
            { question: 'Which could happen in real life?', correct: 'Snow falls in winter.', wrong: ['Snow falls from a spoon.', 'Snow falls in a bed.'] },
            { question: 'Which could happen in real life?', correct: 'A baby drinks milk.', wrong: ['A baby drives a bus.', 'A baby becomes a cloud.'] }
          ];
          const item = pickPoolItem('reality-fiction', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            question: item.question,
            hint: 'Real life means it can really happen.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Good thinking!'
          }));
        } else if (skillId === 'character-actions') {
          const item = pickPoolItem('characterActions', bank.characterActions || []);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          const stems = [
            { h: 'Use the action or words to help you.' },
            { h: 'What the character does tells what they are like.' },
            { h: 'Look for clues in the passage.' }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            passage: item.passage,
            question: item.question || 'What is the character like?',
            hint: stem.h,
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice! You used clues about the character.'
          }));
        } else if (skillId === 'problem-solution') {
          const item = pickPoolItem('problemSolution', bank.problemSolution || []);
          const ask = pickUniqueValue('problem-solution-ask', ['problem', 'solution']) || 'problem';
          const isProblem = ask === 'problem';
          const correct = isProblem ? item.problem : item.solution;
          const wrong = isProblem ? item.wrongProblem : item.wrongSolution;
          const answers = shuffleInPlace([correct, ...(wrong || []).slice(0, 2)]);
          const stems = isProblem
            ? [
                { q: 'What is the problem?', h: 'Problem means what is wrong.' },
                { q: 'What goes wrong first?', h: 'Find the trouble in the passage.' },
                { q: 'What is happening that needs help?', h: 'Look for the problem.' }
              ]
            : [
                { q: 'What is the solution?', h: 'Solution means what fixes the problem.' },
                { q: 'What does the character do to fix it?', h: 'Find what helps.' },
                { q: 'What happens to help the problem?', h: 'Look for the solution.' }
              ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            passage: item.passage,
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: correct,
            successMessage: 'Great! You found the problem/solution.'
          }));
        } else if (skillId === 'best-title') {
          const item = pickPoolItem('bestTitle', bank.bestTitle || []);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          const stems = [
            { q: 'What is the best title for the passage?', h: 'A title tells what the passage is mostly about.' },
            { q: 'Choose the best title.', h: 'Pick the title that matches the main idea.' },
            { q: 'Which title fits best?', h: 'Think: what is it mostly about?' }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            passage: item.passage,
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice! That title matches the passage.'
          }));
        } else if (skillId === 'supporting-detail') {
          const item = pickPoolItem('supportingDetail', bank.supportingDetail || []);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            passage: item.passage,
            question: item.question || 'Which detail is in the passage?',
            hint: 'Read the passage again and find the exact detail.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Great! You found a detail from the passage.'
          }));
        } else if (skillId === 'punctuation-endmark') {
          const items = [
            { sentence: 'What do you want', correct: '?' },
            { sentence: 'Where is my hat', correct: '?' },
            { sentence: 'Can you help me', correct: '?' },
            { sentence: 'I like pizza', correct: '.' },
            { sentence: 'We ride the train', correct: '.' },
            { sentence: 'The fish is fresh', correct: '.' },
            { sentence: 'Stop', correct: '!' },
            { sentence: 'Watch out', correct: '!' },
            { sentence: 'That is amazing', correct: '!' }
          ];
          const item = pickPoolItem('punctuation-endmark', items);
          const answers = shuffleInPlace(['.', '?', '!']);
          pages.push(makeMCQ({
            passage: item.sentence,
            question: 'Choose the best end mark.',
            hint: 'Questions use ?  Statements use .  Strong feelings use !',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice punctuation!'
          }));
        } else if (skillId === 'parts-noun') {
          const correct = pickUniqueValue('parts-noun', bank.nouns) || pickOne(bank.nouns);
          const wrong = [pickOne(bank.verbs), pickOne(bank.adjectives)];
          const answers = shuffleInPlace([correct, ...wrong]);
          pages.push(makeMCQ({
            question: 'Which word is a noun?',
            hint: 'A noun is a person, place, or thing.',
            answers,
            correctAnswerName: correct,
            successMessage: 'Yes! That is a noun.'
          }));
        } else if (skillId === 'parts-verb') {
          const correct = pickUniqueValue('parts-verb', bank.verbs) || pickOne(bank.verbs);
          const wrong = [pickOne(bank.nouns), pickOne(bank.adjectives)];
          const answers = shuffleInPlace([correct, ...wrong]);
          pages.push(makeMCQ({
            question: 'Which word is an action verb?',
            hint: 'Action verbs are doing words.',
            answers,
            correctAnswerName: correct,
            successMessage: 'Yes! That is an action.'
          }));
        } else if (skillId === 'parts-adj') {
          const correct = pickUniqueValue('parts-adj', bank.adjectives) || pickOne(bank.adjectives);
          const wrong = [pickOne(bank.nouns), pickOne(bank.verbs)];
          const answers = shuffleInPlace([correct, ...wrong]);
          pages.push(makeMCQ({
            question: 'Which word is an adjective?',
            hint: 'Adjectives describe.',
            answers,
            correctAnswerName: correct,
            successMessage: 'Yes! That word describes.'
          }));
        } else if (skillId === 'noun-type') {
          const types = [
            { label: 'Person', key: 'person' },
            { label: 'Place', key: 'place' },
            { label: 'Animal', key: 'animal' },
            { label: 'Thing', key: 'thing' }
          ];
          const chosenType = pickPoolItem('noun-type-type', types) || pickOne(types);
          const word = pickUniqueValue(`noun-type-word-${chosenType.key}`, bank.nounTypes?.[chosenType.key] || bank.nouns) || pickOne(bank.nouns);
          const wrong = pickDistinct(types.map(t => t.label).filter(label => label !== chosenType.label), 2);
          const answers = shuffleInPlace([chosenType.label, ...wrong]);
          pages.push(makeMCQ({
            passage: `Word: ${word}`,
            question: 'What kind of noun is this word?',
            hint: 'Nouns can be people, places, animals, or things.',
            answers,
            correctAnswerName: chosenType.label,
            successMessage: 'Nice noun sorting!'
          }));
        } else if (skillId === 'adjectives-compare') {
          const item = pickPoolItem('adjectiveDegrees', bank.adjectiveDegrees) || pickOne(bank.adjectiveDegrees);
          const mode = pickUniqueValue('adjectives-compare-mode', ['comparative', 'superlative']) || pickOne(['comparative', 'superlative']);
          const correct = mode === 'comparative' ? item.comparative : item.superlative;
          const wrongPool = mode === 'comparative' ? [item.base, item.superlative] : [item.base, item.comparative];
          const answers = shuffleInPlace([correct, ...wrongPool]).slice(0, 3);
          const stems = mode === 'comparative'
            ? [
                { q: 'Choose the word that means more.', h: 'Comparative words often end with -er.' },
                { q: 'Choose the comparative form.', h: 'Comparative = comparing two things.' },
                { q: 'Which word means "more" than the base word?', h: 'Look for -er.' }
              ]
            : [
                { q: 'Choose the word that means the most.', h: 'Superlative words often end with -est.' },
                { q: 'Choose the superlative form.', h: 'Superlative = the most of three or more.' },
                { q: 'Which word means the most of all?', h: 'Look for -est.' }
              ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            passage: `Base word: ${item.base}`,
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: correct,
            successMessage: 'Great adjective form!'
          }));
        } else if (skillId === 'unscramble-sentence') {
          const item = pickPoolItem('unscramble-sentence', bank.unscrambleSentences) || pickOne(bank.unscrambleSentences);
          const scrambled = shuffleInPlace([...item.words]).join(' ');
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            passage: `Words: ${scrambled}`,
            question: 'Which sentence uses the words in the best order?',
            hint: 'A sentence starts with a capital letter and makes sense.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice sentence building!'
          }));
        } else if (skillId === 'articles-a-an') {
          const items = [
            { sentence: 'I see ___ apple.', correct: 'an', wrong: ['a', 'the'] },
            { sentence: 'I see ___ dog.', correct: 'a', wrong: ['an', 'the'] },
            { sentence: 'I eat ___ orange.', correct: 'an', wrong: ['a', 'the'] },
            { sentence: 'I have ___ egg.', correct: 'an', wrong: ['a', 'the'] },
            { sentence: 'I want ___ hat.', correct: 'a', wrong: ['an', 'the'] },
            { sentence: 'I see ___ inchworm.', correct: 'an', wrong: ['a', 'the'] },
            { sentence: 'I draw ___ octopus.', correct: 'an', wrong: ['a', 'the'] },
            { sentence: 'I see ___ rabbit.', correct: 'a', wrong: ['an', 'the'] },
            { sentence: 'I eat ___ sandwich.', correct: 'a', wrong: ['an', 'the'] }
          ];
          const item = pickPoolItem('articles-a-an', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            passage: item.sentence.replace('___', '____'),
            question: 'Choose a or an.',
            hint: 'Use an before a vowel sound.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice article choice!'
          }));
        } else if (skillId === 'prepositions') {
          const items = [
            { passage: 'The cat is ____ the box.', correct: 'in', wrong: ['run', 'big'] },
            { passage: 'The book is ____ the table.', correct: 'on', wrong: ['eat', 'happy'] },
            { passage: 'The ball is ____ the chair.', correct: 'under', wrong: ['see', 'yummy'] },
            { passage: 'The frog is ____ the log.', correct: 'on', wrong: ['fast', 'jump'] },
            { passage: 'The dog is ____ the bed.', correct: 'on', wrong: ['blue', 'eat'] },
            { passage: 'The coin is ____ the cup.', correct: 'in', wrong: ['tall', 'run'] },
            { passage: 'The shoes are ____ the bed.', correct: 'under', wrong: ['hot', 'sleep'] },
            { passage: 'The cat is ____ the chair.', correct: 'under', wrong: ['big', 'smell'] }
          ];
          const item = pickPoolItem('prepositions', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            passage: item.passage,
            question: 'Which word shows where?',
            hint: 'Prepositions tell where something is.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Great! That word shows where.'
          }));
        } else if (skillId === 'point-of-view') {
          const items = [
            { passage: 'I go to the park. I play.', correct: 'I (first person)', wrong: ['He (third person)', 'They (third person)'] },
            { passage: 'She has a dog. She runs.', correct: 'She (third person)', wrong: ['I (first person)', 'We (first person)'] },
            { passage: 'We ride the train. We sit down.', correct: 'We (first person)', wrong: ['He (third person)', 'She (third person)'] },
            { passage: 'They walk to the store. They buy milk.', correct: 'They (third person)', wrong: ['I (first person)', 'We (first person)'] },
            { passage: 'He jumps. He laughs.', correct: 'He (third person)', wrong: ['I (first person)', 'They (third person)'] },
            { passage: 'I read a book. I learn.', correct: 'I (first person)', wrong: ['She (third person)', 'They (third person)'] },
            { passage: 'We wash our hands. We eat lunch.', correct: 'We (first person)', wrong: ['He (third person)', 'They (third person)'] },
            { passage: 'They play a game. They laugh.', correct: 'They (third person)', wrong: ['I (first person)', 'We (first person)'] },
            { passage: 'She paints a picture. She smiles.', correct: 'She (third person)', wrong: ['He (third person)', 'I (first person)'] },
            { passage: 'He reads the sign. He stops.', correct: 'He (third person)', wrong: ['They (third person)', 'We (first person)'] },
            { passage: 'I am hungry. I eat an apple.', correct: 'I (first person)', wrong: ['He (third person)', 'She (third person)'] },
            { passage: 'We go home. We rest.', correct: 'We (first person)', wrong: ['She (third person)', 'They (third person)'] }
          ];
          const item = pickPoolItem('point-of-view', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            passage: item.passage,
            question: 'Who is telling the story?',
            hint: 'Look for I, we, he, she, they.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice point of view!'
          }));
        } else if (skillId === 'phoneme-change-first') {
          const item = pickPoolItem('phoneme-change', bank.phonemeChange) || pickOne(bank.phonemeChange);
          const passage = `Change the first sound in ${item.base} to ${item.firstTo}.`;
          const correct = item.result;
          const wrong = pickDistinct(bank.cvc, 2, new Set([correct, item.base]));
          const answers = shuffleInPlace([correct, ...wrong]);
          pages.push(makeMCQ({
            passage,
            question: 'Which word do you make?',
            hint: 'Look at the first letter.',
            answers,
            correctAnswerName: correct,
            successMessage: 'Yes! You changed the first sound.'
          }));
        } else if (skillId === 'phoneme-change-last') {
          const item = pickPoolItem('phoneme-change', bank.phonemeChange) || pickOne(bank.phonemeChange);
          const passage = `Change the last sound in ${item.base} to ${item.lastTo}.`;
          const correct = item.lastResult;
          const wrong = pickDistinct(bank.cvc, 2, new Set([correct, item.base]));
          const answers = shuffleInPlace([correct, ...wrong]);
          pages.push(makeMCQ({
            passage,
            question: 'Which word do you make?',
            hint: 'Look at the last letter.',
            answers,
            correctAnswerName: correct,
            successMessage: 'Nice! You changed the last sound.'
          }));
        } else if (skillId === 'phoneme-change-vowel') {
          const item = pickPoolItem('phoneme-change', bank.phonemeChange) || pickOne(bank.phonemeChange);
          const passage = `Change the vowel in ${item.base} to ${item.vowelTo}.`;
          const correct = item.vowelResult;
          const wrong = pickDistinct(bank.cvc, 2, new Set([correct, item.base]));
          const answers = shuffleInPlace([correct, ...wrong]);
          pages.push(makeMCQ({
            passage,
            question: 'Which word do you make?',
            hint: 'The vowel is in the middle.',
            answers,
            correctAnswerName: correct,
            successMessage: 'Good vowel change!'
          }));
        } else if (skillId === 'abc-order') {
          const words = pickDistinct(bank.cvc, 3);
          const correct = [...words].sort((a, b) => a.localeCompare(b)).join(', ');
          const wrong1 = [...words].sort((a, b) => b.localeCompare(a)).join(', ');
          const wrong2 = shuffleInPlace([...words]).join(', ');
          const answers = shuffleInPlace([correct, wrong1, wrong2]);
          pages.push(makeMCQ({
            passage: `Words: ${words.join(', ')}`,
            question: 'Which list is in ABC order?',
            hint: 'ABC order means alphabetical order.',
            answers,
            correctAnswerName: correct,
            successMessage: 'Nice ABC order!'
          }));
        } else if (skillId === 'synonyms') {
          const item = pickPoolItem('synonyms', bank.synonyms);
          const answers = shuffleInPlace([item.synonym, ...item.wrong]);
          pages.push(makeMCQ({
            passage: `Word: ${item.word}`,
            question: 'Which word means almost the same?',
            hint: 'A synonym means nearly the same thing.',
            answers,
            correctAnswerName: item.synonym,
            successMessage: 'Yes! Those words are synonyms.'
          }));
        } else if (skillId === 'antonyms') {
          const item = pickPoolItem('antonyms', bank.antonyms);
          const answers = shuffleInPlace([item.antonym, ...item.wrong]);
          pages.push(makeMCQ({
            passage: `Word: ${item.word}`,
            question: 'Which word means the opposite?',
            hint: 'An antonym means the opposite.',
            answers,
            correctAnswerName: item.antonym,
            successMessage: 'Yes! That is the opposite.'
          }));
        } else if (skillId === 'categories-odd') {
          const item = pickPoolItem('categories', bank.categories);
          const words = shuffleInPlace([...pickDistinct(item.words, 2), item.odd]);
          pages.push(makeMCQ({
            passage: `Category: ${item.category}`,
            question: 'Which word does not belong?',
            hint: 'Two words fit the category.',
            answers: words,
            correctAnswerName: item.odd,
            successMessage: 'Good sorting!'
          }));
        } else if (skillId === 'number-words') {
          const item = pickPoolItem('numberWords', bank.numberWords || []);
          const answers = shuffleInPlace([item.word, ...item.wrong]);
          const stems = [
            { q: 'Which word names this number?', h: 'Read the number, then pick the matching word.' },
            { q: 'What number word is this?', h: 'Match the digit to the word.' },
            { q: 'Choose the correct number word.', h: 'Look carefully at each word.' }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            passage: `Number: ${item.digit}`,
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: item.word,
            successMessage: 'Nice number word!'
          }));
        } else if (skillId === 'prefix-un') {
          const item = pickPoolItem('prefix-un', bank.prefixesUn || []);
          const answers = shuffleInPlace([item.derived, ...item.wrong]);
          pages.push(makeMCQ({
            passage: `Base word: ${item.base}`,
            question: `Which word means ${item.meaning}?`,
            hint: 'The prefix un- can mean not, or it can mean to undo.',
            answers,
            correctAnswerName: item.derived,
            successMessage: 'Great! You used a prefix.'
          }));
        } else if (skillId === 'suffix-ful') {
          const item = pickPoolItem('suffix-ful', bank.suffixesFul || []);
          const answers = shuffleInPlace([item.derived, ...item.wrong]);
          pages.push(makeMCQ({
            passage: `Base word: ${item.base}`,
            question: `Which word means ${item.meaning}?`,
            hint: 'The suffix -ful can mean full of.',
            answers,
            correctAnswerName: item.derived,
            successMessage: 'Great! You used a suffix.'
          }));
        } else if (skillId === 'pronouns') {
          const items = [
            { sentence: '___ has a hat.', correct: 'He', wrong: ['They', 'We'] },
            { sentence: '___ has a doll.', correct: 'She', wrong: ['He', 'We'] },
            { sentence: '___ go to the park.', correct: 'They', wrong: ['He', 'She'] },
            { sentence: '___ play a game.', correct: 'We', wrong: ['He', 'She'] },
            { sentence: '___ have a dog.', correct: 'They', wrong: ['He', 'I'] },
            { sentence: '___ am hungry.', correct: 'I', wrong: ['He', 'They'] },
            { sentence: '___ runs fast.', correct: 'He', wrong: ['We', 'They'] },
            { sentence: '___ likes milk.', correct: 'She', wrong: ['They', 'We'] }
          ];
          const item = pickPoolItem('pronouns', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            passage: item.sentence.replace('___', '____'),
            question: 'Choose the best pronoun.',
            hint: 'Pronouns can be he, she, they, we, I.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice pronoun!'
          }));
        } else if (skillId === 'possessive-pronouns') {
          const item = pickPoolItem('possessive-pronouns', bank.possessivePronouns || []);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          const passage = String(item.sentence || '').replace('___', '____');
          pages.push(makeMCQ({
            passage,
            question: 'Choose the correct possessive pronoun.',
            hint: 'Possessive pronouns show who owns something.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice! That shows ownership.'
          }));
        } else if (skillId === 'pronoun-reference') {
          const item = pickPoolItem('pronounReference', bank.pronounReference || []);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          const stems = [
            { q: item.question || 'What does the pronoun mean?', h: 'A pronoun stands for a noun. Look back at the passage.' },
            { q: item.question || 'Who or what is the pronoun talking about?', h: 'Find the pronoun and look for the name or thing it replaces.' }
          ];
          const stem = pickOne(stems);
          pages.push(makeMCQ({
            passage: item.passage,
            question: stem.q,
            hint: stem.h,
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Great! You found what the pronoun means.'
          }));
        } else if (skillId === 'subject-verb') {
          const items = [
            { sentence: 'He ____.', correct: 'runs', wrong: ['run', 'running'] },
            { sentence: 'They ____.', correct: 'run', wrong: ['runs', 'running'] },
            { sentence: 'She ____.', correct: 'jumps', wrong: ['jump', 'jumping'] },
            { sentence: 'We ____.', correct: 'play', wrong: ['plays', 'playing'] },
            { sentence: 'The dog ____.', correct: 'barks', wrong: ['bark', 'barking'] },
            { sentence: 'The cats ____.', correct: 'sleep', wrong: ['sleeps', 'sleeping'] },
            { sentence: 'I ____.', correct: 'read', wrong: ['reads', 'reading'] },
            { sentence: 'My friend ____.', correct: 'walks', wrong: ['walk', 'walking'] }
          ];
          const item = pickPoolItem('subject-verb', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            passage: item.sentence.replace('____', '_____'),
            question: 'Choose the best verb.',
            hint: 'One person: runs/jumps. More than one: run/jump.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Good subject-verb match!'
          }));
        } else if (skillId === 'verb-tense') {
          const items = [
            { question: 'Which sentence tells about the past?', correct: 'I jumped.', wrong: ['I jump.', 'I will jump.'] },
            { question: 'Which sentence tells about the future?', correct: 'I will eat.', wrong: ['I eat.', 'I ate.'] },
            { question: 'Which sentence tells about the present?', correct: 'I run.', wrong: ['I ran.', 'I will run.'] },
            { question: 'Which sentence tells about the past?', correct: 'She played.', wrong: ['She plays.', 'She will play.'] },
            { question: 'Which sentence tells about the future?', correct: 'They will read.', wrong: ['They read.', 'They readed.'] },
            { question: 'Which sentence tells about the present?', correct: 'He walks.', wrong: ['He walked.', 'He will walk.'] },
            { question: 'Which sentence tells about the past?', correct: 'We ate.', wrong: ['We eat.', 'We will eat.'] },
            { question: 'Which sentence tells about the future?', correct: 'I will go.', wrong: ['I went.', 'I go.'] }
          ];
          const item = pickPoolItem('verb-tense', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            question: item.question,
            hint: 'Past already happened. Present is now. Future will happen.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice tense!'
          }));
        } else if (skillId === 'capitalization') {
          const items = [
            { question: 'Choose the sentence with correct capitalization.', correct: 'I like pizza.', wrong: ['i like pizza.', 'i Like pizza.'] },
            { question: 'Choose the sentence with correct capitalization.', correct: 'We go to the park.', wrong: ['we go to the park.', 'We go to the Park.'] },
            { question: 'Choose the sentence with correct capitalization.', correct: 'She has a dog.', wrong: ['she has a dog.', 'She has a Dog.'] },
            { question: 'Choose the sentence with correct capitalization.', correct: 'He can read.', wrong: ['he can read.', 'He Can read.'] },
            { question: 'Choose the sentence with correct capitalization.', correct: 'Today is Monday.', wrong: ['today is monday.', 'Today is monday.'] },
            { question: 'Choose the sentence with correct capitalization.', correct: 'My mom is here.', wrong: ['my mom is here.', 'My Mom is here.'] },
            { question: 'Choose the sentence with correct capitalization.', correct: 'I see a cat.', wrong: ['i see a cat.', 'I see a Cat.'] }
          ];
          const item = pickPoolItem('capitalization', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            question: item.question,
            hint: 'Start a sentence with a capital letter. \"I\" is always capital.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Great capitalization!'
          }));
        } else if (skillId === 'proper-nouns') {
          const item = pickPoolItem('proper-nouns', bank.properNouns || []);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            question: item.question,
            hint: 'Names of people, days, and months start with a capital letter.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Nice! That is a proper noun.'
          }));
        } else if (skillId === 'complete-sentence') {
          const items = [
            { question: 'Which is a complete sentence?', correct: 'The dog runs.', wrong: ['The dog.', 'Runs fast.'] },
            { question: 'Which is a complete sentence?', correct: 'I see a cat.', wrong: ['See a cat.', 'A cat.'] },
            { question: 'Which is a complete sentence?', correct: 'We play outside.', wrong: ['We play.', 'Outside.'] },
            { question: 'Which is a complete sentence?', correct: 'She eats lunch.', wrong: ['Eats lunch.', 'She lunch.'] },
            { question: 'Which is a complete sentence?', correct: 'My dad cooks.', wrong: ['My dad.', 'Cooks.'] },
            { question: 'Which is a complete sentence?', correct: 'The fish swims.', wrong: ['The fish.', 'Swims fast.'] },
            { question: 'Which is a complete sentence?', correct: 'They read books.', wrong: ['Read books.', 'They books.'] }
          ];
          const item = pickPoolItem('complete-sentence', items);
          const answers = shuffleInPlace([item.correct, ...item.wrong]);
          pages.push(makeMCQ({
            question: item.question,
            hint: 'A complete sentence has a naming part and an action part.',
            answers,
            correctAnswerName: item.correct,
            successMessage: 'Yes! That is a complete sentence.'
          }));
        } else if (skillId === 'spelling-cvc') {
          const item = pickPoolItem('spelling-cvc', bank.spelling.cvc);
          const answers = shuffleInPlace([item.word, ...item.wrong]);
          pages.push(makeMCQ({
            passage: `Word: ${item.word}`,
            question: 'Choose the correct spelling.',
            hint: 'Look carefully at each letter.',
            answers,
            correctAnswerName: item.word,
            successMessage: 'Yes! That spelling is correct.'
          }));
        } else if (skillId === 'spelling-digraph') {
          const item = pickPoolItem('spelling-digraph', bank.spelling.digraph);
          const answers = shuffleInPlace([item.word, ...item.wrong]);
          pages.push(makeMCQ({
            passage: `Word: ${item.word}`,
            question: 'Choose the correct spelling.',
            hint: 'Look for the digraph.',
            answers,
            correctAnswerName: item.word,
            successMessage: 'Yes! That spelling is correct.'
          }));
        } else if (skillId === 'spelling-sight') {
          const item = pickPoolItem('spelling-sight', bank.spelling.sight);
          const answers = shuffleInPlace([item.word, ...item.wrong]);
          pages.push(makeMCQ({
            passage: `Sight word: ${item.word}`,
            question: 'Choose the correct spelling.',
            hint: 'Sight words are words we learn by heart.',
            answers,
            correctAnswerName: item.word,
            successMessage: 'Great! You spelled the sight word.'
          }));
        } else {
          // Fallback: main idea
          const answers = shuffleInPlace(['Getting a cold drink', 'Going to bed', 'Catching a fish']);
          pages.push(makeMCQ({
            passage: 'Sam is hot. Sam gets a cold drink. Sam feels better.',
            question: 'What is the main idea?',
            hint: 'What is it mostly about?',
            answers,
            correctAnswerName: 'Getting a cold drink'
          }));
        }
      }

      return pages;
    }

	    const skillsCatalog = [
      // ===== LEVEL 1 =====
      { id: 'consonant-or-vowel', level: 1, category: 'Reading foundations', name: 'Consonant or Vowel', description: 'Tell if a letter is a vowel or consonant' },
      { id: 'vowels-letter', level: 1, category: 'Reading foundations', name: 'Vowels', description: 'Identify vowels a, e, i, o, u' },
      { id: 'start-letter', level: 1, category: 'Reading foundations', name: 'Starting Letter', description: 'Find the word that starts with a letter' },
      { id: 'end-letter', level: 1, category: 'Reading foundations', name: 'Ending Letter', description: 'Find the word that ends with a letter' },
      { id: 'first-sound', level: 1, category: 'Reading foundations', name: 'First Letter', description: 'Find the first letter in a word' },
      { id: 'last-sound', level: 1, category: 'Reading foundations', name: 'Last Letter', description: 'Find the last letter in a word' },
      { id: 'rhyming-choose', level: 1, category: 'Reading foundations', name: 'Rhyming', description: 'Choose a rhyming word' },
      { id: 'rhyming-odd', level: 1, category: 'Reading foundations', name: 'Rhyming: Odd One Out', description: 'Find the word that does not rhyme' },
      { id: 'rhyming-complete', level: 1, category: 'Reading foundations', name: 'Complete the Rhyme', description: 'Pick the word that rhymes' },
      { id: 'blend-sounds', level: 1, category: 'Reading foundations', name: 'Blend Sounds', description: 'Blend sounds to read a word' },
      { id: 'short-vowel-fill', level: 1, category: 'Reading foundations', name: 'Short Vowels', description: 'Complete a word with the right vowel' },
      { id: 'spelling-cvc', level: 1, category: 'Reading foundations', name: 'Spell CVC Words', description: 'Choose the correct spelling' },
      { id: 'compound-words', level: 1, category: 'Reading foundations', name: 'Compound Words', description: 'Put two words together' },
      { id: 'sight-blank', level: 1, category: 'Sight words', name: 'Sight Words', description: 'Complete a sentence with a sight word' },
      { id: 'punctuation-endmark', level: 1, category: 'Grammar', name: 'End Marks', description: 'Pick the best end mark' },
      { id: 'sentence-type', level: 1, category: 'Grammar', name: 'Sentence Types', description: 'Statement, question, command, or exclamation' },
      { id: 'complete-sentence', level: 1, category: 'Grammar', name: 'Complete Sentences', description: 'Find a complete sentence' },
      { id: 'capitalization', level: 1, category: 'Grammar', name: 'Capitalization', description: 'Choose correct capitalization' },

      // ===== LEVEL 2 =====
      { id: 'vowels-word', level: 2, category: 'Reading foundations', name: 'Vowels in a Word', description: 'Find a vowel inside a word' },
      { id: 'syllables-count', level: 2, category: 'Reading foundations', name: 'Syllables: Count', description: 'Count syllables in a word' },
      { id: 'syllables-which', level: 2, category: 'Reading foundations', name: 'Syllables: Choose', description: 'Choose the word with 2 or 3 syllables' },
      { id: 'two-syllable-build', level: 2, category: 'Reading foundations', name: 'Build Two-Syllable Words', description: 'Put syllables together to make a word' },
      { id: 'categories-odd', level: 2, category: 'Vocabulary', name: 'Categories', description: 'Find the word that does not belong' },
      { id: 'synonyms', level: 2, category: 'Vocabulary', name: 'Synonyms', description: 'Choose words with similar meanings' },
      { id: 'antonyms', level: 2, category: 'Vocabulary', name: 'Antonyms', description: 'Choose words with opposite meanings' },
      { id: 'abc-order', level: 2, category: 'Vocabulary', name: 'ABC Order', description: 'Put words in ABC order' },
      { id: 'number-words', level: 2, category: 'Vocabulary', name: 'Number Words', description: 'Match digits to number words' },
      { id: 'noun-type', level: 2, category: 'Vocabulary', name: 'Noun Types', description: 'Person, place, animal, or thing' },
      { id: 'main-idea', level: 2, category: 'Reading strategies', name: 'Main Idea', description: 'Find what the passage is mostly about' },
      { id: 'sequence-first', level: 2, category: 'Reading strategies', name: 'Sequence', description: 'Use first, next, and last' },
      { id: 'setting', level: 2, category: 'Reading strategies', name: 'Setting', description: 'Find where the story happens' },
      { id: 'character', level: 2, category: 'Reading strategies', name: 'Characters', description: 'Find who the story is about' },
      { id: 'inference-feeling', level: 2, category: 'Reading strategies', name: 'Inference: Feelings', description: 'Use clues to pick a feeling' },
      { id: 'reality-fiction', level: 2, category: 'Reading strategies', name: 'Reality vs. Fiction', description: 'Choose what could happen' },
      { id: 'best-title', level: 2, category: 'Reading strategies', name: 'Best Title', description: 'Pick the best title for a passage' },
      { id: 'supporting-detail', level: 2, category: 'Reading strategies', name: 'Supporting Details', description: 'Find a detail from a passage' },
      { id: 'articles-a-an', level: 2, category: 'Grammar', name: 'A or An', description: 'Choose a or an' },
      { id: 'parts-noun', level: 2, category: 'Grammar', name: 'Nouns', description: 'Find a noun' },
      { id: 'parts-verb', level: 2, category: 'Grammar', name: 'Verbs', description: 'Find an action verb' },
      { id: 'parts-adj', level: 2, category: 'Grammar', name: 'Adjectives', description: 'Find a describing word' },
      { id: 'unscramble-sentence', level: 2, category: 'Grammar', name: 'Unscramble Sentences', description: 'Choose the sentence in the right order' },
      { id: 'pronouns', level: 2, category: 'Grammar', name: 'Pronouns', description: 'Choose he, she, or they' },
      { id: 'prepositions', level: 2, category: 'Grammar', name: 'Prepositions', description: 'Pick a word that shows where' },
      { id: 'conjunctions', level: 2, category: 'Grammar', name: 'Linking Words', description: 'Choose and, but, so, or because' },
      { id: 'time-order', level: 2, category: 'Grammar', name: 'Time-Order Words', description: 'Choose first, next, or last' },

      // ===== LEVEL 3 =====
      { id: 'digraph-find', level: 3, category: 'Reading foundations', name: 'Digraphs', description: 'Find words with sh, ch, and th' },
      { id: 'digraph-choose', level: 3, category: 'Reading foundations', name: 'Choose a Digraph', description: 'Pick the digraph that fits' },
      { id: 'spelling-digraph', level: 3, category: 'Reading foundations', name: 'Spell Digraph Words', description: 'Choose the correct spelling with sh, ch, or th' },
      { id: 'blends-start', level: 3, category: 'Reading foundations', name: 'Consonant Blends', description: 'Find words that start with blends' },
      { id: 'phoneme-change-first', level: 3, category: 'Reading foundations', name: 'Change First Sound', description: 'Change the first sound in a word' },
      { id: 'phoneme-change-last', level: 3, category: 'Reading foundations', name: 'Change Last Sound', description: 'Change the last sound in a word' },
      { id: 'phoneme-change-vowel', level: 3, category: 'Reading foundations', name: 'Change Vowel', description: 'Change the vowel in a word' },
      { id: 'silent-e', level: 3, category: 'Reading foundations', name: 'Silent E', description: 'Find words with silent e' },
      { id: 'long-vowel-silent-e', level: 3, category: 'Reading foundations', name: 'Long Vowels', description: 'Pick the long-vowel word' },
      { id: 'point-of-view', level: 3, category: 'Reading strategies', name: 'Point of View', description: 'Who is telling the story?' },
      { id: 'character-actions', level: 3, category: 'Reading strategies', name: 'Character Clues', description: 'Use actions and words to understand a character' },
      { id: 'problem-solution', level: 3, category: 'Reading strategies', name: 'Problem and Solution', description: 'Find the problem or the solution in a passage' },
      { id: 'cause-effect', level: 3, category: 'Reading strategies', name: 'Cause and Effect', description: 'Why did it happen?' },
      { id: 'prediction-next', level: 3, category: 'Reading strategies', name: 'Prediction', description: 'What will happen next?' },
      { id: 'subject-verb', level: 3, category: 'Grammar', name: 'Subject-Verb Agreement', description: 'Choose the best verb' },
      { id: 'verb-tense', level: 3, category: 'Grammar', name: 'Verb Tense', description: 'Past, present, or future' },
      { id: 'wh-words', level: 3, category: 'Grammar', name: 'Question Words', description: 'Choose who, what, where, when, or why' },
      { id: 'proper-nouns', level: 3, category: 'Grammar', name: 'Proper Nouns', description: 'Find names that start with a capital letter' },
      { id: 'pronoun-reference', level: 3, category: 'Grammar', name: 'Pronoun Reference', description: 'Find what a pronoun means' },
      { id: 'contractions', level: 3, category: 'Grammar', name: 'Contractions', description: 'Choose the contraction' },
      { id: 'plurals', level: 3, category: 'Grammar', name: 'Plurals', description: 'Choose the correct plural word' },
      { id: 'irregular-plurals', level: 3, category: 'Grammar', name: 'Irregular Plurals', description: 'Choose special plural words like children and feet' },
      { id: 'adjectives-compare', level: 3, category: 'Grammar', name: 'Comparative & Superlative', description: 'Choose -er or -est words' },

      // ===== LEVEL 4 =====
      { id: 'vowel-team-ee', level: 4, category: 'Reading foundations', name: 'Vowel Teams: EE', description: 'Find words with ee' },
      { id: 'vowel-team-ea', level: 4, category: 'Reading foundations', name: 'Vowel Teams: EA', description: 'Find words with ea' },
      { id: 'vowel-team-ai', level: 4, category: 'Reading foundations', name: 'Vowel Teams: AI', description: 'Find words with ai' },
      { id: 'vowel-team-ay', level: 4, category: 'Reading foundations', name: 'Vowel Teams: AY', description: 'Find words with ay' },
      { id: 'vowel-team-oa', level: 4, category: 'Reading foundations', name: 'Vowel Teams: OA', description: 'Find words with oa' },
      { id: 'vowel-team-ow', level: 4, category: 'Reading foundations', name: 'Vowel Teams: OW', description: 'Find ow words with the long o sound' },
      { id: 'r-controlled-ar', level: 4, category: 'Reading foundations', name: 'R-Controlled: AR', description: 'Find words with ar' },
      { id: 'r-controlled-er', level: 4, category: 'Reading foundations', name: 'R-Controlled: ER', description: 'Find words with er' },
      { id: 'r-controlled-ir', level: 4, category: 'Reading foundations', name: 'R-Controlled: IR', description: 'Find words with ir' },
      { id: 'r-controlled-or', level: 4, category: 'Reading foundations', name: 'R-Controlled: OR', description: 'Find words with or' },
      { id: 'r-controlled-ur', level: 4, category: 'Reading foundations', name: 'R-Controlled: UR', description: 'Find words with ur' },
      { id: 'diphthong-oi', level: 4, category: 'Reading foundations', name: 'Diphthongs: OI', description: 'Find words with oi' },
      { id: 'diphthong-oy', level: 4, category: 'Reading foundations', name: 'Diphthongs: OY', description: 'Find words with oy' },
      { id: 'diphthong-ou', level: 4, category: 'Reading foundations', name: 'Diphthongs: OU', description: 'Find words with ou' },
      { id: 'diphthong-ow', level: 4, category: 'Reading foundations', name: 'Diphthongs: OW', description: 'Find ow words that sound like cow' },
      { id: 'context-clues', level: 4, category: 'Vocabulary', name: 'Context Clues', description: 'Use the sentence to find the meaning' },
      { id: 'prefix-un', level: 4, category: 'Vocabulary', name: 'Prefixes: un-', description: 'Use un- to change a word' },
      { id: 'suffix-ful', level: 4, category: 'Vocabulary', name: 'Suffixes: -ful', description: 'Use -ful to change a word' },
      { id: 'multiple-meaning', level: 4, category: 'Vocabulary', name: 'Multiple-Meaning Words', description: 'Use context to choose the meaning' },
      { id: 'shades-of-meaning', level: 4, category: 'Vocabulary', name: 'Shades of Meaning', description: 'Pick the strongest word' },
      { id: 'shades-order', level: 4, category: 'Vocabulary', name: 'Shades: Order', description: 'Order words by strength' },
      { id: 'possessive-nouns', level: 4, category: 'Grammar', name: 'Possessive Nouns', description: 'Show ownership with apostrophe and s' },
      { id: 'possessive-pronouns', level: 4, category: 'Grammar', name: 'Possessive Pronouns', description: 'my, his, her, our, or their' },
      { id: 'text-features', level: 4, category: 'Reading strategies', name: 'Text Features', description: 'Headings, captions, table of contents' },
      { id: 'spelling-sight', level: 4, category: 'Sight words', name: 'Spell Sight Words', description: 'Choose the correct spelling' }
    ];

    function setSkillsLevelFilter(level) {
      state.skillsLevelFilter = level;
      updateSkillsFilterButtons();
      renderSkillsScreen();
    }

    function updateSkillsFilterButtons() {
      const mapping = [
        { id: 'skillsFilterAll', value: 'all' },
        { id: 'skillsFilter1', value: 1 },
        { id: 'skillsFilter2', value: 2 },
        { id: 'skillsFilter3', value: 3 },
        { id: 'skillsFilter4', value: 4 },
      ];

      mapping.forEach(item => {
        const el = document.getElementById(item.id);
        if (!el) return;
        const isActive = state.skillsLevelFilter === item.value;
        el.classList.toggle('active', isActive);
      });
    }

	    function renderSkillsScreen() {
	      const container = document.getElementById('skillsList');
	      if (!container) return;

      container.innerHTML = '';

      const visibleSkills = skillsCatalog.filter(s => {
        if (state.skillsLevelFilter === 'all') return true;
        return s.level === state.skillsLevelFilter;
      });

	      const categoryOrder = ['Reading foundations', 'Sight words', 'Reading strategies', 'Vocabulary', 'Grammar'];
	      const categories = Array.from(new Set(visibleSkills.map(s => s.category))).sort((a, b) => {
	        const ai = categoryOrder.indexOf(a);
	        const bi = categoryOrder.indexOf(b);
	        if (ai !== -1 || bi !== -1) return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
	        return a.localeCompare(b);
	      });
	      categories.forEach(category => {
        const heading = document.createElement('div');
        heading.style.width = '100%';
        heading.style.margin = '12px 0 6px';
        heading.style.fontFamily = 'var(--font-display)';
        heading.style.fontWeight = '700';
        heading.style.color = 'var(--text-primary)';
        heading.textContent = category;
        container.appendChild(heading);

	        visibleSkills
	          .filter(s => s.category === category)
	          .sort((a, b) => a.level - b.level || a.name.localeCompare(b.name))
	          .forEach(skill => {
	          const btn = document.createElement('button');
	          btn.className = 'station-btn';
	          btn.onclick = () => startSkillPractice(skill.id);
	          btn.innerHTML = `
	            <div class="station-info">
	              <div class="station-name">${skill.name}</div>
	              <div class="station-desc">Level ${skill.level}  ${skill.description}</div>
	            </div>
	            <span class="station-status">Start</span>
	          `;
	          container.appendChild(btn);
	        });
	      });
	    }

    function startSkillPractice(skillId) {
      const skill = skillsCatalog.find(s => s.id === skillId);
      if (!skill) return;

      state.practiceSkillId = skillId;
      state.practiceCorrect = 0;
      state.practiceFirstTryCorrect = 0;

      const pages = generateSkillPages(skillId, 10);
      state.practiceTotal = pages.filter(p => p.type === 'question').length;

      stationContent.practice.name = `Skill Practice: ${skill.name}`;
      stationContent.practice.pages = pages;

      state.currentStation = 'practice';
      state.currentPage = 0;
      state.currentOrder = null;
      state.sessionPages = stationContent.practice.pages;

      showRestaurant();
    }

    // ===== GENERATE MRT MAP =====
    function generateMRTMap() {
      console.log('=== Generating MRT map ===');
      const map = document.getElementById('mrtMap');

      if (!map) {
        console.error('MRT map element not found!');
        return;
      }

      // Clear and recreate the MRT line
      map.innerHTML = '<div class="mrt-line"></div>';

      // Station order by level - ALL 8 STATIONS
      const stationOrder = ['fruit', 'drink', 'bakery', 'pizza', 'icecream', 'fishshop', 'cheese', 'noodle'];

      console.log('Station order:', stationOrder);
      console.log('Available stations in content:', Object.keys(stationContent));

      let stationsCreated = 0;

      stationOrder.forEach((stationId, index) => {
        const station = stationContent[stationId];
        if (!station) {
          console.error('MISSING STATION:', stationId);
          return;
        }

        const isCompleted = state.completedStations.includes(stationId);
        const isUnlocked = isStationUnlocked(stationId, index);

        console.log(`[${index}] ${stationId}: unlocked=${isUnlocked}, completed=${isCompleted}, name=${station.name}`);

        const btn = document.createElement('button');
        btn.className = `station-btn${isCompleted ? ' completed' : ''}`;
        btn.id = `station-${stationId}`;
        btn.disabled = !isUnlocked;
        btn.onclick = () => selectStation(stationId);

        const digraphInfo = station.digraphFocus ? ` (${station.digraphFocus.toUpperCase()} words)` : '';

        // Use SVG icon if available, otherwise fall back to emoji
        const iconHtml = stationIcons[stationId]
          ? `<img class="station-icon-img" src="${stationIcons[stationId]}" alt="${station.name}" />`
          : `<span class="station-icon">${station.icon}</span>`;

        btn.innerHTML = `
          ${iconHtml}
          <div class="station-info">
            <div class="station-name">${station.name}</div>
            <div class="station-desc">
              <span class="station-level level-${station.level}">Level ${station.level}</span>
              ${digraphInfo}
            </div>
          </div>
	          <span class="station-status">${isCompleted ? 'Done' : (isUnlocked ? 'Go' : 'Locked')}</span>
	        `;

        map.appendChild(btn);
        stationsCreated++;
      });

      console.log(`=== MRT map complete: ${stationsCreated} stations created ===`);
    }

    // TEST MODE: Set to true to unlock all stations for testing
    const TEST_MODE = true;

    function isStationUnlocked(stationId, index) {
      // TEST MODE: All stations unlocked
      if (TEST_MODE) {
        return true;
      }

      // First station ALWAYS unlocked - no exceptions
      if (index === 0) {
        console.log(`Station ${stationId} at index 0: ALWAYS UNLOCKED`);
        return true;
      }

      const stationOrder = ['fruit', 'drink', 'bakery', 'pizza', 'icecream', 'fishshop', 'cheese', 'noodle'];
      const station = stationContent[stationId];

      if (!station) {
        console.error(`Cannot check unlock for missing station: ${stationId}`);
        return false;
      }

      // Check if previous station is completed
      const prevStationId = stationOrder[index - 1];
      if (state.completedStations.includes(prevStationId)) {
        console.log(`Station ${stationId}: unlocked because ${prevStationId} completed`);
        return true;
      }

      // Also unlock if this station itself was already completed (for replay)
      if (state.completedStations.includes(stationId)) {
        console.log(`Station ${stationId}: unlocked because already completed`);
        return true;
      }

      // Also unlock if any station from a higher level is completed (for replay flexibility)
      const higherLevelCompleted = state.completedStations.some(id => {
        const s = stationContent[id];
        return s && s.level >= station.level;
      });

      if (higherLevelCompleted) {
        console.log(`Station ${stationId}: unlocked because higher level completed`);
      }

      return higherLevelCompleted;
    }

    // Update unlockNextStation to use the new system
    function unlockNextStation() {
      // Re-generate the map to reflect new unlock status
      generateMRTMap();
    }

    // ===== INIT =====
    window.onload = () => {
      console.log('App initializing...');

      // Load voices
      if (window.speechSynthesis) {
        window.speechSynthesis.getVoices();
      }

      // Prime mobile audio unlock on the first interaction (iOS Safari requirement).
      const unlockOnce = () => unlockAudioContext();
      document.addEventListener('touchstart', unlockOnce, { passive: true, once: true });
      document.addEventListener('pointerdown', unlockOnce, { passive: true, once: true });
      document.addEventListener('mousedown', unlockOnce, { once: true });

	      // Load saved progress
	      loadProgress();
	      document.getElementById('soundToggle').textContent = 'Audio';
	      document.getElementById('soundToggle').classList.toggle('active', state.soundEnabled);
	      document.getElementById('calmModeToggle').textContent = 'Calm';
	      document.getElementById('calmModeToggle').classList.toggle('active', state.calmMode);
	      const marksToggle = document.getElementById('sightWordMarksSettingToggle');
	      const gateToggle = document.getElementById('sightWordGateSettingToggle');
	      if (marksToggle) marksToggle.classList.toggle('active', state.sightWordMarksEnabled);
	      if (gateToggle) gateToggle.classList.toggle('active', state.sightWordGateEnabled);

	      // Generate MRT map
	      generateMRTMap();

      // Build skills list
      updateSkillsFilterButtons();
      renderSkillsScreen();

      // Preload all images in background for instant station loading
      preloadAllStationAssets();

      updateHomeButtonState();

      console.log('App initialized. Stations:', Object.keys(stationContent));
      console.log('Completed stations:', state.completedStations);
    };
  </script>
</body>
</html>
